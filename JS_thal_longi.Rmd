---
title: "Thalamus Analysis"
author: "John Schloemer"
date: "9 5 2022"
output: 
  bookdown::html_document2:
    code_folding: hide
    toc: yes
    toc_depth: 5
    highlight: tango
    theme: paper
    fig_width: 20
    fig_height: 20
    fig_caption: yes
    number_sections: yes
    keep_md: yes
    df_print: default
---

```{r library, results='hide', message=FALSE, warning=FALSE} 
# library(devtools) # for development versions on GitHub
library(htmlTable)
#library(magick)
library(rmarkdown)
library(Hmisc)
# library(Rcmdr)
library(dplyr)
library(plotrix)
library(psych)
library(pastecs)
library(tidyr)
library(tidyverse)
library(ggplot2) # for data visualization (plotting)
library(car) # for statistical models (ANCOVA with type III errors), dummy coding
library(MatchIt) # for propensity (e.g. age, IQ) matching
# library(purrr)  # for applying functions and working with lists (e.g. map(), reduce(), transpose())
# library(stringr) # for string manipulation (e.g. str_detect(), str_extract(), str_subset(); string pattern - regular expressions)
# library(forcats) # for dealing with factors (e.g. reordering)
library(ggforce) # extends functionality of ggplot2 (e.g. spreads boxplot facets (facet_wrap) over multiple pages)
library(cowplot) # extends functionality of ggplot2 (e.g. create raincloud plots)
# library(PupillometryR) # for raincloud (flat violin) plots
library(ggsci) # alternative color tool/palettes for plotting (scientific journal style)
library(ggpubr) # extends functionality of ggplot2 (e.g. editing options for publication)
library(ggsignif) # for adding significance brackets and labels to ggplots (better compatible with geom_boxplot() than ggpubr)
# library(stargazer) # for creating aesthetic table outputs to summarize analyses
library(kableExtra) # for creating kables (customized tables in RMarkdown output with styling options)
library(bookdown) # support for numbering figure and table captions
library(rstatix) # for statistical tests (in combination with dplyr/piping and plotting) and summary statistics
# library(psych) # additional statistic options (e.g. correlation matrix, partial correlations)
# library(lme4) # for linear mixed modelling
library(MASS) # for robust linear model
library(broom) # tidy test output, e.g. of GLM
library(broom.mixed)
library(emmeans) # for estimated marginal means (EMM) (covariate-adjusted means in ANCOVA)
library(sfsmisc) # for p values of robust regression analyses
# library(broom.mixed) # tidy mixed model
library(scales) # for scale and percentage formatting (optional)
# library(corrplot) # generate correlation matrix/visualization
# library(ppcor) # for partial correlations
# library(effectsize) # for effect size statistics (e.g. eta squared, Cohen's d)
library(sjstats) # for effect size statistics
# library(pwr) # basic functions for power analysis
# library(broom)
# #library(matlib) # for Gram-Schmidt Orthogonalization of a Matrix
# library(tidystats) # make lists and dataframes out of statistical test results
# library(reshape2) # for transposing/melting data (can also be done with dplyr)
# library(RColorBrewer) # color tool/palettes for plotting
# library(captioner) # support for numbering figure and table captions (alternative to bookdown)
library(sqldf)
```

```{r}
# Code for creating raincloud plots (geom flat violin, will be used later to visualize data distribution)
"%||%" <- function(a, b) {
  if (!is.null(a)) a else b
}

geom_flat_violin <- function(mapping = NULL, data = NULL, stat = "ydensity",
                        position = "dodge", trim = TRUE, scale = "area",
                        show.legend = NA, inherit.aes = TRUE, ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomFlatViolin,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      ...
    )
  )
}

GeomFlatViolin <-
  ggproto("GeomFlatViolin", Geom,
          setup_data = function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)
            
            # ymin, ymax, xmin, and xmax define the bounding rectangle for each group
            data %>%
              group_by(group) %>%
              mutate(ymin = min(y),
                     ymax = max(y),
                     xmin = x,
                     xmax = x + width / 2)
            
          },
          
          draw_group = function(data, panel_scales, coord) {
            # Find the points for the line to go all the way around
            data <- transform(data, xminv = x,
                              xmaxv = x + violinwidth * (xmax - x))
            
            # Make sure it's sorted properly to draw the outline
            newdata <- rbind(plyr::arrange(transform(data, x = xminv), y),
                             plyr::arrange(transform(data, x = xmaxv), -y))
            
            # Close the polygon: set first and last point the same
            # Needed for coord_polar and such
            newdata <- rbind(newdata, newdata[1,])
            
            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, panel_scales, coord))
          },
          
          draw_key = draw_key_polygon,
          
          default_aes = aes(weight = 1, colour = "grey20", fill = "white", size = 0.5,
                            alpha = NA, linetype = "solid"),
          
          required_aes = c("x", "y")
)
```

```{r labellingfunctions, results="hide", message=FALSE, warning=FALSE}
# Grouping of thalamus volumes
variables_grouper.thal <- c(lh_Whole_thalamus="Whole Thalamus",
                                                   rh_Whole_thalamus="Whole Thalamus",
                                                   lh_AV="Thalamus nuclei",rh_AV="Thalamus nuclei",
                                                   lh_LD="Thalamus nuclei",rh_LD="Thalamus nuclei",
                                                   lh_LP="Thalamus nuclei",rh_LP="Thalamus nuclei",
                                                   lh_VA="Thalamus nuclei",rh_VA="Thalamus nuclei",
                                                   lh_VAmc="Thalamus nuclei",rh_VAmc="Thalamus nuclei",
                                                   lh_VLa="Thalamus nuclei",rh_VLa="Thalamus nuclei",
                                                   lh_VLp="Thalamus nuclei",rh_VLp="Thalamus nuclei",
                                                   lh_VPL="Thalamus nuclei",rh_VPL="Thalamus nuclei",
                                                   lh_VM="Thalamus nuclei",rh_VM="Thalamus nuclei",
                                                   lh_CeM="Thalamus nuclei",rh_CeM="Thalamus nuclei",
                                                   lh_CL="Thalamus nuclei",rh_CL="Thalamus nuclei",
                                                   lh_Pc="Thalamus nuclei",rh_Pc="Thalamus nuclei",
                                                   lh_CM="Thalamus nuclei",rh_CM="Thalamus nuclei",
                                                   lh_Pf="Thalamus nuclei",rh_Pf="Thalamus nuclei",
                                                   lh_Pt="Thalamus nuclei",rh_Pt="Thalamus nuclei",
                                                   'lh_MV(Re)'="Thalamus nuclei",'rh_MV(Re)'="Thalamus nuclei",
                                                   lh_MDm="Thalamus nuclei",rh_MDm="Thalamus nuclei",
                                                   lh_MDl="Thalamus nuclei",rh_MDl="Thalamus nuclei",
                                                   lh_LGN="Thalamus nuclei",rh_LGN="Thalamus nuclei",
                                                   lh_MGN="Thalamus nuclei",rh_MGN="Thalamus nuclei",
                                                   'lh_L-SG'="Thalamus nuclei",'rh_L-Sg'="Thalamus nuclei",
                                                   lh_PuA="Thalamus nuclei",rh_PuA="Thalamus nuclei",
                                                   lh_PuM="Thalamus nuclei",rh_PuM="Thalamus nuclei",
                                                   lh_PuL="Thalamus nuclei",rh_PuL="Thalamus nuclei",
                                                   lh_PuI="Thalamus nuclei",rh_PuI="Thalamus nuclei")


labeller.desc <- function(x) {
  dplyr::recode(x,
                "age_at_date_of_research.x" = "Age (years)",
                "iq" = "IQ",
                "bmi_at_date_of_research.x" = "BMI (kg/m\u00B2)",
                "bmisds_at_date_of_research.x" = "BMI-SDS",
                "minbmi" = "Minimal lifetime BMI (kg/m\u00B2)",
                "research_blood_results_leptin.x" = "Leptin (µg/L)",
                "e_tiv" = "eTIV (mm\u00B3)",
                "subcort_gray" = "Subcortical GM volume (mm\u00B3)",
                "resultquest_bdi2_total" = "BDI-II total",
                "edi_core" = "EDI-2 core symptoms",
                "resultquest_scl90r_skagloba" = "SCL-90-R GSI",
                "s.anxiety" = "STAI(K) State Anxiety",
                "t.anxiety" = "STAI(K) Trait Anxiety",
                "delta_dates" = "Time period TP2 - TP1 (days)",
                "delta_bmi" = "∆BMI in %",
                "delta_edi_core" = "∆EDI in %",
                "resultquest_bdi2_total" = "BDI-II total",
                "resultquest_edi2_ss" = "EDI-2 Drive for Thinness",
                "resultquest_edi2_uk" = "EDI-2 Body Dissatisfaction",
                "resultquest_edi2_iw" = "EDI-2 Interoceptive Awareness",
                "resultquest_scl90r_skazwang" = "SCL-90-R Compulsiveness",
                "delta_resultquest_scl90r_skazwang" ="∆SCL-90-R Compulsiveness in %",
                "delta_leptin" = "∆Leptin in %",
                "delta_edi_ss" = "∆ EDI-2 Drive for Thinness in %",
                "delta_edi_uk" = "∆ EDI-2 Body Dissatisfaction in %",
                "delta_edi_iw" = "∆ EDI-2 Interoceptive Awareness in %")
  }

# Custom order of descriptive variables 
order.desc <- function(x) {
  factor(x, 
         levels=c("iq", "bmi_at_date_of_research.x",
                                              "bmisds_at_date_of_research.x", "age_at_date_of_research.x", "minbmi", "research_blood_results_leptin.x",
                                              "e_tiv", "subcort_gray", "edi_core",
                                              "resultquest_scl90r_skagloba", "s.anxiety", "t.anxiety",
                                              "delta_age", "delta_bmi",
                                              "delta_bmisds",
                                              "delta_leptin", 
                                              "delta_e_tiv", "delta_subcort_gray",
                                              "delta_resultquest_bdi2_total",
                                              "delta_edi_core", "delta_resultquest_scl90r_skagloba",
                                              "resultquest_bdi2_total", "resultquest_edi2_ss",
                                              "resultquest_edi2_uk", "resultquest_edi2_iw", "resultquest_scl90r_skazwang", "delta_resultquest_scl90r_skazwang", "delta_edi_uk", "delta_edi_ss", "delta_edi_iw"))
  }

# Grouping of descriptive variables
variables_grouper.desc <- c(age_at_date_of_research.x = "Demographics and BMI", 
               iq = "Demographics and BMI", 
               bmi_at_date_of_research.x = "Demographics and BMI", 
               bmisds_at_date_of_research.x = "Demographics and BMI",
               minbmi  = "Demographics and BMI",
               research_blood_results_leptin.x = "Hormone parameter",
               e_tiv = "Brain segmentation volumes",
               subcort_gray = "Brain segmentation volumes",
               t.anxiety	 = "Symptoms",
               resultquest_bdi2_total = "Symptoms",
               edi_core = "Symptoms",
               resultquest_scl90r_skagloba = "Symptoms",resultquest_bdi2_total = "Symptoms",
               resultquest_edi2_ss = "Symptoms",
               resultquest_edi2_uk = "Symptoms",
               resultquest_edi2_iw = "Symptoms",
               resultquest_scl90r_skazwang = "Symptoms",
               s.anxiety = "Symptoms",
               delta_age = "Change (T2 - T1)",
               delta_bmi = "Change (T2 - T1)",
               delta_bmisds= "Change (T2 - T1)",
               delta_leptin = "Change (T2 - T1)",
               delta_e_tiv = "Change (T2 - T1)",
               delta_subcort_gray = "Change (T2 - T1)",
               delta_resultquest_bdi2_total_T2 = "Change (T2 - T1)",
               delta_edi_core = "Change (T2 - T1)",
               delta_resultquest_scl90r_skagloba_T2 = "Change (T2 - T1)",
               delta_s.anxiety_T2 = "Change (T2 - T1)",
               delta_edi_core = "Change (T2-T1)",
               delta_resultquest_scl90r_skazwang= "Change (T2-T1)",
               delta_edi_ss= "Change (T2-T1)",
               delta_edi_uk= "Change (T2-T1)",
               delta_edi_iw= "Change (T2-T1)")

levels.region <- function(x) {
  factor(x, levels=c('AV',
                                       'CL',
                                       'CM',
                                       'CeM',
                                       'L-Sg',
                                       'LD',
                                       'LGN',
                                       'LP',
                                       'MDl',
                                       'MDm',
                                       'MGN',
                                       'MV(Re)',
                                       'Pc',
                                       'Pf',
                                       'Pt',
                                       'PuA',
                                       'PuI',
                                       'PuL',
                                       'PuM',
                                       'VA',
                                       'VAmc',
                                       'VLa',
                                       'VLp',
                                       'VM',
                                       'VPL',
                                       'Whole_thalamus'))
  }

levels.hemi_region <- function(x) {
  factor(x, levels=c('lh_Whole_thalamus','rh_Whole_thalamus',
                                                   'lh_AV','rh_AV',
                                                   'lh_LD','rh_LD',
                                                   'lh_LP','rh_LP',
                                                   'lh_VA','rh_VA',
                                                   'lh_VAmc','rh_VAmc',
                                                   'lh_VLa','rh_VLa',
                                                   'lh_VLp','rh_VLp',
                                                   'lh_VPL','rh_VPL',
                                                   'lh_VM','rh_VM',
                                                   'lh_CeM','rh_CeM',
                                                   'lh_CL','rh_CL',
                                                   'lh_Pc','rh_Pc',
                                                   'lh_CM','rh_CM',
                                                   'lh_Pf','rh_Pf',
                                                   'lh_Pt','rh_Pt',
                                                   'lh_MV(Re)','rh_MV(Re)',
                                                   'lh_MDm','rh_MDm',
                                                   'lh_MDl','rh_MDl',
                                                   'lh_LGN','rh_LGN',
                                                   'lh_MGN','rh_MGN',
                                                   'lh_L-Sg','rh_L-Sg',
                                                   'lh_PuA','rh_PuA',
                                                   'lh_PuM','rh_PuM',
                                                   'lh_PuL','rh_PuL',
                                                   'lh_PuI','rh_PuI'))
  }
```

```{r}
setwd("//med/zfs/users/SCHLOEMJO/Desktop/Thalamus_R_temp/data")
glmdata <- read.csv("glmdata09-Mai-2022 15.44.csv")
#create real id variable
glmdata$id <- substring(glmdata$storage_name, 1, 9)

#get QC
setwd("Z:/For_TrDeN/Projekte/Anorexie/05_Projekte/smri/thalamus_subfields/analysis/R_project_smri-Thalamus")
QC_data <- get_redcap()%>%
  dplyr::select(point_of_research, redcap_event_name, participant_id, storage_name, mriqc_smri_thal_summary)%>%
  rename(thal_summary_redcap = mriqc_smri_thal_summary) %>%
  right_join(get_QC(), by =c("redcap_event_name", "participant_id", "storage_name"))%>%
  dplyr::select(-c(outlier_regions_symmetry, outlier_regions_volume))%>%
  write.csv(., paste0("//med/zfs/users/SCHLOEMJO/Desktop/Thalamus_R_temp/data/QCdata", format(Sys.time(), "%d-%b-%Y %H.%M"), ".csv"), sep=",", row.names = FALSE, quote=FALSE, col.names=FALSE)
QC_data <- read.csv(paste0("//med/zfs/users/SCHLOEMJO/Desktop/Thalamus_R_temp/data/QCdata", format(Sys.time(), "%d-%b-%Y %H.%M"), ".csv"), sep=",")
#id variable in Qc and 
QC_data$id <- substring(QC_data$storage_name, 1, 9)

QC_data %>% mutate_at(vars(-c(storage_name, point_of_research)),
            funs(as.numeric(.)))

```

```{r}
a <- QC_data %>%
  filter(point_of_research %in% c("T1","T2", "recAN", "HCW"))

b <- a %>%
  filter(is.outlier_cnr == FALSE & is.outlier_snr == FALSE)

c <- b %>% 
  filter(mriqc_smri_summary < 3)

d <- c %>%
  filter(n_outliers_symmetry_4.721sd < 1 & n_outliers_volume_4.721sd < 1) # only extreme volume & symmetry outliers!

d %>%
  filter(n_outliers_volume_2.698sd > 1 | n_outliers_symmetry_2.698sd > 1) %>%
  filter(mriqc_smri_thal_summary == 9)

d %>%
  filter(n_outliers_volume_2.698sd < 2 & n_outliers_symmetry_2.698sd < 2) %>%
  filter(mriqc_smri_thal_summary == 9)

```

## Generate final study sample  
Background: >1 T1-scans per subject available from some subjects that have passed our general and thalghippo QC (they participated in >1 research studies) => unique T1-scans must be selected.  

Priorities:
1: For acAN: first AN episode (in case of re-inclusions) and/or scan closest to admission/acute phase (for acAN-TP1);  
2: Within-subject thalamus segmentation quality (sum of thalamus volume and symmetry outliers);  
3: Date of research (see Priority 1 for acAN): for recAN most recent scan (longer duration of recovery), for HC first assessment (in line with acAN-TP1);  
4: General QC rating (0 and 1 reflect good scan quality vs. 2, our general QC rating is rather cortex-focused and was therefore not prioritized);  
5: For acAN-TP2: most recent scan within the same AN episode as acAN-TP1 (closer to discharge/short-term weight-restored state);  
6: For acAN: re-inclusions were checked (criteria: time span between study time points, minimum BMI increase of 12%).  

```{r subjects01, message=FALSE, warning=FALSE}
redcap_bmi <- glmdata %>%
  dplyr::select(storage_name, bmi_at_date_of_research) 

redcap_date <- redcap_total %>%
    dplyr::select(storage_name, date_of_research, research_blood_taking_date,
                research_blood_results_leptin)

uniquesubjects_prep <- QC_data %>%
  filter(!str_detect(storage_name, "atd")) %>% # exclude atd study arm
  left_join(redcap_date, by="storage_name") %>%
  filter(mriqc_smri_thal_summary == 1) %>%
  mutate(outliersum = n_outliers_volume_2.698sd + n_outliers_symmetry_2.698sd) %>%
  mutate(mriqc_smri_summary = ifelse(mriqc_smri_summary %in% c(0,1), 1, 2)) %>% # general QC ratings 0 and 1 are not distinguished (good quality!)
  dplyr::select(storage_name, id, point_of_research, date_of_research, mriqc_smri_summary, outliersum, research_blood_taking_date, research_blood_results_leptin)


# AcAN case selection
uniquesubjects_T1 <- uniquesubjects_prep %>%
  filter(point_of_research %in% "T1") %>%
  left_join(redcap_bmi, by="storage_name")

uniquesubjects_acAN <- uniquesubjects_prep %>%
  filter(point_of_research %in% "T2") %>%
  left_join(redcap_bmi, by="storage_name") %>%
  full_join(uniquesubjects_T1, by="id", suffix = c(".T2", ".T1")) %>%
  filter(is.na(storage_name.T2) | (storage_name.T2 != "64-10-041-1_T2_mop")) %>% # exclusion, subject has only TP2 (no baseline TP1 available or excluded in QC)
  group_by(id) %>%
  mutate(delta_dates = as.Date(as.character(date_of_research.T2), format="%Y-%m-%d") - as.Date(as.character(date_of_research.T1), format="%Y-%m-%d")) %>%
  mutate(delta_dates=as.numeric(gsub(" days", "", delta_dates))) %>%
  mutate(delta_dates_leptin.T1=abs(as.Date(date_of_research.T1) - # aim for minimum time difference between blood draw and MRI scan
           as.Date(research_blood_taking_date.T1))) %>%
  mutate(delta_dates_leptin.T2=abs(as.Date(date_of_research.T2) - 
           as.Date(research_blood_taking_date.T2))) %>%
  mutate(delta_bmi = 100*((bmi_at_date_of_research.T2 - bmi_at_date_of_research.T1)/bmi_at_date_of_research.T1)) %>% 
  filter(is.na(delta_dates) | (delta_dates > 0), .preserve=TRUE) %>% # date difference TP2 - TP1 must be positive or NA (if only TP1 available)
  filter(is.na(delta_dates) | (delta_dates != 323), .preserve=TRUE) %>% # acAN re-inclusion, TP1 conni and TP2 braef do not match
  filter(is.na(delta_bmi) | (delta_bmi >=12), .preserve=TRUE) %>% # Minimum BMI increase criterion (or NA if only TP1 available)
  arrange(date_of_research.T1, outliersum.T2, outliersum.T1, mriqc_smri_summary.T2, mriqc_smri_summary.T1, delta_dates_leptin.T2, delta_dates_leptin.T1, desc(date_of_research.T2), .by_group = TRUE) %>% # QC: T2 more important than T1 (longi paper!) 
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(storage_name.T1, storage_name.T2, id, delta_dates) %>% # Last dates / time span check => OK!
  mutate(session_T1 = str_extract(storage_name.T1, "[a-z]+")) %>%
  mutate(session_T2 = str_extract(storage_name.T2, "[a-z]+")) %>%
  mutate(same_session = ifelse(session_T1 == session_T2, TRUE, FALSE)) %>% # Check acAN-TP1 - acAN-TP2 matching => OK!
  dplyr::select(storage_name.T1, storage_name.T2, id) %>% 
  pivot_longer(-id, names_to="name", values_to="storage_name") %>%
  filter(!is.na(storage_name)) %>% 
  dplyr::select(storage_name, id)

# RecAN case selection
uniquesubjects_recAN <- uniquesubjects_prep %>%
  filter(point_of_research %in% "recAN") %>%
  group_by(id) %>%
  arrange(date_of_research, .by_group=TRUE) %>%
  mutate(delta_dates=as.Date(date_of_research) - lead(as.Date(date_of_research))) %>%
  mutate(delta_dates=ifelse(is.na(delta_dates), 
                              as.Date(date_of_research) - lag(as.Date(date_of_research)),
                              delta_dates)) %>%
  mutate(order_date=ifelse(is.na(delta_dates), 2,
                             ifelse((abs(delta_dates)<10) & 
                               (delta_dates<0), 1, 2))) %>%
  mutate(demo_date=ifelse(is.na(delta_dates), date_of_research, 
                            ifelse((abs(delta_dates)<10) & (delta_dates>0), 
                            lag(as.Date(date_of_research)), 
                            as.Date(date_of_research)))) %>%
  mutate(delta_dates_leptin=abs(as.Date(date_of_research) - 
                                    as.Date(research_blood_taking_date))) %>%
  arrange(outliersum, desc(demo_date), order_date, mriqc_smri_summary, .by_group = TRUE) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(storage_name, id)

# HC case selection 
uniquesubjects_HC <- uniquesubjects_prep %>%
  filter(point_of_research %in% "HCW") %>%
  group_by(id) %>%
  arrange(outliersum, date_of_research, mriqc_smri_summary, .by_group = TRUE) %>% # exactly as in cross-sectional paper
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(storage_name, id)

uniquesubjects <- rbind(uniquesubjects_acAN, uniquesubjects_recAN, uniquesubjects_HC)
  
 #Are there still any duplicated subjects (via subset ID, grouped by point of research)
exclusion <- uniquesubjects %>%
  left_join(glmdata, by="storage_name", all.x=TRUE)%>%
    dplyr::select(storage_name, participant_id, id.x, point_of_research, bmi_at_date_of_research) %>%
   left_join(redcap_total, by=c("storage_name", "point_of_research", "bmi_at_date_of_research", "participant_id"))

exclusion %>%
  group_by(point_of_research) %>%
  mutate(duplicated = duplicated(id.x)) %>%
  filter(duplicated == TRUE) %>%
  nrow(.)
```

**Exclusion of participants: BMI criteria in recAN and HC**  
```{r bmi, results="asis", message=FALSE, warning=FALSE}
bmiexclusion <- exclusion %>%
    filter(point_of_research %in% c("HCW", "recAN"))%>%
  filter(bmi_at_date_of_research >= 28 | bmi_at_date_of_research <= 17.5) %>%
  dplyr::select(storage_name, point_of_research, bmi_at_date_of_research)

#check age of excluded participants
bmiexclusion2 <- left_join(bmiexclusion, glmdata, by="storage_name")%>%
  group_by(id, point_of_research.x) %>%
  arrange(id, .by_group=TRUE) %>%
  slice_head(n = 1)%>%
  ungroup()

#use age percentiles for underage participants
bmiexclusion <- bmiexclusion %>%
  mutate(BMI_percentile=case_when(str_detect(storage_name, "64-23-079-1_mop") ~ 13,
                                         str_detect(storage_name, "64-23-109-1_mop") ~ 16,
                                         str_detect(storage_name, "64-23-231-1_suber") ~ 13,
                                         str_detect(storage_name, "64-23-295-1_suber") ~ 21,
                                         str_detect(storage_name, "64-23-319-1_suber") ~ 24,
                                         str_detect(storage_name, "64-23-410-1_conni") ~ 28,
                                         str_detect(storage_name, "64-23-430-1_conni") ~ 23,
                                         str_detect(storage_name, "64-23-437-1_conni") ~ 15,
                                         str_detect(storage_name, "64-23-445-1_conni") ~ 24,
                                ))%>%
  group_by(storage_name)%>%
  filter(BMI_percentile<10 | is.na(BMI_percentile), by_group=TRUE)%>%
  ungroup()%>%
  dplyr::select(storage_name, point_of_research, bmi_at_date_of_research)

bmiexclusion  %>%
  knitr::kable(format = "html", digits=2, col.names = c("Subject", "Study group", "BMI (kg/m\u00B2)"), align = "l", caption = "Participants with BMI outside of our inclusion criteria") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```


**Exclusion of participants: psychiatric diagnoses or clinically relevant BDI-II scores (>= 20) in HC participants**  
```{r hccomorbidity01, results="asis", message=FALSE, warning=FALSE}
comorb_HC <- exclusion %>%
  filter(point_of_research %in% "HCW") %>% 
  filter((psychiatric_disorders %in% "ja") | (resultquest_bdi2_total >= 20)) %>%
  dplyr::select(storage_name, point_of_research, resultquest_bdi2_total, depressive_disorders, obsessivecompulsive_disorders, anxiety_disorders, addiction, ptsd, tic_tourette, conduct_disorder, defiant_behaviour, adaption_disorder, psychosis, attention_deficit_hyperactivity_disorder, personality_disorders, developmental_disorders, other_psychiatric_disorders, spec_other_psychiatric_disorders) %>% 
  arrange(desc(resultquest_bdi2_total))

comorb_HC$spec_other_psychiatric_disorders %>% 
  .[!is.na(.)] %>%
  paste(., collapse=" ; ") %>%
  knitr::kable(format = "html", align = "l", col.names = "Summary of diagnoses", caption = "Other psychiatric disorders in HC participants") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above("No exclusions due to other psychiatric disorders in HC", align="l")
```

```{r hccomorbidity02, results="asis", message=FALSE, warning=FALSE}
comorb_HC %>%
  dplyr::select(-c(other_psychiatric_disorders, spec_other_psychiatric_disorders)) %>%
  filter_all(any_vars(str_detect(., "ja") | resultquest_bdi2_total>=20)) %>%
  mutate_all(funs(str_replace(., "ja", "yes"))) %>%
  mutate_all(funs(str_replace(., "nein", "no"))) %>%
  mutate_all(funs(str_replace(., "nicht mehr erhoben", NA_character_))) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Subject", "Study group", "BDI-II total scores", "Depressive disorders", "OCD", "Anxiety disorders", "Addiction", "PTSD", "Tic-Tourette syndrome", "Conduct disorder", "Defiant behavior", "Adaption disorder", "Psychosis", "ADHD", "Personality disorders", "Developmental disorders"), caption = "Psychiatric comorbidity in HC subjects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("BDI-II scores >= 20 excluded + 1 confirmed anxiety disorder excluded (remaining participants without confirmed (by medical professional) psychiatric disorders)"=16), align="l")

comorbexclusion <- comorb_HC %>%
  filter((resultquest_bdi2_total>=20) | (storage_name == "64-23-413-1_conni")) # Aktenkontrolle (anxiety disorder)
```
**Exclusion of participants: psychoactive medication in HC**
```{r hcmedi, results="asis", message=FALSE, warning=FALSE}
exclusion %>%
  filter(point_of_research %in% "HCW") %>%
  dplyr::select(storage_name, point_of_research, type_of_current_medication___1, type_of_current_medication___2, type_of_current_medication___3, type_of_current_medication___4, type_of_current_medication___5, type_of_recent_medication___1, type_of_recent_medication___2, type_of_recent_medication___3, type_of_recent_medication___4, type_of_recent_medication___5, recent_benzodiazepine_preparation) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Subject", "Study group", "Antidepressants", "Neuroleptic drugs", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "Neuroleptic drugs", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Preparation (Benzo)"), caption = "HC participants with current (past 2 weeks) or recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
   add_header_above(c("", "", "Note that the recently applied benzodiazepine in 1 HC participant can remain included."=11), align="l") %>%
  add_header_above(c("", "", "Current medication"=5, "Recent medication"=6), align="l")
```

**Exclusion of participants: psychoactive medication in AN patients/participants**
```{r anmedi, results="asis", message=FALSE, warning=FALSE}
medi_AN <- exclusion %>%
  filter(point_of_research != "HCW") %>%
  dplyr::select(storage_name, point_of_research, type_of_current_medication___1, current_antidepressants_preparation, type_of_current_medication___2, current_neuroleptic_drug_preparation, type_of_current_medication___3, type_of_current_medication___4, type_of_current_medication___5, type_of_recent_medication___1, recent_antidepressants_preparation, type_of_recent_medication___2, recent_neuroleptic_drug_preparation, type_of_recent_medication___3, type_of_recent_medication___4, type_of_recent_medication___5) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  mutate(point_of_research = dplyr::recode(point_of_research,
                                           "T1" = "acAN-TP1",
                                           "T2" = "acAN-TP2")) %>% arrange(point_of_research) %>%
  mutate(type_of_current_medication___2 = ifelse(storage_name %in% "64-10-580-1_T1_dehab", "no", type_of_current_medication___2)) # "Current neuroleptic medication" were checked in this participant but no preparation was given (we assume that this participant is under NO current neuroleptic medication)

medi_AN %>%
  knitr::kable(format = "html", align = "l", col.names = c("Subject", "Study group", "Antidepressants", "... Preparation", "Neuroleptic drugs", "... Preparation (exclusion criterion)", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "... Preparation", "Neuroleptic drugs", "... Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines"), caption = "Descriptive statistics acAN and recAN: Current (past 2 weeks) and recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "", "Current medication"=7, "Recent medication"=7), align="l") %>%
  add_header_above(c("AcAN-TP2 participant 64-10-372-1_T2_conni has to be excluded because of current neuroleptic medication (Promethazine). Besides, no other current neuroleptic drugs have been described in any participant. SSRIs and mirtazapine can remain included."=16), align="l")

mediexclusion <- medi_AN %>%
  filter(storage_name == "64-10-372-1_T2_conni")
```
**Study sample with eligible participants (after exclusions)** 
```{r subjects02, results="hide", message=FALSE, warning=FALSE}
postexclusion <- anti_join(uniquesubjects, bmiexclusion, by = "storage_name") %>%
  anti_join(comorbexclusion, by = "storage_name")%>%
  left_join(glmdata, by="storage_name")%>%
  rename(id=id.x)
```


```{r sample01, results="hide", message=FALSE, warning=FALSE}
# Matching acAN-TP1 - acAN-TP2
match_T1_T2 <- postexclusion %>%
  filter(point_of_research %in% c("T1", "T2")) %>%
  group_by(id) %>%
  arrange(id, .by_group=TRUE) %>%
  filter(n() == 104, .preserve=TRUE, .by_group=TRUE) %>% # filter by group
  ungroup()

recAN_HC <- postexclusion %>%
  filter(point_of_research %in% c("recAN", "HCW")) %>%
  group_by(id, point_of_research) %>%
  arrange(id, .by_group=TRUE) %>%
  filter(n() ==52, .preserve=TRUE, .by_group=TRUE) %>% # filter by group
  ungroup()

# Eliminate acAN - recAN re-inclusions (recAN are excluded)
T1_T2_recAN_HC <- bind_rows(match_T1_T2, recAN_HC)%>%
  left_join(leptin_replace, by="storage_name") %>%
  mutate(research_blood_results_leptin=ifelse((is.na(research_blood_results_leptin))&(!is.na(research_blood_results_leptin.y)), research_blood_results_leptin.y, research_blood_results_leptin)) %>%
  dplyr::select(-research_blood_results_leptin.y) %>%
  mutate(leptin.svi=ifelse((leptin2021==TRUE) & (research_blood_results_leptin<0.20), 0.20/sqrt(2), # single value imputation
                       ifelse((leptin2021==FALSE) & (research_blood_results_leptin<0.05), 0.05/sqrt(2),
                       research_blood_results_leptin))) %>%
  mutate(log_leptin.svi=log10(leptin.svi)) %>%
  filter(!is.na(measure)) %>%
  mutate(por=factor(ifelse(point_of_research %in% c("recAN", "HCW"),
                                as.character(point_of_research), "acAN"),
                    levels=c("acAN", "recAN", "HCW"))) %>% 
  mutate(point_of_research=factor(point_of_research,
                                  levels=c("T1", "T2", "recAN", "HCW"))) %>%
  mutate(region=recode.region1(region)) %>%
  mutate(region=levels.region(region)) %>%
  unite("hemi_region", c(hemi, region), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  mutate(hemi_region=levels.hemi_region(hemi_region)) %>%
  unite("labeller", c(region, hemi), 
        sep=" ", remove=FALSE, na.rm=FALSE) %>%
  mutate(whole.sub=ifelse(region=="Whole_thalamus", "whole", "sub"))
  

exclude_reinclusions <- T1_T2_recAN_HC %>%
  group_by(id) %>%
  arrange(point_of_research, by_group = TRUE) %>%
  filter(n()==156, .preserve=TRUE, .by_group=TRUE) %>%
  filter(point_of_research %in% "recAN") %>%
  ungroup()

T1_T2_recAN_HC %>%
mutate(research_blood_results_leptin = coalesce(research_blood_results_leptin, clinical_blood_results_leptin)) #get missing leptin data from clinical blood draw



 #Final study sample
sample <- anti_join(T1_T2_recAN_HC, exclude_reinclusions, by="storage_name") %>%
  dplyr::select(-c(file_type)) %>%
  mutate(por = as.factor(ifelse(point_of_research %in% c("recAN", "HCW"), as.character(point_of_research), "acAN"))) %>% 
  mutate(point_of_research = fct_relevel(point_of_research, c("T1", "T2", "recAN", "HCW"))) %>%
  mutate(whole.sub = ifelse(region %in% "Whole_thalamus", "whole", "subregion"))
```

```{r new redcap pull for leptin data, message=FALSE, Warning=FALSe}
setwd("//med/zfs/users/SCHLOEMJO/Desktop/Thalamus_R_temp/data")
newleptinredcap <- read.csv("redcap_leptin_new.csv")

newleptinredcap <- newleptinredcap %>%
  dplyr::select(-c("point_of_research"))
```

###missing leptin data
```{r smsample, message=FALSE, warning=FALSE}
sample_is.na_leptin <- sample %>% distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, point_of_research, research_blood_results_leptin,
                date_of_research) %>%
  filter(is.na(research_blood_results_leptin))

redcap_leptin <- redcap_total %>%
  dplyr::select(storage_name, participant_id, point_of_research, research_blood_results_leptin,
                date_of_research, research_blood_results_leptin_batch, clinical_blood_results_leptin) %>%
  mutate(leptin2021=ifelse(grepl("2021", research_blood_results_leptin_batch), TRUE, FALSE))

leptin_replace <- inner_join(sample_is.na_leptin, redcap_leptin, by=c("participant_id", "point_of_research")) %>%
  mutate(delta_dates=abs(as.Date(date_of_research.x) - as.Date(date_of_research.y))) %>%
  mutate(leptin_replace=ifelse(((point_of_research %in% c("T1", "T2")) & (delta_dates<10)) |
                                 ((point_of_research %in% c("recAN", "HCW")) & 
                                    (delta_dates<30)), TRUE, FALSE)) %>%
  filter(leptin_replace==TRUE) %>%
  dplyr::select(storage_name.x, research_blood_results_leptin.y, leptin2021, clinical_blood_results_leptin) %>%
  dplyr::rename(storage_name=storage_name.x) %>%
  distinct(storage_name, .keep_all=TRUE)


sample.leptin.add <- sample %>%
  left_join(leptin_replace, by="storage_name") %>%
  mutate(research_blood_results_leptin=ifelse(!is.na(research_blood_results_leptin.y), research_blood_results_leptin.y, research_blood_results_leptin)) %>%
  dplyr::select(-research_blood_results_leptin.y) %>%
  mutate(leptin.svi=ifelse((leptin2021==TRUE) & (research_blood_results_leptin<0.20), 0.20/sqrt(2), # single value imputation
                       ifelse((leptin2021==FALSE) & (research_blood_results_leptin<0.05), 0.05/sqrt(2),
                       research_blood_results_leptin))) %>%
  mutate(log_leptin.svi=log10(leptin.svi)) %>%
  filter(!is.na(measure)) %>%
  mutate(por=factor(ifelse(point_of_research %in% c("recAN", "HCW"),
                                as.character(point_of_research), "acAN"),
                    levels=c("acAN", "recAN", "HCW"))) %>% 
  mutate(point_of_research=factor(point_of_research,
                                  levels=c("T1", "T2", "recAN", "HCW"))) %>%
  unite("hemi_region", c(hemi, region), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  mutate(hemi_region=levels.hemi_region(hemi_region)) %>%
  unite("labeller", c(region, hemi), 
        sep=" ", remove=FALSE, na.rm=FALSE) %>%
  mutate(whole.sub=ifelse(region=="Whole_thalamus", "whole", "sub"))
``` 


# Final study sample (demographic, clinical and descriptive statistics)  
```{r sample02, results="asis", message=FALSE, warning=FALSE}
sample %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  group_by(point_of_research) %>%
  count(.) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Study groups", "n"), caption = "Final study sample: Number of participants per study group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("Note that T1 and T2 are matched and belong to the same study group (acAN at two study time points)."=2), align="l")
```

*Calculate longitudinal change scores in acAN*  
```{r sample03, results="hide", message=FALSE, warning=FALSE}
#get redcap data
setwd("Z:/For_TrDeN/Projekte/Anorexie/05_Projekte/smri/thalamus_subfields/analysis/R_project_smri-Thalamus")
redcap_total <- read.csv("data/redcap_do_not_delete/redcap.csv")

redcap_total$date_of_research <- as.Date(redcap_total$date_of_research)

redcap_totalstore <- redcap_total %>%
  dplyr::select(resultquest_scl90r_skagloba, resultquest_bdi2_total, storage_name, resultquest_edi2_ss, resultquest_edi2_uk, resultquest_edi2_iw, resultquest_scl90r_skazwang, resultquest_edi2_b, clinical_blood_results_leptin)

samplestore <- left_join(sample, redcap_totalstore, by="storage_name") %>%
    mutate(edi_core = (resultquest_edi2_ss + resultquest_edi2_uk + resultquest_edi2_b)/3)%>%
  dplyr::select(id, por, storage_name, point_of_research, date_of_research, bmi_at_date_of_research, age_at_date_of_research, e_tiv, total_gray, subcort_gray, research_blood_results_leptin, resultquest_scl90r_skagloba, resultquest_bdi2_total, bmisds_at_date_of_research, resultquest_scl90r_skazwang, edi_core, resultquest_edi2_ss, resultquest_edi2_uk, resultquest_edi2_iw, resultquest_edi2_b)
  
# Longitudinal sample (calculate differences T2 - T1)

#preparation
descr_T1 <- samplestore %>%
  filter(point_of_research %in% "T1") 

descr_T2 <- samplestore %>%
  filter(point_of_research %in% "T2") 

descriptives_T1_T2 <- descr_T1 %>%
  filter(por %in% "acAN")%>%
  full_join(descr_T2, by="id", suffix = c(".T1", ".T2")) %>%
  distinct(storage_name.T2, .keep_all=TRUE) %>% 
  group_by(id) %>%
  mutate(delta_dates = as.Date(as.character(date_of_research.T2), format="%Y-%m-%d") - as.Date(as.character(date_of_research.T1), format="%Y-%m-%d")) %>%
  mutate(delta_dates=as.numeric(gsub(" days", "", delta_dates))) %>%
  mutate(delta_bmi = 100*((bmi_at_date_of_research.T2 - bmi_at_date_of_research.T1)/bmi_at_date_of_research.T1))%>%
  mutate(delta_bmisds = 100*((bmisds_at_date_of_research.T2 - bmisds_at_date_of_research.T1)/bmisds_at_date_of_research.T1))%>%
  mutate(delta_age = 100*((age_at_date_of_research.T2 - age_at_date_of_research.T1)/age_at_date_of_research.T1))%>%
  mutate(delta_e_tiv=100*((e_tiv.T2 - e_tiv.T1)/e_tiv.T1))%>%
  mutate(delta_total_gray=100*((total_gray.T2 - total_gray.T1)/total_gray.T1))%>%
  mutate(delta_subcort_gray=100*((subcort_gray.T2 - subcort_gray.T1)/subcort_gray.T1))%>%
  mutate(delta_leptin=100*((research_blood_results_leptin.T2 - research_blood_results_leptin.T1)/research_blood_results_leptin.T1), na.rm = TRUE)%>%
  mutate(delta_resultquest_scl90r_skagloba=100*((resultquest_scl90r_skagloba.T2 - resultquest_scl90r_skagloba.T1)/resultquest_scl90r_skagloba.T1))%>%
  mutate(delta_resultquest_bdi2_total=100*((resultquest_bdi2_total.T2 - resultquest_bdi2_total.T1)/resultquest_bdi2_total.T1))%>%
  mutate(delta_resultquest_scl90r_skazwang=100*((resultquest_scl90r_skazwang.T2 - resultquest_scl90r_skazwang.T1)/resultquest_scl90r_skazwang.T1))%>%
  mutate(delta_edi_core=100*((edi_core.T2 - edi_core.T1)/edi_core.T1))%>%
  mutate(delta_edi_ss=100*((resultquest_edi2_ss.T2 - resultquest_edi2_ss.T1)/resultquest_edi2_ss.T1))%>%
  mutate(delta_edi_uk=100*((resultquest_edi2_uk.T2 - resultquest_edi2_uk.T1)/resultquest_edi2_uk.T1))%>%
  mutate(delta_edi_iw=100*((resultquest_edi2_iw.T2 - resultquest_edi2_iw.T1)/resultquest_edi2_iw.T1))

  


  
descriptives_T1_T2 <- do.call(data.frame,                      # Replace Inf in data by NA
                   lapply(descriptives_T1_T2,
                          function(x) replace(x, is.infinite(x), NA)))

  
  
  
  descriptives_acAN <- descriptives_T1_T2 %>%
  dplyr::select(id, delta_dates, delta_bmi, delta_bmisds, delta_age, delta_e_tiv, delta_total_gray, delta_subcort_gray, delta_leptin, delta_resultquest_scl90r_skagloba, delta_resultquest_bdi2_total, delta_edi_core, delta_resultquest_scl90r_skazwang, delta_edi_ss, delta_edi_uk, delta_edi_iw) 
```

```{r andescriptives01, results="asis", message=FALSE, warning=FALSE}
# data preparation
redcap_totalstore_AN <- redcap_total %>%
  dplyr::select(point_of_research, storage_name, siabex_age_onset, onset_of_an, recovered_since_months, siabex_result_an_type, siabex_past_result_an_type, depressive_disorders, obsessivecompulsive_disorders, anxiety_disorders, addiction, ptsd, tic_tourette, conduct_disorder, defiant_behaviour, adaption_disorder, psychosis, attention_deficit_hyperactivity_disorder, personality_disorders, developmental_disorders, other_psychiatric_disorders, spec_other_psychiatric_disorders, psychiatric_disorders) %>%
  group_by(point_of_research)%>%
  distinct(storage_name, .keep_all = TRUE)

redcap_totalstore_AN$id <- substring(redcap_totalstore_AN$storage_name, 1, 9)

redcap_totalstore_acute <- redcap_totalstore_AN %>%
  filter(point_of_research %in% "T1") %>%
    dplyr::select(point_of_research, storage_name, siabex_age_onset, onset_of_an, recovered_since_months, siabex_result_an_type, id) 



         
redcap_totalstore_recan <- redcap_totalstore_AN %>%
  filter(point_of_research %in% "recAN") %>%
    dplyr::select(point_of_research, storage_name, siabex_age_onset, onset_of_an, recovered_since_months, siabex_past_result_an_type, id)

  

#duration statistics
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  left_join(redcap_totalstore_AN, by="id") %>% 
  group_by(point_of_research.x) %>%
  distinct(id, .keep_all=TRUE)%>%
  rstatix::get_summary_stats(siabex_age_onset, onset_of_an, recovered_since_months) %>%
  dplyr::select(point_of_research.x, variable, n, mean, sd, min, max) %>%
  mutate(variable = dplyr::recode(variable,
                                  "siabex_age_onset" = "Age at first AN onset (years)",
                                  "recovered_since_months" = "Duration of recovery from former AN episode (months)",
                                  "onset_of_an" = "Duration of current AN episode (months)")) %>%
  mutate(point_of_research.x = dplyr::recode(point_of_research.x,
                                           "T1" = "acAN-TP1")) %>%
  dplyr::arrange(point_of_research.x, variable) %>%
  knitr::kable(format = "html", digits=0, col.names = c("Study groups", "AN characteristics", "n(valid data)", "Mean", "SD", "Min", "Max"), align = "l", caption = "Descriptive statistics acAN and recAN: AN characteristics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

#AN subtypes
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  left_join(redcap_totalstore_recan, by="id") %>% 
  left_join(redcap_totalstore_acute, by="id") %>% 
  group_by(point_of_research.x)%>%
  distinct(id, .keep_all=TRUE)%>%
  mutate(siabex_result_an_type = dplyr::recode(siabex_result_an_type,
         "1.0" = "restrictive",
         "2.0" = "binge/purge")) %>% 
  mutate(siabex_past_result_an_type = dplyr::recode(siabex_past_result_an_type,
         "1.0" = "restrictive",
         "2.0" = "binge/purge")) %>% 
  group_by(id)%>%
  ungroup()%>%
  group_by(point_of_research.x)%>%
  mutate(siabex_result_an_type = ifelse(point_of_research.x %in% "T1", siabex_result_an_type, NA)) %>% 
  mutate(siabex_past_result_an_type = ifelse(point_of_research.x %in% "recAN", siabex_past_result_an_type, NA)) %>% 
  count(siabex_result_an_type, siabex_past_result_an_type) %>% 
  mutate(percentage = 100*(n / sum(n))) %>% 
  mutate(point_of_research.x = dplyr::recode(point_of_research.x,
                                           "T1" = "acAN-TP1")) %>%
  dplyr::arrange(point_of_research.x) %>%
  knitr::kable(format = "html", digits=2, col.names = c("Study groups", "Current AN subtype via SIAB-EX", "Past AN subtype via SIAB-EX", "n", "%"), align = "l", caption = "Descriptive statistics acAN and recAN: AN subtypes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r andescriptives02, results="asis", message=FALSE, warning=FALSE}
# Psychiatric comorbidities (acAN, recAN)
comorb_AN <- sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(redcap_totalstore_AN, by="storage_name") %>% 
  filter((point_of_research.x %in% c("T1", "recAN")) & (psychiatric_disorders %in% "ja")) %>%
  dplyr::select(storage_name, point_of_research.x, depressive_disorders, obsessivecompulsive_disorders, anxiety_disorders, addiction, ptsd, tic_tourette, conduct_disorder, defiant_behaviour, adaption_disorder, psychosis, attention_deficit_hyperactivity_disorder, personality_disorders, developmental_disorders, other_psychiatric_disorders, spec_other_psychiatric_disorders) %>%
  filter(storage_name != "64-10-284-1_suber") %>% # participant without "official" psychiatric diagnosis ("Trennung der Eltern, 2-3 Termine, keine Diagnose")
  group_by(point_of_research.x) %>%
  mutate(n = n())

comorb_AN %>%  
  dplyr::select(point_of_research.x, n) %>%
  distinct(n) %>%
  mutate(point_of_research.x = dplyr::recode(point_of_research.x,
                                           "T1" = "acAN-TP1")) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Study groups", ""), caption = "Descriptive statistics acAN and recAN: Total number of participants with psychiatric comorbidities") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

comorb_AN %>%
  dplyr::select(-c(spec_other_psychiatric_disorders, storage_name, point_of_research.x, n)) %>%
  summarize_all(~ sum(str_count(., "ja"), na.rm=TRUE)) %>%
  mutate(point_of_research.x = dplyr::recode(point_of_research.x,
                                           "T1" = "acAN-TP1")) %>% arrange(point_of_research.x) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Study groups", "Depressive disorders", "OCD", "Anxiety disorders", "Addiction", "PTSD", "Tic-Tourette syndrome", "Conduct disorder", "Defiant behavior", "Adaption disorder", "Psychosis", "ADHD", "Personality disorders", "Developmental disorders", "Other psychiatric disorders"), caption = "Descriptive statistics acAN and recAN: Individual psychiatric comorbidities") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

# Psychoactive medication (acAN-TP1, acAN-TP2, recAN)
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(redcap_total, by="storage_name") %>% 
  filter(point_of_research.x != "HCW") %>%
  dplyr::select(storage_name, point_of_research.x, type_of_current_medication___1, current_antidepressants_preparation, type_of_current_medication___2, current_neuroleptic_drug_preparation, type_of_current_medication___3, type_of_current_medication___4, type_of_current_medication___5, type_of_recent_medication___1, recent_antidepressants_preparation, type_of_recent_medication___2, recent_neuroleptic_drug_preparation, type_of_recent_medication___3, type_of_recent_medication___4, type_of_recent_medication___5) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  group_by(point_of_research.x) %>%
  mutate(n = n()) %>%
  mutate(point_of_research.x = dplyr::recode(point_of_research.x,
                                           "T1" = "acAN-TP1")) %>% arrange(point_of_research.x) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Subject", "Study group", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation (exclusion criterion)", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "n"), caption = "Descriptive statistics acAN-TP1, acAN-TP2 and recAN: Current (past 2 weeks) and recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "", "Current medication"=7, "Recent medication"=7, "Current medication: number of participants per study group"), align="l")
```

## Descriptive statistics  
```{r descriptives01, results="asis", message=FALSE, warning=FALSE}
# Descriptive statistics of final study sample
descriptives_all <- sample %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  left_join(redcap_total, by=c("storage_name")) %>% 
  left_join(descriptives_acAN, by="id") %>% 
  mutate(across(contains("delta"), ~ifelse(point_of_research.x %in% "T2", ., NA))) %>%
  mutate(edi_core = (resultquest_edi2_ss + resultquest_edi2_uk + resultquest_edi2_b)/3)%>%
  dplyr::select(storage_name, participant_id.x, id, point_of_research.x, por, everything())

#exclude duplicates
descriptives_all <- descriptives_all %>%
  group_by(point_of_research.x)%>%
  distinct(id, .keep_all=TRUE)

descriptives_all %>%
  get_summary_stats(delta_dates, delta_bmi) %>%
    mutate(variable.labelled = labeller.desc(variable)) %>%
  dplyr::select(variable.labelled, n, mean, sd, min, max) %>%
  knitr::kable(format = "html", align = "l", digits=0, col.names = c("Variable", "n", "mean", "SD", "min", "max"),
               caption = "Duration of inpatient treatment (Date TP2 - Date TP1) and % BMI increase in acAN patients (TP2 - TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") 
  
# Prepare descriptive table
descriptives <- descriptives_all %>%
  group_by(point_of_research.x) %>%
  rstatix::get_summary_stats(age_at_date_of_research.x, iq,
                             bmi_at_date_of_research.x,
                             bmisds_at_date_of_research.x, 
                             minbmi, 
                             e_tiv, 
                             subcort_gray,
                             delta_age, 
                             delta_bmi,
                             delta_bmisds,
                             delta_e_tiv,
                             delta_subcort_gray,
                             delta_total_gray,
                             delta_leptin,
                             delta_resultquest_bdi2_total,
                             delta_resultquest_scl90r_skazwang,
                             delta_edi_core,
                             delta_edi_ss,
                             delta_edi_uk,
                             delta_edi_iw,
                             resultquest_bdi2_total,
                             resultquest_edi2_ss,
                             resultquest_edi2_uk,
                             resultquest_edi2_iw,
                             resultquest_scl90r_skazwang,
                             research_blood_results_leptin.x,
                             edi_core) %>%
  dplyr::select(point_of_research.x, variable, n, mean, sd) %>%
  ungroup() %>%
  mutate(variable = order.desc(variable)) %>%
  arrange(variable) %>% 
  mutate(variable = as.character(variable)) %>%
  mutate(mean = ifelse((variable %in% c("e_tiv", "subcort_gray")) | (variable %in% c("delta_e_tiv", 
                                                                                     "delta_subcort_gray")),
                         formatC(mean, format="f", big.mark=",", digits=0),
                         formatC(mean, format="f", digits=2))) %>%
  mutate(sd = ifelse((variable %in% c("e_tiv", "subcort_gray")) | (variable %in% c("delta_e_tiv", "delta_subcort_gray")),
                         formatC(sd, format="f", big.mark=",", digits=0),
                         formatC(sd, format="f", digits=2)))
  
descriptives_T1 <- descriptives %>% filter(point_of_research.x %in% "T1") %>%
  mutate(n_T1 = n) %>%
  unite("mean_sd_T1", c(mean, sd), sep = " ± ", remove = FALSE, na.rm = FALSE) %>%
  dplyr::select(variable, n_T1, mean_sd_T1)
  
descriptives_T2 <- descriptives %>% filter(point_of_research.x %in% "T2") %>%
  filter(str_detect(variable, "delta", negate=TRUE)) %>%
  mutate(n_T2 = n) %>%
  unite("mean_sd_T2", c(mean, sd), sep = " ± ", remove = FALSE, na.rm = FALSE) %>%
  dplyr::select(variable, n_T2, mean_sd_T2)

descriptives_delta <- descriptives %>% filter(point_of_research.x %in% "T2") %>%
  filter(str_detect(variable, "delta")) %>%
  unite("mean_sd_delta", c(mean, sd), sep = " ± ", remove = FALSE, na.rm = FALSE) %>%
  mutate(variable = dplyr::recode(variable,
                                  "delta_age" = "age_at_date_of_research.x",
                                  "delta_bmi" = "bmi_at_date_of_research.x",
                                  "delta_bmisds" = "bmisds_at_date_of_research.x",
                                  "delta_subcort_gray" = "subcort_gray",
                                  "delta_e_tiv" = "e_tiv",
                                  "delta_leptin" = "research_blood_results_leptin.x",
                                  "delta_resultquest_bdi2_total" ="resultquest_bdi2_total",
                                  "delta_resultquest_scl90r_skazwang"= "resultquest_scl90r_skazwang",
                                  "delta_edi_core"="edi_core",
                                  "delta_edi_ss"= "resultquest_edi2_ss",
                                  "delta_edi_uk"= "resultquest_edi2_uk",
                                  "delta_edi_iw"="resultquest_edi2_iw")) %>%
  dplyr::select(variable, mean_sd_delta)

descriptives_recAN <- descriptives %>% filter(point_of_research.x %in% "recAN") %>%
  mutate(n_recAN = n) %>%
  unite("mean_sd_recAN", c(mean, sd), sep = " ± ", remove = FALSE, na.rm = FALSE) %>%
  dplyr::select(variable, n_recAN, mean_sd_recAN)

descriptives_HC <- descriptives %>% filter(point_of_research.x %in% "HCW") %>%
  mutate(n_HC = n) %>%
  unite("mean_sd_HC", c(mean, sd), sep = " ± ", remove = FALSE, na.rm = FALSE) %>%
  dplyr::select(variable, n_HC, mean_sd_HC)

descriptives_joined <- descriptives_T1 %>%
  full_join(descriptives_T2, by="variable") %>%
  full_join(descriptives_delta, by="variable") %>%
  full_join(descriptives_recAN, by="variable") %>%
  full_join(descriptives_HC, by="variable") %>%
  mutate(variable.labelled = labeller.desc(variable)) %>%
  mutate(variables_group = dplyr::recode(variable, !!!variables_grouper.desc, 
                                       .default = "missing group"))

descriptives_joined %>%
  dplyr::select(variable.labelled, n_T1, mean_sd_T1, n_T2, mean_sd_T2, mean_sd_delta, n_recAN, mean_sd_recAN, n_HC, mean_sd_HC) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Variable", rep(c("n", "mean ± SD"), 2), "88 ± 28 days", rep(c("n", "mean ± SD"), 2)),
               caption = "Descriptive table of the current study sample") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "acAN-TP1"=2, "acAN-TP2"=2, "acAN-TP2 - acAN-TP1"=1, "recAN"=2, "HC"=2), align="l") %>%
  add_header_above(c("", "Acute AN sample at two observation time points"=4, "Change in %"=1, "Control samples"=4), align="l") %>%
  pack_rows(index = table(fct_inorder(descriptives_joined$variables_group)))
```

##ANOVAs (mixed ANOVAs)
```{r anovas, results="asis", message=FALSE, warning=FALSE}
options(contrasts = c("contr.sum", "contr.poly")) # needed for type III SS tests (ANOVA, does not change Type I or II SS results)

asterisk_function <- function(x) { # for tables in HTML output
  ifelse(is.na(x), NA, 
  symnum(x, 
         cutpoints = c(0, 0.001, 0.01, 0.05, 1), 
         symbols = c("(* * *)", "(* *)", "(*)", "(ns)")))
  }

asterisk_function_fig <- function(x) { # for figures
  ifelse(is.na(x), NA, 
  symnum(x, 
         cutpoints = c(0, 0.001, 0.01, 0.05, 1), 
         symbols = c("* * *", "* *", "*", "ns")))
  }

anovas.prep <- descriptives_all %>%
  dplyr::select(participant_id.x, por, point_of_research.x, age_at_date_of_research.x, iq, bmi_at_date_of_research.x,
                 bmisds_at_date_of_research.x,
                 minbmi, research_blood_results_leptin.x, e_tiv, subcort_gray, resultquest_bdi2_total, edi_core,
                 resultquest_scl90r_skazwang, resultquest_edi2_ss, resultquest_edi2_uk, resultquest_edi2_iw) %>%
  pivot_longer(-c(participant_id.x, por, point_of_research.x), names_to = "variable", values_to = "value") %>%
  mutate(value = ifelse(is.nan(value), NA, value)) %>% # consistent formatting of "NA"s
  mutate(tp = as.factor(ifelse(point_of_research.x %in% c("recAN", "HCW"), "T1", as.character(point_of_research.x)))) %>%
  dplyr::select(-point_of_research.x)

anovas.filter <- anovas.prep %>% # IQ, Min BMI and trait anxiety are not assessed at acAN-TP2 (TP2 contains "NA" and has to be removed from data.frame for these variables)
  dplyr::filter((variable %in% c("iq", "minbmi", "e_tiv", "resultquest_scl90r_skazwang") & (tp %in% "T2")))

# One-way ANOVAs for IQ, min BMI, eTIV and trait anxiety
## Prepare contrast setting (assignment of positive vs. negative weights does not matter!, see https://aosmith.rbind.io/2019/04/15/custom-contrasts-emmeans/)
acAN = c(1, 0, 0)
recAN = c(0, 0, 1)
HC = c(0, 1, 0)

anovas <- anti_join(anovas.prep, anovas.filter, by=c("participant_id.x", "por", "tp", "variable")) %>%
  filter(variable %in% c("iq", "minbmi", "e_tiv", "t.anxiety")) %>% filter (tp != "T2") %>% 
  nest(data = -variable) %>%
  mutate(
    lm = map(data, ~ lm(value ~ por, data = .x, na.action = na.omit)),
    anova = map(lm, ~ car::Anova(.x, type="III", test.statistic="F")),
    anova = map(anova, ~ rownames_to_column(.x, "term")), 
    emmeans = map(lm, ~ emmeans(.x, "por")),
    emmeanstidy = map(emmeans, tidy),
    contrasts = map(emmeans, ~ emmeans::contrast(.x, method = list("acAN vs. recAN" = acAN - recAN, # recAN - acAN would not change output
                                                                   "acAN vs. HC" = acAN - HC,
                                                                   "recAN vs. HC" = recAN - HC), adjust="fdr")),
    contraststidy = map(contrasts, tidy)) %>%
  dplyr::select(variable, anova, contraststidy)

# Mixed ANOVAs (LME4)
## Prepare contrast setting
acAN_TP1.m = c(1, 0, 0, 0, 0, 0) # "m" for mixed
acAN_TP2.m = c(0, 0, 0, 1, 0, 0)
recAN.m = c(0, 0, 1, 0, 0, 0)
HC.m = c(0, 1, 0, 0, 0, 0)

anovas.lme <- anovas.prep %>%
  filter(!variable %in% c("iq", "minbmi", "e_tiv", "t.anxiety")) %>%
  mutate(participant_id.x = as.factor(participant_id.x)) %>%
  nest(data = -variable) %>%
  mutate(
    lme = map(data, ~ lme4::lmer(value ~ 1 + por + tp + (1|participant_id.x), data=.x, REML = TRUE, 
                                 na.action = na.omit)),
    anova = map(data, ~ anova(lmerTest::lmer(value ~ 1 + por + tp + (1|participant_id.x), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova = map(anova, ~ rownames_to_column(.x, "term")),
    refgrid = map(lme, ~ emmeans::ref_grid(.x, lmer.df="satterthwaite") @ grid),
    emmeans = map(lme, ~ emmeans::emmeans(.x, c("por", "tp"), lmer.df = "satterthwaite", type="response")), # type "response" means that emmeans are not log-transformed (output on the expected/original scale)
    emmeanstidy = map(emmeans, tidy),
    contrasts = map(emmeans, ~ emmeans::contrast(.x, method = list( # only relevant contrasts for longi analyses (see thalamus nuclei LME contrasts)
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.m - acAN_TP1.m,
      "acAN-TP2 vs. recAN" = acAN_TP2.m - recAN.m,
      "acAN-TP2 vs. HC" = acAN_TP2.m - HC.m,
      "recAN vs. HC" = recAN.m - HC.m), lmer.df = "satterthwaite", adjust="fdr")),
    contraststidy = map(contrasts, tidy)) %>%
  dplyr::select(variable, anova, contraststidy) 


# Prepare ANOVA output
## DFs: The F test statistic is found by dividing the between group variance by the within group variance. The degrees of freedom for the numerator are the degrees of freedom for the between group (k-1) and the degrees of freedom for the denominator are the degrees of freedom for the within group (N-k). The denominator degrees of freedom is the bottom portion of the F distribution ratio and is often called the degrees of freedom error. You can calculate the denominator degrees of freedom by subtracting the number of sample groups from the total number of samples tested.

anovas.out <- anovas %>%
  dplyr::select(variable, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair = "universal") %>% # remove spaces in column names after analysis
  filter(term %in% c("por", "Residuals")) %>%
  group_by(variable) %>%
  mutate(Df = paste(Df, collapse=", ")) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(variable, Df, F.value, p.value)

anovas.lme.out <- anovas.lme %>%
  dplyr::select(variable, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair = "universal") %>% # remove spaces in column names after analysis
  filter(term %in% c("por", "tp")) %>%
  group_by(variable) %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  unite("Df", c(NumDF, DenDF), sep = ", ", remove = TRUE, na.rm = FALSE) %>%
  mutate(Df = paste(Df, collapse=" | ")) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(F.value = paste(F.value, collapse=" | ")) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.value = paste(p.value, collapse=" | ")) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(variable, Df, F.value, p.value)

anovas.combi.out <- rbind(anovas.lme.out, anovas.out) %>%
  mutate(variable = order.desc(variable)) %>%
  arrange(variable) %>% 
  mutate(variable = as.character(variable)) %>%
  mutate(variable.labelled = labeller.desc(variable)) %>%
  mutate(variables_group = dplyr::recode(variable, !!!variables_grouper.desc, 
                                       .default = "missing group"))

anovas.combi.out %>%
  dplyr::select(variable.labelled, F.value, Df, p.value) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Variable", "F(between-subjects) | F(within-subjects)", "df(between-subjects) | df(within-subjects)", "p(between-subjects) | p(within-subjects)"),
               caption = "Mixed ANOVAs for demographic, clinical, brain segmentation and symptom variables (denominator dfs via Satterthwaite approximation) (one-way ANOVAs for IQ, BMI(min) and trait anxiety)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  pack_rows(index = table(fct_inorder(anovas.combi.out$variables_group)))

# Prepare contrasts output
contrasts.out <- rbind(anovas.lme, anovas) %>%
  dplyr::select(variable, contraststidy) %>%
  unnest(contraststidy) %>%
  mutate(comparison = ifelse(estimate > 0, ">", "<")) %>%
  mutate(contrast_comparison = str_replace(contrast, "vs.", comparison)) %>%
  mutate(adj.p.value_formatted = formatC(adj.p.value, format="f", digits=3)) %>%
  mutate(adj.p.value_formatted = ifelse(adj.p.value < 0.001, "< 0.001", adj.p.value_formatted)) %>%
  mutate(variable = order.desc(variable)) %>%
  arrange(variable) %>% 
  mutate(variable = as.character(variable)) %>%
  mutate(variable.labelled = labeller.desc(variable)) %>%
  mutate(variables_group = dplyr::recode(variable, !!!variables_grouper.desc, 
                                       .default = "missing group"))

contrasts.out %>%
  dplyr::select(variable.labelled, term, contrast, adj.p.value_formatted) %>%
   knitr::kable(format = "html", align = "l", col.names = c("Variable", "Effects term", "Contrast (between study groups or within acAN study group)", "FDR-adjusted p-value"),
               caption = "Post-hoc contrasts after mixed ANOVAs / one-way ANOVAs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("FDR-adjustment for multiple comparisons was applied across all post-hoc contrasts (all pairwise comparisons) and separately for each variable."=4), align="l") %>% 
  pack_rows(index = table(fct_inorder(contrasts.out$variables_group)))
```

## Table with descriptive statistics  
```{r desctable, results="asis", message=FALSE, warning=FALSE}
desctable_contrasts <- contrasts.out %>%
  filter(adj.p.value < 0.05) %>% # only significant post-hoc contrasts
  mutate(brackets01 = " (p ") %>%
  mutate(brackets02 = ")") %>%
  dplyr::select(variable, contrast_comparison, brackets01, adj.p.value_formatted, brackets02) %>%
  group_by(variable) %>%
  unite("posthoc", c(contrast_comparison, brackets01, adj.p.value_formatted, brackets02), sep = "", 
        remove = FALSE, na.rm = FALSE) %>%
  dplyr::summarize(posthoc.paste = paste(posthoc, collapse=" | ")) %>%
  ungroup()

descriptives_joined %>%
  dplyr::select(-c(variable.labelled, variables_group)) %>%
  left_join(anovas.combi.out, by="variable") %>%
  left_join(desctable_contrasts, by="variable") %>%
  dplyr::select(variable.labelled, n_T1, mean_sd_T1, n_T2, mean_sd_T2, mean_sd_delta, n_recAN, 
                mean_sd_recAN, n_HC, mean_sd_HC, 
                F.value, Df, p.value, posthoc.paste) %>%
  mutate(posthoc.paste = ifelse(is.na(posthoc.paste), "", posthoc.paste)) %>%
  knitr::kable(format = "html", align = "l", col.names = c("Variable", rep(c("n", "mean ± SD"), 2), 
                                                           "88 ± 28 days", rep(c("n", "mean ± SD"), 2),
                                                           "F(between) | F(within)", 
                                                           "df(between) | df(within)", 
                                                           "p(between) | p(within)",
                                                           "Significant contrasts (FDR-adjusted) between 
                                                           study groups or within acAN at TP2 vs. TP1"),
               caption = "Table 1: Descriptive statistics of the current study sample") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "acAN-TP1"=2, "acAN-TP2"=2, "acAN-TP2 - acAN-TP1"=1, "recAN"=2, "HC"=2, " "=4), align="l") %>%
  add_header_above(c("", "Acute AN sample at two observation time points"=4, "Change"=1, "Control samples"=4, "Test statistics: Mixed ANOVAs (dfs via Satterthwaite approximation) and one-way ANOVAs (for IQ, BMImin, trait anxiety)"=3, "Post-hoc contrasts"), align="l") %>%
  pack_rows(index = table(fct_inorder(anovas.combi.out$variables_group))) #%>%
  #save_kable("figures/descriptives.png", zoom=6)
```

# Main longitudinal thalamus nuclei analysis
## Data distribution - Histograms with normal curves and raincloud plots
```{r histogramsettings, results='hide', message=FALSE, warning=FALSE}
plot_theme_transparent_histo = theme(plot.title = element_text(size=5, face="bold"), 
                   strip.text = element_text(size=5), 
                   strip.text.x = element_text(size=5),
                   axis.text.y = element_text(size=5),
                   axis.text.x = element_text(size=5),
                   axis.title = element_text(size=5), 
                   axis.line = element_line(color = "black"), 
                   panel.background = element_rect(fill="transparent"), 
                   plot.background = element_rect(fill="transparent", color=NA), 
                   panel.border = element_blank(),
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(), 
                   strip.background = element_rect(color=NA, fill="grey90"))

#color allocation:
#grey: acAN-T1 => #374E55FF
#orange: HC => #DF8F44FF
#blue: acAN-T2 => #00468BFF
#red: recAN => #800000FF
``` 

```{r figuresettings, results='hide', message=FALSE, warning=FALSE}
plot_theme_transparent = theme(plot.title = element_text(size=5, face="bold"), 
                 strip.text = element_text(size=5), 
                   strip.text.x = element_text(size=5),
                   axis.text.y = element_text(size=5),
                   axis.text.x = element_text(size=5),
                   axis.title = element_text(size=5), 
                   axis.line = element_line(color = "black"), 
                   panel.background = element_rect(fill="transparent"), 
                   plot.background = element_rect(fill="transparent", color=NA), 
                   panel.border = element_blank(),
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(), 
                   strip.background = element_rect(color=NA, fill="grey90"))
``` 

```{r histograms01, fig.cap="Histograms with normal curves for thalamus (nuclei) volumes in acAN at TP1 and TP2", message=FALSE, warning=FALSE}
histos <- sample  %>%
  filter(por %in% "acAN") %>%
  arrange(hemi_region) %>%
  mutate(point_of_research = dplyr::recode(point_of_research,
                                    "T1" = "acAN-TP1",
                                    "T2" = "acAN-TP2"))

plotlist = list()

bins <- 25

for (Hemi_Region in unique(histos$hemi_region)) {
  
  histdata <- histos %>% filter(hemi_region %in% Hemi_Region)
  
  bw <- histdata %>% # individual binwidths per plot depending on the measure range
    dplyr::summarize(bw = (max(measure) - min(measure))/bins) %>%
    pull(bw)
  
  mean_sd_T1 <- histdata %>% filter(point_of_research %in% "acAN-TP1") 
  
  mean_sd_T2 <- histdata %>% filter(point_of_research %in% "acAN-TP2") 
  
  thalhist <- histdata %>%
    ggplot(aes(x=measure, group=point_of_research, fill=point_of_research)) +
    geom_histogram(aes(group=point_of_research, y=..count..), binwidth=bw, alpha=0.7, position="identity") +
    stat_function(color="#374E55FF", size=2.5, alpha=1, fun = function(x, mean, sd, n, bw)
      {bw * n * dnorm(x = x, mean = mean, sd = sd)},
                  args=with(mean_sd_T1, c(mean = mean(measure), sd = sd(measure), n = length(measure), bw=bw))) +
    stat_function(color="#00468BFF", size=2.5, alpha=1, fun = function(x, mean, sd, n, bw)
      {bw * n * dnorm(x = x, mean = mean, sd = sd)},
                  args=with(mean_sd_T2, c(mean = mean(measure), sd = sd(measure), n = length(measure), bw=bw))) +
    scale_x_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    scale_y_continuous(breaks=seq(0,20,5)) +
    scale_fill_manual(values = c("#374E55FF", "#00468BFF", "#000000")) + 
    scale_color_manual(values = c("#374E55FF", "#00468BFF", "#000000")) + 
    plot_theme_transparent_histo +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks.y = 
            element_line(size=1), axis.ticks.x = element_line(size=1), 
          axis.ticks.length.y=unit(.25, "cm"), axis.ticks.length.x=unit(.2, "cm")) +
    theme(legend.position = "none") +
    facet_wrap(~ labeller, labeller = label_wrap_gen(width=10))
  
 plotlist[[Hemi_Region]] = thalhist
 }

histo.whole.lh <- plotlist$lh_Whole_thal
histo.whole.rh <- plotlist$rh_Whole_thal
histos.nuclei <- plotlist[3:25] 

histoarrange_T1_T2 <- ggarrange(histo.whole.lh, histo.whole.rh,
                          ggarrange(plotlist=histos.nuclei, ncol=5, nrow=5),
                          ncol=3, widths=c(1,1,4)) %>%
  annotate_figure(bottom = text_grob(expression(paste("Volumes (raw) in mm"^"3")),
                                     size=28),
                left = text_grob("Counts", size=28, rot=90),
                right = text_grob("", size=8, rot=270),
                top = text_grob("Histograms: Thalamus volume distribution in acAN at TP1 and TP2", 
                                size=28, rot=0))

histoarrange_T1_T2

#ggsave(histoarrange_T1_T2, path="figures", filename="histograms_thal_T1_T2.png", width=30, height=20, dpi=600)
```

```{r histograms02, fig.cap="Histograms with normal curves for thalamus (nuclei) volumes in recAN", message=FALSE, warning=FALSE}
histos <- sample  %>%
  filter(por %in% "recAN") %>%
  arrange(hemi_region)

plotlist = list()

bins <- 25

for (Hemi_Region in unique(histos$hemi_region)) {
  
  histdata <- histos %>% filter(hemi_region %in% Hemi_Region)
  
  bw <- histdata %>%
    dplyr::summarize(bw = (max(measure) - min(measure))/bins) %>%
    pull(bw)
  
  mean_sd_recAN <- histdata %>% filter(point_of_research %in% "recAN")
  
  thalhist <- histdata %>%
    ggplot(aes(x=measure, group=point_of_research, fill=point_of_research)) +
    geom_histogram(aes(group=point_of_research, y=..count..), binwidth=bw, alpha=0.7, position="identity") +
    stat_function(color="#800000FF", size=2.5, alpha=1, fun = function(x, mean, sd, n, bw){bw * n * dnorm(x = x, 
                                                                                            mean = mean, sd = sd)},
                  args=with(mean_sd_recAN, c(mean = mean(measure), sd = sd(measure), n = length(measure), bw=bw))) +
    scale_x_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    scale_y_continuous(breaks=seq(0,20,5)) +
    scale_fill_manual(values = c("#800000FF", "#000000")) + 
    scale_color_manual(values = c("#800000FF", "#000000")) + 
    plot_theme_transparent_histo +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
          axis.ticks.y = element_line(size=1), axis.ticks.x = element_line(size=1), 
          axis.ticks.length.y=unit(.25, "cm"), axis.ticks.length.x=unit(.25, "cm")) +
    theme(legend.position = "none") +
    facet_wrap(~ labeller, labeller = label_wrap_gen(width=8))
  
 plotlist[[Hemi_Region]] = thalhist
 }

histo.whole.lh <- plotlist$lh_Whole_thal
histo.whole.rh <- plotlist$rh_Whole_thal
histos.nuclei <- plotlist[3:25] 

histoarrange_recAN <- ggarrange(histo.whole.lh, histo.whole.rh,
                          ggarrange(plotlist=histos.nuclei, ncol=5, nrow=5),
                          ncol=4, widths=c(1,1,4)) %>%
  annotate_figure(bottom = text_grob(expression(paste("Volumes (raw) in mm"^"3")),
                                     size=28),
                left = text_grob("Counts", size=28, rot=90),
                right = text_grob("", size=12, rot=270),
                top = text_grob("Histograms: Thalamus volume distribution in recAN",
                                size=28, rot=0))

histoarrange_recAN

#ggsave(histoarrange_recAN, path="figures", filename="histograms_thal_recAN.png", width=30, height=20, dpi=600)
```

```{r histograms03, fig.cap="Histograms with normal curves for thalamus (nuclei) volumes in HC", message=FALSE, warning=FALSE}
histos <- sample  %>%
  filter(por %in% "HCW") %>%
  arrange(hemi_region) %>%
  mutate(point_of_research = dplyr::recode(point_of_research,
                                    "HCW" = "HC"))

plotlist = list()

bins <- 25

for (Hemi_Region in unique(histos$hemi_region)) {
  
  histdata <- histos %>% filter(hemi_region %in% Hemi_Region)
  
  bw <- histdata %>%
    dplyr::summarize(bw = (max(measure) - min(measure))/bins) %>%
    pull(bw)
  
  mean_sd_HC <- histdata %>% filter(point_of_research %in% "HC")
  
  thalhist <- histdata %>%
    ggplot(aes(x=measure, group=point_of_research, fill=point_of_research)) +
    geom_histogram(aes(group=point_of_research, y=..count..), binwidth=bw, alpha=0.7, position="identity") +
    stat_function(color="#DF8F44FF", size=2.5, alpha=1, fun = function(x, mean, sd, n, bw){bw * n * dnorm(x = x, 
                                                                                            mean = mean, sd = sd)},
                  args=with(mean_sd_HC, c(mean = mean(measure), sd = sd(measure), n = length(measure), bw=bw))) +
    scale_x_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    scale_y_continuous(breaks=seq(0,50,10)) +
    scale_fill_manual(values = c("#DF8F44FF", "#000000")) + 
    scale_color_manual(values = c("#DF8F44FF", "#000000")) + 
    plot_theme_transparent_histo +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks.y = 
            element_line(size=1.5), axis.ticks.x = element_line(size=1.5), 
          axis.ticks.length.y=unit(.25, "cm"), axis.ticks.length.x=unit(.25, "cm")) +
    theme(legend.position = "none") +
    facet_wrap(~ labeller, labeller = label_wrap_gen(width=15))
  
 plotlist[[Hemi_Region]] = thalhist
 }

histo.whole.lh <- plotlist$lh_Whole_thal
histo.whole.rh <- plotlist$rh_Whole_thal
histos.nuclei <- plotlist[3:25] 

histoarrange_HC <- ggarrange(histo.whole.lh, histo.whole.rh,
                          ggarrange(plotlist=histos.nuclei, ncol=5, nrow=5),
                          ncol=3, widths=c(1,1,4))%>%
  annotate_figure(bottom = text_grob(expression(paste("Volumes (raw) in mm"^"3")),
                                     size=28),
                left = text_grob("Counts", size=28, rot=90),
                right = text_grob("", size=10, rot=270),
                top = text_grob("Histograms: Thalamus volume distribution in HC", size=28, rot=0))

histoarrange_HC

#ggsave(histoarrange_HC, path="figures", filename="histograms_thal_HC.png", width=30, height=20, dpi=600)
```

## Raincloud plots (raw data, data distribution - boxplots, probability density - violin plots)  
```{r raincloud, fig.cap="Raincloud plots for thalamus (nuclei) volumes (hemispheres separately) in all study groups", message=FALSE, warning=FALSE}
rcdata <- sample %>%
  arrange(region) %>%
  mutate(point_of_research = dplyr::recode(point_of_research,
                                    "T1" = "acAN-TP1",
                                    "T2" = "acAN-TP2",
                                    "recAN" = "recAN",
                                    "HCW" = "HC")) %>%
  mutate(xlabels = ifelse(region %in% "Whole_thal", TRUE, FALSE))

plotlist = list()

for (Region in unique(rcdata$region)) {
  
  plotdata <- rcdata %>% filter(region %in% Region)

  rainclouds <- plotdata %>%
    ggplot(aes(x = point_of_research, y = measure, fill = point_of_research, color = point_of_research)) +
    geom_flat_violin(position = position_nudge(x = 0.2, y = 0), adjust = 0.8, trim = FALSE, alpha=0.7, color=NA) +
    geom_point(aes(x = as.numeric(point_of_research) - 0.1, y=measure),
               position = position_jitter(width = 0.15), size = 0.9) +
    stat_boxplot(aes(x = as.numeric(point_of_research) + 0.2, y = measure), geom="errorbar",
               width=0.2, size=0.9, position=position_dodge(1), color = "BLACK", alpha=0.9) +
    geom_boxplot(aes(x = as.numeric(point_of_research) + 0.2, y = measure), outlier.shape=NA,
               width = 0.2, position=position_dodge(1), color = "BLACK", alpha=0.9, size=1.2, fatten=1.35) +
    plot_theme_transparent + 
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#800000FF", "#DF8F44FF", "#000000"), 1)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#800000FF", "#DF8F44FF", "#000000"), 1)) + 
    scale_x_discrete(labels = c("acAN-TP1" = "acAN-TP1", "acAN-TP2" = "acAN-TP2", "recAN" = "recAN", "HC" = "HC")) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    theme(axis.text.x = element_text(size = 28, angle=45, hjust=1), axis.ticks.y = 
            element_line(size=1.5), axis.ticks.x = element_line(size=1.5), 
          axis.ticks.length.y=unit(.25, "cm"), axis.ticks.length.x=unit(.25, "cm")) +
    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15))
  
  if(plotdata$xlabels == FALSE) {
   rainclouds = rainclouds + 
     theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
   }
  
 plotlist[[Region]] = rainclouds
 
}

rc.whole <- plotlist$Whole_thal
rc.nuclei <- plotlist[2:25] 

raincloudarrange <- ggarrange(rc.whole, 
          ggarrange(plotlist=rc.nuclei, ncol=5, nrow=5),
          ncol=2, widths=c(1,2.5)) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (raw) in mm"^"3")), size=28, rot=90))

raincloudarrange

#ggsave(raincloudarrange, path="figures", filename="raincloud_thal.png", width=30, height=20, dpi=600)
```

## LME model (linear mixed effects model) implementation
**Main LME model => primary objectives:** 1) differences in thalamus nuclei volumes between acAN-TP1 and acAN-TP2 as a linear function of changes (i.e., increase) in BMI-SDS (Does increasing BMI-SDS predict changes in thalamus (nuclei) volumes from acAN-TP1 to acAN-TP2?); 2) differences between acAN-TP2 (at short-term weight-restored follow-up) and HC (i.e., relative normalization of thalamus nuclei volumes after short-term weight-restoration or persisting differences?) + between acAN-TP2 and recAN; 3) thalamus nuclei volumes after long-term weight-recovery (recAN) compared to HC (relatively normalized?).  
Bernardoni et al. (2016): "To assess the relative speed and completeness of changes in CT in AN resulting from weight restoration, our sample also included single time point data from 34 recAN (all from our previous study)  and 75 HC participants (69 from our previous study)."  
**Supplementary modified LME model => objective:** reproduce cross-sectional comparison of acAN-TP1 and HC using a larger acAN-TP1 sample (all available subjects, i.e., also those without TP2 assessment) and an independent statistical approach (LME model in this paper vs. age-matching + GLM in cross-sectional paper).  

**Model specifications:** 
*General:*  
LME model using packages lme4 and lmerTest;  
REML = restricted maximum likelihood, method for estimating variance components in models with random effects;  
Type III anova table with p-values for F-tests based on Satterthwaite's method (denominator degrees of freedom approximation method) (Luke et al., 2017 => In sum, the results of these simulations suggest that Type I error rates are most optimal across different sample sizes when models are fitted using REML and p-values are derived using the Kenward-Roger or Satterthwaite approximations.);  
Reference grid = basis for estimated marginal means / adjusted means and post-hoc contrasts (reference grid consists of combinations of independent variables over which predictions are made, default reference grid is determined by the observed levels of any factors, the ordered unique values of character-valued predictors, and the results of "cov.reduce" for numeric predictors ("cov.reduce" and "cov.keep" may be overridden using "at"));  
Details on post-hoc emmeans and contrasts: factorial predictor (point of research, emmeans for all factor levels, i.e., acAN / recAN / HC) and numeric / continuous predictor (delta BMI-SDS: will be reduced to its overall mean by default (i.e., covariates are averaged by default) => reference grid has to be adapted so that emmeans (adjusted means) are computed separately over levels 0 (no BMI-SDS change as in acAN-TP2, recAN and HC) and the mean BMI-SDS change in acAN during treatment (acAN-TP2 vs. acAN-TP1)). *Note that emmeans are computed for acAN-TP2 as well as acAN-TP1 + recAN + HC in order to produce graphical output (figures for paper). Post-hoc contrasts are computed for acAN-TP2 vs. recAN, acAN-TP2 vs. HC, recAN vs. HC as well as acAN-TP2 vs. acAN-TP1. The latter contrast acAN-TP2 vs. acAN-TP1 could also be retrieved directly from the lmer ANOVA output - predictor "delta.bmisds.T1_minus_T2", since BMI-SDS change is the main difference between AN patients at TP1 and TP2.*  

*Dependent variable:* individual whole thalamus and thalamus nuclei volumes (lh, rh separately).  

*Independent variables (fixed effects):*  
* study groups (acAN, recAN, HC);  
* delta BMI-SDS (TP1 - TP2, i.e., delta BMI-SDS = 0 at acAN-TP2) representing the increase in BMI-SDS between baseline (acAN-TP1) and follow-up (acAN-TP2) (TP1 - TP2 is chosen for main analyses due to focus on acAN-TP2 - i.e., longitudinal comparisons to acAN-TP1, HC and recAN; see SM analyses for TP2 - TP1 with complete acAN-TP1 sample);  
* age.meandiff refers to mean-subtracted age of the participant at the time of scan (computed relative to entire sample mean age);  
* etiv.meandiff refers to mean-substracted head size (estimated total intracranial volume) (computed relative to entire sample mean eTIV);  
* linear effects of BMI-SDS and age are assumed (cf. Bernardoni et al. (2016) for testing of alternative models which were no better fit);  
* no age-matching applied for our LME model, since (1) HC were already recruited to match acAN and recAN samples for age, and (2) age.meandiff was introduced as a covariate in our LME model;  
* follow-up relative approach (thalamus nuclei in relation to whole thalamus and total subcortical gray matter volume, cf. relative approach in cross-sectional thalamus nuclei paper): wholethal.meandiff and subcortgm.meandiff refer to mean-substracted whole thalamus volume and mean-substracted subcortical gray matter volume (computed relative to entire sample mean);  
* grand mean centering is applied to age, eTIV and whole thalamus and subcortical GM volume (mean centering using overall or full sample mean, makes interpretation of intercept more reasonable (e.g., intercept at mean age instead of zero age), makes sense in multilevel regression (... whereas rescaling via linear transformation (= mean centering) has no effect in OLS regression!, see cross-sectional thalamus nuclei paper where mean centering was not applied)).  

*Random effects:*  
* Random intercept only model: 1 | participant_id.  

**Follow-up or Supplementary analyses:**  
* Further fixed effects are added (to main age- and eTIV-adjusted LME model): duration of illness (... delta BMI-SDS interaction), change in leptin concentration, changes in psychiatric symptoms (separately: BDI-II, EDI-2 core, SCL-90-R GSI, state anxiety). Alternative approach: psychiatric symptoms as dependent variables (research question: Does potential normalization of thalamus nuclei volumes with weight-restoration in AN (predictor) affect psychiatric symptom levels (dependent)?) => but would entail conceptualization of several new models and, besides, findings of main LME with added fixed effects can also be interpreted as relationships between changes in symptoms (added fixed factors) and thalamus volumes (dependent variable).  
* Modify delta BMI-SDS term from TP1 - TP2 to TP2 - TP1 in order to include further acAN-TP1 patients (i.e., also those without TP2 assessment) and compare their thalamus nuclei volumes to HC via modified main LME model (absolute age- and eTIV-adjusted model) => reproduce cross-sectional paper findings = acAN-TP1 vs. HC (<- age-matching + GLMs) but using a different/independent statistical approach;  
* Reproduce main LME model (absolute age- and eTIV-adjusted model) via simple paired analysis (acAN-TP2 vs. acAN-TP1) as well as eTIV-adjusted GLMs with age-matched samples (acAN-TP2 vs. HC, potentially recAN vs. HC);  
* Robust linear regression analyses (RLMs) for clinical measures / psychopathology if thalamus nuclei in acAN-TP2 and recAN are still significantly different from HC.  

**Why use LME?**  
* Simple paired analysis less precise than LME (does not account for variability in BMI-SDS change during renutrition and does not include further covariates);  
* Only LME allows simultaneous testing/comparisons with reference groups (acAN-TP2 vs. recAN and acAN-TP2 vs. HC) within one model.  
* Speed of thalamus (nuclei) volume changes as a function of BMI-SDS increase can be analyzed in addition to group differences.  

## Leptin below LOD
```{r leptinimpute, results="asis", message=FALSE, warning=FALSE}
sample %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  dplyr::select(storage_name, point_of_research, research_blood_results_leptin, leptin2021) %>%
  filter(!is.na(research_blood_results_leptin)) %>%
  group_by(point_of_research) %>%
  mutate(n_available=n()) %>%
  ungroup() %>% 
  group_by(point_of_research, leptin2021) %>%
  mutate(n_batch=n()) %>%
  mutate(n_below_0.05=sum(research_blood_results_leptin<0.05, na.rm=T)) %>%
  mutate(n_below_0.20=sum(research_blood_results_leptin<0.20, na.rm=T)) %>% 
  mutate(n_below_0.05=ifelse(leptin2021==TRUE, NA, n_below_0.05)) %>%  
  distinct(n_available, .keep_all=TRUE) %>% 
  dplyr::select(n_available, n_batch, n_below_0.20, n_below_0.05) %>% 
  arrange(point_of_research) %>% 
  knitr::kable(format="html", align="l", 
               col.names=c("Study group", "Batch 2021?", 
                             "n(leptin available)", "n(per batch)", 
                             "n(leptin<0.20µg/L) including also leptin<0.05µg/L",
                             "n(leptin<0.05µg/L)"),
               caption="Leptin values <LOD") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10")
```

```{r lmedata, results="hide", message=FALSE, warning=FALSE}
# Custom contrast setting for LME (based on reference grid)
acAN_TP1.lme = c(0, 0, 0, 1, 0, 0)
acAN_TP2.lme = c(1, 0, 0, 0, 0, 0)
recAN.lme = c(0, 0, 1, 0, 0, 0)
HC.lme = c(0, 1, 0, 0, 0, 0)

#redcap sample prep
redcap_analysis <- redcap_total %>%
    mutate(edi_core = (resultquest_edi2_ss + resultquest_edi2_uk + resultquest_edi2_b)/3)%>%
    dplyr::select(storage_name, onset_of_an, recovered_since_months, resultquest_bdi2_total, edi_core, resultquest_scl90r_skagloba, resultquest_scl90r_skazwang, clinical_blood_results_leptin)
  

# Prepare data for all LME modifications
lmedata <- sample %>%
  filter(region %in% "Whole_thalamus") %>% # introduce "whole thalamus" as a new variable/column
  dplyr::select(storage_name, hemi, measure) %>%
  rename(whole_thalamus = measure) %>%
  right_join(sample, by=c("storage_name", "hemi")) %>%
  left_join(redcap_analysis, by="storage_name") %>% 
        transform(., research_blood_results_leptin = ifelse(!is.na(research_blood_results_leptin), research_blood_results_leptin, clinical_blood_results_leptin))%>%
  dplyr::select(storage_name, participant_id, por, point_of_research, hemi_region, labeller, region, 
                whole.sub, measure, bmisds_at_date_of_research, age_at_date_of_research, e_tiv, whole_thalamus,
                subcort_gray, onset_of_an, recovered_since_months, research_blood_results_leptin, 
                resultquest_bdi2_total, edi_core, resultquest_scl90r_skagloba, resultquest_scl90r_skazwang) %>%
  mutate(across(.cols=onset_of_an:resultquest_scl90r_skagloba, ~ ifelse(is.nan(.x), NA, .x))) %>% # consistent formatting of "NA"s
  group_by(hemi_region) %>% # each participant (i.e., entire sample) occurs once per hemi_region in long data format; means of entire sample are regarded for mean subtraction
  mutate(age.meandiff = age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE)) %>%
  mutate(etiv.meandiff = e_tiv - mean(e_tiv, na.rm=TRUE)) %>%
  mutate(wholethal.meandiff = whole_thalamus - mean(whole_thalamus, na.rm=TRUE)) %>%
  mutate(subcortgm.meandiff = subcort_gray - mean(subcort_gray, na.rm=TRUE)) %>%
  mutate(doi = ifelse(point_of_research %in% "T1", onset_of_an, 0)) %>% # Duration of illness
  ungroup() %>%
  group_by(participant_id, hemi_region) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                              bmisds_at_date_of_research - lead(bmisds_at_date_of_research), 
                              0)) %>% # delta = T1 - T2
  mutate(delta.leptin.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                              research_blood_results_leptin - lead(research_blood_results_leptin), 
                              0)) %>%
  mutate(delta.bdi.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                              resultquest_bdi2_total - lead(resultquest_bdi2_total), 
                              0)) %>%
  mutate(delta.edicore.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                             edi_core - lead(edi_core), 
                              0)) %>%
  mutate(delta.sclgsi.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                             resultquest_scl90r_skagloba - lead(resultquest_scl90r_skagloba), 
                              0)) %>%
  mutate(delta.sclzwang.T1_minus_T2 = ifelse(point_of_research %in% "T1", 
                             resultquest_scl90r_skazwang - lead(resultquest_scl90r_skazwang), 
                              0)) %>%
  ungroup() %>%
  mutate(delta.bmisds.mean.T1_minus_T2 = 
           mean(delta.bmisds.T1_minus_T2[delta.bmisds.T1_minus_T2!=0], na.rm=TRUE)) %>%
  mutate(participant_id = as.factor(participant_id)) %>%
  mutate(point_of_research = as.factor(point_of_research)) 

delta.bmisds.mean.T1_minus_T2 <- unique(lmedata$delta.bmisds.mean.T1_minus_T2)
```

```{r lme1, results="hide", message=FALSE, warning=FALSE}
# Main LME model and modified LME model versions
lme <- lmedata %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, labeller, region, whole.sub)) %>%
  mutate(
    # Main or basic LME model with age and eTIV adjustment
    lme = map(data, ~ lme4::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff + etiv.meandiff +
                                   (1|participant_id), data = .x, REML = TRUE, na.action = na.omit)),
    lmetidy = map(lme, tidy),
    anova = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff + 
                                               etiv.meandiff + (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova = map(anova, ~ rownames_to_column(.x, "term")),
    refgrid = map(lme, ~ emmeans::ref_grid(.x, cov.keep=2, 
                                           at = list(delta.bmisds.T1_minus_T2 = 
                                                       c(0, delta.bmisds.mean.T1_minus_T2)), 
                                           lmer.df = "satterthwaite") @ grid),
    emmeans = map(lme, ~ emmeans::emmeans(.x, c("por", "delta.bmisds.T1_minus_T2"), cov.keep=2, 
                                           at = list(delta.bmisds.T1_minus_T2 = 
                                                       c(0, delta.bmisds.mean.T1_minus_T2)), 
                                          lmer.df = "satterthwaite", type="response")),
    emmeanstidy = map(emmeans, tidy), # Emmeans are calculated for plotting, note that emmeans for HC or recaN with BMI-SDS change do not actually exist; simple emmeans plotting via emmip(model, formula, cov.reduce = ...)
    contrasts = map(emmeans, ~ emmeans::contrast(.x, method = list(
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.lme - acAN_TP1.lme,
      "acAN-TP2 vs. recAN" = acAN_TP2.lme - recAN.lme,
      "acAN-TP2 vs. HC" = acAN_TP2.lme - HC.lme,
      "recAN vs. HC" = recAN.lme - HC.lme), lmer.df = "satterthwaite", adjust="none")), # FDR adjustment later across all post-hoc contrasts and hemi_regions
    contraststidy = map(contrasts, tidy),
    SDtable = map(lme, ~ as.tibble(lme4::VarCorr(.x))), # for effect size statistics (see SM)
    SDtotal = map_dbl(SDtable, ~ sqrt((.x$sdcor[.x$grp=="participant_id"]^2) + (.x$sdcor[.x$grp=="Residual"]^2))), # map_dbl = return number, not list
    # Follow-up relative approach 1: Basic LME model with eTIV and whole thalamus
    lme_wholethal = map(data, ~ lme4::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff +
                                            etiv.meandiff + wholethal.meandiff + (1|participant_id),
                                       data = .x, REML = TRUE, na.action = na.omit)),
    anova_wholethal = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff + 
                                               etiv.meandiff + wholethal.meandiff + (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_wholethal = map(anova_wholethal, ~ rownames_to_column(.x, "term")),
    emmeans_wholethal = map(lme_wholethal, ~ emmeans::emmeans(.x, c("por", "delta.bmisds.T1_minus_T2"), cov.keep=2, 
                                           at = list(delta.bmisds.T1_minus_T2 = 
                                                       c(0, delta.bmisds.mean.T1_minus_T2)), 
                                           lmer.df = "satterthwaite", type="response")),
    emmeanstidy_wholethal = map(emmeans_wholethal, tidy), 
    contrasts_wholethal = map(emmeans_wholethal, ~ emmeans::contrast(.x, method = list(
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.lme - acAN_TP1.lme,
      "acAN-TP2 vs. recAN" = acAN_TP2.lme - recAN.lme,
      "acAN-TP2 vs. HC" = acAN_TP2.lme - HC.lme,
      "recAN vs. HC" = recAN.lme - HC.lme), lmer.df = "satterthwaite", adjust="none")),
    contraststidy_wholethal = map(contrasts_wholethal, tidy),
    # Follow-up relative approach 2: Basic LME model with eTIV and subcortical GM volume
    lme_subcortgm = map(data, ~ lme4::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff +
                                            etiv.meandiff + subcortgm.meandiff + (1|participant_id),
                                       data = .x, REML = TRUE, na.action = na.omit)),
    anova_subcortgm = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 + age.meandiff + 
                                               etiv.meandiff + subcortgm.meandiff + (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_subcortgm = map(anova_subcortgm, ~ rownames_to_column(.x, "term")),
    emmeans_subcortgm = map(lme_subcortgm, ~ emmeans::emmeans(.x, c("por", "delta.bmisds.T1_minus_T2"), cov.keep=2, 
                                           at = list(delta.bmisds.T1_minus_T2 = 
                                                       c(0, delta.bmisds.mean.T1_minus_T2)), 
                                           lmer.df = "satterthwaite", type="response")),
    emmeanstidy_subcortgm = map(emmeans_subcortgm, tidy), 
    contrasts_subcortgm = map(emmeans_subcortgm, ~ emmeans::contrast(.x, method = list(
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.lme - acAN_TP1.lme,
      "acAN-TP2 vs. recAN" = acAN_TP2.lme - recAN.lme,
      "acAN-TP2 vs. HC" = acAN_TP2.lme - HC.lme,
      "recAN vs. HC" = recAN.lme - HC.lme), lmer.df = "satterthwaite", adjust="none")),
    contraststidy_subcortgm = map(contrasts_subcortgm, tidy),
    # Modification 1: Basic LME model with delta BMI-SDS and DOI interaction
    anova_doi = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2*doi +
                                                   age.meandiff + etiv.meandiff + (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_doi = map(anova_doi, ~ rownames_to_column(.x, "term")),
    # Modification 2: Basic LME model with change in leptin concentration
    anova_leptin = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + delta.leptin.T1_minus_T2 +
                                                     (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_leptin = map(anova_leptin, ~ rownames_to_column(.x, "term")),
    # Modification 3: Basic LME model with change in depressive symptom levels (BDI-II)
    anova_bdi = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + delta.bdi.T1_minus_T2 +
                                                   (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_bdi = map(anova_bdi, ~ rownames_to_column(.x, "term")),
    # Modification 4: Basic LME model with change in core eating disorder symptoms (EDI-2 "drive for thinness", "body dissatisfaction", "bulimia")
    anova_edicore = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + delta.edicore.T1_minus_T2 +
                                                     (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova_edicore = map(anova_edicore, ~ rownames_to_column(.x, "term")),
    # Modification 5: Basic LME model with change in SCL-90-R Global Severity Index (GSI)
    anova_sclgsi = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + delta.sclgsi.T1_minus_T2 + 
                                                     (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
        anova_sclgsi = map(anova_sclgsi, ~ rownames_to_column(.x, "term")),
     # Modification 5: Basic LME model with change in SCL-90-R Global Severity Index (GSI)
    anova_sclzwang_whole = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + delta.sclzwang.T1_minus_T2 + 
                                                     (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
        anova_sclzwang_whole = map(anova_sclzwang_whole, ~ rownames_to_column(.x, "term")),
      #modification 6: Basic LME model with change in SCL-90R compulsiveness scale 
  anova_sclzwang = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T1_minus_T2 +
                                                   age.meandiff + etiv.meandiff + wholethal.meandiff + delta.sclzwang.T1_minus_T2 + 
                                                     (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
        anova_sclzwang = map(anova_sclzwang, ~ rownames_to_column(.x, "term")))%>%
  dplyr::select(hemi_region, labeller, region, whole.sub, SDtotal, emmeans, lmetidy, anova, emmeanstidy, contraststidy, anova_wholethal, emmeanstidy_wholethal, contraststidy_wholethal, anova_subcortgm, emmeanstidy_subcortgm, contraststidy_subcortgm, anova_doi, anova_leptin, anova_bdi, anova_edicore, anova_sclgsi, anova_sclzwang, anova_sclzwang_whole) 

# Alternative way to predict model-based means
#predictmeans::predictmeans(lme, "por", adj="none")
#predictmeans::covariatemeans(lme, "por", covariate="delta.bmisds.T1_minus_T2")
```

```{r lmeoutput, results="asis", message=FALSE, warning=FALSE}
# ANOVA output 
## contrast acAN-TP2 vs. acAN-TP1 is modeled as a function of BMI-SDS change between study time points => can be retrieved from contrasts output (cf. all other group comparisons) or directly from ANOVA output 
## Nonsignificant overall ANOVA, but significant post-hoc contrasts? - Answer: post-hoc multiple comparison tests are powerful enough and valid ... and often more focused or hypothesis-relevant (except for Fisher LSD) than overall ANOVA => nonsignificant omnibus ANOVA can be ignored

anovas.mainlme <- lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = ifelse(term %in% "delta.bmisds.T1_minus_T2", 
                             as.character(asterisk_function(p.adj)), NA)) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Main or basic LME model for whole Thalamus and Thalamus nuclei volumes: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("ANOVA p-values are only interpreted for BMI-SDS change (TP1 - TP2) in acAN, please refer to contrasts for between-group differences in point of research."=8), align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme$hemi_region_group)))


# Speed of changes in thalamus (nuclei) volumes as a function of BMI-SDS change (Slope)
# Speed of changes in thalamus (nuclei) volumes as a function of age change (Slope) in order to compare with BMI-SDS related changes

age_speed.mainlme <- lme %>%
  dplyr::select(hemi_region, labeller, hemi_region, region, lmetidy) %>%
  unnest(lmetidy) %>%
  filter(term %in% "age.meandiff") %>%
  dplyr::select(hemi_region, labeller, effect, estimate, std.error) %>%
  mutate(change_88days = (estimate*88)/365)

bmisds_speed.mainlme <- lme %>%
  dplyr::select(hemi_region, labeller, hemi_region, region, lmetidy) %>%
  unnest(lmetidy) %>%
  filter(term %in% "delta.bmisds.T1_minus_T2") %>%
  dplyr::select(hemi_region, labeller, effect, estimate, std.error) %>%
  mutate(change_weightgain = estimate*2.44) %>%
  left_join(age_speed.mainlme, by=c("hemi_region", "labeller", "effect"), 
            suffix = c(".bmisds_change", ".age_change")) %>%
  mutate(ratio = round(abs((change_weightgain / change_88days)), -1)) %>% 
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

bmisds_speed.mainlme %>%
  dplyr::select(-c(hemi_region, hemi_region_group)) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("Thalamus (sub)region", "Effect", "Slope: Volume change in mm^3 / BMI-SDS unit", "Standard error", "BMI-SDS-related volume change in mm^3 during observation period (on average + 2.44 BMI-SDS units)", "Slope: Volume change in mm^3 / year (age)", "Standard error", "Age-related volume change in mm^3 during observation period (on average 88 days)", "Ratio of BMI-SDS- and age-related changes in Thalamus (nuclei) volumes (absolute value, rounded) during weight-restoration"), caption = "LME model-estimated speed of changes in Thalamus (nuclei) volumes as a function of BMI-SDS increase and age-related change in acAN during short-term weight-restoration") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Weight-restoration (i.e., therapy-related) changes in thalamus (nuclei) volumes are at least one order of magnitude (at least 30 times) faster than age-related changes (cf. also longitudinal studies on CT and cortical folding, Bernardoni et al., 2016&2018)."=9), align="l") %>% 
  pack_rows(index = table(fct_inorder(bmisds_speed.mainlme$hemi_region_group))) #%>% 
  #save_kable("figures/speed_change.png", zoom=6)


# EMMEANS output
emmeans.mainlme <- lme %>%
  dplyr::select(labeller, hemi_region, region, emmeanstidy) %>%
  unnest(emmeanstidy) %>%
  mutate(por = ifelse((por %in% "HCW") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar1", por)) %>% # add zero bar for custom bar spacing in bar plots
  mutate(por = ifelse((por %in% "recAN") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar2", por)) %>%
  mutate(delta.bmisds.T1_minus_T2 = ifelse(por %in% c("zero_bar1", "zero_bar2"), NA, delta.bmisds.T1_minus_T2)) %>%
  mutate(estimate = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, estimate)) %>%
  mutate(std.error = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, std.error)) %>%
  mutate(emmeans = ifelse((delta.bmisds.T1_minus_T2 == 0) & (por %in% "acAN"), "acAN-TP2", 
                          ifelse(por != "acAN", por, "acAN-TP1"))) %>%
  mutate(emmeans = dplyr::recode(emmeans,
                                 "HCW" = "HC")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

emmeans.mainlme %>%
  dplyr::select(labeller, por, delta.bmisds.T1_minus_T2, estimate, std.error) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("Thalamus (sub)region", "Term: point of research", "Term: delta BMI-SDS", "EMMEANS estimate", "EMMEANS standard error of the mean (SEM)"),
               caption = "Main LME model for whole thalamus and thalamus nuclei volumes: EMMEANS table (relevant for results figures)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  pack_rows(index = table(fct_inorder(emmeans.mainlme$hemi_region_group)))

# Contrasts output
contrasts.mainlme <- lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, contraststidy) %>%
  unnest(contraststidy) %>%
  group_by(whole.sub) %>%
  mutate(p.adj = p.adjust(p.value, method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  mutate(adj.signif_fig = as.character(asterisk_function_fig(p.adj))) %>%
  ungroup() %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.value_formatted = ifelse(p.value<0.001, "< 0.001", p.value_formatted)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

contrasts.mainlme %>%
  dplyr::select(labeller, contrast, term, p.value_formatted, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Custom resp. planned contrast", "Contrast term", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"), 
               caption = "Main LME model for whole Thalamus and Thalamus nuclei volumes: Contrasts table (all pairwise contrasts including acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("FDR-adjustment for multiple comparisons was applied across all contrasts (all pairwise comparisons) and all thalamus (sub)regions (separately for whole thalamus vs. all thalamus nuclei)."=6), align="l") %>% 
  pack_rows(index = table(fct_inorder(contrasts.mainlme$hemi_region_group)))
```

**Follow-up relative LME model approach (1) for thalamus nuclei: main or basic LME model adjusted for mean-centered whole thalamus volume** 
```{r lmewholeoutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.wholethal <- lme %>%
  filter(!hemi_region %in% c("lh_Whole_thalamus", "rh_Whole_thalamus")) %>% # remove whole thalamus as dependent variable when whole thalamus is covariate itself
  dplyr::select(labeller, hemi_region, region, whole.sub, anova_wholethal) %>%
  unnest(anova_wholethal) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  group_by(term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = ifelse(term %in% "delta.bmisds.T1_minus_T2", as.character(asterisk_function(p.adj)), NA)) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region)

anovas.mainlme.wholethal %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus nuclei", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Follow-up relative LME model approach for thalamus nuclei, adjusted for whole thalamus volume: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

emmeans.mainlme.wholethal <- lme %>% 
  filter(!hemi_region %in% c("lh_Whole_thalamus", "rh_Whole_thalamus")) %>%
  dplyr::select(labeller, hemi_region, region, emmeanstidy) %>%
  unnest(emmeanstidy) %>%
  mutate(por = ifelse((por %in% "HCW") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar1", por)) %>% # add zero bar for custom bar spacing in bar plots
  mutate(por = ifelse((por %in% "recAN") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar2", por)) %>%
  mutate(delta.bmisds.T1_minus_T2 = ifelse(por %in% c("zero_bar1", "zero_bar2"), NA, delta.bmisds.T1_minus_T2)) %>%
  mutate(estimate = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, estimate)) %>%
  mutate(std.error = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, std.error)) %>%
  mutate(emmeans = ifelse((delta.bmisds.T1_minus_T2 == 0) & (por %in% "acAN"), "acAN-TP2", 
                          ifelse(por != "acAN", por, "acAN-TP1"))) %>%
  mutate(emmeans = dplyr::recode(emmeans,
                                 "HCW" = "HC")) %>%
  arrange(hemi_region)

emmeans.mainlme.wholethal %>% 
  dplyr::select(labeller, por, delta.bmisds.T1_minus_T2, estimate, std.error) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("thalamus nuclei", "Term: point of research", "Term: delta BMI-SDS", "EMMEANS estimate", "EMMEANS standard error of the mean (SEM)"),
               caption = "Follow-up relative LME model approach for thalamus nuclei, adjusted for whole thalamus volume: EMMEANS table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

contrasts.mainlme.wholethal <- lme %>%
  filter(!hemi_region %in% c("lh_Whole_thalamus", "rh_Whole_thalamus")) %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, contraststidy_wholethal) %>%
  unnest(contraststidy_wholethal) %>%
  mutate(p.adj = p.adjust(p.value, method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  mutate(adj.signif_fig = as.character(asterisk_function_fig(p.adj))) %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.value_formatted = ifelse(p.value<0.001, "< 0.001", p.value_formatted)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region)

contrasts.mainlme.wholethal %>% 
  dplyr::select(labeller, contrast, term, p.value_formatted, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus nuclei", "Custom resp. planned contrast", "Contrast term", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"), 
               caption = "Follow-up relative LME model approach for thalamus nuclei, adjusted for whole thalamus volume: Contrasts table (all pairwise contrasts including acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("FDR-adjustment for multiple comparisons was applied across all contrasts (all pairwise comparisons) and all thalamus nuclei."=6), align="l")
```

**Follow-up relative LME model approach (2): main or basic LME model adjusted for mean-centered subcortical gray matter volume** 
```{r lmesubcortoutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.subcortgm <- lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, anova_subcortgm) %>%
  unnest(anova_subcortgm) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = ifelse(term %in% "delta.bmisds.T1_minus_T2", as.character(asterisk_function(p.adj)), NA)) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F. < 0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.subcortgm %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Follow-up relative LME model approach, adjusted for subcortical gray matter volume: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  pack_rows(index = table(fct_inorder(anovas.mainlme.subcortgm$hemi_region_group)))

emmeans.mainlme.subcortgm <- lme %>%
  dplyr::select(labeller, hemi_region, region, emmeanstidy) %>%
  unnest(emmeanstidy) %>%
  mutate(por = ifelse((por %in% "HCW") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar1", por)) %>% # add zero bar for custom bar spacing in bar plots
  mutate(por = ifelse((por %in% "recAN") & (delta.bmisds.T1_minus_T2 != 0), "zero_bar2", por)) %>%
  mutate(delta.bmisds.T1_minus_T2 = ifelse(por %in% c("zero_bar1", "zero_bar2"), NA, delta.bmisds.T1_minus_T2)) %>%
  mutate(estimate = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, estimate)) %>%
  mutate(std.error = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, std.error)) %>%
  mutate(emmeans = ifelse((delta.bmisds.T1_minus_T2 == 0) & (por %in% "acAN"), "acAN-TP2", 
                          ifelse(por != "acAN", por, "acAN-TP1"))) %>%
  mutate(emmeans = dplyr::recode(emmeans,
                                 "HCW" = "HC")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

emmeans.mainlme.subcortgm %>%
  dplyr::select(labeller, por, delta.bmisds.T1_minus_T2, estimate, std.error) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("thalamus (sub)region", "Term: point of research", "Term: delta BMI-SDS", "EMMEANS estimate", "EMMEANS standard error of the mean (SEM)"),
               caption = "Follow-up relative LME model approach, adjusted for subcortical gray matter volume: EMMEANS table (relevant for results figures)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  pack_rows(index = table(fct_inorder(emmeans.mainlme.subcortgm$hemi_region_group)))

contrasts.mainlme.subcortgm <- lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, contraststidy_subcortgm) %>%
  unnest(contraststidy_subcortgm) %>%
  group_by(whole.sub) %>%
  mutate(p.adj = p.adjust(p.value, method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  mutate(adj.signif_fig = as.character(asterisk_function_fig(p.adj))) %>%
  ungroup() %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.value_formatted = ifelse(p.value<0.001, "< 0.001", p.value_formatted)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

contrasts.mainlme.subcortgm %>%
  dplyr::select(labeller, contrast, term, p.value_formatted, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Custom resp. planned contrast", "Contrast term", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"), 
               caption = "Follow-up relative LME model approach, adjusted for subcortical gray matter volume: Contrasts table (all pairwise contrasts including acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("FDR-adjustment for multiple comparisons was applied across all contrasts (all pairwise comparisons) and all thalamus (sub)regions (separately for whole thalamus vs. all thalamus nuclei)."=6), align="l") %>% 
  pack_rows(index = table(fct_inorder(contrasts.mainlme.subcortgm$hemi_region_group)))
```

## Main LME model modifications
**Main LME model modification (1): Interaction term delta.bmisds and DOI in acAN**  
Background: Longer duration of illness (DOI) in acAN could interfere with thalamus recovery during weight-restoration (i.e., less change in thalamus (nuclei) volumes during weight-restoration).  

```{r lmedoioutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.doi <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_doi) %>%
  unnest(anova_doi) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.doi %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance"),
               caption = "Main LME model modification including duration of illness in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.doi$term, "doi")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Duration of illness and interaction term delta BMI-SDS : DOI were nonsignificant (for all thalamus (sub)regions). Changes in whole thalamus and thalamus nuclei volumes are independent of duration of illness or its interaction with BMI-SDS."=7), align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.doi$hemi_region_group))) 
```

*Multicollinearity assessment: Pearson's product-moment correlations between independent variables (change BMI-SDS - change leptin, change BMI-SDS - change symptoms)*  
```{r correlations, results="asis", message=FALSE, warning=FALSE}
lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  filter(point_of_research %in% "T1") %>%
  dplyr::select(storage_name, delta.bmisds.T1_minus_T2, delta.leptin.T1_minus_T2, delta.bdi.T1_minus_T2,
                delta.edicore.T1_minus_T2, delta.sclgsi.T1_minus_T2, delta.sclzwang.T1_minus_T2) %>%
  pivot_longer(-c(storage_name, delta.bmisds.T1_minus_T2), 
               names_to = "demo_variable", values_to = "value") %>%
  nest(-demo_variable) %>%
    mutate(
      cor = map(data, ~ cor.test(.x$delta.bmisds.T1_minus_T2, .x$value, 
                                 alternative="two.sided", method="pearson", conf.level=0.95,
                                 na.action=na.omit)),
      cortidy = map(cor, tidy)) %>%
  unnest(cortidy) %>%
  dplyr::select(demo_variable, estimate, p.value) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("Correlation between change in BMI-SDS (TP1 - TP2) and ...", "r (Pearson)", "p-value (raw)"),
               caption = "Pearson correlations between predictors in modified LME (multicollinearity check)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Independent variables are not strongly / significantly correlated (no risk of multicollinearity). Thus, orthogonalization of variables (e.g., via Gram-Schmidt procedure) is not necessary!"=3), align="l") 
```

```{r lmeleptinoutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.leptin <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_leptin) %>%
  unnest(anova_leptin) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.leptin %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Main LME model modification including leptin change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.leptin$term, "leptin")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in leptin concentration as an additional predictor besides delta BMI-SDS was nominally significant for corticoamygdaloid transition area rh. However, this did not survive FDR-adjustment. Thus, changes in whole thalamus and thalamus nuclei volumes are independent of change in leptin concentration during weight-restoration."=9), align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.leptin$hemi_region_group))) 
```

**Main LME model modification (3): Change in BDI-II total score (depressive symptoms) in acAN**  
```{r lmebdioutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.bdi <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_bdi) %>%
  unnest(anova_bdi) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.bdi %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance"),
               caption = "Main LME model modification including BDI-II total score change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.bdi$term, "bdi")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in BDI-II total score (depressive symptoms) was nonsignificant (for all thalamus (sub)regions). Changes in whole thalamus and thalamus nuclei volumes are independent of improvements in depressive symptoms during weight-restoration. Thus, there are no significant relationships between thalamus (nuclei) volume changes and improvements in depressive symptoms in longitudinal acAN."=7), align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.bdi$hemi_region_group))) 
```

**Main LME model modification (4): Change in EDI-2 core symptoms (eating disorder symptoms: combined score comprising "drive for thinness", "body dissatisfaction" and "bulimia" subscales of EDI-2) in acAN**  
```{r lmeedioutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.edicore <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_edicore) %>%
  unnest(anova_edicore) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.edicore %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance"),
               caption = "Main LME model modification including EDI-2 core symptom change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.edicore$term, "edicore")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in EDI-2 core symptoms was nonsignificant (for all thalamus (sub)regions). Changes in whole thalamus and thalamus nuclei volumes are independent of improvements in core eating disorder symptoms during weight-restoration. Thus, there are no significant relationships between thalamus (nuclei) volume changes and improvements in eating disorder symptoms in longitudinal acAN."=7), align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.edicore$hemi_region_group))) 
```

**Main LME model modification (5): Change in SCL-90-R GSI score (global severity index = general psychopathology) in acAN**  
```{r lmescloutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.sclgsi <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_sclgsi) %>%
  unnest(anova_sclgsi) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.sclgsi %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance"),
               caption = "Main LME model modification including SCL-90-R GSI change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.sclgsi$term, "sclgsi")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in SCL-90-R GSI (general psychiatric symptom level via global severity index) was nonsignificant (for all thalamus (sub)regions). Changes in whole thalamus and thalamus nuclei volumes are independent of improvements in general psychiatric symptom levels during weight-restoration. Thus, there are no significant relationships between thalamus (nuclei) volume changes and improvements in general psychiatric symptoms via SCL-90-R GSI in longitudinal acAN."=7), 
                   align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.sclgsi$hemi_region_group))) 
```

**Main LME model modification (6): Change in SCL-90-R Compulsiveness score (global severity index = general psychopathology) in acAN**  
```{r lmescloutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.sclzwang <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_sclzwang) %>%
  unnest(anova_sclzwang) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
  group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.sclzwang %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Main LME model modification including SCL-90-R compulsiveness change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.sclzwang$term, "sclzwang")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in SCL-90-R Compulsiveness  was significant for some thalamus subregions. "=9), 
                   align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.sclzwang$hemi_region_group))) 
```

**Main wholethal model modification (7): Change in SCL-90-R Compulsiveness score  in acAN**  
```{r lmescloutput, results="asis", message=FALSE, warning=FALSE}
anovas.mainlme.sclzwang.wholethal <- lme %>%
  dplyr::select(labeller, hemi_region, whole.sub, anova_sclzwang_whole) %>%
  unnest(anova_sclzwang_whole) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  mutate(signif = as.character(asterisk_function(Pr..F.))) %>%
   group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.mainlme.sclzwang.wholethal %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, signif, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus subregion", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "Significance", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "Main LME model modification including SCL-90-R compulsiveness change in acAN: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  row_spec(which(str_detect(anovas.mainlme.sclzwang.wholethal$term, "sclzwang")), bold=TRUE, color="darkblue") %>%
  add_header_above(c("Change in SCL-90-R Compulsiveness  was significant for some thalamus subregions. "=9), 
                   align="l") %>% 
  pack_rows(index = table(fct_inorder(anovas.mainlme.sclzwang.wholethal$hemi_region_group))) 
```

## Graphical implementation of results of main LME model and follow-up relative LME model approach

```{r barplotsmainlme, fig.cap="Main LME model (age- and eTIV-adjusted): Model estimates of thalamus (nuclei) volumes in study groups acAN at TP1 and TP2, recAN and HC including group differences", message=FALSE, warning=FALSE}
bardata.mainlme <- emmeans.mainlme %>%
  dplyr::select(labeller, region, emmeans, estimate, std.error) %>%
  arrange(region) %>%
  mutate(emmeans = fct_relevel(emmeans, c("acAN-TP1", "acAN-TP2", "zero_bar1", "recAN", "zero_bar2", "HC"))) %>%
  mutate(xlabels = ifelse(region %in% "Whole_thalamus", TRUE, FALSE))

plotlist = list()

for (Region in unique(bardata.mainlme$region)) {
  
  plotdata <- bardata.mainlme %>% filter(region %in% Region)
  
  y.position <- emmeans.mainlme %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>% # y positions (y axis min and max) are regulated by maximum volume measure per region
    slice_head(n = 1) %>%
    mutate(ymin = round((0.90*estimate)-5, -1)) %>%
    mutate(ymax = round((1.08*estimate)+6, -1)) %>% # round to nearest 10
    mutate(signif.position_T2_T1 = (0.06*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_recAN = (0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_recAN_HC = (0.27*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_HC = (0.36*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl = 0.008) %>% # tip lengths for significance bars
    dplyr::select(region, ymin, ymax, signif.position_T2_T1, signif.position_T2_recAN, 
                  signif.position_recAN_HC, signif.position_T2_HC, tipl)

   longi.line <- emmeans.mainlme %>%
    filter(region %in% Region) %>%
    filter(emmeans %in% c("acAN-TP1", "acAN-TP2")) %>%
    mutate(emmeans = dplyr::recode(emmeans,
                                   "acAN-TP1" = "y",
                                   "acAN-TP2" = "yend")) %>% 
    dplyr::select(labeller, emmeans, estimate) %>%
    pivot_wider(names_from = emmeans, values_from = estimate) %>%
    mutate(x = 1) %>%
    mutate(xend = 2)
   
  signif.T2_T1 <- contrasts.mainlme %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. acAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 1) %>%
    mutate(xmax = 2)

  signif.T2_recAN <- contrasts.mainlme %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. recAN") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 4)
  
  signif.recAN_HC <- contrasts.mainlme %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "recAN vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 4) %>%
    mutate(xmax = 6)
  
  signif.T2_HC <- contrasts.mainlme %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 6)
  
  barplots <- plotdata %>%
    ggplot(aes(x = emmeans, y = estimate)) +
    geom_col(aes(fill = emmeans, color = emmeans), stat = "identity", color = NA, width=1, position = position_dodge()) +
    geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error), width = 0.3, size = 1.25, color = "BLACK",
                 position = position_dodge(1)) +
    geom_segment(data = longi.line, aes(x = x, xend = xend, y = y, yend = yend), color="BLACK", size = 1.25, 
                 linetype = "21212121") +
    geom_signif(data = signif.T2_T1, aes(annotations = adj.signif_fig, y_position = signif.position_T2_T1, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_recAN, aes(annotations = adj.signif_fig, y_position = signif.position_T2_recAN, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.recAN_HC, aes(annotations = adj.signif_fig, y_position = signif.position_recAN_HC, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_HC, aes(annotations = adj.signif_fig, y_position = signif.position_T2_HC, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    coord_cartesian(ylim = c(y.position$ymin, y.position$ymax)) +
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                       "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                        "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_x_discrete(labels = c("acAN-TP1" = "acAN-TP1", "acAN-TP2" = "acAN-TP2", "zero_bar1" = "", "recAN" = "recAN", 
                                "zero_bar2" = "", "HC" = "HC")) +
    plot_theme_transparent + 
    theme(axis.text.x = element_text(size = 28, angle=45, hjust=1), axis.ticks.y = 
            element_line(size=1.5), axis.ticks.length.y=unit(.25, "cm")) +
    theme(axis.title.x = element_blank(), axis.ticks.x = element_blank(), axis.title.y = element_blank()) +
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15)) +
    theme(panel.spacing = unit(1.75, "cm"))
    
  
  if(plotdata$xlabels == FALSE) {
   barplots = barplots + 
     theme(axis.text.x = element_blank())
   }
  
 plotlist[[Region]] = barplots
 
}

bp.whole <- plotlist$Whole_thalamus
bp.nuclei <- plotlist[2:25] 

barplotarrange <- ggarrange(bp.whole, 
          ggarrange(plotlist=bp.nuclei, ncol=5, nrow=5),
          ncol=2, nrow=1, widths=c(1, 2.5)) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), size=28, rot=90))

barplotarrange

#ggsave(barplotarrange, path="figures", filename="barplots_mainlme.png", width=32, height=25, dpi=600)
```

```{r barplotsrelativewhole, fig.cap="Follow-up relative LME model (adjusted for whole thalamus volume): Model estimates of thalamus (nuclei) volumes in study groups acAN at TP1 and TP2, recAN and HC including group differences", message=FALSE, warning=FALSE}
bardata.mainlme.wholethal <- emmeans.mainlme.wholethal %>%
  dplyr::select(labeller, region, emmeans, estimate, std.error) %>%
  arrange(region) %>%
  mutate(emmeans = fct_relevel(emmeans, c("acAN-TP1", "acAN-TP2", "zero_bar1", "recAN", "zero_bar2", "HC")))

plotlist = list()

for (Region in unique(bardata.mainlme.wholethal$region)) {
  
  plotdata <- bardata.mainlme.wholethal %>% filter(region %in% Region)
  
  y.position <- emmeans.mainlme.wholethal %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>% # y positions (y axis min and max) are regulated by maximum volume measure per region
    slice_head(n = 1) %>%
    mutate(ymin = round((0.90*estimate)-5, -1)) %>%
    mutate(ymax = round((1.08*estimate)+6, -1)) %>% # round to nearest 10
    mutate(signif.position_T2_T1 = (0.06*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_recAN = (0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_recAN_HC = (0.27*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_HC = (0.36*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl = 0.008) %>% # tip lengths for significance bars
    dplyr::select(region, ymin, ymax, signif.position_T2_T1, signif.position_T2_recAN, 
                  signif.position_recAN_HC, signif.position_T2_HC, tipl)

   longi.line <- emmeans.mainlme.wholethal %>%
    filter(region %in% Region) %>%
    filter(emmeans %in% c("acAN-TP1", "acAN-TP2")) %>%
    mutate(emmeans = dplyr::recode(emmeans,
                                   "acAN-TP1" = "y",
                                   "acAN-TP2" = "yend")) %>% 
    dplyr::select(labeller, emmeans, estimate) %>%
    pivot_wider(names_from = emmeans, values_from = estimate) %>%
    mutate(x = 1) %>%
    mutate(xend = 2)
   
  signif.T2_T1 <- contrasts.mainlme.wholethal %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. acAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 1) %>%
    mutate(xmax = 2)

  signif.T2_recAN <- contrasts.mainlme.wholethal %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. recAN") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 4)
  
  signif.recAN_HC <- contrasts.mainlme.wholethal %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "recAN vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 4) %>%
    mutate(xmax = 6)
  
  signif.T2_HC <- contrasts.mainlme.wholethal %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 6)
  
  barplots <- plotdata %>%
    ggplot(aes(x = emmeans, y = estimate)) +
    geom_col(aes(fill = emmeans, color = emmeans), stat = "identity", color = NA, width=1, position = position_dodge()) +
    geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error), width = 0.3, size = 1.25, color = "BLACK",
                 position = position_dodge(1)) +
    geom_segment(data = longi.line, aes(x = x, xend = xend, y = y, yend = yend), color="BLACK", size = 1.25, 
                 linetype = "21212121") +
    geom_signif(data = signif.T2_T1, aes(annotations = adj.signif_fig, y_position = signif.position_T2_T1, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_recAN, aes(annotations = adj.signif_fig, y_position = signif.position_T2_recAN, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.recAN_HC, aes(annotations = adj.signif_fig, y_position = signif.position_recAN_HC, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_HC, aes(annotations = adj.signif_fig, y_position = signif.position_T2_HC, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    coord_cartesian(ylim = c(y.position$ymin, y.position$ymax)) +
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                       "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                        "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_x_discrete(labels = c("acAN-TP1" = "acAN-TP1", "acAN-TP2" = "acAN-TP2", "zero_bar1" = "", "recAN" = "recAN", 
                                "zero_bar2" = "", "HC" = "HC")) +
    plot_theme_transparent + 
    theme(axis.title.x = element_blank(), axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(), axis.title.y = element_blank(), axis.ticks.y = 
            element_line(size=1.5), axis.ticks.length.y=unit(.25, "cm")) +
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15)) +
    theme(panel.spacing = unit(1.75, "cm"))
  
 plotlist[[Region]] = barplots
 
}

bp.nuclei <- plotlist[1:25] 

barplotarrange <- ggarrange(plotlist=bp.nuclei, ncol=5, nrow=5) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), size=28, rot=90))

barplotarrange

#ggsave(barplotarrange, path="figures", filename="barplots_mainlme.wholethal.png", width=25, height=25, dpi=600)
```

```{r barplotsrelativesubcortgm, fig.cap="Follow-up relative LME model (adjusted for subcortical gray matter volume): Model estimates of thalamus (nuclei) volumes in study groups acAN at TP1 and TP2, recAN and HC including group differences", message=FALSE, warning=FALSE}
bardata.mainlme.subcortgm <- emmeans.mainlme.subcortgm %>%
  dplyr::select(labeller, region, emmeans, estimate, std.error) %>%
  arrange(region) %>%
  mutate(emmeans = fct_relevel(emmeans, c("acAN-TP1", "acAN-TP2", "zero_bar1", "recAN", "zero_bar2", "HC"))) %>%
  mutate(xlabels = ifelse(region %in% "Whole_thalamus", TRUE, FALSE))

plotlist = list()

for (Region in unique(bardata.mainlme.subcortgm$region)) {
  
  plotdata <- bardata.mainlme.subcortgm %>% filter(region %in% Region)
  
  y.position <- emmeans.mainlme.subcortgm %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>% # y positions (y axis min and max) are regulated by maximum volume measure per region
    slice_head(n = 1) %>%
    mutate(ymin = round((0.90*estimate)-5, -1)) %>%
    mutate(ymax = round((1.08*estimate)+6, -1)) %>% # round to nearest 10
    mutate(signif.position_T2_T1 = (0.06*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_recAN = (0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_recAN_HC = (0.27*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(signif.position_T2_HC = (0.36*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl = 0.008) %>% # tip lengths for significance bars
    dplyr::select(region, ymin, ymax, signif.position_T2_T1, signif.position_T2_recAN, 
                  signif.position_recAN_HC, signif.position_T2_HC, tipl)

   longi.line <- emmeans.mainlme.subcortgm %>%
    filter(region %in% Region) %>%
    filter(emmeans %in% c("acAN-TP1", "acAN-TP2")) %>%
    mutate(emmeans = dplyr::recode(emmeans,
                                   "acAN-TP1" = "y",
                                   "acAN-TP2" = "yend")) %>% 
    dplyr::select(labeller, emmeans, estimate) %>%
    pivot_wider(names_from = emmeans, values_from = estimate) %>%
    mutate(x = 1) %>%
    mutate(xend = 2)
   
  signif.T2_T1 <- contrasts.mainlme.subcortgm %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. acAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 1) %>%
    mutate(xmax = 2)

  signif.T2_recAN <- contrasts.mainlme.subcortgm %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. recAN") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 4)
  
  signif.recAN_HC <- contrasts.mainlme.subcortgm %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "recAN vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 4) %>%
    mutate(xmax = 6)
  
  signif.T2_HC <- contrasts.mainlme.subcortgm %>%
    filter(region %in% Region) %>%
    filter(contrast %in% "acAN-TP2 vs. HC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 2) %>%
    mutate(xmax = 6)
  
  barplots <- plotdata %>%
    ggplot(aes(x = emmeans, y = estimate)) +
    geom_col(aes(fill = emmeans, color = emmeans), stat = "identity", color = NA, width=1, position = position_dodge()) +
    geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error), width = 0.3, size = 1.25, color = "BLACK",
                 position = position_dodge(1)) +
    geom_segment(data = longi.line, aes(x = x, xend = xend, y = y, yend = yend), color="BLACK", size = 1.25, 
                 linetype = "21212121") +
    geom_signif(data = signif.T2_T1, aes(annotations = adj.signif_fig, y_position = signif.position_T2_T1, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_recAN, aes(annotations = adj.signif_fig, y_position = signif.position_T2_recAN, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.recAN_HC, aes(annotations = adj.signif_fig, y_position = signif.position_recAN_HC, 
                                            xmin = xmin, xmax = xmax, tip_length = tipl),
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    geom_signif(data = signif.T2_HC, aes(annotations = adj.signif_fig, y_position = signif.position_T2_HC, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 3, vjust = -0.04, color = "BLACK", manual = TRUE) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    coord_cartesian(ylim = c(y.position$ymin, y.position$ymax)) +
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                       "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                        "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_x_discrete(labels = c("acAN-TP1" = "acAN-TP1", "acAN-TP2" = "acAN-TP2", "zero_bar1" = "", "recAN" = "recAN", 
                                "zero_bar2" = "", "HC" = "HC")) +
    plot_theme_transparent + 
    theme(axis.text.x = element_text(size = 28, angle=45, hjust=1)) +
    theme(axis.title.x = element_blank(), axis.ticks.x = element_blank(), axis.title.y = element_blank(),
          axis.ticks.y = element_line(size=1.5), axis.ticks.length.y=unit(.25, "cm")) +
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15)) +
    theme(panel.spacing = unit(1.75, "cm"))
    
  
  if(plotdata$xlabels == FALSE) {
   barplots = barplots + 
     theme(axis.text.x = element_blank())
   }
  
 plotlist[[Region]] = barplots
 
}

bp.whole <- plotlist$Whole_thalamus
bp.nuclei <- plotlist[2:25] 

barplotarrange <- ggarrange(bp.whole, 
          ggarrange(plotlist=bp.nuclei, ncol=5, nrow=5),
          ncol=2, nrow=1, widths=c(1, 2.5)) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), size=28, rot=90))

barplotarrange

#ggsave(barplotarrange, path="figures", filename="barplots_mainlme.subcortgm.png", width=32, height=25, dpi=600)
```

##diff LME implementation

## follow up analysis needed???
much emptyyyy

# Supplementary analyses
## Reproduce findings of cross-sectional thalamus nuclei paper (acAN-TP1 vs. HC) using modified LME model
Aims of supplementarily modified LME model (adapted version of our main absolute eTIV model):  
* Include all available acAN patients (also those without TP2 assessment) and compare them at TP1 to HC;  
* Reproduce cross-sectional paper findings (acAN-TP1 vs. HC, age-matching + eTIV-adjusted GLMs) using an independent statistical approach (i.e., age- and eTIV-adjusted LME model!).  

Complete acAN sample in SM analyses equals the sample in our cross-sectional paper (n(acAN-TP1)=168).  
Note that there were n=10 acAN - recAN re-inclusions in total (if all available acAN and not only (matching) acAN with both TP1 and TP2 assessments (see main LME model, n=7 acAN - recAN re-inclusions) were taken into account). The referring recAN were removed in order to keep the complete acAN sample.  

```{r smsubjects, results="asis", message=FALSE, warning=FALSE}
# Select unique additional acAN-TP1 for SM sample (without TP2 assessment)
sm.uniquesunjects_T1 <- uniquesubjects_T1 %>%
  anti_join(match_T1_T2, by="id") %>%
  filter(id != "64-10-500") %>% # drug exclusion (alcohol abuse)
  group_by(id) %>%
  arrange(date_of_research, outliersum, mriqc_smri_summary, .by_group = TRUE) %>% # priorities, first AN episode or first/earliest date for acAN-TP1
  slice_head(n = 1) %>%
  ungroup() %>%
  dplyr::select(storage_name, id, point_of_research)

# Merge with matching acAN-TP1 - acAN-TP2 from main sample
sm.acAN <- match_T1_T2 %>%
  dplyr::select(storage_name, id, point_of_research) %>%
  rbind(sm.uniquesunjects_T1)

# Merge with unique recAN and HC from main sample 
sm.presample <- recAN_HC %>%
  dplyr::select(storage_name, id, point_of_research) %>%
  rbind(sm.acAN)

# Eliminate acAN-recAN re-inclusions (recAN are excluded)
sm.exclude_reinclusions <- sm.presample %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  group_by(id) %>%
  arrange(point_of_research, .by_group = TRUE) %>%
  filter(n()==104, .preserve=TRUE) %>%
  filter(point_of_research %in% "recAN") %>%
  ungroup()

data <- unique(glmdata)
# Final SM sample 
sm.sample <- anti_join(sm.presample, sm.exclude_reinclusions, by="storage_name") %>%
  dplyr::select(storage_name, id) %>%
  left_join(data, by="storage_name", all.x=TRUE)%>%
  dplyr::select(-c(file_type)) %>%
  mutate(por = as.factor(ifelse(point_of_research %in% c("recAN", "HCW"), as.character(point_of_research), "acAN"))) %>% 
  mutate(point_of_research = fct_relevel(point_of_research, c("T1", "T2", "recAN", "HCW"))) %>%
  unite("hemi_region", c(hemi, region), sep = "_", remove = FALSE, na.rm = FALSE) %>%
  unite("labeller", c(region, hemi), sep= " ", remove = FALSE, na.rm = FALSE) %>%
  mutate(hemi_region = levels.hemi_region(hemi_region)) %>%
  mutate(whole.sub = ifelse(region %in% "Whole_thalamus", "whole", "subregion"))

sm.sample <- unique(sm.sample)

sm.sample %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  group_by(point_of_research) %>%
  distinct(id.x, .keep_all = TRUE)%>%
  count(.) %>%
  knitr::kable(format = "html", align = "l", col.names = c("SM study groups", "n"), 
               caption = "SM study sample: Number of participants per study group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("Note that acAN-TP2 and HC study groups are equal to the main sample. Complete acAN-TP1 sample cf. our cross-sectional thalamus nuclei paper. Re-included recAN (former acAN, n=10) were removed so that acAN and recAN samples were independent."=2), align="l")
```

```{r smlmedata, results="hide", message=FALSE, warning=FALSE}
acAN_TP1.smlme = c(1, 0, 0, 0, 0, 0)
acAN_TP2.smlme = c(0, 0, 0, 1, 0, 0)
recAN.smlme = c(0, 0, 1, 0, 0, 0)
HC.smlme = c(0, 1, 0, 0, 0, 0)

sm.lmedata <- sm.sample %>%
  filter(region %in% "Whole_thalamus") %>%
  dplyr::select(storage_name, hemi, measure) %>%
  rename(whole_thalamus = measure) %>%
  right_join(sm.sample, by=c("storage_name", "hemi")) %>%
  group_by(point_of_research) %>%
  dplyr::select(storage_name, participant_id, por, point_of_research, hemi_region, labeller, region, whole.sub, measure,
                bmisds_at_date_of_research, age_at_date_of_research, e_tiv) %>%
  group_by(hemi_region) %>%
  mutate(age.meandiff = age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE)) %>%
  mutate(etiv.meandiff = e_tiv - mean(e_tiv, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(participant_id, hemi_region) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds.T2_minus_T1 = ifelse(point_of_research %in% "T2",
                                  bmisds_at_date_of_research - lag(bmisds_at_date_of_research), 
                              0)) %>% # delta = T2 - T1
  ungroup() %>%
  mutate(delta.bmisds.mean.T2_minus_T1 = 
           mean(delta.bmisds.T2_minus_T1[delta.bmisds.T2_minus_T1!=0], na.rm=TRUE)) %>%
  mutate(participant_id = as.factor(participant_id)) %>%
  mutate(point_of_research = as.factor(point_of_research))%>%
  filter(storage_name!="64-10-580-1_T1_dehab") #exclude bc only NAs

delta.bmisds.mean.T2_minus_T1 <- unique(sm.lmedata$delta.bmisds.mean.T2_minus_T1)
```

```{r smlme, results="hide", message=FALSE, warning=FALSE}
sm.lme <- sm.lmedata %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, labeller, region, whole.sub)) %>%
  mutate(
    lme = map(data, ~ lme4::lmer(measure ~ 1 + por + delta.bmisds.T2_minus_T1 + age.meandiff + etiv.meandiff +
                                   (1|participant_id), data = .x, REML = TRUE, na.action = na.omit)),
    anova = map(data, ~ anova(lmerTest::lmer(measure ~ 1 + por + delta.bmisds.T2_minus_T1 + age.meandiff + 
                                               etiv.meandiff + (1|participant_id), 
                                             data=.x, REML = TRUE, na.action = na.omit),
                              type="III", ddf="Satterthwaite")),
    anova = map(anova, ~ rownames_to_column(.x, "term")),
    refgrid = map(lme, ~ emmeans::ref_grid(.x, cov.keep=2, at = list(delta.bmisds.T2_minus_T1 = 
                                                                       c(0, delta.bmisds.mean.T2_minus_T1)),
                                           lmer.df = "satterthwaite") @ grid),
    emmeans = map(lme, ~ emmeans::emmeans(.x, c("por", "delta.bmisds.T2_minus_T1"), cov.keep=2, 
                                           at = list(delta.bmisds.T2_minus_T1 = 
                                                       c(0, delta.bmisds.mean.T2_minus_T1)), 
                                          lmer.df = "satterthwaite", type="response")),
    emmeanstidy = map(emmeans, tidy),
    contrasts = map(emmeans, ~ emmeans::contrast(.x, method = list(
      "acAN-TP1 vs. HC" = acAN_TP1.smlme - HC.smlme,
      "acAN-TP1 vs. recAN" = acAN_TP1.smlme - recAN.smlme,
      "acAN-TP1 vs. acAN-TP2" = acAN_TP1.smlme - acAN_TP2.smlme), lmer.df = "satterthwaite", adjust="none")),
    contraststidy = map(contrasts, tidy),
    SDtable = map(lme, ~ as.tibble(lme4::VarCorr(.x))), # for effect size statistics
    SDtotal = map_dbl(SDtable, ~ sqrt((.x$sdcor[.x$grp=="participant_id"]^2) + (.x$sdcor[.x$grp=="Residual"]^2)))) %>%
  dplyr::select(hemi_region, labeller, region, whole.sub, SDtotal, emmeans, anova, emmeanstidy, contraststidy)
```

```{r smlmeoutput, results="asis", message=FALSE, warning=FALSE}
anovas.smlme <- sm.lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair = "universal") %>%
  mutate(DenDF = formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value = formatC(F.value, format="f", digits=2)) %>%
  group_by(whole.sub, term) %>%
  mutate(p.adj = p.adjust(Pr..F., method="fdr")) %>%
  mutate(adj.signif = ifelse(term %in% "delta.bmisds.T2_minus_T1", as.character(asterisk_function(p.adj)), NA)) %>%
  ungroup() %>%
  mutate(p.value = formatC(Pr..F., format="f", digits=3)) %>%
  mutate(p.value = ifelse(Pr..F.<0.001, "< 0.001", p.value)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

anovas.smlme %>%
  dplyr::select(labeller, term, NumDF, DenDF, F.value, p.value, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Term", "df(num)", "df(den)", "F statistic", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"),
               caption = "SM-modified LME model including further acAN-TP1 (age- and eTIV-adjusted): ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("ANOVA p-values are only interpreted for BMI-SDS change (TP2 - TP1) in acAN, please refer to contrasts for between-group differences in point of research."=8), align="l") %>%
  pack_rows(index = table(fct_inorder(anovas.smlme$hemi_region_group)))

emmeans.smlme <- sm.lme %>%
  dplyr::select(labeller, hemi_region, region, emmeanstidy) %>%
  unnest(emmeanstidy) %>%
  mutate(por = ifelse((por %in% "HCW") & (delta.bmisds.T2_minus_T1 != 0), "zero_bar1", por)) %>% # add zero bars for custom bar spacing in bar plots
  mutate(por = ifelse((por %in% "recAN") & (delta.bmisds.T2_minus_T1 != 0), "zero_bar2", por)) %>%
  mutate(delta.bmisds.T2_minus_T1 = ifelse(por %in% c("zero_bar1", "zero_bar2"), NA, delta.bmisds.T2_minus_T1)) %>%
  mutate(estimate = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, estimate)) %>%
  mutate(std.error = ifelse(por %in% c("zero_bar1", "zero_bar2"), 0, std.error)) %>%
  mutate(emmeans = ifelse((delta.bmisds.T2_minus_T1 == 0) & (por %in% "acAN"), "acAN-TP1", 
                          ifelse(por != "acAN", por, "acAN-TP2"))) %>%
  mutate(emmeans = dplyr::recode(emmeans,
                                 "HCW" = "HC")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

emmeans.smlme %>%
  dplyr::select(labeller, por, delta.bmisds.T2_minus_T1, estimate, std.error) %>%
  knitr::kable(format = "html", digits=2, align = "l", col.names = c("thalamus (sub)region", "Term: point of research", "Term: delta BMI-SDS", "EMMEANS estimate", "EMMEANS standard error of the mean (SEM)"),
               caption = "SM-modified LME model including further acAN-TP1 (age- and eTIV-adjusted): EMMEANS table (relevant for results figures)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  pack_rows(index = table(fct_inorder(emmeans.smlme$hemi_region_group)))

contrasts.smlme <- sm.lme %>%
  dplyr::select(labeller, hemi_region, region, whole.sub, contraststidy) %>%
  unnest(contraststidy) %>%
  filter(contrast == "acAN-TP1 vs. HC") %>% # filter due to main focus of SM LME model = reproduce acAN-TP1 vs. HC comparison
  group_by(whole.sub) %>%
  mutate(p.adj = p.adjust(p.value, method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  mutate(adj.signif_fig = as.character(asterisk_function_fig(p.adj))) %>%
  ungroup() %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.value_formatted = ifelse(p.value<0.001, "< 0.001", p.value_formatted)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

contrasts.smlme %>%
  dplyr::select(labeller, contrast, term, p.value_formatted, p.adj_formatted, adj.signif) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Custom resp. planned contrast", "Contrast term", "p-value (raw)", "p-value (FDR-adjusted)", "Adjusted significance"), 
               caption = "SM-modified LME model including further acAN-TP1 (age- and eTIV-adjusted): Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("FDR-adjustment for multiple comparisons was applied across all contrasts and all thalamus (sub)regions (separately for whole thalamus vs. all thalamus nuclei)."=6), align="l") %>% 
  add_header_above(c("Reproduce findings of cross-sectional thalamus nuclei paper? - YES, all cross-sectional findings acAN-TP1 vs. HC could be reproduced."=6), align="l") %>%
  pack_rows(index = table(fct_inorder(contrasts.smlme$hemi_region_group)))
```

```{r smbarplotslmereproduce, fig.cap="SM-modified LME model including further acAN-TP1 (age- and eTIV-adjusted): Model estimates of thalamus (nuclei) volumes in study groups acAN at TP1 and TP2, recAN and HC including group differences between acAN-TP1 and HC (reproduce cross-sectional thalamus nuclei paper findings)", message=FALSE, warning=FALSE}
bardata.smlme <- emmeans.smlme %>%
  dplyr::select(labeller, region, emmeans, estimate, std.error) %>%
  arrange(region) %>%
  mutate(emmeans = fct_relevel(emmeans, c("acAN-TP1", "acAN-TP2", "zero_bar1", "recAN", "zero_bar2", "HC"))) %>%
  mutate(xlabels = ifelse(region %in% "Whole_thalamus", TRUE, FALSE))

plotlist = list()

for (Region in unique(bardata.smlme$region)) {
  
  plotdata <- bardata.smlme %>% filter(region %in% Region)
  
  y.position <- emmeans.smlme %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n = 1) %>%
    mutate(ymin = round((0.90*estimate)-5, -1)) %>%
    mutate(ymax = round((1.05*estimate)+5, -1)) %>% 
    mutate(signif.position_T1_HC = (0.15*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl = 0.015) %>% 
    dplyr::select(region, ymin, ymax, signif.position_T1_HC, tipl)

   longi.line <- emmeans.smlme %>%
    filter(region %in% Region) %>%
    filter(emmeans %in% c("acAN-TP1", "acAN-TP2")) %>%
    mutate(emmeans = dplyr::recode(emmeans,
                                   "acAN-TP1" = "y",
                                   "acAN-TP2" = "yend")) %>% 
    dplyr::select(labeller, emmeans, estimate) %>%
    pivot_wider(names_from = emmeans, values_from = estimate) %>%
    mutate(x = 1) %>%
    mutate(xend = 2)
   
  signif.T1_HC <- contrasts.smlme %>% # contrast acAN-TP1 vs. HC has already been filtered
    filter(region %in% Region) %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 1) %>%
    mutate(xmax = 6)

  barplots <- plotdata %>%
    ggplot(aes(x = emmeans, y = estimate)) +
    geom_col(aes(fill = emmeans, color = emmeans), stat = "identity", color = NA, width=1, position = position_dodge()) +
    geom_errorbar(aes(ymin = estimate-std.error, ymax = estimate+std.error), width = 0.3, size = 1.25, color = "BLACK",
                 position = position_dodge(1)) +
    geom_segment(data = longi.line, aes(x = x, xend = xend, y = y, yend = yend), color="BLACK", size = 1.25, 
                 linetype = "21212121") +
    geom_signif(data = signif.T1_HC, aes(annotations = adj.signif_fig, y_position = signif.position_T1_HC, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 9, vjust = -0.1, color = "BLACK", manual = TRUE) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    coord_cartesian(ylim = c(y.position$ymin, y.position$ymax)) +
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                       "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000", "#800000FF", 
                                        "#000000", "#DF8F44FF", "#000000"), 0.8)) + 
    scale_x_discrete(labels = c("acAN-TP1" = "acAN-TP1", "acAN-TP2" = "acAN-TP2", "zero_bar1" = "", "recAN" = "recAN", 
                                "zero_bar2" = "", "HC" = "HC")) +
    plot_theme_transparent + 
    theme(axis.text.x = element_text(size = 28, angle=45, hjust=1)) +
    theme(axis.title.x = element_blank(), axis.ticks.x = element_blank(), axis.title.y = element_blank(), axis.ticks.y = 
            element_line(size=1.5), axis.ticks.length.y=unit(.25, "cm")) +
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15)) +
    theme(panel.spacing = unit(1.75, "cm"))
    
  
  if(plotdata$xlabels == FALSE) {
   barplots = barplots + 
     theme(axis.text.x = element_blank())
   }
  
 plotlist[[Region]] = barplots
 
}

bp.whole <- plotlist$Whole_thalamus
bp.nuclei <- plotlist[2:25] 

barplotarrange <- ggarrange(bp.whole, 
          ggarrange(plotlist=bp.nuclei, ncol=5, nrow=5),
          ncol=2, nrow=1, widths=c(1, 2.5)) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), size=28, rot=90))

barplotarrange

#ggsave(barplotarrange, path="figures", filename="barplots_smlme.png", width=32, height=25, dpi=600)
```

## Effect size statistics for main LME model and SM LME model
Cohen's D for post-hoc LME group differences, interpretation (benchmarks):  
Small effect - d = 0.2;  
Medium effect - d = 0.5;  
Large effect - d = 0.8 (Cohen, 1988).  
*Main LME model:* Cohen's d for all post-hoc contrasts (pairwise).  
*SM LME model:* Cohen's d only for acAN-TP1 vs. HC contrast (aim: reproduce cross-sectional thalamus nuclei paper findings).  

```{r maincohensd, results="asis", message=FALSE, warning=FALSE}
# Effect size statistics (Cohen's d) for LME model: SD estimate for LME - NOT residual SD!, instead manually computed total SD of the population (computation via Pythagorean Theorem); infinite degrees of freedom assumed (i.e., we claim we know sigma = total SD perfectly => affects SE and confidence levels only, does not affect effect size estimate)
# Computation as loop (was not possible via nest and map!)

## Main LME model
cohenlist.main = list()

for (Hemi_Region in unique(lme$hemi_region)) {
  
  SDtotal <- lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal)
  
  cohen.d <- lme %>%
    dplyr::select(hemi_region, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohen.d = map(emmeans, ~ as.tibble(emmeans::eff_size(.x, sigma = SDtotal, edf = Inf, method = list(
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.lme - acAN_TP1.lme,
      "acAN-TP2 vs. recAN" = acAN_TP2.lme - recAN.lme,
      "acAN-TP2 vs. HC" = acAN_TP2.lme - HC.lme,
      "recAN vs. HC" = recAN.lme - HC.lme))))) %>%
    unnest(cohen.d) %>%
    mutate(cohens.d = abs(as.numeric(formatC(effect.size, format="f", digits=2)))) %>% # absolute/positive values
    dplyr::select(hemi_region, contrast, cohens.d)
  
  cohenlist.main[[Hemi_Region]] = cohen.d
  }

cohen.d.mainlme <- contrasts.mainlme %>%
  left_join(as.tibble(bind_rows(cohenlist.main[1:52])), by=c("hemi_region", "contrast")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

cohen.d.mainlme %>%
  dplyr::select(labeller, contrast, p.adj_formatted, adj.signif, cohens.d) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Contrast (pairwise group differences)", "p-value (FDR-adjusted)", "Adjusted significance", "Effect size: Cohen's d"), 
               caption = "Main LME model for whole thalamus and thalamus nuclei volumes: Contrasts table including effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  column_spec(5, bold=TRUE) %>%
  pack_rows(index = table(fct_inorder(cohen.d.mainlme$hemi_region_group))) #%>%
  #save_kable("figures/effects_main.png", zoom=6)
```

```{r 2maincohensd, results="asis", message=FALSE, warning=FALSE}
# Effect size statistics (Cohen's d) for relative LME model: SD estimate for LME - NOT residual SD!, instead manually computed total SD of the population (computation via Pythagorean Theorem); infinite degrees of freedom assumed (i.e., we claim we know sigma = total SD perfectly => affects SE and confidence levels only, does not affect effect size estimate)
# Computation as loop (was not possible via nest and map!)

## Main LME model
cohenlist.main2 = list()

for (Hemi_Region in unique(lme$hemi_region)) {
  
  SDtotal <- lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal)
  
  cohen.d <- lme %>%
    dplyr::select(hemi_region, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohen.d = map(emmeans, ~ as.tibble(emmeans::eff_size(.x, sigma = SDtotal, edf = Inf, method = list(
      "acAN-TP2 vs. acAN-TP1" = acAN_TP2.lme - acAN_TP1.lme,
      "acAN-TP2 vs. recAN" = acAN_TP2.lme - recAN.lme,
      "acAN-TP2 vs. HC" = acAN_TP2.lme - HC.lme,
      "recAN vs. HC" = recAN.lme - HC.lme))))) %>%
    unnest(cohen.d) %>%
    mutate(cohens.d = abs(as.numeric(formatC(effect.size, format="f", digits=2)))) %>% # absolute/positive values
    dplyr::select(hemi_region, contrast, cohens.d)
  
  cohenlist.main2[[Hemi_Region]] = cohen.d
  }

cohen.d.mainlme2 <- contrasts.mainlme.wholethal %>%
  left_join(as.tibble(bind_rows(cohenlist.main2[1:52])), by=c("hemi_region", "contrast")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

cohen.d.mainlme2 %>%
  dplyr::select(labeller, contrast, p.adj_formatted, adj.signif, cohens.d) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Contrast (pairwise group differences)", "p-value (FDR-adjusted)", "Adjusted significance", "Effect size: Cohen's d"), 
               caption = "Main LME model for whole thalamus and thalamus nuclei volumes: Contrasts table including effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  column_spec(5, bold=TRUE) %>%
  pack_rows(index = table(fct_inorder(cohen.d.mainlme2$hemi_region_group))) #%>%
  #save_kable("figures/effects_main.png", zoom=6)
```

```{r smcohensd, results="asis", message=FALSE, warning=FALSE}
## SM LME model
cohenlist.sm = list()

for (Hemi_Region in unique(sm.lme$hemi_region)) {
  
  SDtotal <- sm.lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal)
  
  cohen.d <- sm.lme %>%
    dplyr::select(hemi_region, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohen.d = map(emmeans, ~ as.tibble(emmeans::eff_size(.x, sigma = SDtotal, edf = Inf, method = list(
      "acAN-TP1 vs. HC" = acAN_TP1.smlme - HC.smlme,
      "acAN-TP1 vs. recAN" = acAN_TP1.smlme - recAN.smlme,
      "acAN-TP1 vs. acAN-TP2" = acAN_TP1.smlme - acAN_TP2.smlme))))) %>%
    unnest(cohen.d) %>%
    mutate(cohens.d = abs(as.numeric(formatC(effect.size, format="f", digits=2)))) %>%
    dplyr::select(hemi_region, contrast, cohens.d)
  
  cohenlist.sm[[Hemi_Region]] = cohen.d
  }

cohen.d.smlme <- contrasts.smlme %>%
  left_join(as.tibble(bind_rows(cohenlist.sm[1:52])), by=c("hemi_region", "contrast")) %>%
  arrange(hemi_region) %>% 
  mutate(hemi_region_group = dplyr::recode(hemi_region, !!!variables_grouper.thal, 
                                       .default = "missing group"))

cohen.d.smlme %>%
  dplyr::select(labeller, contrast, p.adj_formatted, adj.signif, cohens.d) %>%
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "Contrast (pairwise group differences)", "p-value (FDR-adjusted)", "Adjusted significance", "Effect size: Cohen's d"), 
               caption = "SM-modified LME model for whole thalamus and thalamus nuclei volumes: Contrasts table including effect size statistics (only contrast acAN-TP1 vs. HC => reproduce cross-sectional thalamus nuclei paper)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  column_spec(5, bold=TRUE) %>%
  pack_rows(index = table(fct_inorder(cohen.d.smlme$hemi_region_group))) #%>%
  #save_kable("figures/effects_sm.png", zoom=6)
```

## Reproduce main LME model findings using independent statistical approaches
### Simple paired analysis acAN-TP2 vs. acAN-TP1 (main sample)
```{r smpairedtest, results="asis", message=FALSE, warning=FALSE}
paired.tests <- sample %>%
  filter(por %in% "acAN") %>%
  dplyr::select(hemi_region, labeller, region, whole.sub, participant_id, point_of_research, measure) %>%
  mutate(point_of_research = relevel(point_of_research, ref="T2")) %>% # T2 is reference group (TP2 vs. TP1)
  nest(-c(hemi_region, labeller, region, whole.sub)) %>%
  mutate(
    ttest = map(data, ~ t.test(measure ~ point_of_research, data = .x, paired=TRUE, alternative="two.sided",
                               var.equal=FALSE)), # paired t-tests: df = n-1 (111 - 1 = 110)
    ttesttidy = map(ttest, tidy)) %>%
  unnest(ttesttidy) %>%
  group_by(whole.sub) %>%
  mutate(p.adj = p.adjust(p.value, method="fdr")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  mutate(adj.signif_fig = as.character(asterisk_function_fig(p.adj))) %>%
  ungroup() %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.value_formatted = ifelse(p.value<0.001, "< 0.001", p.value_formatted)) %>%
  mutate(p.adj_formatted = formatC(p.adj, format="f", digits=3)) %>%
  mutate(p.adj_formatted = ifelse(p.adj<0.001, "< 0.001", p.adj_formatted)) %>%
  arrange(hemi_region)

paired.tests %>%
  dplyr::select(labeller, statistic, parameter, p.value_formatted, p.adj_formatted, adj.signif) %>% # function abs() = absolute value / Betrag (if t-values < 0 which does not affect significance)
  knitr::kable(format = "html", align = "l", col.names = c("thalamus (sub)region", "t-value", "df", "p-value (raw)", 
                                                           "p-value (FDR-adjusted)", "Adjusted significance"), 
               caption = "Reproduce main LME model findings: Paired-samples t-tests acAN-TP2 vs. acAN-TP1 (main sample)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("Reproduce main LME? - YES!"=6), align="l")

means.paired <- sample %>%
  filter(por %in% "acAN") %>%
  group_by(hemi_region, point_of_research) %>%
  mutate(mean = mean(measure, na.rm=TRUE)) %>%
  mutate(std.error = std.error(measure, na.rm=TRUE)) %>%
  distinct(hemi_region, .keep_all=TRUE) %>%
  ungroup() %>%
  dplyr::select(labeller, region, point_of_research, mean, std.error)
```

```{r smbarplotspaired, fig.cap="Reproduce main LME model findings: Paired-samples t-tests acAN-TP2 vs. acAN-TP1 (main sample)", message=FALSE, warning=FALSE}
bardata.paired <- means.paired %>%
  dplyr::select(labeller, region, point_of_research, mean, std.error) %>%
  arrange(region) %>%
  mutate(point_of_research = dplyr::recode(point_of_research,
                                    "T1" = "acAN-TP1",
                                    "T2" = "acAN-TP2")) %>%
  mutate(point_of_research = fct_relevel(point_of_research, c("acAN-TP1", "acAN-TP2"))) %>%
  mutate(xlabels = ifelse(region %in% "Whole_thalamus", TRUE, FALSE))

plotlist = list()

for (Region in unique(bardata.paired$region)) {
  
  plotdata <- bardata.paired %>% filter(region %in% Region)
  
  y.position <- means.paired %>% 
    filter(region %in% Region) %>%
    arrange(desc(mean), .by_group=TRUE) %>%
    slice_head(n = 1) %>%
    mutate(ymin = round((0.90*mean)-5, -1)) %>%
    mutate(ymax = round((1.05*mean)+5, -1)) %>% 
    mutate(signif.position_paired = (0.15*(ymax-ymin)) + (mean+std.error)) %>%
    mutate(tipl = 0.15) %>% 
    dplyr::select(region, ymin, ymax, signif.position_paired, tipl)

   longi.line <- means.paired %>%
    filter(region %in% Region) %>%
    mutate(point_of_research = dplyr::recode(point_of_research,
                                   "T1" = "y",
                                   "T2" = "yend")) %>% 
    dplyr::select(labeller, point_of_research, mean) %>%
    pivot_wider(names_from = point_of_research, values_from = mean) %>%
    mutate(x = 1) %>%
    mutate(xend = 2)
   
  signif.paired <- paired.tests %>%
    filter(region %in% Region) %>%
    left_join(y.position, by="region") %>%
    mutate(xmin = 1) %>%
    mutate(xmax = 2)

  barplots <- plotdata %>%
    ggplot(aes(x = point_of_research, y = mean)) +
    geom_col(aes(fill = point_of_research, color = point_of_research), stat = "identity", color = NA, width=1.0, 
             position = position_dodge()) +
    geom_errorbar(aes(ymin = mean-std.error, ymax = mean+std.error), 
                  width = 0.3, size = 1.25, color = "BLACK",
                 position = position_dodge(1)) +
    geom_segment(data = longi.line, aes(x = x, xend = xend, y = y, yend = yend), color="BLACK", size = 1.25, 
                 linetype = "21212121") +
    geom_signif(data = signif.paired, aes(annotations = adj.signif_fig, y_position = signif.position_paired, 
                                         xmin = xmin, xmax = xmax, tip_length = tipl), 
                textsize = 9, vjust = -0.1, color = "BLACK", manual = TRUE) +
    scale_y_continuous(breaks = pretty_breaks(n=3), labels = scales::comma_format(big.mark = ",",
                                                                                  decimal.mark = ".",
                                                                                  accuracy=1L)) +
    coord_cartesian(ylim = c(y.position$ymin, y.position$ymax)) +
    scale_fill_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000"), 0.8)) + 
    scale_color_manual(values = alpha(c("#374E55FF", "#00468BFF", "#000000"), 0.8)) +
    plot_theme_transparent + 
    theme(axis.text.x = element_text(size = 28, angle=45, hjust=1)) +
    theme(axis.title.x = element_blank(), axis.ticks.x = element_blank(), axis.title.y = element_blank(),
          axis.ticks.y = element_line(size=1.5), axis.ticks.length.y=unit(.25, "cm")) +
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
    guides(fill = FALSE, color = FALSE) +
    facet_wrap(~ labeller, scales="free_x", labeller = label_wrap_gen(width=15)) +
    theme(panel.spacing = unit(1.75, "cm"))
    
  
  if(plotdata$xlabels == FALSE) {
   barplots = barplots + 
     theme(axis.text.x = element_blank())
   }
  
 plotlist[[Region]] = barplots
 
}

bp.whole <- plotlist$Whole_thalamus
bp.nuclei <- plotlist[2:25] 

barplotarrange <- ggarrange(bp.whole, 
          ggarrange(plotlist=bp.nuclei, ncol=5, nrow=5),
          ncol=2, nrow=1, widths=c(1, 2.5)) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), size=28, rot=90))

barplotarrange

#ggsave(barplotarrange, path="figures", filename="barplots_paired.png", width=32, height=25, dpi=600)
```


##RLMs 
```{r robustregressionnuclei, results="asis", message=FALSE, warning=FALSE}
sample_regression <- left_join(sample, redcap_total, by="storage_name") %>%
dplyr::select(storage_name, 
              bmisds_at_date_of_research.x, 
              resultquest_bdi2_total, 
              resultquest_edi2_ss,
              resultquest_edi2_uk,
              resultquest_edi2_iw, 
              resultquest_scl90r_skazwang)

cordata.rlm1 <- contrasts.mainlme.wholethal %>%
  dplyr::select(hemi_region, p.value) %>%
  right_join(sample, by="hemi_region") %>%
  mutate(hemi_region = factor(hemi_region, levels=c('lh_Whole_thalamus','rh_Whole_thalamus',
                                                   'lh_AV','rh_AV',
                                                   'lh_LD','rh_LD',
                                                   'lh_LP','rh_LP',
                                                   'lh_VA','rh_VA',
                                                   'lh_VAmc','rh_VAmc',
                                                   'lh_VLa','rh_VLa',
                                                   'lh_VLp','rh_VLp',
                                                   'lh_VPL','rh_VPL',
                                                   'lh_VM','rh_VM',
                                                   'lh_CeM','rh_CeM',
                                                   'lh_CL','rh_CL',
                                                   'lh_Pc','rh_Pc',
                                                   'lh_CM','rh_CM',
                                                   'lh_Pf','rh_Pf',
                                                   'lh_Pt','rh_Pt',
                                                   'lh_MV(Re)','rh_MV(Re)',
                                                   'lh_MDm','rh_MDm',
                                                   'lh_MDl','rh_MDl',
                                                   'lh_LGN','rh_LGN',
                                                   'lh_MGN','rh_MGN',
                                                   'lh_L-Sg','rh_L-Sg',
                                                   'lh_PuA','rh_PuA',
                                                   'lh_PuM','rh_PuM',
                                                   'lh_PuL','rh_PuL',
                                                   'lh_PuI','rh_PuI'))) %>%
  # filter(region != "Whole_thalamus") %>%
  left_join(sample_regression, by="storage_name") %>% 
  dplyr::select(storage_name, 
                hemi_region, 
                labeller, 
                age_at_date_of_research, 
                e_tiv, 
                measure, 
                bmisds_at_date_of_research, 
                research_blood_results_leptin, 
                resultquest_bdi2_total, 
                resultquest_edi2_ss,
                resultquest_edi2_uk,
                resultquest_edi2_iw, 
                resultquest_scl90r_skazwang) %>%
  pivot_longer(-c(storage_name, hemi_region, labeller, age_at_date_of_research, e_tiv, measure), 
               names_to = "demo_variable", values_to = "value") %>%
  nest(-c(hemi_region, labeller, demo_variable)) %>%
  mutate(
    rlm = map(data, ~ rlm(value ~ measure + age_at_date_of_research + e_tiv, data=.x, na.action = na.omit)),
    tidyrlm = map(rlm, tidy),
    tidyrlm = map(tidyrlm, ~ rename(.x, t.value = statistic)),
    testrlm = map(rlm, ~ f.robftest(.x, var = "measure")),
    tidytestrlm = map(testrlm, tidy),
    tidytestrlm = map(tidytestrlm, ~ rename(.x, F.value = statistic)),
    filterrlm = map(tidyrlm, ~ filter(.x, term %in% "measure"))) %>%
  unnest(tidytestrlm, filterrlm) %>%
  mutate(unadj.signif = as.character(asterisk_function(p.value))) %>%
  mutate(p.adj = p.adjust(p.value, method="BH")) %>%
  mutate(adj.signif = as.character(asterisk_function(p.adj))) %>%
  dplyr::select(hemi_region, labeller, demo_variable, t.value, p.value, unadj.signif, p.adj, adj.signif) %>%
  mutate(p.value = formatC(p.value, format="f", digits=3)) %>%
  mutate(p.adj = formatC(p.adj, format="f", digits=3)) %>% ## adjusted digits of adjusted p value.
  mutate(t.value = formatC(t.value, format="f", digits=3)) %>% ## adjusted digits of adjusted t value.
  nest(-c(hemi_region, labeller, demo_variable)) %>%
  group_by(hemi_region) %>%
  pivot_wider(names_from = "demo_variable", values_from = "data") %>%
  unnest(bmisds_at_date_of_research, 
         research_blood_results_leptin, 
         resultquest_bdi2_total,
         resultquest_edi2_ss,
         resultquest_edi2_uk,
         resultquest_edi2_iw,
         resultquest_scl90r_skazwang)  %>%
  arrange(hemi_region) %>%
  mutate(hemi_region = as.character(hemi_region)) %>%
  ungroup()

#write.csv2(cordata.rlm1,"tables/correlation_results_RLM1_C.csv", row.names = FALSE)


 cordata.rlm1 %>%
   dplyr::select(-c(hemi_region)) #%>%
   knitr::kable(format = "html", digits=2, align = "l", col.names=c("Thalamus (sub-)regions (GLM adj. whole thalamus, p.adj<0.05)", rep(c("t", "p", "Unadj. signif.", "p.adj", "Adj. signif."), 8)), caption = "Robust regression models in acAN-T1 (adjusted for participant age and eTIV)") %>%
kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
   add_header_above(c(" ", "Thalamus ~ Current BMI-SDS"=5, "Thalamus ~ Leptin"=5, "Thalamus ~ Duration of illness"=5, "Thalamus ~ BDI-II total score"=5, "Thalamus ~ EDI-2 Drive for thinness"=5, "Thalamus ~ EDI-2 Body dissatisfaction"=5, "Thalamus ~ EDI-2 Interoceptive awareness"=5,"Thalamus ~ SCL-90-R Compulsiveness"=5), align="l")# %>%
   #pack_rows(index = table(fct_inorder(cordata.rlm1$variables_group))) #%>%
   #save_kable(file="tables/thalamus_RLM1_FDR.png", zoom=5)
```

### RLM with change scores for longi data###
```{r regressionlongi, results="asis", message=FALSE, warning=FALSE}
#for loop for change scores of Thalamus (nuclei) volumes

```

```{r RLM, results="asis", message=FALSE, warning=FALSE}
# RLMs for acAN-TP2
contrasts.mainlme.wholethal %>%
  filter((contrast %in% "acAN-TP2 vs. acAN-TP1") & (p.adj < 0.05)) %>%
  dplyr::select(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  filter(point_of_research %in% "T2") %>%
  dplyr::select(storage_name, hemi_region, labeller, measure, age_at_date_of_research, e_tiv,
                bmisds_at_date_of_research, research_blood_results_leptin, 
                resultquest_bdi2_total, edi_core, resultquest_scl90r_skazwang) %>%
  pivot_longer(-c(storage_name, hemi_region, labeller, age_at_date_of_research, e_tiv, measure), 
               names_to = "demo_variable", values_to = "value") %>%
  nest(-c(hemi_region, labeller, demo_variable)) %>%
  mutate(
    rlm = map(data, ~ rlm(value ~ measure + age_at_date_of_research + e_tiv, data=.x, na.action = na.omit)),
    rlmtidy = map(rlm, tidy),
    rlmtidy = map(rlmtidy, ~ rename(.x, t.value = statistic)),
    rlmtest = map(rlm, ~ f.robftest(.x, var="measure")), # predictor = amygdala volume
    rlmtesttidy = map(rlmtest, tidy),
    rlmtesttidy = map(rlmtesttidy, ~ rename(.x, F.value = statistic)),
    rlmfiltered = map(rlmtidy, ~ filter(.x, term %in% "measure"))) %>%
  unnest(rlmfiltered, rlmtesttidy) %>%
  mutate(unadj.signif = as.character(asterisk_function(p.value))) %>%
  mutate(t.value_formatted = formatC(t.value, format="f", digits=2)) %>%
  mutate(p.value_formatted = formatC(p.value, format="f", digits=3)) %>%
  dplyr::select(hemi_region, labeller, demo_variable, t.value_formatted, p.value_formatted, 
                unadj.signif) %>%
  nest(-c(hemi_region, labeller, demo_variable)) %>%
  group_by(hemi_region) %>%
  pivot_wider(names_from = "demo_variable", values_from = "data") %>%
  unnest(bmisds_at_date_of_research, research_blood_results_leptin, resultquest_bdi2_total,
         edi_core, resultquest_scl90r_skazwang) %>%
  ungroup() %>%
  arrange(hemi_region) %>%
  dplyr::select(-hemi_region) %>%
  knitr::kable(format = "html", align = "l", col.names=c("Thalamus (sub)region significantly different from T1", rep(c("t", "p", "Unadj. signif."), 5)), 
               caption = "Robust linear regression models at acAN-TP2 (adjusted for age and eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "Thalamus ~ Current BMI-SDS"=3, "Thalamus ~ Leptin"=3, "Thalamus ~ BDI-II total score"=3, "Thalamus ~ EDI-2 core symptoms"=3, "Thalamus ~ SCL-90-R Zwang"=3), align="l") #%>%
  #add_header_above(c("No significant relationships between amygdala nuclei volumes significantly different from HC according to main LME model and any of the assessed clinical measures (BMI-SDS, leptin concentration, psychiatric symptoms) at acAN-TP2."=19), align="l") #%>%
  #save_kable("figures/rlms_T2.png", zoom=6)
```