---
title: "Longitudinal amygdala nuclei project"
author: "MW"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: yes
    toc_depth: 5
    highlight: tango
    theme: paper
    fig_width: 32
    fig_height: 22
    fig_caption: yes
    number_sections: yes
    keep_md: yes
    df_print: default
editor_options: 
  markdown: 
    wrap: 72
---v
---

# Project summary

Longitudinal sMRI study on amygdala nuclei volumes over the course of
short-term weight-restoration (acAN-TP1 ... acAN-TP2) and in long-term
weight-recovered individuals with former AN in comparison to healthy
control participants.

# Library of applied R packages

```{r library, message=FALSE, warning=FALSE}
options(contrasts=c("contr.sum", "contr.poly")) # needed for type III SS tests (ANOVA, does not change Type I or II SS results)

setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

# Github installations
library(devtools)

# Tidy data
library(tidyverse)
library(broom.mixed)
#library(tidymodels)

# for data import (e.g. read_csv() and .txt)
# for data transformation (e.g. mutate(), filter(), group_by(), join())
# for data wrangling (e.g. unnest(), gather(), spread())
# for applying functions and working with lists (e.g. map(), reduce(), transpose())
# for string manipulation (e.g. str_detect(), str_extract(), str_subset(); string pattern - regular expressions)
# for dealing with factors (e.g. reordering)

# Graphs
library(ggplot2) # for data visualization (plotting)
library(cowplot) # extends functionality of ggplot2 (e.g. create raincloud plots)
library(ggsci) # alternative color tool/palettes for plotting (scientific journal style)
library(ggpubr) # extends functionality of ggplot2 (e.g. editing options for publication)
library(ggsignif) # for adding significance brackets and labels to ggplots (better compatible with geom_boxplot() than ggpubr)
library(ggpattern)
library(ggtext)
#library(ggbreak)
#library(gg.gap)
library(lemon)
library(grid)
library(Hmisc) # Contains many functions useful for data analysis, high-level graphics, utility operations, functions for computing sample size and power, simulation, importing and annotating datasets, imputing missing values, advanced table making, variable clustering, character string manipulation, conversion of R objects to LaTeX and html code, and recoding variables.

# HTML output
library(kableExtra) # for creating kables (customized tables in RMarkdown output with styling options)
library(bookdown) # support for numbering figure and table captions

# Statistics
library(rstatix) # for statistical tests (in combination with dplyr/piping and plotting) and summary statistics
library(car) # for statistical models (ANCOVA with type III errors), dummy coding
library(fastDummies)
library(MASS) # for robust linear models (RLM)
library(sfsmisc) # Robust F-Test: Wald test for multiple coefficients of rlm() 
library(sjstats) # for effect size statistics
library(effectsize) # for effect size statistics (e.g. eta squared, Cohen's d)
#library(lsr) # for effect size statistics
library(plotrix) # standard error of the mean computation
library(lme4) # for linear mixed effects modeling
library(lmerTest) # p-values for linear mixed effects models via Satterthwaite or Kenward-Roger approximations
library(EMAtools) # Cohen's D for each effect in an lme4 object.
library(pbkrtest) # required for Kenward-Roger ddf (lme)
library(emmeans) # for estimated marginal means (EMM) and contrasts after LME
library(pwr) # basic functions for power analysis
library(MatchIt) # for propensity (e.g. age, IQ) matching
library(optmatch) # for optimal propensity matching
library(DescTools) # interrater reliability
library(matlib) # for GramSchmidt procedure
library(mediation) # for mediation analysis

# Multiple imputation
library(mice)
library(lodi)
library(miceadds)
library(mitools)
library(mitml)

# Tidy statistical output
library(scales) # for scale and percentage formatting (optional)

# Not used
#install_github("willemsleegers/tidystats")
#library(tidystats)
#library(lsmeans) # see emmeans (older version of emmeans)
#library(predictmeans) # alternative: predict means from lmer
#library(multcomp) # General linear hypotheses and multiple comparisons for parametric models, including generalized linear models, linear mixed effects models, and survival models
#library(afex) # for mixed ANOVAs (not preferred!, LME4 is preferred instead)
#library(pracma) # for GramSchmidt procedure

# Citations
paste(R.Version()[c("major", "minor")], collapse=".")
citation("lme4")
citation("emmeans")
citation("MASS")
citation("MatchIt")
citation("ggplot2")
citation("ggplot2")
citation("mice")
citation("lodi")
```

# Labelling and plot basics

```{r figuresettings, message=FALSE, warning=FALSE}
asterisk_function <- function(x) {
  ifelse(is.na(x), NA, 
  symnum(x, corr=FALSE, na=FALSE, legend=FALSE,
         cutpoints=c(0, 0.001, 0.01, 0.05, 1), 
         symbols=c("* * *", "* *", "*", "ns"))
  )
}


plot_theme_transparent=theme(plot.title=element_text(size=35, 
                                                         color="black", face="bold"), 
                   strip.text=element_text(size=35, color="black"), 
                   strip.text.x=element_text(size=35, color="black"),
                   axis.text.y=element_text(size=35, color="black"),
                   axis.text.x=element_text(size=35,  color="black"),
                   axis.title=element_text(size=35, color="black"), 
                   axis.line=element_line(color="black", size=1.5), 
                   panel.background=element_rect(fill="white"), 
                   plot.background=element_rect(fill="white", color=NA), 
                   panel.border=element_blank(),
                   panel.grid.major=element_blank(), 
                   panel.grid.minor=element_blank(), 
                   strip.background=element_rect(color=NA))
```

```{r}
# Code for creating raincloud plots (geom flat violin, will be used later to visualize data distribution)
"%||%" <- function(a, b) {
  if (!is.null(a)) a else b
}

geom_flat_violin <- function(mapping=NULL, data=NULL, stat="ydensity",
                        position="dodge", trim=TRUE, scale="area",
                        show.legend=NA, inherit.aes=TRUE, ...) {
  layer(
    data=data,
    mapping=mapping,
    stat=stat,
    geom=GeomFlatViolin,
    position=position,
    show.legend=show.legend,
    inherit.aes=inherit.aes,
    params=list(
      trim=trim,
      scale=scale,
      ...
    )
  )
}

GeomFlatViolin <-
  ggproto("GeomFlatViolin", Geom,
          setup_data=function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)
            
            # ymin, ymax, xmin, and xmax define the bounding rectangle for each group
            data %>%
              group_by(group) %>%
              mutate(ymin=min(y),
                     ymax=max(y),
                     xmin=x,
                     xmax=x + width / 2)
            
          },
          
          draw_group=function(data, panel_scales, coord) {
            # Find the points for the line to go all the way around
            data <- transform(data, xminv=x,
                              xmaxv=x + violinwidth * (xmax - x))
            
            # Make sure it's sorted properly to draw the outline
            newdata <- bind_rows(plyr::arrange(transform(data, x=xminv), y),
                             plyr::arrange(transform(data, x=xmaxv), -y))
            
            # Close the polygon: set first and last point the same
            # Needed for coord_polar and such
            newdata <- bind_rows(newdata, newdata[1,])
            
            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, 
                                                                        panel_scales,
                                                                        coord))
          },
          
          draw_key=draw_key_polygon,
          
          default_aes=aes(weight=1, colour="gray20", fill="white", size=0.5,
                            alpha=NA, linetype="solid"),
          
          required_aes=c("x", "y")
)
```

```{r labellingfunctions, message=FALSE, warning=FALSE}
recode.region1 <- function(x) {
  dplyr::recode(x,
                "Whole-amygdala"="Whole_amygdala", 
                "Accessory-Basal-nucleus"=
                  "Accessory_basal_nucleus",
                "Anterior-amygdaloid-area-AAA"=
                  "Anterior_amygdaloid_area",
                "Basal-nucleus"="Basal_nucleus",
                "Central-nucleus"="Central_nucleus",
                "Cortical-nucleus"="Cortical_nucleus",
                "Corticoamygdaloid-transitio"=
                  "Corticoamygdaloid_transitio",
                "Lateral-nucleus"="Lateral_nucleus",
                "Medial-nucleus"="Medial_nucleus",
                "Paralaminar-nucleus"="Paralaminar_nucleus") 
  }

recode.region2 <- function(x) {
  dplyr::recode(x,
                "Whole_amygdala"="Whole amygdala",
                "Accessory_basal_nucleus"="Accessory basal nucleus",
                "Anterior_amygdaloid_area"="Anterior amygdaloid area",
                "Basal_nucleus"="Basal nucleus",
                "Central_nucleus"="Central nucleus",
                "Cortical_nucleus"="Cortical nucleus",
                "Corticoamygdaloid_transitio"="Cortico- amygdaloid transition",
                "Lateral_nucleus"="Lateral nucleus",
                "Medial_nucleus"="Medial nucleus",
                "Paralaminar_nucleus"="Paralaminar nucleus")
  }

levels.region <- function(x) {
  factor(x, levels=c("Whole_amygdala", "Basal_nucleus", "Lateral_nucleus",
                     "Accessory_basal_nucleus", "Cortical_nucleus",
                     "Corticoamygdaloid_transitio", "Medial_nucleus",
                     "Central_nucleus", "Anterior_amygdaloid_area",
                     "Paralaminar_nucleus"))
  }

levels.hemi_region <- function(x) {
  factor(x, levels=c("lh_Whole_amygdala", "rh_Whole_amygdala", 
                     "lh_Basal_nucleus", "rh_Basal_nucleus",
                     "lh_Lateral_nucleus", "rh_Lateral_nucleus",
                     "lh_Accessory_basal_nucleus", 
                     "rh_Accessory_basal_nucleus",
                     "lh_Cortical_nucleus", "rh_Cortical_nucleus",
                     "lh_Corticoamygdaloid_transitio",
                     "rh_Corticoamygdaloid_transitio", 
                     "lh_Medial_nucleus", "rh_Medial_nucleus",
                     "lh_Central_nucleus", "rh_Central_nucleus",
                     "lh_Anterior_amygdaloid_area",
                     "rh_Anterior_amygdaloid_area",
                     "lh_Paralaminar_nucleus", "rh_Paralaminar_nucleus"))
  }

labeller.desc <- function(x) {
  dplyr::recode(x,
                "age_at_date_of_research"="Age (years)",
                "iq"="IQ",
                "bmi_at_date_of_research"="BMI (kg/m\u00B2)",
                "bmisds_at_date_of_research"="BMI-SDS",
                "minbmi"="Minimal lifetime BMI (kg/m\u00B2)",
                "leptin"="Leptin (µg/L)",
                "log_leptin"="Log10-leptin",
                "e_tiv"="eTIV (mm\u00B3)",
                "subcort_gray"="Subcortical GM volume (mm\u00B3)",
                "edi_core"="EDI-2 core symptoms",
                "resultquest_bdi2_total"="BDI-II total",
                "stai_s"="STAI(K) State Anxiety",
                "stai_t"="STAI(K) Trait Anxiety",
                "resultquest_scl90r_skagloba"="SCL-90-R GSI",
                "delta_date_of_research_T2"="Time period TP2-TP1 (days)",
                "delta.p_bmi_at_date_of_research_T2"="∆BMI (%)")
  }

# Custom order of descriptive variables 
order.desc <- function(x) {
  factor(x, 
         levels=c("age_at_date_of_research", "iq", 
                  "bmi_at_date_of_research", "bmisds_at_date_of_research",
                  "minbmi", "leptin", "log_leptin",
                  "e_tiv", "subcort_gray", "edi_core", 
                  "resultquest_bdi2_total", "stai_s", "stai_t",
                  "resultquest_scl90r_skagloba"))
  }

# Grouping of descriptive variables
variables_grouper.desc <- c(age_at_date_of_research="Demographics", 
               iq="Demographics", 
               bmi_at_date_of_research="Demographics", 
               bmisds_at_date_of_research="Demographics",
               minbmi="Demographics",
               leptin="Hormone parameter",
               log_leptin="Hormone parameter",
               e_tiv="Brain segmentation volumes",
               subcort_gray="Brain segmentation volumes",
               edi_core="Symptoms",
               resultquest_bdi2_total="Symptoms",
               stai_s="Symptoms",
               stai_t="Symptoms",
               resultquest_scl90r_skagloba="Symptoms")
```

# Data preparation steps

## Redcap import

```{r redcapimport, message=FALSE, warning=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

redcap <- read_csv("data/redcap.csv") %>%
  filter(point_of_research %in% c("T1", "T2", "recAN", "HCW")) %>%
  filter(str_detect(redcap_event_name, "atd1_[0-9]_arm_8", negate=TRUE)) %>%
  filter(!is.na(storage_name)) %>% 
  filter(!is.na(age_at_date_of_research)) # remove unavailable data from Redcap import and remove atd study arm

redcap_analysis <- redcap %>%
  dplyr::select(storage_name, point_of_research, participant_id,
                date_of_research, research_blood_taking_date,
                age_at_date_of_research, bmisds_at_date_of_research,
                bmi_at_date_of_research, iq, minbmi,
                contains("leptin"), onset_of_an, recovered_since_months,
                resultquest_edi2_total, resultquest_edi2_ss,
                resultquest_edi2_uk,
                resultquest_edi2_b,
                resultquest_bdi2_total,
                resultquest_scl90r_skagloba, 
                stai_s_gs, stai_t_gs, staik_s_gs, staik_t_gs) %>%
  mutate(stai_s=ifelse(is.na(stai_s_gs), staik_s_gs, stai_s_gs)) %>%
  mutate(stai_t=ifelse(is.na(stai_t_gs), staik_t_gs, stai_t_gs)) %>%
  mutate(edi_core=(resultquest_edi2_ss + resultquest_edi2_uk + resultquest_edi2_b)/3) %>%
  dplyr::rename(leptin_clinical=clinical_blood_results_leptin,
                leptin_result=research_blood_results_leptin,
                leptin_batch=research_blood_results_leptin_batch,
                leptin_date=research_blood_results_leptin_date) %>%
  mutate(leptin2021=ifelse(grepl("2021", leptin_batch), TRUE, FALSE)) %>%
  mutate(leptin_batch=ifelse(storage_name=="64-10-450-1_T1_conni",
                             "Magedburg022017", leptin_batch)) %>%
  mutate(leptin_batch_recoded=case_when(
    leptin_batch=="Magdeburg2014" ~"batch1",
    leptin_batch=="Magdeburg2015" ~"batch2",
    leptin_batch=="Magedburg022017" ~"batch3",
    leptin_batch=="Magdeburg2021" ~"batch4",
    is.na(leptin_batch) ~"batch2")) %>%
  dplyr::select(-c(resultquest_edi2_b, stai_s_gs, stai_t_gs, 
                staik_s_gs, staik_t_gs, leptin_batch))

redcap_clinical <- redcap %>%
                      dplyr::select(storage_name,
                                    siabex_age_onset,
                                    siabex_result_an_type,
                                    siabex_past_result_an_type,
                                    hand_preference_total_value,
                                    hand_preference_cat,
                                    psychiatric_disorders,
                                    depressive_disorders, 
                                    obsessivecompulsive_disorders, 
                                    anxiety_disorders, 
                                    addiction, 
                                    ptsd, 
                                    tic_tourette,
                                    conduct_disorder,
                                    defiant_behaviour,
                                    adaption_disorder,
                                    psychosis,
                                    attention_deficit_hyperactivity_disorder,
                                    personality_disorders,
                                    developmental_disorders,
                                    other_psychiatric_disorders,
                                    spec_other_psychiatric_disorders,
                                    current_medication,
                                    type_of_current_medication___1, 
                                    type_of_current_medication___2, 
                                    type_of_current_medication___3, 
                                    type_of_current_medication___4, 
                                    type_of_current_medication___5, 
                                    recent_medication,	
                                    type_of_recent_medication___1, 
                                    type_of_recent_medication___2, 
                                    type_of_recent_medication___3,	
                                    type_of_recent_medication___4,
                                    type_of_recent_medication___5,
                                    current_antidepressants_preparation,
                                    recent_antidepressants_preparation,
                                    current_neuroleptic_drug_preparation,
                                    recent_neuroleptic_drug_preparation, 
                                    recent_benzodiazepine_preparation,
                                    current_smoking, 
                                    current_cigarettes_per_day, 
                                    current_duration_of_smoking, 
                                    ever_smoking,
                                    ever_cigarettes_per_day,
                                    siabex_question_21_an_type,
                                    siabex_question_26_alcohol_abuse, 
                                    siabex_question_27_drug_abuse,
                                    siabex_past_question_26_alcohol_abuse,
                                    siabex_past_question_27_drug_abuse,
                                    resultquest_scl90r_skasomat,
                                    resultquest_scl90r_skazwang, 
                                    resultquest_scl90r_skaunsic, 
                                    resultquest_scl90r_skadepre,
                                    resultquest_scl90r_skaangst, 
                                    resultquest_scl90r_skaaggre, 
                                    resultquest_scl90r_skaphobi,
                                    resultquest_scl90r_skaparan, 
                                    resultquest_scl90r_skapsych)
```

## FreeSurfer data import

```{r fsimport, message=FALSE, warning=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

fsdata_long_pre <- read_csv("cache/fsdata_long.csv") %>%
  dplyr::rename(storage_name.long=storage_name) %>%
  extract(storage_name.long, "storage_name",
            "([^.]*)", remove=FALSE) %>%
  filter(analysis=="amygdala")

# Conflicting cases (choose km!)
fsdata_long_pre %>%
  group_by(storage_name) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  mutate(n=n()) %>%
  filter(n>1)

fsdata_long <- fsdata_long_pre %>%
  filter(storage_name.long !="64-10-234-1_T1_suber.long.64-10-234-1_base") %>%
  filter(storage_name.long !="64-10-535-1_T2_braef.long.64-10-535-1_base") 



fsdata_aseg_long_pre <- read_csv("cache/fsasegvolumes_long.csv") %>%
  dplyr::rename(storage_name.long=storage_name) %>%
  extract(storage_name.long, "storage_name",
            "([^.]*)", remove=FALSE)

# Conflicting cases (choose km!)
fsdata_aseg_long_pre %>%
  group_by(storage_name) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  mutate(n=n()) %>%
  filter(n>1)

fsdata_aseg_long <- fsdata_aseg_long_pre %>%
  filter(!str_detect(storage_name.long, "_lGI")) %>%
  filter(storage_name.long !="64-10-234-1_T1_suber.long.64-10-234-1_base") %>%
  filter(storage_name.long !="64-10-535-1_T2_braef.long.64-10-535-1_base") 

fsquality <- read_csv("cache/fsqualitydata_long.csv")
```

## QC summary: Combined amygdala and hippocampus QC

Inter-rater reliability (2 trained raters): Cohen's κ (Cohen,
1960)=0.76, which lies within the range classified as substantial
agreement between raters (Landis and Koch, 1977).\
The absolute counts of exclusions at each QC stage did not significantly
differ between study groups (acAN at TP1 and TP2, recAN, HC) according
to Chi-squared or Fisher's exact tests.

Scan quality outliers (a-priori excluded): CNR and/or SNR,
threshold=mean - 2.698 SD.\
Artifacts in general cortical and subcortical QC (a-priori excluded).\
Note that all subjects after a-priori exclusions received HTML
snapshot-based visual QC.

Fisher's exact test: counts \<5=\> for scan quality exclusions and
visual QC exclusions\
Chi-squared test: counts \>=5=\> for general QC exclusions

```{r qcresults, results='asis', message=FALSE, warning=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

amyghippo_qced <- read_csv("data/amyghippo_qced.csv")

qcdata_pre <- redcap_analysis %>% 
  dplyr::select(storage_name, point_of_research) %>%
  right_join(amyghippo_qced, by="storage_name")

n_storage_name <- qcdata_pre %>% nrow(.)

qcdata <- qcdata_pre %>%
  mutate(remove_quality=ifelse((is.outlier_cnr==TRUE) | (is.outlier_snr==TRUE),
                                 TRUE, FALSE)) %>%
  mutate(remove_general_qc=ifelse((remove_quality==FALSE) & (mriqc_smri_summary==3),
                                    TRUE, FALSE)) %>%
  group_by(point_of_research, .drop=FALSE) %>% 
  mutate(study_groups=n()) %>% 
  mutate(n_remove_quality_groupwise=sum(remove_quality)) %>%
  mutate(n_general_qc_groupwise=study_groups - sum(remove_quality)) %>%
  mutate(n_remove_general_qc_groupwise=sum(remove_general_qc)) %>%
  mutate(n_visual_qc_groupwise=study_groups - sum(remove_quality) - 
           sum(remove_general_qc)) %>%
  mutate(n_visual_exclude_groupwise=sum(mriqc_smri_amhc_summary==9) - 
           sum(remove_quality) - sum(remove_general_qc)) %>%
  mutate(n_include_groupwise=sum(mriqc_smri_amhc_summary==1)) %>%
  ungroup() %>%
  mutate(n_remove_quality=sum(remove_quality)) %>%
  mutate(n_general_qc=n_storage_name - n_remove_quality) %>%
  mutate(n_remove_general_qc=sum(remove_general_qc)) %>%
  mutate(n_visual_qc=n_storage_name - n_remove_quality - n_remove_general_qc) %>%
  mutate(n_freeview=sum(visual_qc)) %>%
  mutate(n_visual_exclude=sum(mriqc_smri_amhc_summary==9) - n_remove_quality -
           n_remove_general_qc) %>%
  mutate(n_include=sum(mriqc_smri_amhc_summary==1))
    
qcsummary <- qcdata %>%
  dplyr::select(point_of_research, study_groups, 
                n_remove_quality, n_remove_quality_groupwise, 
                n_general_qc, n_general_qc_groupwise, 
                n_remove_general_qc, n_remove_general_qc_groupwise, 
                n_visual_qc, n_visual_qc_groupwise,
                n_freeview,  
                n_visual_exclude, n_visual_exclude_groupwise, 
                n_include, n_include_groupwise) %>%
  distinct(point_of_research, .keep_all=TRUE) %>%
  mutate(point_of_research=fct_relevel(point_of_research, 
                                         c("T1", "T2", "recAN", "HCW"))) %>%
  arrange(point_of_research)

qcstatistics_characteristics <- c("CNR and/or SNR outliers: n(subjects)",
                                  "AcAN-TP1",
                                  "AcAN-TP2",
                                  "RecAN",
                                  "HC",
                                  "General QC exclusions: n(subjects)",
                                  "AcAN-TP1",
                                  "AcAN-TP2",
                                  "RecAN",
                                  "HC",
                                  "FreeView QC: n(subjects)",
                                  "FreeView QC exclusions: n(subjects)",
                                  "AcAN-TP1",
                                  "AcAN-TP2",
                                  "RecAN",
                                  "HC",
                                  "Included n(subjects) after all QC stages",
                                  "AcAN-TP1",
                                  "AcAN-TP2",
                                  "RecAN",
                                  "HC")

qcstatistics <- c(unique(qcsummary$n_remove_quality),
                  qcsummary$n_remove_quality_groupwise,
                  unique(qcsummary$n_remove_general_qc),
                  qcsummary$n_remove_general_qc_groupwise,
                  unique(qcsummary$n_freeview),
                  unique(qcsummary$n_visual_exclude),
                  qcsummary$n_visual_exclude_groupwise,
                  unique(qcsummary$n_include),
                  qcsummary$n_include_groupwise)

subjects <- c(n_storage_name,
              qcsummary$study_groups,
              unique(qcsummary$n_general_qc),
              qcsummary$n_general_qc_groupwise,
              unique(qcsummary$n_visual_qc),
              unique(qcsummary$n_visual_qc),
              qcsummary$n_visual_qc_groupwise,
              n_storage_name,
              qcsummary$study_groups)

percentage <- 100*(qcstatistics/subjects)

fisher.quality <- fisher.test(matrix(c(qcsummary$n_general_qc_groupwise, qcsummary$n_remove_quality_groupwise), nrow=4, ncol=2, byrow=FALSE)) %>% tidy() %>% 
  mutate_all(funs(formatC(., format="f", digits=3))) %>%
  pull(p.value) 

chi.general <- chisq.test(matrix(c(qcsummary$n_visual_qc_groupwise, qcsummary$n_remove_general_qc_groupwise), nrow=4, ncol=2, byrow=FALSE)) %>% tidy() %>%
  mutate_all(funs(formatC(., format="f", digits=3))) %>%
  pull(p.value)

fisher.visual <- fisher.test(matrix(c(qcsummary$n_include_groupwise, qcsummary$n_visual_exclude_groupwise), nrow=4, ncol=2, byrow=FALSE)) %>% tidy() %>%
  mutate_all(funs(formatC(., format="f", digits=3))) %>%
  pull(p.value)

tests <- c("",
           fisher.quality,
           rep(c(""),4),
           chi.general,
           rep(c(""),5),
           fisher.visual,
           rep(c(""),8))

tibble(qcstatistics_characteristics, qcstatistics, subjects, percentage, tests) %>%
  unite("n_x_n_total", c(qcstatistics, subjects), sep=" / ", 
        remove=TRUE, na.rm=FALSE) %>%
  knitr::kable(format="html", digits=2, 
               col.names=c("QC characteristics", "n(x) / n(total)", "%",
                             "Chi-squared or Fisher's exact test (p-value)"), 
               align="l", caption="Summary table: Amygdala and hippocampus QC") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## Subjects (not important/has been run before, just included for completeness)

Selection hierarchy: First date of research / first AN episode (TP1:
date closest to admission to minimize early effects of renutrition, TP2:
date closest to discharge); subsegmentation (amygdala and hippocampus)
and general scan quality; for recAN, longer duration of recovery.

```{r subjects01, message=FALSE, warning=FALSE}
redcap_bmi <- redcap_analysis %>%
  dplyr::select(storage_name, bmi_at_date_of_research)

redcap_date <- redcap_analysis %>%
  dplyr::select(storage_name, date_of_research, research_blood_taking_date,
                leptin_result)

uniquesubjects_prep <- qcdata %>%
  filter(!str_detect(storage_name, "atd")) %>% # exclude atd study arm
  left_join(redcap_date, by="storage_name") %>%
  filter(mriqc_smri_amhc_summary==1) %>%
  mutate(id_subset=str_extract(storage_name, 
                                 "64-[0-9][0-9]-[0-9][0-9][0-9]")) %>%
  mutate(outliersum=
           n_outliers_volume_amygdala_2.698sd + n_outliers_symmetry_amygdala_2.698sd) %>%
  mutate(mriqc_smri_summary=ifelse(mriqc_smri_summary %in% c(0,1), 1, 2)) %>% # general QC ratings 0 and 1 are not distinguished (good quality!)
  dplyr::select(storage_name, id_subset, point_of_research, 
                date_of_research, research_blood_taking_date, leptin_result,
                mriqc_smri_summary, outliersum)

# AcAN case selection
uniquesubjects_T1 <- uniquesubjects_prep %>%
  filter(point_of_research=="T1") %>%
  left_join(redcap_bmi, by="storage_name")

uniquesubjects_acAN <- uniquesubjects_prep %>%
  filter(point_of_research=="T2") %>%
  filter(storage_name !="64-10-492-1_T2_dehab") %>% # Take braef scan!
  left_join(redcap_bmi, by="storage_name") %>%
  full_join(uniquesubjects_T1, by="id_subset", suffix=c(".T2", ".T1")) %>%
  filter(is.na(storage_name.T2) | (storage_name.T2 !="64-10-041-1_T2_mop")) %>% # exclusion, subject has only TP2 (no baseline TP1 available or excluded in QC)
  group_by(id_subset) %>%
  mutate(delta_dates=date_of_research.T2 - date_of_research.T1) %>% 
  mutate(delta_dates_leptin.T1=abs(date_of_research.T1 - # aim for minimum time difference between blood draw and MRI scan
           research_blood_taking_date.T1)) %>%
  mutate(delta_dates_leptin.T2=abs(date_of_research.T2 - 
           research_blood_taking_date.T2)) %>%
  mutate(delta_bmi=100*((bmi_at_date_of_research.T2 -
                             bmi_at_date_of_research.T1)/
                            bmi_at_date_of_research.T1)) %>% 
  filter(is.na(delta_dates) | (delta_dates > 0), .preserve=TRUE) %>% # date difference TP2 - TP1 must be positive or NA (the latter if only TP1 available)
  filter(is.na(delta_dates) | (delta_dates !=323), .preserve=TRUE) %>% # acAN re-inclusion, TP1 conni and TP2 braef do not match
  filter(is.na(delta_bmi) | (delta_bmi >=12), .preserve=TRUE) %>% # Minimum BMI increase criterion (or NA if only TP1 available)
  arrange(date_of_research.T1, 
          outliersum.T2, outliersum.T1,
          mriqc_smri_summary.T2, mriqc_smri_summary.T1,
          delta_dates_leptin.T2, delta_dates_leptin.T1,
          desc(date_of_research.T2), .by_group=TRUE) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  #dplyr::select(storage_name.T1, storage_name.T2, id_subset, delta_dates) %>% # Dates/time span check=> OK!
  #mutate(session_T1=str_extract(storage_name.T1, "[a-z]+")) %>%
  #mutate(session_T2=str_extract(storage_name.T2, "[a-z]+")) %>%
  #mutate(same_session=ifelse(session_T1==session_T2, TRUE, FALSE)) %>% # Check acAN-TP1-acAN-TP2 matching=> OK!
  dplyr::select(storage_name.T1, storage_name.T2, id_subset) %>% 
  pivot_longer(-id_subset, names_to="name", values_to="storage_name") %>%
  filter(!is.na(storage_name)) %>% 
  dplyr::select(storage_name, id_subset)

# RecAN case selection
uniquesubjects_recAN <- uniquesubjects_prep %>%
  filter(point_of_research=="recAN") %>%
  group_by(id_subset) %>%
  arrange(date_of_research, .by_group=TRUE) %>%
  mutate(delta_dates=date_of_research - lead(date_of_research)) %>%
  mutate(delta_dates=ifelse(is.na(delta_dates), 
                              date_of_research - lag(date_of_research),
                              delta_dates)) %>%
  mutate(order_date=ifelse(is.na(delta_dates), 2,
                             ifelse((abs(delta_dates)<10) & 
                               (delta_dates<0), 1, 2))) %>%
  mutate(demo_date=ifelse(is.na(delta_dates), date_of_research, 
                            ifelse((abs(delta_dates)<10) & (delta_dates>0), 
                            lag(date_of_research), 
                            date_of_research))) %>%
  mutate(delta_dates_leptin=abs(date_of_research - 
                                    research_blood_taking_date)) %>%
  arrange(outliersum, 
          desc(demo_date), order_date, 
          mriqc_smri_summary, 
          .by_group=TRUE) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(storage_name, id_subset)

# HC case selection 
uniquesubjects_HC <- uniquesubjects_prep %>%
  filter(point_of_research=="HCW") %>%
  group_by(id_subset) %>%
  arrange(outliersum, date_of_research, mriqc_smri_summary, 
          .by_group=TRUE) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(storage_name, id_subset)

uniquesubjects <- bind_rows(uniquesubjects_acAN, uniquesubjects_recAN, uniquesubjects_HC)
  
exclusion <- uniquesubjects %>%
  left_join(redcap_analysis, by="storage_name") %>%
  left_join(redcap_clinical, by="storage_name") 

# Are there still any duplicated subjects (via subset ID, grouped by point of research)?
exclusion %>%
  group_by(point_of_research) %>%
  mutate(duplicated=duplicated(id_subset)) %>%
  filter(duplicated==TRUE) %>%
  nrow(.)

# Are atd subjects still included (incorrect)?
uniquesubjects %>%
  filter(str_detect(storage_name, "atd"))
```

*Exclusion of participants: BMI criteria in recAN and HC*

```{r bmi, results="asis", message=FALSE, warning=FALSE}
bmiexclusion <- exclusion %>%
  filter(bmi_at_date_of_research > 28) %>%
  dplyr::select(storage_name, point_of_research, bmi_at_date_of_research)

bmiexclusion %>%
  knitr::kable(format="html", digits=2, col.names=c("Subject", "Study group", "BMI (kg/m\u00B2)"), align="l", 
               caption="Participants with too high BMI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

*Exclusion of participants: drug abuse due to potential influence on
amygdala volumes*

```{r drugs, results="asis", message=FALSE, warning=FALSE}
drugexclusion <- exclusion %>%
  filter(point_of_research !="T2") %>% # If there is no relevant drug consumption at TP1, this will apply to TP2 as well (no additional assessment at TP2)
  filter((addiction=="ja") | # MINI question
           grepl("Alkoholkonsum", spec_other_psychiatric_disorders) | # MINI question
           grepl("starker Alkoholmissbrauch", siabex_question_26_alcohol_abuse) | # SIAB questions
           grepl("sehr starker Alkoholmissbrauch", siabex_question_26_alcohol_abuse) |
           grepl("starker Alkoholmissbrauch", siabex_past_question_26_alcohol_abuse) |
           grepl("sehr starker Alkoholmissbrauch", siabex_past_question_26_alcohol_abuse) |
           grepl("starkes Drogenproblem", siabex_question_27_drug_abuse) |
           grepl("sehr starkes Drogenproblem", siabex_question_27_drug_abuse) |
           grepl("starkes Drogenproblem", siabex_past_question_27_drug_abuse) |
           grepl("sehr starkes Drogenproblem", siabex_past_question_27_drug_abuse)) %>%
  dplyr::select(storage_name, id_subset, point_of_research)

drugexclusion %>%
  dplyr::select(-id_subset) %>%
  knitr::kable(format="html", col.names=c("Subject", "Study group"), 
               align="l", 
               caption="Study participants with drug abuse (mainly alcohol) according to MINI and/or SIAB") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

*Exclusion of participants: psychiatric diagnoses and/or clinically
relevant BDI-II scores (\>20) in HC participants*

```{r hccomorbidity01, results="asis", message=FALSE, warning=FALSE}
comorb_HC <- exclusion %>%
  filter(point_of_research=="HCW") %>% 
  filter((psychiatric_disorders=="ja") | (resultquest_bdi2_total > 20)) %>%
  dplyr::select(storage_name, point_of_research, resultquest_bdi2_total,
                depressive_disorders, anxiety_disorders,
                obsessivecompulsive_disorders, ptsd, addiction, 
                tic_tourette, conduct_disorder, defiant_behaviour, 
                adaption_disorder, psychosis, 
                attention_deficit_hyperactivity_disorder, personality_disorders,
                developmental_disorders, other_psychiatric_disorders,
                spec_other_psychiatric_disorders) %>% 
  arrange(desc(resultquest_bdi2_total))

comorb_HC$spec_other_psychiatric_disorders %>% 
  .[!is.na(.)] %>%
  paste(., collapse=" ; ") %>%
  knitr::kable(format="html", align="l", col.names="Diagnoses", caption="Other psychiatric disorders in HC") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10") %>%
  add_header_above("No exclusions due to other psychiatric disorders in HC", align="l")
```

```{r hccomorbidity02, results="asis", message=FALSE, warning=FALSE}
comorb_HC %>%
  dplyr::select(-c(other_psychiatric_disorders, spec_other_psychiatric_disorders)) %>%
  filter_all(any_vars(str_detect(., "ja") | (resultquest_bdi2_total>20))) %>%
  mutate_all(funs(str_replace(., "ja", "yes"))) %>%
  mutate_all(funs(str_replace(., "nein", "no"))) %>%
  mutate_all(funs(str_replace(., "nicht mehr erhoben", NA_character_))) %>%
  knitr::kable(format="html", align="l", 
               caption="Co-existing psychiatric diagnoses in HC") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10") %>%
  add_header_above(c("BDI-II scores >20 excluded + 1 confirmed anxiety disorder excluded (other HC without confirmed psychiatric diagnoses)"=16), align="l")

comorbexclusion_HC <- comorb_HC %>%
  filter((resultquest_bdi2_total>20) | (storage_name=="64-23-413-1_conni")) # Aktenkontrolle (anxiety disorder)
```

*Exclusion of participants: psychoactive medication in HC*

```{r hcmedi, results="asis", message=FALSE, warning=FALSE}
exclusion %>%
  filter(point_of_research=="HCW") %>%
  dplyr::select(storage_name, point_of_research, 
                type_of_current_medication___1, 
                type_of_current_medication___2, 
                type_of_current_medication___3, 
                type_of_current_medication___4, 
                type_of_current_medication___5, 
                type_of_recent_medication___1, 
                type_of_recent_medication___2, 
                type_of_recent_medication___3, 
                type_of_recent_medication___4, 
                type_of_recent_medication___5, 
                recent_benzodiazepine_preparation) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  knitr::kable(format="html", align="l", col.names=c("Subject", "Study group", "Antidepressants", "Neuroleptic drugs", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "Neuroleptic drugs", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Preparation"), caption="HC with current (past 2 weeks) or recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10") %>%
  add_header_above(c("", "", "Current medication"=5, "Recent medication"=6), 
                   align="l") %>%
 add_header_above(c("", "", "Note that the recently applied benzodiazepine in 1 HC participant can remain included."=11), align="l") 
```

*Exclusion of participants: psychoactive medication in AN
patients/participants*

```{r anmedi, results="asis", message=FALSE, warning=FALSE}
medi_AN <- exclusion %>%
  filter(point_of_research !="HCW") %>%
  dplyr::select(storage_name, id_subset, point_of_research, 
                type_of_current_medication___1, 
                current_antidepressants_preparation, 
                type_of_current_medication___2, 
                current_neuroleptic_drug_preparation, 
                type_of_current_medication___3, 
                type_of_current_medication___4, 
                type_of_current_medication___5, 
                type_of_recent_medication___1, 
                recent_antidepressants_preparation, 
                type_of_recent_medication___2, 
                recent_neuroleptic_drug_preparation, 
                type_of_recent_medication___3, 
                type_of_recent_medication___4, 
                type_of_recent_medication___5) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  mutate(point_of_research=dplyr::recode(point_of_research,
                                           "T1"="acAN-TP1",
                                           "T2"="acAN-TP2")) %>% 
  arrange(point_of_research) %>%
  mutate(type_of_current_medication___2=ifelse(storage_name=="64-10-580-1_T1_dehab",
                                                 "no", type_of_current_medication___2)) # "Current neuroleptic medication" was checked in this participant but no preparation was entered (we assume that this participant is under NO current neuroleptic medication)

medi_AN %>%
  dplyr::select(-id_subset) %>%
  knitr::kable(format="html", align="l", col.names=c("Subject", "Study group", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines"), caption="Descriptive statistics acAN and recAN: Current (past 2 weeks) and recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10") %>%
  add_header_above(c("", "", "Current medication"=7, "Recent medication"=7), align="l") %>%
  add_header_above(c("AcAN-TP2 64-10-372-1_T2_conni is excluded due to current neuroleptic medication (Promethazine). SSRIs and mirtazapine are included."=16), align="l")

mediexclusion <- medi_AN %>%
  filter(storage_name=="64-10-372-1_T2_conni")
```

## Generate study sample after exclusions

```{r subjects02, message=FALSE, warning=FALSE}
postexclusion <- anti_join(uniquesubjects, bmiexclusion, 
                           by="storage_name") %>% # exclude recAN or HC if BMI is too high
  anti_join(drugexclusion, by="id_subset") %>% # exclude all points of research in case of drug abuse (i.e., exclude TP1 and TP2)
  anti_join(comorbexclusion_HC, by="storage_name") %>% # exclude HC in case of co-existing psychiatric diagnoses
  anti_join(mediexclusion, by="storage_name") %>% # exclude current medication (acAN: if TP2 has to be excluded due to medication, TP1 can remain included)
  left_join(redcap, by="storage_name") %>%
  dplyr::select(storage_name, participant_id, id_subset, point_of_research)
```

**Matching acAN-TP1 - acAN-TP2 and remove acAN - recAN re-inclusions**\
Re-inclusion of acAN as recAN: n=10 (recAN are excluded).

```{r sample01, message=FALSE, warning=FALSE}
# Exclude re-included recAN
exclude_reinclusions <- postexclusion %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  group_by(id_subset) %>%
  arrange(point_of_research, .by_group=TRUE) %>%
  filter(n()>1, .preserve=TRUE) %>%
  ungroup() %>%
  filter(point_of_research=="recAN")

# Final complete sample=SM sample 
sm.sample_pre <- anti_join(postexclusion, exclude_reinclusions,
                           by="storage_name") %>%
  dplyr::select(storage_name, id_subset) %>%
  left_join(redcap_analysis, by="storage_name") %>%
  left_join(fsdata_long, by="storage_name")

sm.sample_missing <- sm.sample_pre %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(is.na(measure))


# Qdecs
qdec.03082022 <- sm.sample_pre %>%
  anti_join(fsdata_long_pre, by="storage_name") %>%
  dplyr::select(storage_name) %>%
  left_join(redcap, by="storage_name") %>%
  dplyr::select(storage_name, participant_id, redcap_event_name) %>%
  dplyr::rename(fsid=storage_name) %>%
  mutate(base=ifelse(str_detect(fsid, "64-23"), "base",
                     "base_km")) %>%
  unite("fsid-base", c(participant_id, base), sep="_",
        remove=FALSE, na.rm=FALSE) %>%
  extract(fsid, "session",
            ".*_([a-z]*)", remove=FALSE) %>%
  arrange(fsid) %>% 
  dplyr::select(fsid, "fsid-base", participant_id, 
                redcap_event_name, session) 
#write_csv(qdec.03082022, "qdec/qdec.03082022.csv", append=FALSE)


# Lh/rh missing - Options to replace?
sm.sample_pre_missing_hemi <- sm.sample_pre %>%
  dplyr::select(storage_name, storage_name.long, participant_id, id_subset, region, hemi, measure) %>%
  filter(region=="Whole_amygdala") %>%
  spread(hemi, measure) %>%
  filter(is.na(lh) | is.na(rh)) 

sm.sample_pre_missing_hemi

fsdata_long_pre %>%
  extract(storage_name, "id_subset", "(64-[0-9][0-9]-[0-9][0-9][0-9])", remove=FALSE) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  filter(id_subset=="64-10-369")

fsdata_long_pre %>%
  extract(storage_name, "id_subset", "(64-[0-9][0-9]-[0-9][0-9][0-9])", remove=FALSE) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  filter(id_subset=="64-10-544")

fsdata_long_pre %>%
  extract(storage_name, "id_subset", "(64-[0-9][0-9]-[0-9][0-9][0-9])", remove=FALSE) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  filter(id_subset=="64-10-071")

fsdata_long_pre %>%
  extract(storage_name, "id_subset", "(64-[0-9][0-9]-[0-9][0-9][0-9])", remove=FALSE) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  filter(id_subset=="64-23-145")

fsdata_long_pre %>%
  extract(storage_name, "id_subset", "(64-[0-9][0-9]-[0-9][0-9][0-9])", remove=FALSE) %>%
  distinct(storage_name.long, .keep_all=TRUE) %>%
  filter(id_subset=="64-23-253")
```

# Final study samples

```{r smsample, message=FALSE, warning=FALSE}
sm.sample_is.na_leptin <- sm.sample_pre %>% distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, point_of_research, leptin_result,
                date_of_research) %>%
  filter(is.na(leptin_result))

redcap_leptin <- redcap_analysis %>%
  dplyr::select(storage_name, participant_id, point_of_research, leptin_result,
                date_of_research) %>%
  filter(!is.na(leptin_result))

leptin_replace <- inner_join(sm.sample_is.na_leptin, redcap_leptin, by=c("participant_id", "point_of_research")) %>%
  mutate(delta_dates=abs(date_of_research.x - date_of_research.y)) %>%
  mutate(leptin_replace=ifelse(((point_of_research %in% c("T1", "T2")) & (delta_dates<10)) |
                                 ((point_of_research %in% c("recAN", "HCW")) & 
                                    (delta_dates<30)), TRUE, FALSE)) %>%
  filter(leptin_replace==TRUE) %>%
  dplyr::select(storage_name.x, leptin_result.y) %>%
  dplyr::rename(storage_name=storage_name.x) %>%
  distinct(storage_name, .keep_all=TRUE)


sm.sample <- sm.sample_pre %>%
  left_join(leptin_replace, by="storage_name") %>%
  mutate(leptin_result=ifelse(!is.na(leptin_result.y), leptin_result.y, leptin_result)) %>%
  dplyr::select(-leptin_result.y) %>%
  mutate(leptin.svi=ifelse((leptin2021==TRUE) & (leptin_result<0.20), 0.20/sqrt(2), # single value imputation
                       ifelse((leptin2021==FALSE) & (leptin_result<0.05), 0.05/sqrt(2),
                       leptin_result))) %>%
  mutate(log_leptin.svi=log10(leptin.svi)) %>%
  filter(!is.na(measure)) %>%
  anti_join(sm.sample_pre_missing_hemi, by="storage_name") %>%
  mutate(por=factor(ifelse(point_of_research %in% c("recAN", "HCW"),
                                as.character(point_of_research), "acAN"),
                    levels=c("acAN", "recAN", "HCW"))) %>% 
  mutate(point_of_research=factor(point_of_research,
                                  levels=c("T1", "T2", "recAN", "HCW"))) %>%
  mutate(region=recode.region1(region)) %>%
  mutate(region=levels.region(region)) %>%
  mutate(region_recoded=recode.region2(region)) %>%
  unite("hemi_region", c(hemi, region), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  mutate(hemi_region=levels.hemi_region(hemi_region)) %>%
  unite("labeller.amy", c(region_recoded, hemi), 
        sep=" ", remove=FALSE, na.rm=FALSE) %>%
  mutate(whole.sub=ifelse(region=="Whole_amygdala", "whole", "sub"))
```

```{r mainsample, message=FALSE, warning=FALSE}
# Matching acAN-TP1 - acAN-TP2
acAN <- anti_join(postexclusion, exclude_reinclusions, 
                  by="storage_name") %>%
  filter(point_of_research %in% c("T1", "T2")) %>%
  semi_join(fsdata_long, by="storage_name") %>%
  group_by(participant_id) %>%
  arrange(participant_id, by_group=TRUE) %>%
  filter(n()==2, .preserve=TRUE) %>%
  ungroup()

recAN.HC <- anti_join(postexclusion, exclude_reinclusions, 
                      by="storage_name") %>%
  filter(point_of_research %in% c("recAN", "HCW"))

# Final study sample for main analysis (main LME)
sample <- bind_rows(acAN, recAN.HC) %>%
  dplyr::select(storage_name, id_subset) %>%
  left_join(redcap_analysis, by="storage_name") %>%
  left_join(leptin_replace, by="storage_name") %>%
  mutate(leptin_result=ifelse((is.na(leptin_result))&(!is.na(leptin_result.y)), leptin_result.y, leptin_result)) %>%
  dplyr::select(-leptin_result.y) %>%
  mutate(leptin.svi=ifelse((leptin2021==TRUE) & (leptin_result<0.20), 0.20/sqrt(2), # single value imputation
                       ifelse((leptin2021==FALSE) & (leptin_result<0.05), 0.05/sqrt(2),
                       leptin_result))) %>%
  mutate(log_leptin.svi=log10(leptin.svi)) %>%
  left_join(fsdata_long, by="storage_name") %>%
  filter(!is.na(measure)) %>%
  anti_join(sm.sample_pre_missing_hemi, by="storage_name") %>%
  mutate(por=factor(ifelse(point_of_research %in% c("recAN", "HCW"),
                                as.character(point_of_research), "acAN"),
                    levels=c("acAN", "recAN", "HCW"))) %>% 
  mutate(point_of_research=factor(point_of_research,
                                  levels=c("T1", "T2", "recAN", "HCW"))) %>%
  mutate(region=recode.region1(region)) %>%
  mutate(region=levels.region(region)) %>%
  mutate(region_recoded=recode.region2(region)) %>%
  unite("hemi_region", c(hemi, region), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  mutate(hemi_region=levels.hemi_region(hemi_region)) %>%
  unite("labeller.amy", c(region_recoded, hemi), 
        sep=" ", remove=FALSE, na.rm=FALSE) %>%
  mutate(whole.sub=ifelse(region=="Whole_amygdala", "whole", "sub"))
```

```{r sample02, results="asis", message=FALSE, warning=FALSE}
sm.sample %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  group_by(point_of_research) %>%
  count(.) %>%
  knitr::kable(format="html", align="l", 
               col.names=c("Study groups", "n"), 
               caption="Complete/SM study sample (including all available acAN)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

sample %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  group_by(point_of_research) %>%
  count(.) %>%
  knitr::kable(format="html", align="l", 
               col.names=c("Study groups", "n"), 
               caption="Main study sample") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

## Clinical characteristics of acAN and recAN participants in the final study sample

**acAN-TP1/TP2:** mean ± SD age at first AN onset (years, assessed in
n=...); mean ± SD duration of current AN episode (months, n); current AN
subtype via SIAB-EX (n, percentage); current co-existing psychiatric
diagnoses (total n; n for individual disorders); psychoactive medication
(n);\
**recAN:** mean ± SD age at first AN onset (years, assessed in n=...);
mean ± SD duration of recovery from former AN episode (months, n);
former AN subtype via SIAB-EX (n, percentage); current or former
co-existing psychiatric diagnoses (total n; n for individual disorders);
psychoactive medication (n);\
**HC:** None of HC participants had any psychiatric diagnosis currently
or in the past or any psychoactive medication.

```{r andescriptives01, results="asis", message=FALSE, warning=FALSE}
# AN duration statistics
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  left_join(redcap_clinical, by="storage_name") %>% 
  group_by(point_of_research) %>%
  rstatix::get_summary_stats(siabex_age_onset, onset_of_an, recovered_since_months) %>%
  dplyr::select(point_of_research, variable, n, mean, sd, min, max) %>%
  mutate(variable=dplyr::recode(variable,
                                "siabex_age_onset"="Age at first AN onset (years)",
                                "recovered_since_months"=
                                  "Duration of recovery from former AN episode (months)",
                                "onset_of_an"=
                                  "Duration of current AN episode (months)")) %>%
  dplyr::arrange(point_of_research, variable) %>%
  knitr::kable(format="html", digits=1, col.names=c("Study groups", "AN characteristics", "n(valid data)", "Mean", "SD", "Min", "Max"), align="l", caption="Descriptive statistics acAN and recAN: DOI characteristics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

# AN subtypes
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research %in% c("T1", "recAN")) %>%
  left_join(redcap_clinical, by="storage_name") %>% 
  group_by(point_of_research) %>%
  mutate(siabex_result_an_type=dplyr::recode(siabex_result_an_type,
         "1.0"="restrictive",
         "2.0"="binge/purge")) %>% 
  mutate(siabex_past_result_an_type=dplyr::recode(siabex_past_result_an_type,
         "1.0"="restrictive",
         "2.0"="binge/purge")) %>% 
  mutate(siabex_result_an_type=ifelse(point_of_research=="T1", 
                                      siabex_result_an_type, NA)) %>% 
  count(siabex_result_an_type, siabex_past_result_an_type) %>% 
  mutate(percentage=100*(n / sum(n))) %>% 
  dplyr::arrange(point_of_research) %>%
  knitr::kable(format="html", digits=2, col.names=c("Study groups", "Current AN subtype via SIAB-EX", "Past AN subtype via SIAB-EX", "n", "%"), align="l", caption="Descriptive statistics acAN and recAN: AN subtypes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r andescriptives02, results="asis", message=FALSE, warning=FALSE}
# Co-existing psychiatric diagnoses (acAN, recAN)
comorb_AN <- sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(redcap_clinical, by="storage_name") %>% 
  filter((point_of_research %in% c("T1", "recAN")) & (psychiatric_disorders=="ja")) %>%
  dplyr::select(storage_name, point_of_research, depressive_disorders,
                anxiety_disorders, obsessivecompulsive_disorders, ptsd, addiction,
                tic_tourette, conduct_disorder, defiant_behaviour,
                adaption_disorder,
                psychosis, attention_deficit_hyperactivity_disorder, 
                personality_disorders, developmental_disorders, 
                other_psychiatric_disorders, spec_other_psychiatric_disorders) %>%
  filter(storage_name!="64-10-005-3_ebit") %>% # no official diagnoses
  filter(storage_name!="64-10-100-1_ebit") %>%
  filter(storage_name!="64-10-108-1_ebit") %>%
  filter(storage_name!="64-10-284-1_suber") %>%
  filter(storage_name!="64-10-342-1_suber")

comorb_AN %>%
  dplyr::select(-c(spec_other_psychiatric_disorders, storage_name)) %>%
  group_by(point_of_research) %>%
  summarize_all(~sum(str_count(., "ja"), na.rm=TRUE)) %>%
  arrange(point_of_research) %>%
  knitr::kable(format="html", align="l", caption="Descriptive statistics acAN and recAN: Co-existing psychiatric diagnoses") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

comorb_AN %>%
  filter(!is.na(spec_other_psychiatric_disorders)) %>%
  dplyr::select(storage_name, point_of_research, 
                spec_other_psychiatric_disorders) %>%
  arrange(point_of_research) %>%
  knitr::kable(format="html", align="l", caption="Other psychiatric diagnoses in acAN and recAN") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

# Psychoactive medication (acAN-TP1, acAN-TP2, recAN)
sample %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(redcap_clinical, by="storage_name") %>% 
  filter(point_of_research!="HCW") %>%
  dplyr::select(storage_name, point_of_research, type_of_current_medication___1,
                current_antidepressants_preparation, 
                type_of_current_medication___2, current_neuroleptic_drug_preparation,
                type_of_current_medication___3, type_of_current_medication___4,
                type_of_current_medication___5, 
                type_of_recent_medication___1, recent_antidepressants_preparation,
                type_of_recent_medication___2, recent_neuroleptic_drug_preparation,
                type_of_recent_medication___3, type_of_recent_medication___4,
                type_of_recent_medication___5) %>%
  filter_all(any_vars(str_detect(., "Checked"))) %>%
  mutate_all(funs(str_replace(., "Checked", "yes"))) %>%
  mutate_all(funs(str_replace(., "Unchecked", "no"))) %>%
  mutate_all(funs(str_replace(., "unbekannt", NA_character_))) %>%
  group_by(point_of_research) %>%
  mutate(n=n()) %>%
  ungroup() %>%
  mutate(point_of_research=fct_relevel(point_of_research, 
                                         c("T1", "T2", "recAN"))) %>%
  arrange(point_of_research) %>%
  knitr::kable(format="html", align="l", col.names=c("Subject", "Study group", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "Antidepressants", "Preparation", "Neuroleptic drugs", "Preparation", "Stimulating drugs", "Mood stabilizers", "Benzodiazepines", "n"), caption="Descriptive statistics acAN-TP1, acAN-TP2, and recAN: Current (past 2 weeks) and recent (past 6 months) psychoactive medication") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10") %>%
  add_header_above(c("", "", "Current medication"=7, "Recent medication"=7, "n participants per study group"), align="l")
```

# MRI quality assessment: Outlier

No extreme volume and/or symmetry outliers after FreeSurfer longitudinal
processing, cross-sectional QC results are valid (see above).

```{r qcoutlier, results="asis", message=FALSE, warning=FALSE}
# Volume outliers
outliers_volume <- sm.sample %>%
  group_by(analysis, region, hemi, point_of_research) %>% # group-wise volume outlier detection
  mutate(lower_threshold_mild=(mean(measure, na.rm=TRUE) - 
                                   (2.698*sd(measure, na.rm=TRUE)))) %>%
  mutate(upper_threshold_mild=(mean(measure, na.rm=TRUE) + 
                                   (2.698*sd(measure, na.rm=TRUE)))) %>%
  mutate(is.outlier_volume_2.698sd=ifelse((measure<lower_threshold_mild) |
                                              (measure>upper_threshold_mild),
                                            TRUE, FALSE)) %>%
  mutate(lower_threshold_extreme=(mean(measure, na.rm=TRUE) - 
                                      (4.721*sd(measure, na.rm=TRUE)))) %>%
  mutate(upper_threshold_extreme=(mean(measure, na.rm=TRUE) + 
                                      (4.721*sd(measure, na.rm=TRUE)))) %>%
  mutate(is.outlier_volume_4.721sd=ifelse((measure<lower_threshold_extreme) | 
                                              (measure>upper_threshold_extreme), 
                                            TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(storage_name) %>%
  mutate(n_outlier_volume_2.698sd=sum(is.outlier_volume_2.698sd)) %>%
  mutate(n_outlier_volume_4.721sd=sum(is.outlier_volume_4.721sd)) %>%
  ungroup()

outliers_volume %>%
  filter((n_outlier_volume_2.698sd > 0) | (n_outlier_volume_4.721sd > 0)) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, point_of_research, n_outlier_volume_2.698sd,
                n_outlier_volume_4.721sd) %>%
  arrange(desc(n_outlier_volume_4.721sd), desc(n_outlier_volume_2.698sd)) %>%
  knitr::kable(format="html",
               caption="Overview: Subjects with volume outliers (amygdala)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

# Symmetry outliers
outliers_symmetry <- sm.sample %>%
  dplyr::select(storage_name, point_of_research, analysis, region, hemi, measure) %>%
  pivot_wider(names_from="hemi", values_from="measure") %>%
  mutate(lat_index=((lh-rh)/(lh+rh))) %>% # laterality or lateralization index (according to ENIGMA)
  group_by(analysis, region, point_of_research) %>% 
  mutate(lower_threshold_mild=(mean(lat_index, na.rm=TRUE) - 
                                   (2.698*sd(lat_index, na.rm=TRUE)))) %>%
  mutate(upper_threshold_mild=(mean(lat_index, na.rm=TRUE) + 
                                   (2.698*sd(lat_index, na.rm=TRUE)))) %>%
  mutate(is.outlier_symmetry_2.698sd=ifelse(lat_index<lower_threshold_mild | 
                                                lat_index>upper_threshold_mild, 
                                              TRUE, FALSE)) %>%
  mutate(lower_threshold_extreme=(mean(lat_index, na.rm=TRUE) - 
                                      (4.721*sd(lat_index, na.rm=TRUE)))) %>% 
  mutate(upper_threshold_extreme=(mean(lat_index, na.rm=TRUE) + 
                                      (4.721*sd(lat_index, na.rm=TRUE)))) %>%
  mutate(is.outlier_symmetry_4.721sd=ifelse(lat_index<lower_threshold_extreme |
                                                lat_index>upper_threshold_extreme, 
                                              TRUE, FALSE)) %>%
  ungroup() %>%
  group_by(storage_name) %>%
  mutate(n_outlier_symmetry_2.698sd=sum(is.outlier_symmetry_2.698sd)) %>%
  mutate(n_outlier_symmetry_4.721sd=sum(is.outlier_symmetry_4.721sd)) %>%
  ungroup()

outliers_symmetry %>%
  filter((n_outlier_symmetry_2.698sd > 0) | (n_outlier_symmetry_4.721sd > 0)) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, point_of_research, n_outlier_symmetry_2.698sd,
                n_outlier_symmetry_4.721sd) %>%
  arrange(desc(n_outlier_symmetry_4.721sd), desc(n_outlier_symmetry_2.698sd)) %>%
  knitr::kable(format="html",
               caption="Overview: Subjects with symmetry outliers (amygdala)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

# Raincloud plots (main study sample)

Including raw data, data distribution (boxplots), and probability
density (violin plots).

```{r raincloud, fig.cap="Data distribution - Raincloud plots", message=FALSE, warning=FALSE, eval=FALSE}
rcdata <- sample %>%
  arrange(region) %>%
  mutate(point_of_research=dplyr::recode(point_of_research,
                                    "T1"="AcAN-TP1",
                                    "T2"="AcAN-TP2",
                                    "recAN"="RecAN",
                                    "HCW"="HC")) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(rcdata$region)) {
  
  plotdata <- rcdata %>% filter(region %in% Region)

  rainclouds <- plotdata %>%
    ggplot(aes(x=point_of_research, y=measure, fill=point_of_research,
               color=point_of_research)) +
    geom_flat_violin(position=position_nudge(x=0.2, y=0), adjust=0.65, 
                     trim=FALSE, alpha=1.0, color=NA) +
    geom_point(aes(x=as.numeric(point_of_research) - 0.1, y=measure),
               position=position_jitter(width=0.13), size=1.6, alpha=1.0) +
    stat_boxplot(aes(x=as.numeric(point_of_research) + 0.2, y=measure), geom="errorbar",
               width=0.5, size=2.1, position=position_dodge(1), 
               color="BLACK", alpha=1.0) +
    geom_boxplot(aes(x=as.numeric(point_of_research) + 0.2, y=measure), 
                 outlier.shape=NA, width=0.2, position=position_dodge(1), 
                 color="BLACK", alpha=1.0, size=2.1, fatten=1.5) +
    scale_x_discrete(labels=c("AcAN-TP1"="AcAN-TP1", "AcAN-TP2"="AcAN-TP2", 
                                "RecAN"="RecAN", "HC"="HC")) +
    scale_y_continuous(breaks=pretty_breaks(n=4), 
                       labels=scales::comma_format(big.mark=",",
                                                     decimal.mark=".",
                                                     accuracy=1L)) +
    scale_fill_manual(values=alpha(c("#1E3F5A", "#466f91", 
                                     "#AA4D0D", "#7b848f", "#000000"), 1)) + 
    scale_color_manual(values=alpha(c("#1E3F5A", "#466f91", 
                                      "#AA4D0D", "#7b848f", "#000000"), 1)) +
    plot_theme_transparent + 
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(size=35, angle=45, hjust=1),
          axis.ticks.x=element_line(size=1.75), 
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.background=element_rect(fill="gray90")) +
    guides(fill=FALSE, color=FALSE) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1, "cm"))
  
  if(plotdata$xlabels==FALSE) {
   rainclouds=rainclouds + 
     theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
   }
  
 plotlist[[Region]]=rainclouds
 
 }

rc.whole <- plotlist$Whole_amygdala
rc.nuclei <- plotlist[2:10] 

raincloudarrange <- ggarrange(rc.whole, 
          ggarrange(plotlist=rc.nuclei, ncol=3, nrow=3),
          ncol=2, widths=c(1,2.5)) %>%
  annotate_figure(left=text_grob(expression(paste("Volumes (raw) in mm"^"3")), 
                                   size=50, rot=90))

raincloudarrange

#ggsave(raincloudarrange, path="figures", filename="raincloudplots_amy.png", 
       #width=40, height=30, dpi=600)
```

# Descriptive statistics

## Leptin below LOD

```{r leptinimpute, results="asis", message=FALSE, warning=FALSE}
sample %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  dplyr::select(storage_name, point_of_research, leptin_result, leptin2021) %>%
  filter(!is.na(leptin_result)) %>%
  group_by(point_of_research) %>%
  mutate(n_available=n()) %>%
  ungroup() %>% 
  group_by(point_of_research, leptin2021) %>%
  mutate(n_batch=n()) %>%
  mutate(n_below_0.05=sum(leptin_result<0.05)) %>%
  mutate(n_below_0.20=sum(leptin_result<0.20)) %>% 
  mutate(n_below_0.05=ifelse(leptin2021==TRUE, NA, n_below_0.05)) %>%  
  distinct(n_available, .keep_all=TRUE) %>% 
  dplyr::select(n_available, n_batch, n_below_0.20, n_below_0.05) %>% 
  arrange(point_of_research) %>% 
  knitr::kable(format="html", align="l", 
               col.names=c("Study group", "Batch 2021?", 
                             "n(leptin available)", "n(per batch)", 
                             "n(leptin<0.20µg/L) including also leptin<0.05µg/L",
                             "n(leptin<0.05µg/L)"),
               caption="Leptin values <LOD") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10")

# Leptin extreme outliers (3SD)
sample %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  group_by(point_of_research) %>% 
  mutate(lower_threshold=mean(leptin_result, na.rm=TRUE) - (3*sd(leptin_result, na.rm=TRUE))) %>%
  mutate(upper_threshold=mean(leptin_result, na.rm=TRUE) + (3*sd(leptin_result, na.rm=TRUE))) %>%
  mutate(extreme.outlier=ifelse((leptin_result<lower_threshold) | (leptin_result>upper_threshold), TRUE, FALSE)) %>%
  ungroup() %>%
  dplyr::select(storage_name, point_of_research, leptin_result, extreme.outlier, lower_threshold, upper_threshold) %>%
  filter(extreme.outlier==TRUE) %>%
  arrange(point_of_research) %>%
  knitr::kable(format="html", align="l",
               caption="Extreme outliers leptin concentration") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10")
```

## LMEdata

```{r lmedata, message=FALSE, warning=FALSE}
lmedata_pre <- sample %>%
  filter(region=="Whole_amygdala") %>% # introduce "whole amygdala" as a new variable/column
  dplyr::select(storage_name, hemi, measure) %>%
  dplyr::rename(whole_amygdala=measure) %>%
  right_join(sample, by=c("storage_name", "hemi")) %>%
  mutate(doi=ifelse(point_of_research=="T1", onset_of_an, 0)) %>%
  mutate(dor=ifelse(point_of_research=="recAN", recovered_since_months, NA)) %>% # Duration of recovery
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, storage_name, participant_id, por, date_of_research,
                point_of_research, measure, age_at_date_of_research, bmisds_at_date_of_research,
                e_tiv, whole_amygdala, subcort_gray,
                log_leptin.svi, leptin.svi, leptin_result, leptin2021, leptin_batch_recoded, minbmi, 
                doi, dor,
                edi_core, resultquest_edi2_ss, resultquest_bdi2_total, stai_s, stai_t, resultquest_scl90r_skagloba) %>%
  mutate(across(.cols=leptin.svi:resultquest_scl90r_skagloba, ~ifelse(is.nan(.x), NA, .x))) %>% # consistent formatting of "NA"s
  filter_at(vars(por, measure, bmisds_at_date_of_research, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  group_by(hemi_region, participant_id) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds=ifelse(point_of_research=="T1", 
                             bmisds_at_date_of_research - lead(bmisds_at_date_of_research), 
                             0)) %>% # delta=T1-T2
  mutate(delta.log_leptin.svi=ifelse(point_of_research=="T1", 
                                 log_leptin.svi - lead(log_leptin.svi),
                                 0)) %>% # delta=T1-T2
  mutate(delta.leptin.svi=ifelse(point_of_research=="T1", 
                                 leptin.svi - lead(leptin.svi),
                                 0)) %>% # delta=T1-T2
  mutate(delta.edicore=ifelse(point_of_research=="T1", 
                              edi_core - lead(edi_core), 
                              0)) %>%
  mutate(delta.edidt=ifelse(point_of_research=="T1", 
                            resultquest_edi2_ss - lead(resultquest_edi2_ss), 
                              0)) %>%
  mutate(delta.bdi=ifelse(point_of_research=="T1", 
                          resultquest_bdi2_total - lead(resultquest_bdi2_total), 
                          0)) %>%
  mutate(delta.stais=ifelse(point_of_research=="T1", 
                            stai_s - lead(stai_s), 
                            0)) %>%
  mutate(stait=ifelse(point_of_research=="T2", # acAN-TP1 and acAN-TP2 have same trait anxiety level
                       lag(stai_t), stai_t)) %>%
  mutate(delta.sclgsi=ifelse(point_of_research=="T1", 
                             resultquest_scl90r_skagloba - lead(resultquest_scl90r_skagloba), 
                             0)) %>%
  mutate(T1.age=ifelse(point_of_research=="T1", 
                       age_at_date_of_research, 0)) %>%
  mutate(T1pred.bmisds=ifelse(point_of_research=="T1", 
                                 bmisds_at_date_of_research, 0)) %>%
  mutate(T1pred.log_leptin.svi=ifelse(point_of_research=="T1", 
                                 log_leptin.svi, 0)) %>%
  mutate(T1pred.edicore=ifelse(point_of_research=="T1", 
                                  edi_core, 0)) %>%
  mutate(T1pred.bdi=ifelse(point_of_research=="T1", 
                            resultquest_bdi2_total, 0)) %>%
  mutate(T1pred.sclgsi=ifelse(point_of_research=="T1", 
                            resultquest_scl90r_skagloba, 0)) %>%
  ungroup() %>%
  mutate(delta.bmisds.mean=
           mean(delta.bmisds[delta.bmisds!=0], na.rm=TRUE)) %>%
  mutate(participant_id=factor(participant_id))


# Gram-Schmidt Orthogonalization
## Log10-leptin (single value imputed)
lmedata_pre_leptin <- lmedata_pre %>%
  filter(point_of_research!="T1") %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  arrange(storage_name) %>%
  dplyr::select(storage_name, bmisds_at_date_of_research, leptin_result) %>%
  filter(!is.na(leptin_result)) 

log_leptin.ortho <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_leptin$bmisds_at_date_of_research, lmedata_pre_leptin$leptin_result), 
                                                         ncol=2, byrow=FALSE), 
                                                  normalize=FALSE, verbose=FALSE)) %>%
  cbind(lmedata_pre_leptin) %>%
  dplyr::rename(log_leptin.ortho=V2) %>%
  dplyr::select(storage_name, log_leptin.ortho)

#delta.log_leptin.svi.ortho.sq <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_leptin$delta.bmisds,
#                                                    lmedata_pre_leptin$delta.bmisds.sq,
#                                                    lmedata_pre_leptin$delta.log_leptin.svi), 
#                                                  ncol=3, byrow=FALSE), 
#                                                  normalize=FALSE, verbose=FALSE)) %>% #cbind(lmedata_pre_leptin) %>%
#  dplyr::rename(delta.log_leptin.svi.ortho.sq=V3) %>%
#  dplyr::select(storage_name, delta.log_leptin.svi.ortho.sq)


## DOI
lmedata_pre_doi <- lmedata_pre %>%
  filter(point_of_research=="T1") %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  mutate(delta.bmisds.sq=delta.bmisds^2) %>%
  arrange(storage_name) %>%
  dplyr::select(storage_name, delta.bmisds, delta.bmisds.sq, doi) %>%
  filter(!is.na(doi))

doi.ortho <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_doi$delta.bmisds,
                                                    lmedata_pre_doi$doi), 
                                                  ncol=2, byrow=FALSE), 
                                                  normalize=FALSE, verbose=FALSE)) %>%
  cbind(lmedata_pre_doi) %>%
  dplyr::rename(doi.ortho=V2) %>%
  dplyr::select(storage_name, doi.ortho)

doi.ortho.sq <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_doi$delta.bmisds,
                                                    lmedata_pre_doi$delta.bmisds.sq,
                                                    lmedata_pre_doi$doi), 
                                                  ncol=3, byrow=FALSE), 
                                                  normalize=FALSE, verbose=FALSE)) %>%
  cbind(lmedata_pre_doi) %>%
  dplyr::rename(doi.ortho.sq=V3) %>%
  dplyr::select(storage_name, doi.ortho.sq)


## EDI core
lmedata_pre_edicore <- lmedata_pre %>%
  filter(point_of_research=="T1") %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  mutate(delta.bmisds.sq=delta.bmisds^2) %>%
  arrange(storage_name) %>%
  dplyr::select(storage_name, delta.bmisds, delta.bmisds.sq, delta.edicore) %>%
  filter(!is.na(delta.edicore))

delta.edicore.ortho <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_edicore$delta.bmisds,
                                                    lmedata_pre_edicore$delta.edicore), 
                                                  ncol=2, byrow=FALSE), 
                                                  normalize=FALSE, verbose=FALSE)) %>%
  cbind(lmedata_pre_edicore) %>%
  dplyr::rename(delta.edicore.ortho=V2) %>%
  dplyr::select(storage_name, delta.edicore.ortho)

delta.edicore.ortho.sq <- as.tibble(matlib::GramSchmidt(matrix(c(lmedata_pre_edicore$delta.bmisds,
                                                    lmedata_pre_edicore$delta.bmisds.sq,
                                                    lmedata_pre_edicore$delta.edicore), 
                                                  ncol=3, byrow=FALSE), 
                                                  normalize=FALSE, verbose=FALSE)) %>%
  cbind(lmedata_pre_edicore) %>%
  dplyr::rename(delta.edicore.ortho.sq=V3) %>%
  dplyr::select(storage_name, delta.edicore.ortho.sq)


# Data basis for LME models
lmedata <- lmedata_pre %>%
  left_join(log_leptin.ortho, by="storage_name") %>%
  #left_join(delta.log_leptin.svi.ortho.sq, by="storage_name") %>%
  #mutate(delta.log_leptin.svi.ortho.sq=ifelse(point_of_research=="T1", 
                                              #delta.log_leptin.svi.ortho.sq, 0)) %>%
  
  left_join(doi.ortho, by="storage_name") %>%
  mutate(doi.ortho=ifelse(point_of_research=="T1", doi.ortho, 0)) %>%
  left_join(doi.ortho.sq, by="storage_name") %>%
  mutate(doi.ortho.sq=ifelse(point_of_research=="T1", doi.ortho.sq, 0)) %>%
  
  left_join(delta.edicore.ortho, by="storage_name") %>%
  mutate(delta.edicore.ortho=ifelse(point_of_research=="T1", delta.edicore.ortho, 0)) %>%
  left_join(delta.edicore.ortho.sq, by="storage_name") %>%
  mutate(delta.edicore.ortho.sq=ifelse(point_of_research=="T1", delta.edicore.ortho.sq, 0))

delta.bmisds.mean <- unique(lmedata$delta.bmisds.mean)


lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  mutate(n_stait=sum(!is.na(stait))) %>%
  filter(point_of_research=="T1") %>%
  mutate(n_leptin=sum(!is.na(delta.log_leptin.svi))) %>%
  mutate(n_doi=sum(!is.na(doi))) %>%
  mutate(n_edicore=sum(!is.na(delta.edicore))) %>%
  mutate(n_bdi=sum(!is.na(delta.bdi))) %>%
  mutate(n_sclgsi=sum(!is.na(delta.sclgsi))) %>%
  dplyr::select(n_leptin, n_doi, n_edicore, n_bdi, n_sclgsi, n_stait) %>%
  slice_head(n=1) %>%
  knitr::kable(format="html", align="l",
               caption="N(acAN) with available change scores or STAI(K) trait anxiety scores") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10")

lmedata %>%
  dplyr::select(hemi_region, storage_name, participant_id, por, date_of_research,
                point_of_research, measure, age_at_date_of_research, bmisds_at_date_of_research, 
                e_tiv, edi_core, resultquest_bdi2_total, stai_s, stai_t,
                resultquest_scl90r_skagloba, delta.bmisds, delta.edicore, delta.bdi,
                delta.sclgsi) #%>%
  #write_csv("dataset_ema_wo_leptin.csv")
```

### Correlation (multicollinearity) analysis

```{r longicor, message=FALSE, warning=FALSE}
lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(participant_id, point_of_research, delta.bmisds, delta.log_leptin.svi, T1pred.log_leptin.svi, doi,  
                          delta.edicore, delta.bdi, stait, delta.sclgsi) %>%
  filter(point_of_research=="T1") %>%
  pivot_longer(-c(participant_id, point_of_research, delta.bmisds), names_to="changescores",
               values_to="changevalues")  %>%
  nest(-changescores) %>%
  mutate(
    cor=map(data, ~ cor.test(.x$delta.bmisds, .x$changevalues, method="pearson", na.action=na.omit)),
    cor.tidy=map(cor, tidy)) %>%
  unnest(cor.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(changescores, estimate, parameter, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Clinical variable", "Pearson r", "df", "p"), 
               caption="Person correlations with deltaBMI-SDS in acAN-TP2 vs. acAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Orthogonalization to basis deltaBMI-SDS applied to deltaLog10-leptin (exclusively, strong correlation with deltaBMI-SDS), not to DOI (since only weak correlation with deltaBMI-SDS)."=4), align="l")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1.age, doi) %>%
  rstatix::cor_test(var1=T1.age, var2=doi, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between age and duration of illnes (DOI) in AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1pred.bmisds, T1pred.log_leptin.svi) %>%
  rstatix::cor_test(var1=T1pred.bmisds, var2=T1pred.log_leptin.svi, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between BMI-SDS and Log10-leptin levels in AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1pred.log_leptin.svi, delta.log_leptin.svi) %>%
  rstatix::cor_test(var1=T1pred.log_leptin.svi, var2=delta.log_leptin.svi, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between Log10-leptin levels at AcAN-TP1 and change in Log10-leptin levels AcAN-TP2 vs. AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1pred.edicore, delta.edicore) %>%
  rstatix::cor_test(var1=T1pred.edicore, var2=delta.edicore, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between EDI-2 core levels at AcAN-TP1 and change in EDI-2 core levels AcAN-TP2 vs. AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1pred.bdi, delta.bdi) %>%
  rstatix::cor_test(var1=T1pred.bdi, var2=delta.bdi, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between BDI-II levels at AcAN-TP1 and change in BDI-II levels AcAN-TP2 vs. AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

lmedata %>% distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(T1pred.sclgsi, delta.sclgsi) %>%
  rstatix::cor_test(var1=T1pred.sclgsi, var2=delta.sclgsi, alternative="two.sided", method="pearson",
                    use="pairwise.complete.obs") %>%
  mutate(p=ifelse(p<0.001, "<0.001", formatC(p, format="f", digits=3))) %>%
  knitr::kable(format="html", digits=3, align="l", 
               col.names=c("Var1", "Var2", "r", "t", "p", "Conf. low", "Conf. high", "Method"), 
               caption="Correlation between SCL-90-R GSI levels at AcAN-TP1 and change in SCL-90-R GSI levels AcAN-TP2 vs. AcAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Multiple imputation for leptin

```{r covmi, results="asis", message=FALSE, warning=FALSE}
set.seed(123456)

impute.covs <- lmedata %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(leptin_result)) %>%
  left_join(redcap_clinical, by="storage_name") %>%
  mutate(siabex_result_an_type=ifelse(siabex_result_an_type==0, NA, 
                                        siabex_result_an_type)) %>%
  mutate(subtype=factor(dplyr::recode(siabex_result_an_type,
         "1"="0", # restrictive
         "2"="1"))) %>% # binge/purge
  mutate(phys_activity=factor(dplyr::recode(siabex_question_21_an_type,
                                                    "nein"="1",
                                                    "selten (weniger als 2 x pro Woche)"="2",
                                                    "oefter (mind. 2 x pro Woche)"="3",
                                                    "haeufig (bis 1 x taeglich)"="4",
                                                    "sehr haeufig (mehrmals taeglich)"="5"))) %>%
  mutate(phys_activity=ordered(phys_activity, levels=c(1,2,3,4,5))) %>% # from least to greatest
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, storage_name, 
                measure, age_at_date_of_research, e_tiv, 
                bmisds_at_date_of_research, delta.bmisds, minbmi, doi,
                edi_core, resultquest_bdi2_total, stait, 
                subtype, phys_activity) %>%
  nest(-c(region, labeller.amy, whole.sub)) %>%
  mutate(
    imp.predmatrix=map(data, ~mice(.x, maxit=0)$predictorMatrix),
    imp.meth=map(data, ~mice(.x, maxit=0)$method),
    imp=map(data, ~mice(.x, seed=123456, maxit=50, m=50, print=FALSE)),
    imp.extract=map(imp, ~complete(.x, action="all", include=FALSE, mild=FALSE))) %>%
  unnest(imp.extract)
```

```{r multimp, results="asis", message=FALSE, warning=FALSE}
set.seed(123456)

leptin_join_pre <- lmedata %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(leptin_result)) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, por, leptin_result, leptin2021, 
                leptin_batch_recoded) %>%
  mutate(lod=ifelse(leptin2021==TRUE, 0.20, 0.05)) %>% 
  mutate(leptin=ifelse(leptin_result<lod, NA, leptin_result))

leptin_join <- dummy_cols(leptin_join_pre, 
                          select_columns="leptin_batch_recoded")

leptin_impute <- impute.covs %>% 
  mutate(
    sum.is.na=map_dbl(imp.extract, ~sum(is.na(.x))),
    data.clmi=map(imp.extract, ~left_join(.x, leptin_join, by="storage_name")),
    data.clmi=map(data.clmi, ~mutate(.x,
                                     measure.std=(measure-mean(measure))/sd(measure),
                                     age.std=(age_at_date_of_research-mean(age_at_date_of_research))/
                                       sd(age_at_date_of_research),
                                     etiv.std=(e_tiv-mean(e_tiv))/sd(e_tiv),
                                     bmisds.std=(bmisds_at_date_of_research-
                                                   mean(bmisds_at_date_of_research))/
                                       sd(bmisds_at_date_of_research),
                                     minbmi.std=(minbmi-mean(minbmi))/sd(minbmi),
                                     doi.std=(doi-mean(doi))/sd(doi),
                                     edi.std=(edi_core-mean(edi_core))/sd(edi_core),
                                     bdi.std=(resultquest_bdi2_total-mean(resultquest_bdi2_total))/
                                       sd(resultquest_bdi2_total),
                                     stait.std=(stait-mean(stait))/sd(stait),
                                     subtype=as.numeric(subtype),
                                     phys_activity=as.numeric(phys_activity))),
    clmi=map(data.clmi, ~clmi(log10(leptin) ~measure.std + poly(age.std, degree=2, raw=FALSE) +
                                etiv.std + bmisds.std + minbmi.std + doi.std + 
                                edi.std + bdi.std + stait.std + subtype + phys_activity, 
                              df=.x, lod=lod, seed=123456, n.imps=1)),
    clmi_nt=map(data.clmi, ~clmi(leptin ~measure.std + poly(age.std, degree=2, raw=FALSE) +
                                etiv.std + bmisds.std + minbmi.std + doi.std + 
                                edi.std + bdi.std + stait.std + subtype + phys_activity, 
                              df=.x, lod=lod, seed=123456, n.imps=1)),
    extract.clmi=map(clmi, ~.x$imputed.dfs),
    extract.clmi_nt=map(clmi_nt, ~.x$imputed.dfs)) %>%
  unnest(extract.clmi, extract.clmi_nt) %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi, extract.clmi_nt)
```

## Multiple imputation for leptin (SM sample)

```{r smlmedata, message=FALSE, warning=FALSE}
sm.lmedata <- sm.sample %>%
  mutate(doi=ifelse(point_of_research=="T1", onset_of_an, 0)) %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, storage_name, 
                participant_id, por,
                point_of_research, measure, bmisds_at_date_of_research,
                age_at_date_of_research, e_tiv, 
                leptin_result, 
                doi, leptin2021, leptin_batch_recoded, minbmi, 
                edi_core, resultquest_bdi2_total, stai_t, resultquest_scl90r_skagloba) %>%
  filter_at(vars(por, measure, bmisds_at_date_of_research, 
                 age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  group_by(hemi_region, participant_id) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds.sm=ifelse(point_of_research=="T2", 
                             bmisds_at_date_of_research - lag(bmisds_at_date_of_research), 
                             0)) %>%
  mutate(stait=ifelse(point_of_research=="T2", # acAN-TP1 and acAN-TP2 have same trait anxiety level
                      lag(stai_t), stai_t)) %>% 
  ungroup() %>%
  mutate(delta.bmisds.sm.mean=
           mean(delta.bmisds.sm[delta.bmisds.sm!=0], na.rm=TRUE)) %>%
  mutate(participant_id=factor(participant_id))

delta.bmisds.sm.mean <- unique(sm.lmedata$delta.bmisds.sm.mean)

# Custom contrast setting for SM LME (based on reference grid)
acAN_TP1.smlme  = c(1, 0, 0, 0, 0, 0)
recAN.smlme     = c(0, 1, 0, 0, 0, 0)
HC.smlme        = c(0, 0, 1, 0, 0, 0)
acAN_TP2.smlme  = c(0, 0, 0, 1, 0, 0)
```

```{r smcovmi, results="asis", message=FALSE, warning=FALSE}
set.seed(123456)

sm.impute.covs <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(leptin_result)) %>%
  left_join(redcap_clinical, by="storage_name") %>%
  mutate(siabex_result_an_type=ifelse(siabex_result_an_type==0, NA, 
                                        siabex_result_an_type)) %>%
  mutate(subtype=factor(dplyr::recode(siabex_result_an_type,
         "1"="0", # restrictive
         "2"="1"))) %>% # binge/purge
  mutate(phys_activity=factor(dplyr::recode(siabex_question_21_an_type,
                                                    "nein"="1",
                                                    "selten (weniger als 2 x pro Woche)"="2",
                                                    "oefter (mind. 2 x pro Woche)"="3",
                                                    "haeufig (bis 1 x taeglich)"="4",
                                                    "sehr haeufig (mehrmals taeglich)"=
                                              "5"))) %>%
  mutate(phys_activity=ordered(phys_activity, levels=c(1,2,3,4,5))) %>% # from least to greatest
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, storage_name, 
                measure, age_at_date_of_research, e_tiv, 
                bmisds_at_date_of_research, delta.bmisds.sm, minbmi, doi,
                edi_core, resultquest_bdi2_total, stait, 
                subtype, phys_activity) %>%
  nest(-c(region, labeller.amy, whole.sub)) %>%
  mutate(
    imp.predmatrix=map(data, ~mice(.x, maxit=0)$predictorMatrix),
    imp.meth=map(data, ~mice(.x, maxit=0)$method),
    imp=map(data, ~mice(.x, seed=123456, maxit=10, m=10, print=FALSE)),
    imp.extract=map(imp, ~complete(.x, action="all", include=FALSE, mild=FALSE))) %>%
  unnest(imp.extract)
```

```{r smmultimp, results="asis", message=FALSE, warning=FALSE}
set.seed(123456)

sm.leptin_join_pre <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(leptin_result)) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, por, leptin_result, leptin2021, 
                leptin_batch_recoded) %>%
  mutate(lod=ifelse(leptin2021==TRUE, 0.20, 0.05)) %>% 
  mutate(leptin=ifelse(leptin_result<lod, NA, leptin_result))

sm.leptin_join <- dummy_cols(sm.leptin_join_pre, 
                          select_columns="leptin_batch_recoded")

sm.leptin_impute <- sm.impute.covs %>% 
  mutate(
    sum.is.na=map_dbl(imp.extract, ~sum(is.na(.x))),
    data.clmi=map(imp.extract, ~left_join(.x, sm.leptin_join, by="storage_name")),
    data.clmi=map(data.clmi, ~mutate(.x,
                                     measure.std=(measure-mean(measure))/sd(measure),
                                     age.std=(age_at_date_of_research-
                                                mean(age_at_date_of_research))/
                                       sd(age_at_date_of_research),
                                     etiv.std=(e_tiv-mean(e_tiv))/sd(e_tiv),
                                     bmisds.std=(bmisds_at_date_of_research-
                                                   mean(bmisds_at_date_of_research))/
                                       sd(bmisds_at_date_of_research),
                                     minbmi.std=(minbmi-mean(minbmi))/sd(minbmi),
                                     doi.std=(doi-mean(doi))/sd(doi),
                                     edi.std=(edi_core-mean(edi_core))/sd(edi_core),
                                     bdi.std=(resultquest_bdi2_total-
                                                mean(resultquest_bdi2_total))/
                                       sd(resultquest_bdi2_total),
                                     stait.std=(stait-mean(stait))/sd(stait),
                                     subtype=as.numeric(subtype),
                                     phys_activity=as.numeric(phys_activity))),
    clmi=map(data.clmi, ~clmi(log10(leptin) ~measure.std + poly(age.std, degree=2, raw=FALSE) +
                                etiv.std + bmisds.std + minbmi.std + doi.std + 
                                edi.std + bdi.std + stait.std + subtype + phys_activity, 
                              df=.x, lod=lod, seed=123456, n.imps=1)),
    extract.clmi=map(clmi, ~.x$imputed.dfs)) %>%
    unnest(extract.clmi) %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi)
```

## Longitudinal change scores

```{r longichangeT1T2, results="asis", message=FALSE, warning=FALSE}
# Longitudinal sample (calculate differences T2 - T1)
descriptive.data_T2.T1 <- sample %>%
  filter(por=="acAN") %>%
  distinct(storage_name, .keep_all=TRUE) %>% 
  mutate(date_of_research=as.numeric(date_of_research)) %>%
  dplyr::select(participant_id, point_of_research, date_of_research, age_at_date_of_research, 
                bmi_at_date_of_research, bmisds_at_date_of_research,
                e_tiv, subcort_gray, edi_core, resultquest_bdi2_total,
                resultquest_scl90r_skagloba) %>% 
  pivot_longer(-c(participant_id, point_of_research), names_to="variable", values_to="value") %>% 
  pivot_wider(names_from="point_of_research", values_from="value") %>%
  mutate(delta=T2 - T1) %>%
  mutate(delta.p=100*(delta/T1)) %>%
  pivot_longer(-c(participant_id, variable, delta, delta.p), names_to="point_of_research", 
               values_to="value") %>%
  pivot_wider(names_from=c("variable", "point_of_research"), values_from=c("value", "delta", "delta.p")) %>%
  dplyr::select(participant_id, delta_date_of_research_T2, delta_age_at_date_of_research_T2,
                delta_bmi_at_date_of_research_T2, delta.p_bmi_at_date_of_research_T2, 
                delta_bmisds_at_date_of_research_T2,
                delta_subcort_gray_T2,
                delta_edi_core_T2, delta_resultquest_bdi2_total_T2,
                delta_resultquest_scl90r_skagloba_T2) 

descriptive.data_T2.T1 %>%
  get_summary_stats(delta_date_of_research_T2, delta.p_bmi_at_date_of_research_T2) %>%
  mutate(variable.labelled=labeller.desc(variable)) %>%
  dplyr::select(variable.labelled, n, mean, sd, min, max) %>%
  knitr::kable(format="html", align="l", digits=1, col.names=c("Variable", "n", "mean", "sd", "min", "max"),
               caption="Duration of inpatient treatment (Date TP2 - Date TP1) and % BMI increase in acAN patients (TP2 - TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10") 
```

## Descriptives data

```{r descriptivedata, results="asis", message=FALSE, warning=FALSE}
descriptive.data <- sample %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(descriptive.data_T2.T1, by="participant_id") %>% 
  mutate(across(contains("delta"), ~ifelse(point_of_research=="T2", ., NA))) %>%
  dplyr::select(storage_name, participant_id, id_subset, point_of_research, por, everything())

# Prepare descriptive table
descriptives <- descriptive.data %>%
  group_by(point_of_research) %>%
  rstatix::get_summary_stats(age_at_date_of_research, iq,
                             bmi_at_date_of_research, bmisds_at_date_of_research, minbmi, 
                             e_tiv, subcort_gray, 
                             edi_core, resultquest_bdi2_total, stai_t,
                             resultquest_scl90r_skagloba,
                             delta_age_at_date_of_research_T2, 
                             delta_bmi_at_date_of_research_T2,
                             delta_bmisds_at_date_of_research_T2,
                             delta_subcort_gray_T2,  
                             delta_edi_core_T2, 
                             delta_resultquest_bdi2_total_T2,
                             delta_resultquest_scl90r_skagloba_T2) %>%
  dplyr::select(point_of_research, variable, n, mean, sd) %>%
  ungroup() %>%
  mutate(mean=ifelse(variable %in% c("e_tiv", "subcort_gray", "delta_subcort_gray_T2"),
                     formatC(mean, format="f", big.mark=",", digits=0),
                     formatC(mean, format="f", digits=2))) %>%
  mutate(sd=ifelse(variable %in% c("e_tiv", "subcort_gray", "delta_subcort_gray_T2"),
                   formatC(sd, format="f", big.mark=",", digits=0),
                   formatC(sd, format="f", digits=2)))
  
descriptives_T1 <- descriptives %>% filter(point_of_research=="T1") %>%
  mutate(n_T1=n) %>%
  unite("mean_sd_T1", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_T1, mean_sd_T1)
  
descriptives_T2 <- descriptives %>% filter(point_of_research=="T2") %>%
  filter(!str_detect(variable, "delta")) %>%
  mutate(n_T2=ifelse(variable=="e_tiv", NA, n)) %>%
  unite("mean_sd_T2", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  mutate(mean_sd_T2=ifelse(variable=="e_tiv", NA, mean_sd_T2)) %>%
  dplyr::select(variable, n_T2, mean_sd_T2)

descriptives_delta <- descriptives %>% filter(point_of_research=="T2") %>%
  filter(str_detect(variable, "delta")) %>%
  mutate(n_delta=n) %>%
  unite("mean_sd_delta", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  mutate(variable=dplyr::recode(variable,
                                  "delta_age_at_date_of_research_T2"="age_at_date_of_research",
                                  "delta_bmi_at_date_of_research_T2"="bmi_at_date_of_research",
                                  "delta_bmisds_at_date_of_research_T2"="bmisds_at_date_of_research",
                                  "delta_subcort_gray_T2"="subcort_gray", 
                                  "delta_edi_core_T2"="edi_core",
                                  "delta_resultquest_bdi2_total_T2"="resultquest_bdi2_total",
                                  "delta_resultquest_scl90r_skagloba_T2"="resultquest_scl90r_skagloba")) %>%
  dplyr::select(variable, n_delta, mean_sd_delta)

descriptives_recAN <- descriptives %>% filter(point_of_research=="recAN") %>%
  mutate(n_recAN=n) %>%
  unite("mean_sd_recAN", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_recAN, mean_sd_recAN)

descriptives_HC <- descriptives %>% filter(point_of_research=="HCW") %>%
  mutate(n_HC=n) %>%
  unite("mean_sd_HC", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_HC, mean_sd_HC)

descriptives_joined <- descriptives_T1 %>%
  full_join(descriptives_T2, by="variable") %>%
  full_join(descriptives_delta, by="variable") %>%
  full_join(descriptives_recAN, by="variable") %>%
  full_join(descriptives_HC, by="variable") 


# Age range of participants per study group
descriptive.data %>%
  group_by(point_of_research) %>%
  rstatix::get_summary_stats(age_at_date_of_research,
                             delta.p_bmi_at_date_of_research_T2) %>%
  dplyr::select(point_of_research, variable, min, max) %>%
  knitr::kable(format="html", align="l", digits=1, col.names=c("Group", "Variable", "min", "max"), caption="Age and BMI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") 
```

## ANOVAs (mixed ANOVAs using multilevel model approach)

Tests for subcortical GM volume: adjustment for linear and quadratic age
effects and eTIV;\
FDR-adjustment across all contrasts obtained for 1 descriptive variable
(no FDR-adjustment across descriptive variables)\
*Previously/Originally: Multiple comparisons adjustment: multivariate t
distribution approach (cf. multcomp::glht, Frank Bretz, Torsten Hothorn,
Peter Westfall) for all contrasts obtained for 1 descriptive variable
(adjust="mvt")*

!!!Effect size package for effect sizes in linear mixed effects
models!!!\
<https://easystats.github.io/effectsize/articles/from_test_statistics.html>\
<https://cran.r-project.org/web/packages/effectsize/vignettes/from_test_statistics.html>

```{r mixedanovas, results="asis", message=FALSE, warning=FALSE}
anovas.prep <- descriptive.data %>%
  dplyr::select(participant_id, por, point_of_research, age_at_date_of_research, iq, 
                bmi_at_date_of_research, bmisds_at_date_of_research, minbmi,
                e_tiv, subcort_gray, 
                edi_core, resultquest_bdi2_total, resultquest_scl90r_skagloba, stai_t) %>%
  pivot_longer(-c(participant_id, por, point_of_research), names_to="variable", values_to="value") %>%
  mutate(value=ifelse(is.nan(value), NA, value)) %>% # consistent formatting of "NA"s
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                             as.character(point_of_research)), levels=c("T1", "T2"))) %>%
  dplyr::select(-point_of_research)


# One-way ANOVAs for IQ, min BMI, eTIV, and trait anxiety
acAN=c(1, 0, 0)
recAN=c(0, 1, 0)
HC=c(0, 0, 1)

anovas <- anovas.prep %>%
  filter(variable %in% c("iq", "minbmi", "e_tiv", "stai_t")) %>% filter(tp!="T2") %>% 
  nest(data=-variable) %>%
  mutate(
    lm=map(data, ~lm(value ~por, data=.x, na.action=na.omit)),
    emmeans=map(lm, ~emmeans(.x, "por")),
    emmeanstidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, 
                                              method=list("AcAN-TP1vsHC"=acAN - HC,
                                                          "RecANvsHC"=recAN - HC), 
                                              adjust="fdr")), 
    contraststidy=map(contrasts, tidy),
    anova=map(lm, ~car::Anova(.x, type="III", test.statistic="F")),
    anova=map(anova, ~rownames_to_column(.x, "term")),
    dferror=map_dbl(lm, df.residual)) %>%
  dplyr::select(variable, anova, dferror, contraststidy)


# Mixed ANOVAs (LME4)
acAN_TP1.m=c(1, 0, 0, 0, 0, 0) # "m" for mixed
recAN.m=c(0, 1, 0, 0, 0, 0)
HC.m=c(0, 0, 1, 0, 0, 0)
acAN_TP2.m=c(0, 0, 0, 1, 0, 0)

anovas.lme <- anovas.prep %>%
  filter(!variable %in% c("iq", "minbmi", "e_tiv", "stai_t", "subcort_gray")) %>%
  mutate(participant_id=factor(participant_id)) %>%
  nest(data=-variable) %>%
  mutate(
    lme=map(data, ~lme4::lmer(value ~1 + por + tp + (1|participant_id), data=.x, REML=TRUE, 
                                 na.action=na.omit)),
    emmeans=map(lme, ~emmeans::emmeans(.x, c("por", "tp"), lmer.df="satterthwaite", type="response")), # type "response" means that emmeans are not log-transformed (output on the expected/original scale)
    emmeanstidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP1vsHC"=acAN_TP1.m - HC.m,
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.m - acAN_TP1.m,
      #"AcAN-TP2vsRecAN"=acAN_TP2.m - recAN.m,
      "AcAN-TP2vsHC"=acAN_TP2.m - HC.m,
      "RecANvsHC"=recAN.m - HC.m), lmer.df="satterthwaite", adjust="fdr")),
    contraststidy=map(contrasts, tidy),
    anova=map(data, ~anova(lmerTest::lmer(value ~1 + por + tp + (1|participant_id), 
                                             data=.x, REML=TRUE, na.action=na.omit),
                              type="III", ddf="Satterthwaite")),
    anova=map(anova, ~rownames_to_column(.x, "term"))) %>%
  dplyr::select(variable, anova, contraststidy) 

anovas.subcort <- descriptive.data %>%
  dplyr::select(participant_id, por, point_of_research, age_at_date_of_research,
                e_tiv, subcort_gray) %>%
  pivot_longer(-c(participant_id, por, point_of_research, age_at_date_of_research,
                  e_tiv), names_to="variable", values_to="value") %>%
  mutate(value=ifelse(is.nan(value), NA, value)) %>%
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                             as.character(point_of_research)))) %>%
  mutate(participant_id=factor(participant_id)) %>%
  dplyr::select(-point_of_research) %>%
  filter_at(vars(por, tp, value, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  nest(data=-variable) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme=map(data, ~lme4::lmer(value ~1 + por + tp + 
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c +  
                                (1|participant_id), data=.x, REML=TRUE, na.action=na.omit)),
    emmeans=map(lme, ~emmeans::emmeans(.x, c("por", "tp"), lmer.df="satterthwaite", type="response")),
    emmeanstidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP1vsHC"=acAN_TP1.m - HC.m,
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.m - acAN_TP1.m,
      #"AcAN-TP2vsRecAN"=acAN_TP2.m - recAN.m,
      "AcAN-TP2vsHC"=acAN_TP2.m - HC.m,
      "RecANvsHC"=recAN.m - HC.m), lmer.df="satterthwaite", adjust="fdr")),
    contraststidy=map(contrasts, tidy),
    anova=map(data, ~anova(lmerTest::lmer(value ~1 + por + tp + 
                                            poly(age.c, degree=2, raw=FALSE) +
                                            etiv.c +  
                                            (1|participant_id), 
                                          data=.x, REML=TRUE, na.action=na.omit),
                              type="III", ddf="Satterthwaite")),
    anova=map(anova, ~rownames_to_column(.x, "term"))) %>%
  dplyr::select(variable, anova, contraststidy) 


# Prepare ANOVA output
anovas.out <- anovas %>%
  dplyr::select(variable, anova, dferror) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair="universal") %>% # remove spaces in column names after analysis
  filter(term=="por") %>%
  nest(effdata=c(F.value, Df, dferror)) %>%
  mutate(p.eta.sq=map(effdata, ~F_to_eta2(.x$F.value, .x$Df, .x$dferror, ci = 0.95,
                                            alternative="two.sided"))) %>%
  unnest(effdata, p.eta.sq) %>%
  mutate(p.eta.sq_formatted=ifelse(abs(Eta2_partial)<0.01, "<0.01", 
                            formatC(abs(Eta2_partial), format="f", digits=2))) %>%
  mutate(F.value=formatC(F.value, format="f", big.mark=",", digits=2)) %>%
  mutate(p_formatted=ifelse(Pr..F.<0.001, "<0.001", 
                            formatC(Pr..F., format="f", digits=3))) %>%
  dplyr::select(variable, F.value, p_formatted, p.eta.sq_formatted)

anovas.lme.out <- anovas.lme %>%
  dplyr::select(variable, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(term %in% c("por", "tp")) %>%
  nest(effdata=c(F.value, NumDF, DenDF)) %>%
  mutate(p.eta.sq=map(effdata, ~F_to_eta2(.x$F.value, .x$NumDF, .x$DenDF, ci=0.95,
                                            alternative="two.sided"))) %>%
  unnest(effdata, p.eta.sq) %>%
  mutate(p.eta.sq_formatted=ifelse(abs(Eta2_partial)<0.01, "<0.01", 
                            formatC(abs(Eta2_partial), format="f", digits=2))) %>%
  
  group_by(variable) %>%
  mutate(F.value=formatC(F.value, format="f", big.mark=",", digits=2)) %>%
  mutate(F.value=paste(F.value, collapse=" | ")) %>%
  mutate(p_formatted=ifelse(Pr..F.<0.001, "<0.001", 
                            formatC(Pr..F., format="f", digits=3))) %>%
  mutate(p_formatted=paste(p_formatted, collapse=" | ")) %>%
  mutate(p.eta.sq_formatted=paste(p.eta.sq_formatted, collapse=" | ")) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(variable, F.value, p_formatted, p.eta.sq_formatted)

anovas.subcort.out <- anovas.subcort %>%
  dplyr::select(variable, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(term %in% c("por", "tp")) %>%
  nest(effdata=c(F.value, NumDF, DenDF)) %>%
  mutate(p.eta.sq=map(effdata, ~F_to_eta2(.x$F.value, .x$NumDF, .x$DenDF, ci=0.95,
                                            alternative="two.sided"))) %>%
  unnest(effdata, p.eta.sq) %>%
  mutate(p.eta.sq_formatted=ifelse(abs(Eta2_partial)<0.01, "<0.01", 
                            formatC(abs(Eta2_partial), format="f", digits=2))) %>%
  mutate(F.value=formatC(F.value, format="f", big.mark=",", digits=2)) %>%
  mutate(F.value=paste(F.value, collapse=" | ")) %>%
  mutate(p_formatted=ifelse(Pr..F.<0.001, "<0.001", 
                            formatC(Pr..F., format="f", digits=3))) %>%
  mutate(p_formatted=paste(p_formatted, collapse=" | ")) %>%
  mutate(p.eta.sq_formatted=paste(p.eta.sq_formatted, collapse=" | ")) %>%
  slice_head(n=1) %>%
  dplyr::select(variable, F.value, p_formatted, p.eta.sq_formatted)
```

## Descripive statistics for multiply imputed Log10-leptin

Info here:
<https://simongrund1.github.io/posts/anova-with-multiply-imputed-data-sets/>
Li, K. H., T. E. Raghunathan, and D. B. Rubin. 1991. Large-Sample
Significance Levels from Multiply Imputed Data Using Moment-Based
Statistics and an F Reference Distribution. Journal of the American
Statistical Association, 86(416): 1065--73.

Emmeans package supports multiple imputation (mira objects, Rubin's
rules)!

```{r mixedanovasleptin, results="asis", message=FALSE, warning=FALSE}
logleptin_T2_recAN_HC_join <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research!="T1") %>%
  filter(!is.na(leptin_result)) %>%
  mutate(leptin_transform_imputed=log10(leptin_result)) %>%
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                             as.character(point_of_research)), levels=c("T1", "T2"))) %>%
  dplyr::select(participant_id, leptin_transform_imputed, por, tp)

anovas.leptin_pre <- leptin_impute %>%
  mutate(variable="log_leptin") %>%
  dplyr::select(variable, extract.clmi) %>%
  mutate(
    extract.clmi.filter=map(extract.clmi, ~dplyr::select(.x, participant_id, 
                                                         leptin_transform_imputed, 
                                                         por)),
    extract.clmi.filter=map(extract.clmi.filter, ~mutate(.x, tp=factor("T1"))),
    data=map(extract.clmi.filter, ~rbind(.x, logleptin_T2_recAN_HC_join)),
    data=map(data, ~mutate(.x, leptin_imputed=10^leptin_transform_imputed)),
    data=map(data, ~group_by(.x, participant_id)),
    data=map(data, ~arrange(.x, tp, .by_group=TRUE)),
    data=map(data, ~mutate(.x, 
                           delta.log_leptin.clmi=ifelse(tp=="T2", 
                                                        leptin_transform_imputed - 
                                                          lag(leptin_transform_imputed),
                                                        NA),
                           delta.leptin.clmi=ifelse(tp=="T2", 
                                                    leptin_imputed - 
                                                      lag(leptin_imputed),
                                                    NA))),
    data=map(data, ~ungroup(.x)),
    lme=map(data, ~lme4::lmer(leptin_transform_imputed ~1 + por + tp + (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.red.por=map(data, ~lme4::lmer(leptin_transform_imputed ~1 + tp + (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.red.tp=map(data, ~lme4::lmer(leptin_transform_imputed ~1 + por + (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit))) 

anovas.leptin <- anovas.leptin_pre %>%
  nest(pooldata=-variable) %>%
  mutate(
    pool.por=map(pooldata, ~mice::D1(.x$lme, .x$lme.red.por, dfcom=NULL)), #pooled or multivariate Wald test, using F reference distribution (comparing 2 models: 1st model=full/complete model, 2nd model=without the variable of interest) 
    pool.por.summary=map(pool.por, ~summary(.x, conf.int=TRUE, conf.level=0.95)),
    pool.tp=map(pooldata, ~mice::D1(.x$lme, .x$lme.red.tp, dfcom=NULL)),
    pool.tp.summary=map(pool.tp, ~summary(.x, conf.int=TRUE, conf.level=0.95)))

anovas.leptin.wt <- anovas.leptin %>%
  dplyr::select(variable, pool.tp.summary) %>%
  unnest(pool.tp.summary) %>%
  dplyr::slice(n=2) %>%
  unnest(pool.tp.summary)

anovas.leptin.out <- anovas.leptin %>%
  dplyr::select(variable, pool.por.summary) %>%
  unnest(pool.por.summary) %>%
  dplyr::slice(n=2) %>%
  unnest(pool.por.summary) %>%
  rbind(anovas.leptin.wt) %>%
  nest(effdata=c(statistic, df1, df2)) %>%
  mutate(p.eta.sq=map(effdata, ~F_to_eta2(.x$statistic, .x$df1, .x$df2, ci=0.95,
                                          alternative="two.sided"))) %>%
  unnest(effdata, p.eta.sq) %>%
  mutate(p.eta.sq_formatted=ifelse(abs(Eta2_partial)<0.01, "<0.01", 
                            formatC(abs(Eta2_partial), format="f", digits=2))) %>%
  mutate(F.value=formatC(statistic, format="f", big.mark=",", digits=2)) %>%
  mutate(F.value=paste(F.value, collapse=" | ")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p_formatted=paste(p_formatted, collapse=" | ")) %>%
  mutate(p.eta.sq_formatted=paste(p.eta.sq_formatted, collapse=" | ")) %>%
  slice_head(n=1) %>%
  dplyr::select(variable, F.value, p_formatted, p.eta.sq_formatted)


contrasts_leptin <- emmeans::contrast(emmeans::emmeans(as.mira(anovas.leptin_pre$lme), c("por", "tp"), lmer.df="satterthwaite",
                                       type="response"), method=list(
                                         "AcAN-TP1vsHC"=acAN_TP1.m - HC.m,
                                         "AcAN-TP2vsAcAN-TP1"=acAN_TP2.m - acAN_TP1.m,
                                         #"AcAN-TP2vsRecAN"=acAN_TP2.m - recAN.m,
                                         "AcAN-TP2vsHC"=acAN_TP2.m - HC.m,
                                         "RecANvsHC"=recAN.m - HC.m), 
                  lmer.df="satterthwaite", adjust="fdr") %>% tidy() %>%
  mutate(variable="log_leptin")


descriptives_leptin <- anovas.leptin_pre %>%
  dplyr::select(data) %>%
  unnest(data) %>%
  dplyr::rename(leptin=leptin_imputed, log_leptin=leptin_transform_imputed) %>%
  unite("por_tp", c(por, tp), sep="_", remove=TRUE, na.rm=TRUE) %>%
  group_by(por_tp) %>%
  rstatix::get_summary_stats(leptin, log_leptin, delta.log_leptin.clmi, delta.leptin.clmi) %>%
  dplyr::select(por_tp, variable, n, mean, sd) %>%
  mutate(n=n/1000) %>%
  ungroup() %>% 
  mutate(mean=formatC(mean, format="f", digits=2)) %>%
  mutate(sd=formatC(sd, format="f", digits=2))


descriptives_leptin_T1 <- descriptives_leptin %>% filter(por_tp=="acAN_T1") %>%
  mutate(n_T1=n) %>%
  unite("mean_sd_T1", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_T1, mean_sd_T1)

descriptives_leptin_T2 <- descriptives_leptin %>% filter(por_tp=="acAN_T2") %>%
  filter(!str_detect(variable, "delta")) %>%
  mutate(n_T2=n) %>%
  unite("mean_sd_T2", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_T2, mean_sd_T2)

descriptives_leptin_delta <- descriptives_leptin %>% filter(por_tp=="acAN_T2") %>%
  filter(str_detect(variable, "delta")) %>%
  mutate(n_delta=n) %>%
  unite("mean_sd_delta", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  mutate(variable=dplyr::recode(variable,
                                  "delta.leptin.clmi"="leptin",
                                  "delta.log_leptin.clmi"="log_leptin")) %>%
  dplyr::select(variable, n_delta, mean_sd_delta)

descriptives_leptin_recAN <- descriptives_leptin %>% filter(por_tp=="recAN_T1") %>%
  mutate(n_recAN=n) %>%
  unite("mean_sd_recAN", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_recAN, mean_sd_recAN)

descriptives_leptin_HC <- descriptives_leptin %>% filter(por_tp=="HCW_T1") %>%
  mutate(n_HC=n) %>%
  unite("mean_sd_HC", c(mean, sd), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(variable, n_HC, mean_sd_HC)

descriptives_leptin_joined <- descriptives_leptin_T1 %>%
  full_join(descriptives_leptin_T2, by="variable") %>%
  full_join(descriptives_leptin_delta, by="variable") %>%
  full_join(descriptives_leptin_recAN, by="variable") %>%
  full_join(descriptives_leptin_HC, by="variable")

# Cave: alternative way to calculate mean and sd after multiple imputation in acAN-TP1
pool_mean_sd <- leptin_impute %>%
  dplyr::select(extract.clmi) %>% 
  mutate( 
    mean=map(extract.clmi, ~mean(.x$leptin_transform_imputed)),
    sd=map(extract.clmi, ~sd(.x$leptin_transform_imputed)),
    mean_raw=map(extract.clmi, ~mean(10^(.x$leptin_transform_imputed))),
    sd_raw=map(extract.clmi, ~sd(10^(.x$leptin_transform_imputed))))

round(Reduce("+", pool_mean_sd$mean_raw)/length(pool_mean_sd$mean_raw), digits=2)
round(Reduce("+", pool_mean_sd$sd_raw)/length(pool_mean_sd$sd_raw), digits=2)
```

## Table with descriptive statistics

State in legend! df(por)=2; df(tp)=1

```{r desctable, results="asis", message=FALSE, warning=FALSE}
# Join ANOVA output
anovas.combi.out <- bind_rows(anovas.out, anovas.lme.out, anovas.subcort.out, anovas.leptin.out)

# Join contrast output
contrasts.out <- bind_rows(anovas, anovas.lme, anovas.subcort) %>%
  dplyr::select(variable, contraststidy) %>%
  unnest(contraststidy) %>%
  rbind(contrasts_leptin) %>%
  mutate(comparison=ifelse(statistic>0, ">", "<")) %>%
  mutate(comparison=str_replace(contrast, "vs", comparison)) %>%
  filter(adj.p.value<0.05) %>% # only significant post-hoc contrasts are shown
  mutate(p.fdr_formatted=ifelse(adj.p.value<0.001, "<0.001", 
                                formatC(adj.p.value, format="f", digits=3))) %>%
  mutate(brackets01=ifelse(adj.p.value<0.001, " (q", " (q=")) %>%
  mutate(brackets02=")") %>%
  unite("posthoc", c(comparison, brackets01, p.fdr_formatted, brackets02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  group_by(variable) %>%
  dplyr::summarize(posthoc=paste(posthoc, collapse=" | ")) %>%
  dplyr::select(variable, posthoc)


desctable <- descriptives_joined %>%
  rbind(descriptives_leptin_joined) %>%
  left_join(anovas.combi.out, by="variable") %>%
  left_join(contrasts.out, by="variable") %>%
  mutate(variable.labelled=labeller.desc(variable)) %>%
  mutate(variable=order.desc(variable)) %>%
  arrange(variable) %>%
  mutate(variables_group=dplyr::recode(variable, !!!variables_grouper.desc, 
                                       .default="missing group"))

desctable %>%
  dplyr::select(variable.labelled, n_T1, mean_sd_T1, n_T2, mean_sd_T2, n_delta, mean_sd_delta, n_recAN, 
                mean_sd_recAN, n_HC, mean_sd_HC, F.value, p_formatted, p.eta.sq_formatted, posthoc) %>%
  knitr::kable(format="html", align="l", col.names=c("Variable", rep(c("N", "Mean ± SD"), 2), "N", 
                                                           "88 ± 27 days", rep(c("N", "Mean ± SD"), 2),
                                                           "F(between) | F(within)",
                                                           "p(between) | p(within)",
                                                           "Partial eta squared",
                                                           "Significant at FDR-q<0.05"),
               caption="Table 1: Descriptive statistics of the study sample") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10") %>%
  add_header_above(c("", "AcAN-TP1"=2, "AcAN-TP2"=2, "AcAN-TP2 - AcAN-TP1"=2, "RecAN"=2, "HC"=2, " "=4),
                   align="l") %>%
  add_header_above(c("", "Acute AN sample at two study time points"=4, "Change"=2, "Control samples"=4, 
                     "Test statistics"=3, "Post-hoc contrasts"=1), align="l") %>% 
  pack_rows(index=table(fct_inorder(desctable$variables_group))) 
```

# Main LME

## LMEprep: Test nonlinear age and deltaBMI-SDS effects

```{r lmeprep, results="asis", message=FALSE, warning=FALSE}
lme.age <- lmedata %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.age.squared=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                        data=.x, REML=TRUE, na.action=na.omit)),
    lme.age.squared.tidy=map(lme.age.squared, tidy),
    # Models must be hierarchical for comparison, ML should be used for model selection/comparison (ML: estimates fixed effects better, REML: estimates random effects better)
    lme.age.compare=map(data, ~anova(lme4::lmer(measure ~1 + por +
                                                 delta.bmisds +
                                                 age.c +
                                                 etiv.c + 
                                                 (1|participant_id), 
                                                data=.x, REML=FALSE, na.action=na.omit),
                                    lme4::lmer(measure ~1 + por +
                                                 delta.bmisds +
                                                 poly(age.c, degree=2, raw=FALSE) +
                                                 etiv.c + 
                                                 (1|participant_id), 
                                               data=.x, REML=FALSE, na.action=na.omit))))

lme.age %>%
  dplyr::select(labeller.amy, hemi_region, lme.age.squared.tidy) %>%
  unnest(lme.age.squared.tidy) %>%
  mutate(age.squared.effects=ifelse((term=="poly(age.c, degree = 2, raw = FALSE)2")&(p.value<0.05), 
                                    TRUE, FALSE)) %>%
  filter(str_detect(term, "age")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif, age.squared.effects) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                                                     "t", "p", "Signif.", "Signif. quadratic age effets?"), 
               caption="LME model with linear and quadratratic age effects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
    add_header_above(c("Linear age effects are significant. Quadratic age effects are not significant. Nonetheless, quadratic age effects are included in the main LME model due to evidence for nonlinear age effects on subcortical brain volumes and in line with recent ENIGMA studies."=9), align="l") 

lme.age %>%
  dplyr::select(labeller.amy, hemi_region, lme.age.compare) %>%
  unnest(lme.age.compare) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(model=ifelse(npar==8, "LME: linear age effects", 
                      "LME: linear and quadratic age effects")) %>%
  mutate(age.squared.improve=ifelse((npar==9)&(Pr..Chisq.<0.05), TRUE, FALSE)) %>%
  mutate(p=formatC(Pr..Chisq., format="f", digits=3)) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, model, AIC, BIC, logLik, Chisq, p, age.squared.improve) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "Model", 
                                                               "Akaike information criterion (AIC)",
                                                               "Bayesian information criterion (BIC)",
                                                               "Log likelihood", 
                                                               "Chi-squared test", "p", "Improved model fit incl. age squared?"), 
               caption="LME model fit comparison: age effects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Adding quadratic age effects does not significantly improve the LME model fit. Nonetheless, quadratic age effects are included in the main LME model due to evidence for nonlinear age effects on subcortical brain volumes and in line with recent ENIGMA studies."=8), align="l") 


lme.delta.bmisds <- lmedata %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.delta.bmisds.cubic=map(data, ~lmerTest::lmer(measure ~1 + por +
                                                         poly(delta.bmisds, degree=3, raw=FALSE) +
                                                         poly(age.c, degree=2, raw=FALSE) + # linear + quadratic age effects
                                                         etiv.c + 
                                                         (1|participant_id), 
                                                       data=.x, REML=TRUE, na.action=na.omit)),
    lme.delta.bmisds.cubic.tidy=map(lme.delta.bmisds.cubic, tidy),
    lme.delta.bmisds.compare=map(data, ~anova(lme4::lmer(measure ~1 + por +
                                                           delta.bmisds +
                                                           poly(age.c, degree=2, raw=FALSE) +
                                                           etiv.c + 
                                                           (1|participant_id), 
                                                         data=.x, REML=FALSE, na.action=na.omit),
                                    lme4::lmer(measure ~1 + por +
                                                 poly(delta.bmisds, degree=2, raw=FALSE) +
                                                 poly(age.c, degree=2, raw=FALSE) +
                                                 etiv.c + 
                                                 (1|participant_id), 
                                               data=.x, REML=FALSE, na.action=na.omit),
                                    lme4::lmer(measure ~1 + por +
                                                 poly(delta.bmisds, degree=3, raw=FALSE) +
                                                 poly(age.c, degree=2, raw=FALSE) +
                                                 etiv.c + 
                                                 (1|participant_id), 
                                               data=.x, REML=FALSE, na.action=na.omit))))

lme.bmisds.effects <- lme.delta.bmisds %>%
  dplyr::select(labeller.amy, hemi_region, lme.delta.bmisds.cubic.tidy) %>%
  unnest(lme.delta.bmisds.cubic.tidy) %>%
  mutate(delta.bmisds.squared.effects=ifelse((term=="poly(delta.bmisds, degree = 3, raw = FALSE)2")&(p.value<0.05), TRUE, FALSE)) %>%
  mutate(delta.bmisds.cubic.effects=ifelse((term=="poly(delta.bmisds, degree = 3, raw = FALSE)3")&(p.value<0.05), TRUE, FALSE)) %>%
  filter(str_detect(term, "delta.bmisds")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  arrange(hemi_region)

lme.bmisds.effects %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif, 
                delta.bmisds.squared.effects, delta.bmisds.cubic.effects) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                                                     "t", "p", "Signif.", "Signif. quadratic deltaBMI-SDS effets?", 
                                                     "Signif. cubic deltaBMI-SDS effets?"), 
               caption="LME model with linear and quadratratic deltaBMI-SDS effects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
    add_header_above(c("Linear deltaBMI-SDS effects are significant. Quadratic deltaBMI-SDS effects are also significant for some nuclei. No significant cubic deltaBMI-SDS effects."=10), align="l") 

anova.bmisds.effects <- lme.delta.bmisds %>%
  dplyr::select(labeller.amy, hemi_region, lme.delta.bmisds.compare) %>%
  unnest(lme.delta.bmisds.compare) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(model=ifelse(npar==9, "LME: linear deltaBMI-SDS effects", 
                      ifelse(npar==10, "LME: linear and quadratic deltaBMI-SDS effects",
                      "LME: linear, quadratic, and cubic deltaBMI-SDS effects"))) %>%
  mutate(delta.bmisds.squared.improve=ifelse((npar==10)&(Pr..Chisq.<0.05), TRUE, FALSE)) %>%
  mutate(delta.bmisds.cubic.improve=ifelse((npar==11)&(Pr..Chisq.<0.05), TRUE, FALSE)) %>%
  mutate(p=formatC(Pr..Chisq., format="f", digits=3)) %>%
  arrange(hemi_region)

anova.bmisds.effects %>%
  dplyr::select(labeller.amy, model, AIC, BIC, logLik, Chisq, p, 
                delta.bmisds.squared.improve, delta.bmisds.cubic.improve) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "Model", 
                                                               "Akaike information criterion (AIC)",
                                                               "Bayesian information criterion (BIC)",
                                                               "Log likelihood", 
                                                               "Chi-squared test", "p",
                                                               "Improved model fit incl. deltaBMI-SDS squared?",
                                                               "Improved model fit incl. deltaBMI-SDS cubic?"), 
               caption="LME model fit comparison: deltaBMI-SDS effects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Adding quadratic deltaBMI-SDS effects significantly improves the LME model fit for some nuclei. No significsnt model fit improvement when adding cubic deltaBMI-SDS effects."=9), align="l")

sig.lme.bmisds <- lme.bmisds.effects %>%
  dplyr::select(hemi_region, delta.bmisds.squared.effects, delta.bmisds.cubic.effects)

sig.anova.bmisds <- anova.bmisds.effects %>%
  dplyr::select(hemi_region, delta.bmisds.squared.improve, delta.bmisds.cubic.improve)

sig.bmisds.sq <- full_join(sig.lme.bmisds, sig.anova.bmisds, by="hemi_region") %>%
  filter((delta.bmisds.squared.effects==TRUE)|(delta.bmisds.squared.improve==TRUE)) %>%
  distinct(hemi_region) %>%
  mutate(sig.bmisds.sq=TRUE)

sig.bmisds.sq
```

## LME implementation

```{r lme, results="asis", message=FALSE, warning=FALSE}
# Custom contrast setting for LME (based on reference grid)
acAN_TP2.lme      =   c(1, 0, 0, 0, 0, 0)
recAN.lme         =   c(0, 1, 0, 0, 0, 0)
HC.lme            =   c(0, 0, 1, 0, 0, 0)
acAN_TP1.lme      =   c(0, 0, 0, 1, 0, 0)

# Main LME model and modified LME model versions (F-test with type III sums of squares via Satterthwaite approximation, see Luke et al., 2017)
lme <- lmedata %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    # Main LME model: age + age^2 (linear + quadratic/non-linear age effects), deltaBMI-SDS (linear BMI-SDS change effects), eTIV (head size correction) 
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme=map(data, ~lme4::lmer(measure ~1 + por +
                                delta.bmisds +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.tidy=map(lme, tidy),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                               delta.bmisds +
                                               poly(age.c, degree=2, raw=FALSE) +
                                               etiv.c + 
                                               (1|participant_id), 
                                             data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    anova=map(lmetest, ~anova(., type="III", ddf="Satterthwaite")),
    anova=map(anova, ~rownames_to_column(.x, "term")),
    # EMMs and contrasts
    emmeans=map(lme, ~emmeans::emmeans(.x,
                                       c("por", "delta.bmisds"),
                                       at=list(delta.bmisds=
                                                 c(0, delta.bmisds.mean)), 
                                       lmer.df="satterthwaite", type="response")),
    emmeans.tidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme, # direct acAN-TP2 vs. recAN contrast
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme, # direct acAN-TP2 vs. HC contrast
      "RecANvsHC"=recAN.lme - HC.lme),
      #"AcAN-TP1vsHC"=acAN_TP1.lme - HC.lme # contrast via acAN-TP2 vs. HC - deltaBMI-SDS
      lmer.df="satterthwaite", adjust="none")),
    contrasts.tidy=map(contrasts, tidy), 
    SDtable=map(lme, ~as.tibble(lme4::VarCorr(.x))), # for effect size statistics
    SDtotal=map_dbl(SDtable, ~sqrt(.x$vcov[.x$grp=="participant_id"] + .x$vcov[.x$grp=="Residual"]))) 
    # varcorr: get random-effect variances => combine them in order to get population/total SD (https://search.r-project.org/CRAN/refmans/emmeans/html/eff_size.html); The variance of the sum of two independent random variables X and Y is equal to the sum of their variances.

contrasts <- lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, contrasts.tidy) %>%
  unnest(contrasts.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                                formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # multiple comparisons adjustment: FDR across all contrasts per (sub-)region and across all (sub-)regions (subregions and whole structure separately)
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

contrasts %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
                                                      caption="Main LME model: Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")


contrasts %>%
  filter(p.value<0.05) %>%
  filter(contrast=="AcAN-TP2vsHC") %>% 
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
                                                      caption="Main LME model: Contrasts table for AcAN-TP2 vs. HC (nominally significant contrasts)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

contrasts %>%
  filter(p.value<0.05) %>%
  filter(contrast=="RecANvsHC") %>% 
  dplyr::select(labeller.amy, contrast, term, statistic, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "t", "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
                                                      caption="Main LME model: Contrasts table for recAN vs. HC (nominally significant contrasts)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

anovas <- lme %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(DenDF=formatC(DenDF, format="f", digits=0)) %>%
  mutate(F.value=formatC(F.value, format="f", digits=2)) %>%
  mutate(p_formatted=ifelse(Pr..F.<0.001, "<0.001", formatC(Pr..F., format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(Pr..F.))) %>%
  group_by(whole.sub, term) %>%
  mutate(p.fdr=p.adjust(Pr..F., method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

anovas %>%
  dplyr::select(labeller.amy, term, NumDF, DenDF, F.value, p_formatted, signif,
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region",
                                                     "Term", "df(num)", 
                                                     "df(den)", "F", "p", "Signif.", "FDR-q", 
                                                     "Adj. Signif."),
               caption="Main LME model: ANOVA table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r lmetest, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lmetestdata <- lmedata %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  filter(hemi_region=="lh_Medial_nucleus") %>%
  filter(!is.na(delta.edicore)) %>%
  mutate(age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
         etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))

lmetest <- lme4::lmer(measure ~1 + por +
                                delta.bmisds +
                                delta.edicore +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                      data=lmetestdata, REML=TRUE, na.action=na.omit)

ref_grid(lmetest)@grid

lmetestdata %>% filter(delta.bmisds<0) %>% 
  mutate(delta.edicore.mean=mean(delta.edicore, na.rm=TRUE)) %>%
  distinct(delta.edicore.mean)

emmeanstest <- emmeans(lmetest, 
                       c("por", "delta.bmisds", "delta.edicore"),
        at=list(delta.bmisds=
                  c(0, delta.bmisds.mean),
                delta.edicore=
                  c(0, 1.755475)))
```

### Effect size statistics for main LME

Cohen's D for post-hoc LME group differences, interpretation
(benchmarks): Small effect: d=0.2; Medium effect: d=0.5; Large effect:
d=0.8 (Cohen, 1988).

```{r effectsize, results="asis", message=FALSE, warning=FALSE}
cohenlist=list()

for (Hemi_Region in unique(lme$hemi_region)) {
  
  SDtotal <- lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal)
  
  cohensD <- lme %>%
    dplyr::select(hemi_region, region, labeller.amy, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohensD=map(emmeans, ~as.tibble(emmeans::eff_size(.x, sigma=SDtotal, edf=Inf, method=list( #total population SD computed from LME model; Inf=assuming that sigma is known, does not affect estimate itself, value of sqrt(2/edf) can be interpreted as the relative accuracy of sigma; method=contrast method
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme,
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme,
      "RecANvsHC"=recAN.lme - HC.lme))))) %>%
    unnest(cohensD) %>%
    mutate(cohensD_pre=formatC(effect.size, format="f", digits=2)) %>%
    mutate(cohensD=abs(effect.size)) %>%
    mutate(d_formatted=ifelse(cohensD<0.01, "<0.01", formatC(cohensD, format="f", digits=2))) %>%
    mutate(se=formatC(SE, format="f", digits=2)) %>%
    mutate(CI_95_lower=formatC(lower.CL, format="f", digits=2)) %>%
    mutate(CI_95_upper=formatC(upper.CL, format="f", digits=2)) %>%
    mutate(bracket01="[", bracket02="]") %>%
    unite("confint_95", c(CI_95_lower, CI_95_upper), sep=",", remove=FALSE, na.rm=FALSE) %>%
    unite("confint_95", c(bracket01, confint_95, bracket02), sep="", remove=FALSE, na.rm=FALSE) %>%
    dplyr::select(hemi_region, region, labeller.amy, contrast, cohensD_pre, cohensD, 
                  d_formatted, se, confint_95)

  cohenlist[[Hemi_Region]]=cohensD
  }

cohensD.lme <- as.tibble(bind_rows(cohenlist[1:20]))
                         
cohensD.lme %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, contrast, cohensD_pre, se, confint_95) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", 
                                                     "Cohen's d", "se", "95% CI"), 
               caption="Main LME model: Effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

### Bar plot visualization of LME findings: Main LME

```{r barplotslme, fig.cap="Main LME model barplot visualization", message=FALSE, warning=FALSE}
plot_theme_transparent_bars=theme(plot.title=element_text(size=35, 
                                                         color="black", face="bold"), 
                   axis.text.x=element_text(size=35, color="black"),
                   axis.text.y=element_text(color="black"),
                   axis.title=element_text(size=35, color="black"), 
                   axis.line=element_line(color="black", size=1.5), 
                   panel.background=element_rect(fill="white"), 
                   plot.background=element_rect(fill="white", color=NA), 
                   panel.border=element_blank(),
                   panel.grid.major=element_blank(), 
                   panel.grid.minor=element_blank(), 
                   strip.background=element_rect(color=NA))

color <- sample %>%
  distinct(region) %>%
  arrange(region) %>%
  mutate(color = case_when(
       region == "Whole_amygdala" ~ "gray35",
       region == "Basal_nucleus" ~ "#880604",
       region == "Lateral_nucleus" ~ "#466f91",
       region == "Accessory_basal_nucleus" ~ "#AA4D0D",
       region == "Cortical_nucleus" ~ "#E2FAB5", 
       region == "Corticoamygdaloid_transitio" ~ "#003366",
       region == "Medial_nucleus" ~ "#006400",
       region == "Central_nucleus" ~ "#9B0AA7",
       region == "Anterior_amygdaloid_area" ~ "#FFF04D",
       region == "Paralaminar_nucleus" ~ "#22B09A")) 

bardata <- lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds==0 ~ "RecAN",
    por=="HCW" & delta.bmisds==0 ~ "HC",
    por=="recAN" & delta.bmisds!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds!=0 ~ "zerobar2")) %>%
  mutate(estimate=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, estimate), 
         std.error=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, std.error)) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "zerobar1", 
                                          "RecAN", "zerobar2", 
                                          "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 18, 14)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 12, 10)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 35)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(bardata$region)) {
  
  plotdata <- bardata %>% filter(region %in% Region)
  
  y.position <- bardata %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.75*estimate) %>%
    mutate(ymax=1.25*estimate) %>%
    mutate(sig.pos_T2.T1=(0.08*(ymax-ymin)) + (estimate+std.error)) %>%
    #mutate(sig.pos_T2.recAN=(0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_recAN.HC=(0.24*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_T2.HC=(0.40*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.015) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.T1, #sig.pos_T2.recAN, 
                  sig.pos_recAN.HC, sig.pos_T2.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- bardata %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)
   
  sig_T2.T1 <- contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2)
  
  effsize_T2.T1 <- cohensD.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.T1) %>%
    mutate(x.eff=2.15)
 
  #sig_T2.recAN <- contrasts %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(xmin=2) %>%
    #mutate(xmax=4)
   
  #effsize_T2.recAN <- cohensD.lme %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    #unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    #mutate(y.eff=sig.pos_T2.recAN) %>%
    #mutate(x.eff=4.15)
  
  sig_recAN.HC <- contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=4) %>%
    mutate(xmax=6)
   
  effsize_recAN.HC <- cohensD.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_recAN.HC) %>%
    mutate(x.eff=3.85)

  sig_T2.HC <- contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=2) %>%
    mutate(xmax=6)
  
  effsize_T2.HC <- cohensD.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.HC) %>%
    mutate(x.eff=3)
      
  regioncolor <- color %>% 
      filter(region %in% Region)
  
  sizes <- bardata %>% 
    filter(region %in% Region) %>%
    mutate(size=ifelse(str_detect(emmeans, "zero"), 0, 1.25)) %>%
    mutate(size.error=ifelse(str_detect(emmeans, "zero"), 0, 3)) 
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=sizes$size,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill="gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values=c("crosshatch", "stripe", "none", "circle", "none", "none")) +
    scale_pattern_density_manual(values=c(0.07,0.07,0,0.25,0,0)) +
    scale_pattern_size_manual(values=c(1.5,1.5,0,1.6,0,0)) +
    scale_pattern_spacing_manual(values=c(0.08,0.08,0,0.06,0,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=sizes$size.error, color="BLACK", position=position_dodge(1)) +
    
    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=3, 
                 linetype="solid") +
    
    geom_signif(data=sig_T2.T1, aes(annotations=adj.signif, y_position=sig.pos_T2.T1, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.T1, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    #geom_signif(data=sig_T2.recAN, aes(annotations=adj.signif, y_position=sig.pos_T2.recAN, 
                                            #xmin=xmin, xmax=xmax, tip_length=tipl),
                #textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    #geom_text(data=effsize_T2.recAN, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              #size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    geom_signif(data=sig_recAN.HC, aes(annotations=adj.signif, y_position=sig.pos_recAN.HC, 
                                            xmin=xmin, xmax=xmax, tip_length=tipl),
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_recAN.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, color="BLACK", parse=FALSE) +

    geom_signif(data=sig_T2.HC, aes(annotations=adj.signif, y_position=sig.pos_T2.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, vjust=-0.5, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1.5, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole1 <- plotlist$Whole_amygdala
bp.nuclei2 <- plotlist$Basal_nucleus
bp.nuclei3 <- plotlist$Lateral_nucleus
bp.nuclei4 <- plotlist$Accessory_basal_nucleus
bp.nuclei5 <- plotlist$Cortical_nucleus
bp.nuclei6 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei7 <- plotlist$Medial_nucleus
bp.nuclei8 <- plotlist$Central_nucleus
bp.nuclei9 <- plotlist$Anterior_amygdaloid_area
bp.nuclei10 <- plotlist$Paralaminar_nucleus

barplotarrange.whole <- ggarrange(bp.whole1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole, path="figures", filename="mainlme.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1 <- ggarrange(bp.nuclei2,
                                 bp.nuclei3,
                                 bp.nuclei4, ncol=3, nrow=1)
#ggsave(barplotarrange.row1, path="figures", filename="mainlme.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2 <- ggarrange(bp.nuclei5,
                                 bp.nuclei6,
                                 bp.nuclei7, ncol=3, nrow=1)
#ggsave(barplotarrange.row2, path="figures", filename="mainlme.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3 <- ggarrange(bp.nuclei8,
                                 bp.nuclei9,
                                 bp.nuclei10, ncol=3, nrow=1)
#ggsave(barplotarrange.row3, path="figures", filename="mainlme.row3.png", 
       #width=32, height=10, dpi=600)
```

# LME modifications (only for significant acAN-TP2 vs. acAN-TP1 contrasts)

## Delta log10-leptin

Hypothesis-driven testing: only rostral-medial nuclei cluster tested
(significant associations with log10-leptin in cross-sectional paper)!
Only significantly increasing nuclei acAN-TP1 vs. acAN-TP2!\
One-sided significance testing: Just divide all two-sided p-values by 2
and select either them or their complements (subtracting them from 1)
depending on the signs of the coefficient estimates.

!Show another 3D model for significant deltaLog10-Leptin findings (no
scatter plots)! Report beta for deltaLog10-Leptin and its standard
error, t-value, p-value, Cohen's D within the model!

Exploratory correction for batch effects!

```{r lmeleptinmichange, results="asis", message=FALSE, warning=FALSE}
# significant associations with log10-leptin levels in cross-sectional paper
hemi_region_cross <- c(
  "lh_Accessory_basal_nucleus", 
  "rh_Accessory_basal_nucleus", 
  "lh_Cortical_nucleus", 
  "rh_Cortical_nucleus", 
  "lh_Corticoamygdaloid_transitio", 
  "rh_Corticoamygdaloid_transitio", 
  "lh_Medial_nucleus") %>% as.tibble() %>%
  dplyr::rename(hemi_region=value)

hemi_region_add <- c("rh_Medial_nucleus") %>% as.tibble() %>%
  dplyr::rename(hemi_region=value)

# LME with multiply imputed leptin
T2_recAN_HC_join <- lmedata %>%
  filter(point_of_research!="T1") %>%
  dplyr::select(hemi_region, participant_id, por, measure, 
                delta.bmisds, bmisds_at_date_of_research, leptin_result, 
                age_at_date_of_research, e_tiv) %>%
  mutate(leptin_transform_imputed=log10(leptin_result)) %>%
  mutate(leptin_batch_recoded_batch1=0, leptin_batch_recoded_batch2=0,
         leptin_batch_recoded_batch3=0, leptin_batch_recoded_batch4=0) %>%
  dplyr::select(-leptin_result)

participant_id_join_T1 <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(delta.log_leptin.svi)) %>%
  arrange(participant_id) %>%
  dplyr::select(participant_id)

participant_id_join <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research!="T1") %>%
  mutate(delta.log_leptin.clmi.ortho=0) %>%
  dplyr::select(participant_id, delta.log_leptin.clmi.ortho)

participant_id_join_alt <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research!="T1") %>%
  mutate(log_leptin.clmi.ortho=log_leptin.ortho) %>%
  dplyr::select(participant_id, log_leptin.clmi.ortho)

participant_id_join.sq <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research!="T1") %>%
  mutate(delta.log_leptin.clmi.ortho.sq=0) %>%
  dplyr::select(participant_id, delta.log_leptin.clmi.ortho.sq)

lme.leptin_pre <- leptin_impute %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi) %>%
  group_by(labeller.amy) %>%
  mutate(rn.hemi_region=row_number()) %>%
  ungroup() %>%
  mutate(rn.total=row_number()) %>%
  mutate(
    extract.clmi.filter=map(extract.clmi, ~dplyr::select(.x, hemi_region, participant_id,
                                                         por, measure, delta.bmisds,
                                                         leptin_transform_imputed, 
                                                         age_at_date_of_research,
                                                         bmisds_at_date_of_research,
                                                         e_tiv,
                                                         leptin_batch_recoded_batch1,
                                                         leptin_batch_recoded_batch2,
                                                         leptin_batch_recoded_batch3,
                                                         leptin_batch_recoded_batch4)),
    data.bind=map(extract.clmi.filter, ~rbind(.x, subset(T2_recAN_HC_join,
                                                       hemi_region==.x$hemi_region))),
    data=map(data.bind, ~group_by(.x, participant_id)),
    data=map(data, ~arrange(.x, delta.bmisds, .by_group=TRUE)),
    data=map(data, ~mutate(.x, 
                           delta.log_leptin.clmi=ifelse(delta.bmisds<0, 
                                                           leptin_transform_imputed - 
                                                             lead(leptin_transform_imputed),
                                                           0))),
    data=map(data, ~ungroup(.x)),
    data=map(data, ~filter(.x, !is.na(delta.log_leptin.clmi))),
    data=map(data, ~arrange(.x, participant_id)),
    gsdata=map(data, ~filter(.x, delta.bmisds<0)),
    gsdata=map(gsdata, ~dplyr::select(.x, participant_id, delta.bmisds,
                                      delta.log_leptin.clmi, 
                                      bmisds_at_date_of_research, 
                                      leptin_transform_imputed)),
    gsdata=map(gsdata, ~mutate(.x, delta.bmisds.sq=delta.bmisds^2)),
    gsdata=map(gsdata, ~arrange(.x, participant_id)),
    ortho=map(gsdata, ~matlib::GramSchmidt(matrix(c(.x$delta.bmisds,
                                                    .x$delta.log_leptin.clmi),
                                                  ncol=2, byrow=FALSE), normalize=FALSE,
                                           verbose=FALSE)),
    ortho=map(ortho, ~as.tibble(.x)),
    ortho=map(ortho, ~dplyr::rename(.x, delta.log_leptin.clmi.ortho=V2)),
    ortho=map(ortho, ~dplyr::select(.x, delta.log_leptin.clmi.ortho)),
    ortho=map(ortho, ~cbind(.x, participant_id_join_T1)),
    ortho=map(ortho, ~full_join(.x, participant_id_join, 
                                by=c("participant_id", "delta.log_leptin.clmi.ortho"))),
    ortho=map(ortho, ~arrange(.x, participant_id)),
    
    ortho_ti=map(gsdata, ~matlib::GramSchmidt(matrix(c(.x$bmisds_at_date_of_research,
                                                    .x$leptin_transform_imputed),
                                                  ncol=2, byrow=FALSE), normalize=FALSE,
                                           verbose=FALSE)),
    ortho_ti=map(ortho_ti, ~as.tibble(.x)),
    ortho_ti=map(ortho_ti, ~dplyr::rename(.x, log_leptin.clmi.ortho=V2)),
    ortho_ti=map(ortho_ti, ~dplyr::select(.x, log_leptin.clmi.ortho)),
    ortho_ti=map(ortho_ti, ~cbind(.x, participant_id_join_T1)),
    ortho_ti=map(ortho_ti, ~full_join(.x, participant_id_join_alt, 
                                by=c("participant_id", "log_leptin.clmi.ortho"))),
    ortho_ti=map(ortho_ti, ~arrange(.x, participant_id)),
    
    ortho.sq=map(gsdata, ~matlib::GramSchmidt(matrix(c(.x$delta.bmisds,
                                                       .x$delta.bmisds.sq,
                                                       .x$delta.log_leptin.clmi),
                                                     ncol=3, byrow=FALSE), normalize=FALSE,
                                              verbose=FALSE)),
    ortho.sq=map(ortho.sq, ~as.tibble(.x)),
    ortho.sq=map(ortho.sq, ~dplyr::rename(.x, delta.log_leptin.clmi.ortho.sq=V3)),
    ortho.sq=map(ortho.sq, ~dplyr::select(.x, delta.log_leptin.clmi.ortho.sq)),
    ortho.sq=map(ortho.sq, ~cbind(.x, participant_id_join_T1)),
    ortho.sq=map(ortho.sq, ~full_join(.x, participant_id_join.sq, 
                                      by=c("participant_id",
                                           "delta.log_leptin.clmi.ortho.sq"))),
    ortho.sq=map(ortho.sq, ~arrange(.x, participant_id))) %>%
  dplyr::select(region, labeller.amy, whole.sub, rn.hemi_region, rn.total, data,
                ortho, ortho.sq, ortho_ti)

lme.leptin <- lme.leptin_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  dplyr::select(participant_id, participant_id1, participant_id2, everything()) %>%
  nest(lmedata=-c(region, hemi_region, labeller.amy, whole.sub, rn.hemi_region, rn.total)) %>%
  mutate(
    lmedata=map(lmedata, ~mutate(.x,
                                 age.c=age_at_date_of_research - mean(age_at_date_of_research,
                                                                      na.rm=TRUE),
                                 etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.expl=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.clmi +
                                        #leptin_transform_imputed +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.batch=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        leptin_batch_recoded_batch2 +
                                        leptin_batch_recoded_batch3 +
                                        leptin_batch_recoded_batch4 +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.sq=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.log_leptin.clmi.ortho.sq +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit))) %>%
  nest(pooldata=-c(region, hemi_region, labeller.amy, whole.sub)) %>% # If you are using a mixed model, first run library(broom.mixed) before calling pool(). Pooling output: Residual degrees of freedom for hypothesis testing (=df).
  mutate(
    pool.lme.expl=map(pooldata, ~mice::pool(.x$lme.expl, 
                                                dfcom=NULL, rule="rubin1987")),
    pool.lme.expl.tidy=map(pool.lme.expl, tidy),
    pool.lme.expl.summary=map(pool.lme.expl, ~summary(.x, conf.int=TRUE, 
                                                              conf.level=0.95)),
    pool.lme=map(pooldata, ~mice::pool(.x$lme, 
                                           dfcom=NULL, rule="rubin1987")),
    pool.lme.tidy=map(pool.lme, tidy),
    pool.lme.summary=map(pool.lme, ~summary(.x, conf.int=TRUE,
                                                    conf.level=0.95)),
    pool.lme.batch=map(pooldata, ~mice::pool(.x$lme.batch, 
                                           dfcom=NULL, rule="rubin1987")),
    pool.lme.batch.tidy=map(pool.lme.batch, tidy),
    pool.lme.batch.summary=map(pool.lme.batch, ~summary(.x, conf.int=TRUE,
                                                    conf.level=0.95)),
    pool.lme.sq=map(pooldata, ~mice::pool(.x$lme.sq, 
                                           dfcom=NULL, rule="rubin1987")),
    pool.lme.sq.tidy=map(pool.lme.sq, tidy),
    pool.lme.sq.summary=map(pool.lme.sq, ~summary(.x, conf.int=TRUE,
                                                    conf.level=0.95)))


# Linear deltaBMI-SDS effects
lme.leptin.lin <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lme.leptin, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, pool.lme.summary) %>%
  unnest(pool.lme.summary) %>%
  filter(str_detect(term, "leptin")) %>%
  #filter((str_detect(term, "delta.bmisds")) | (str_detect(term, "leptin"))) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region)

lme.leptin.lin %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in Log10-Leptin levels (CLMI-imputed, orthogonalized), trend-level (p<0.10) for 4 nuclei, significant (p<0.05) for 2 nuclei.") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


# Linear and quadratic deltaBMI-SDS effects
lme.leptin.lin %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region) %>%
  semi_join(sig.bmisds.sq, by="hemi_region") %>%
  left_join(lme.leptin, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, pool.lme.sq.summary) %>%
  unnest(pool.lme.sq.summary) %>%
  #filter(str_detect(term, "leptin")) %>%
  filter((str_detect(term, "delta.bmisds")) | (str_detect(term, "leptin"))) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "Cohen's d"), 
               caption="Follow-up/selective LME model including change in Log10-Leptin levels (CLMI-imputed, orthogonalized), linear and quadratic deltaBMI-SDS effects") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 


# Leptin batch effects?
lme.leptin.lin %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region) %>%
  left_join(lme.leptin, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, pool.lme.batch.summary) %>%
  unnest(pool.lme.batch.summary) %>%
  filter(str_detect(term, "delta.log_leptin.clmi.ortho")) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "Cohen's d"), 
               caption="Follow-up LME model including change in Log10-Leptin levels (CLMI-imputed, orthogonalized), controlled for leptin batch effects. Only for significant nuclei in basic deltaLog10-Leptin LME model.") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


# Exploratory without orthogonalization of Log10Leptin levels
contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lme.leptin, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, pool.lme.expl.summary) %>%
  unnest(pool.lme.expl.summary) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="Exploratory LME model including change in Log10-Leptin levels (CLMI-imputed, NOT orthogonalized)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

# Data set export for Maria including leptin
lme.leptin_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  dplyr::select(participant_id, participant_id1, participant_id2, everything()) %>%
  filter(rn.hemi_region==1) %>%
  mutate(point_of_research=ifelse(delta.bmisds<0, "T1", ifelse(por=="acAN", "T2",
                                                               as.character(por)))) %>%
  dplyr::select(hemi_region, participant_id, por,
                point_of_research, measure, age_at_date_of_research, bmisds_at_date_of_research, 
                e_tiv, leptin_transform_imputed, delta.log_leptin.clmi,
                delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq,
                delta.bmisds) #%>%
  #write_csv("dataset_ema_incl_leptin.csv")
```

Log10-leptin at acAN-TP1 (predictor of outcome)

```{r lmeleptinmiT1pred, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.leptin.T1pred <- leptin_impute %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi) %>%
  mutate(
    extract.clmi.filter=map(extract.clmi, ~dplyr::select(.x, hemi_region, participant_id,
                                                         por, measure, delta.bmisds,
                                                         bmisds_at_date_of_research,
                                                         leptin_transform_imputed, 
                                                         age_at_date_of_research,
                                                         e_tiv,
                                                         leptin_batch_recoded_batch1,
                                                         leptin_batch_recoded_batch2,
                                                         leptin_batch_recoded_batch3,
                                                         leptin_batch_recoded_batch4)),
    data=map(extract.clmi.filter, ~rbind(.x, subset(T2_recAN_HC_join,
                                                       hemi_region==.x$hemi_region))),
    data=map(data, ~mutate(.x,
                           T1pred.log_leptin.clmi=ifelse(delta.bmisds<0, 
                                                            leptin_transform_imputed, 0),
                           T1pred.bmisds=ifelse(delta.bmisds<0, 
                                                            bmisds_at_date_of_research, 0))),
    data=map(data, ~filter(.x, !is.na(T1pred.log_leptin.clmi))),
    lmedata=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE)))) %>%
  mutate(
    lme.expl=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        T1pred.log_leptin.clmi +
                                        T1pred.bmisds + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit))) %>%
  nest(pooldata=-c(region, labeller.amy, whole.sub)) %>%
  mutate(
    pool.lme.expl=map(pooldata, ~mice::pool(.x$lme.expl, 
                                                dfcom=NULL, rule="rubin1987")),
    pool.lme.expl.tidy=map(pool.lme.expl, tidy),
    pool.lme.expl.summary=map(pool.lme.expl, ~summary(.x, conf.int=TRUE, 
                                                              conf.level=0.95)))

lme.leptin.T1pred %>%
  dplyr::select(labeller.amy, whole.sub, pool.lme.expl.summary) %>%
  unnest(pool.lme.expl.summary) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="Exploratory LME model including Log10-Leptin levels at acAN-TP1 as predictor of change, adjusted for BMI-SDS at acAN-TP1 (CLMI-imputed, NOT orthogonalized)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### Exploratory: single-value imputation

```{r lmeleptinsvichange, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Single value imputation alternative
lme.leptin.svi <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.log_leptin.svi.ortho), ~!is.na(.x)) %>%
  #group_by(hemi_region, participant_id) %>% 
  #mutate(nomatch=ifelse((por=="acAN") & (n()<2), TRUE, FALSE)) %>%
  #ungroup() %>%
  #filter(nomatch==FALSE) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.svi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                    delta.bmisds +
    #                                    delta.log_leptin.svi.ortho +
    #                                    poly(age.c, degree=2, raw=FALSE) +
    #                                    etiv.c + 
    #                                    (1|participant_id),
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, term=="delta.log_leptin.svi.ortho")),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.leptin.svi %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in log10-leptin levels") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 
```

```{r lmeleptinsvichangesquared, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Reproduce with quadratic deltaBMI-SDS effects where significant
lme.leptin.svi.sq <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(sig.bmisds.sq, by="hemi_region") %>%
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.log_leptin.svi.ortho.sq), ~!is.na(.x)) %>%
  group_by(hemi_region, participant_id) %>% 
  mutate(nomatch=ifelse((por=="acAN") & (n()<2), TRUE, FALSE)) %>%
  ungroup() %>%
  #filter(nomatch==FALSE) %>%
  dplyr::select(-c(storage_name, point_of_research, nomatch)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.log_leptin.svi.ortho.sq +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.log_leptin.svi.ortho.sq +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id),
                                        data=.x, REML=TRUE, na.action=na.omit), 
                                  data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="delta.log_leptin.svi.ortho.sq")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.leptin.svi.sq %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in log10-leptin levels, linear + quadratic deltaBMI-SDS effects!") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 
```

```{r lmeleptinsviTP1, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Log10-leptin at acAN-TP1
lme.leptin.svi.T1 <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, T1pred.log_leptin.svi), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        T1pred.log_leptin.svi +
                                        T1pred.bmisds +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))


lme.leptin.svi.T1 %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif, p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif."), 
               caption="LME model including log10-leptin levels at acAN-TP1 (adjusted for BMI-SDS at acAN-TP1) as a potential predictor of outcome") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 
```

### DeltaLeptin - deltaPsychopathology relationships

```{r leptinpsychocor, results="asis", message=FALSE, warning=FALSE}
psycho <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(participant_id, por, delta.bmisds, edi_core, 
                resultquest_bdi2_total, stai_t,
                resultquest_scl90r_skagloba,
                delta.edicore, delta.edidt, delta.bdi, delta.stais, delta.sclgsi)

psycho_T1 <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(participant_id, edi_core, resultquest_bdi2_total, stai_t,
                resultquest_scl90r_skagloba,
                delta.edicore, delta.edidt, delta.bdi, delta.stais, delta.sclgsi)

T2_recAN_HC_join_sm <- lmedata %>%
  filter(point_of_research!="T1") %>%
  dplyr::select(hemi_region, participant_id, por, measure, delta.bmisds, leptin_result, 
                age_at_date_of_research, bmisds_at_date_of_research, e_tiv,
                edi_core, resultquest_bdi2_total, stai_t,
                resultquest_scl90r_skagloba,
                delta.edicore, delta.edidt, delta.bdi, delta.stais, delta.sclgsi) %>%
  mutate(leptin_nt_imputed=leptin_result) %>%
  dplyr::select(-leptin_result)

participant_id_join_T1_sm <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research=="T1") %>%
  filter(!is.na(delta.log_leptin.svi)) %>%
  arrange(participant_id) %>%
  dplyr::select(participant_id)

participant_id_join_sm <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(point_of_research!="T1") %>%
  mutate(delta.leptin.clmi.ortho=0) %>%
  dplyr::select(participant_id, delta.leptin.clmi.ortho)


lme.leptin_nt_pre <- leptin_impute %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi_nt) %>%
  group_by(labeller.amy) %>%
  mutate(rn.hemi_region=row_number()) %>%
  ungroup() %>%
  mutate(rn.total=row_number()) %>%
  mutate(
    extract.clmi_nt_filter=map(extract.clmi_nt, ~dplyr::select(.x, hemi_region, participant_id,
                                                         por, measure, delta.bmisds,
                                                         leptin_transform_imputed, 
                                                         age_at_date_of_research,
                                                         bmisds_at_date_of_research,
                                                         e_tiv)),
    extract.clmi_nt_filter=map(extract.clmi_nt_filter, 
                               ~dplyr::rename(.x, leptin_nt_imputed=leptin_transform_imputed)),
    extract.clmi_nt_join=map(extract.clmi_nt_filter, ~left_join(.x, psycho_T1, by="participant_id")),
    data.bind=map(extract.clmi_nt_join, ~rbind(.x, subset(T2_recAN_HC_join_sm,
                                                       hemi_region==.x$hemi_region))),
    data=map(data.bind, ~group_by(.x, participant_id)),
    data=map(data, ~arrange(.x, delta.bmisds, .by_group=TRUE)),
    data=map(data, ~mutate(.x, 
                           delta.leptin.clmi=ifelse(delta.bmisds<0,
                                                    leptin_nt_imputed - 
                                                      lead(leptin_nt_imputed), 0))),
    data=map(data, ~ungroup(.x)),
    data=map(data, ~filter(.x, !is.na(delta.leptin.clmi))),
    data=map(data, ~arrange(.x, participant_id)),
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    gsdata=map(data, ~filter(.x, delta.bmisds<0)),
    gsdata=map(gsdata, ~dplyr::select(.x, participant_id, delta.bmisds, delta.leptin.clmi)),
    gsdata=map(gsdata, ~mutate(.x, delta.bmisds.sq=delta.bmisds^2)),
    gsdata=map(gsdata, ~arrange(.x, participant_id)),
    ortho=map(gsdata, ~matlib::GramSchmidt(matrix(c(.x$delta.bmisds,
                                                    .x$delta.leptin.clmi),
                                                  ncol=2, byrow=FALSE), normalize=FALSE, verbose=FALSE)),
    ortho=map(ortho, ~as.tibble(.x)),
    ortho=map(ortho, ~dplyr::rename(.x, delta.leptin.clmi.ortho=V2)),
    ortho=map(ortho, ~dplyr::select(.x, delta.leptin.clmi.ortho)),
    ortho=map(ortho, ~cbind(.x, participant_id_join_T1_sm)),
    ortho=map(ortho, ~full_join(.x, participant_id_join_sm, 
                                by=c("participant_id", "delta.leptin.clmi.ortho"))),
    ortho=map(ortho, ~arrange(.x, participant_id))) %>%
  dplyr::select(region, labeller.amy, whole.sub, rn.hemi_region, rn.total, data, ortho)

lme.leptin_nt_psycho <- lme.leptin_nt_pre %>%
  unnest(data, ortho) %>%
  dplyr::rename(bdi2=resultquest_bdi2_total, sclgsi=resultquest_scl90r_skagloba) %>%
  dplyr::select(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                measure, e_tiv,
                age_at_date_of_research, delta.bmisds, delta.leptin.clmi, delta.leptin.clmi.ortho,
                edi_core, bdi2, sclgsi,
                delta.edicore, delta.edidt, delta.bdi, delta.stais, delta.sclgsi) %>%
  pivot_longer(-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                  measure, e_tiv, age_at_date_of_research, delta.bmisds, delta.leptin.clmi,
                  delta.leptin.clmi.ortho), 
               names_to="demo_variable", values_to="psych") %>%
  filter(!str_detect(demo_variable, "delta")) %>%
  nest(data_pre=-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, demo_variable)) %>%
  mutate(
    lmedata=map(data_pre, ~drop_na(.x)),
    lmedata=map(lmedata, ~group_by(.x, participant_id)),
    lmedata=map(lmedata, ~mutate(.x, nomatch=ifelse((por=="acAN") & (n()<2) & (delta.bmisds<0), TRUE, FALSE))),
    lmedata=map(lmedata, ~ungroup(.x)),
    lmedata=map(lmedata, ~filter(.x, nomatch==FALSE)),
    lmedata=map(lmedata, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    n_lme=map_dbl(lmedata, ~nrow(.x)),
    n_lme_T1=map_dbl(lmedata, ~sum(.x$delta.bmisds<0)))

lme.leptin_nt_psycho %>%
  mutate(
    lme.leptin.psycho=map(lmedata, ~lme4::lmer(psych ~1 + por +
                                        delta.bmisds +
                                        delta.leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit))) %>%
  dplyr::select(demo_variable, n_lme, n_lme_T1, lme.leptin.psycho) %>%
  nest(-c(demo_variable, n_lme, n_lme_T1)) %>%
  mutate(
    pool.lme.leptin.psycho=map(data, ~mice::pool(.x$lme.leptin.psycho, 
                                                 dfcom=NULL, rule="rubin1987")),
    pool.lme.leptin.psycho.tidy=map(pool.lme.leptin.psycho, tidy),
    pool.lme.leptin.psycho.summary=map(pool.lme.leptin.psycho, ~summary(.x, conf.int=TRUE, 
                                                                         conf.level=0.95))) %>%
  dplyr::select(demo_variable, n_lme, n_lme_T1, pool.lme.leptin.psycho.summary) %>%
  unnest(pool.lme.leptin.psycho.summary) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  dplyr::select(demo_variable, term, n_lme, n_lme_T1, estimate, std.error, statistic, 
                p_formatted, signif, 
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptom levels", "Term", "N", "N(acAN)", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's D"), 
               caption="LME model including all groups: Psychiatric symptom level, predicted by group, age, age^2, and change in BMI-SDS and leptin levels (original scale)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## DeltaBMI-SDS:DOI interaction

Does longer duration of illness (DOI) in acAN impede speed of
deltaBMI-SDS-related change in amygdala nuclei volumes? Does DOI affect
slope of relationship between deltaBMI-SDS and amygdala nuclei volumes?
DOI itself does not change between acAN-TP1 and acAN-TP2 (is not
assessed at acAN-TP2).

```{r lmedoi, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.doi <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, doi), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                               delta.bmisds +
                                               delta.bmisds:doi +
                                               poly(age.c, degree=2, raw=FALSE) +
                                               etiv.c + 
                                               (1|participant_id), 
                                             data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                          delta.bmisds +
    #                                          delta.bmisds:doi +
    #                                         poly(age.c, degree=2, raw=FALSE) +
    #                                        etiv.c + 
    #                                       (1|participant_id), 
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x,
    #                        type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, term=="delta.bmisds:doi")),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))


lme.doi %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "doi")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, 
                signif, p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including deltaBMI-SDS*DOI interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 
```

## DeltaBMI-SDS:age interaction while accounting for DOI

Is age related to the speed of deltaBMI-SDS related amygdala nuclei
changes (moderating effect)?

Illness duration increases in older patients.

```{r lmeagedoi, results="asis", message=FALSE, warning=FALSE}
lme.agedoi <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, doi), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                               delta.bmisds +
                                               delta.bmisds:T1.age +
                                               delta.bmisds:doi +
                                               delta.bmisds:T1.age:doi + 
                                               poly(age.c, degree=2, raw=FALSE) +
                                               etiv.c + 
                                               (1|participant_id), 
                                             data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                           delta.bmisds +
    #                                           delta.bmisds:T1.age +
    #                                           delta.bmisds:doi +
    #                                           delta.bmisds:T1.age:doi + 
    #                                           poly(age.c, degree=2, raw=FALSE) +
    #                                           etiv.c + 
    #                                           (1|participant_id), 
    #                                         data=.x, REML=TRUE, na.action=na.omit), 
    #                              data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD_age=map(cohensD, ~filter(.x, term=="delta.bmisds:T1.age")),
    #cohensD_age=map(cohensD_age, ~dplyr::select(.x, d)),
    #cohensD_doi=map(cohensD, ~filter(.x, term=="delta.bmisds:doi")),
    #cohensD_doi=map(cohensD_doi, ~dplyr::select(.x, d)),
    #cohensD_age.doi=map(cohensD, ~filter(.x, term=="delta.bmisds:T1.age:doi")),
    #cohensD_age.doi=map(cohensD_age.doi, ~dplyr::select(.x, d)))


lme.agedoi.out <- lme.agedoi %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "delta.bmisds:")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, 
                signif, p.fdr_formatted, adj.signif, d_formatted)

lme.agedoi.out %>%
   filter(term=="delta.bmisds:T1.age")

lme.agedoi.out %>%
   filter(term=="delta.bmisds:doi")

lme.agedoi.out %>%
   filter(term=="delta.bmisds:T1.age:doi")
```

## DeltaBMI-SDS:AN subtype interaction

Does AN subtype in acAN (restrictive vs. binge/purge) affect speed of
deltaBMI-SDS-related change in amygdala nuclei volumes (i.e., slope of
relationship between deltaBMI-SDS and amygdala nuclei volume change)?

```{r lmesubtype, results="asis", message=FALSE, warning=FALSE}
lme.subtype <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  left_join(redcap_clinical, by="storage_name") %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, siabex_result_an_type,
                storage_name, point_of_research, por, participant_id, measure, delta.bmisds, 
                age_at_date_of_research, e_tiv) %>%
  mutate(subtype=factor(ifelse(point_of_research=="T1", siabex_result_an_type, 0),
         levels=c(0,1,2), labels=c("no", "R", "BP"))) %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, subtype), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                               delta.bmisds +
                                               delta.bmisds:subtype +
                                               poly(age.c, degree=2, raw=FALSE) +
                                               etiv.c + 
                                               (1|participant_id), 
                                             data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                           delta.bmisds +
    #                                           delta.bmisds:subtype +
    #                                           poly(age.c, degree=2, raw=FALSE) +
    #                                           etiv.c + 
    #                                           (1|participant_id), 
    #                                         data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, str_detect(term, "delta.bmisds:subtype"))),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))
    

lme.subtype %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "subtype")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, 
                signif, p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including deltaBMI-SDS*acAN subtype interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") 
```

## Delta core eating disorder symptoms

```{r lmeedicore, results="asis", message=FALSE, warning=FALSE}
lme.edicore <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.edicore), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.edicore +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                    delta.bmisds +
    #                                    delta.edicore +
    #                                    poly(age.c, degree=2, raw=FALSE) +
    #                                    etiv.c + 
    #                                    (1|participant_id),
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, str_detect(term, "delta.edicore"))),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.edicore %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "edicore")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in core eating disorder symptoms (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

# Reproduce with quadratic deltaBMI-SDS effects where significant
lme.edicore.sq <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  semi_join(sig.bmisds.sq, by="hemi_region") %>%
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.edicore), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.edicore +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                         (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.edicore +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id),
                                        data=.x, REML=TRUE, na.action=na.omit), 
                                  data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="delta.edicore")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.edicore.sq %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "edicore")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "Cohen's d"), 
               caption="LME model including change in core eating disorder symptoms (acAN-TP2 vs. acAN-TP1), linear + quadratic deltaBMI-SDS effects!") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r lmeedicoreleptin, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.edicore.bmisds <- lme.leptin.lin %>%
  filter(p.value>=0.05) %>% # only deltaBMI-SDS adjustment (only the regions where deltaLogLeptin was non-significant)
  dplyr::select(hemi_region) %>%
  left_join(lme.edicore, by="hemi_region") %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "edicore")) %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, term, estimate, std.error, statistic, p.value, d)


# Adjust for deltaLogLeptin where significant (does change in psychiatric symptoms (intervention + accompanying renutrition) predict change in amygdala nuclei volumes (independent of weight and neuroendocrine - where significant - changes)?

lme.edicore.leptin <- lme.leptin.lin %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy) %>%
  left_join(lme.leptin_pre, by="labeller.amy") %>%
  unnest(data, ortho) %>%
  left_join(psycho, by=c("participant_id", "por", "delta.bmisds")) %>%
  dplyr::select(rn.hemi_region, rn.total, region, hemi_region, labeller.amy, whole.sub, participant_id, por, 
                measure, e_tiv, age_at_date_of_research, delta.bmisds, delta.log_leptin.clmi.ortho, delta.edicore) %>%
  nest(lmedata_pre=-c(region, hemi_region, labeller.amy, whole.sub, rn.hemi_region, rn.total)) %>%
  mutate(
    lmedata=map(lmedata_pre, ~drop_na(.x)),
    lmedata=map(lmedata, ~mutate(.x,
                                 age.c=age_at_date_of_research - mean(age_at_date_of_research,
                                                                      na.rm=TRUE),
                                 etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    n_lme=map_dbl(lmedata, ~nrow(.x)),
    n_lme_T1=map_dbl(lmedata, ~sum(.x$delta.bmisds<0)),
    lme=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        delta.edicore +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit))) %>%
  nest(pooldata=-c(region, hemi_region, labeller.amy, whole.sub, n_lme, n_lme_T1)) %>%
  mutate(
    pool.lme=map(pooldata, ~mice::pool(.x$lme, 
                                           dfcom=NULL, rule="rubin1987")),
    pool.lme.summary=map(pool.lme, ~summary(.x, conf.int=TRUE,
                                                    conf.level=0.95))) %>%
  dplyr::select(-c(pooldata, pool.lme)) %>%
  unnest(pool.lme.summary) %>%
  filter(str_detect(term, "edicore")) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, term, estimate, std.error, statistic, p.value, d)

bind_rows(lme.edicore.bmisds, lme.edicore.leptin) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in core eating disorder symptoms (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r lmeedicoreT1pred, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# EDI-2 core symptoms at acAN-TP1 as predictor of outcome
lme.edicore.T1 <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, T1pred.edicore), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        T1pred.edicore +
                                        T1pred.bmisds +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                               delta.bmisds + 
                                               T1pred.edicore +
                                               T1pred.bmisds +
                                               poly(age.c, degree=2, raw=FALSE) +
                                               etiv.c + 
                                               (1|participant_id),
                                             data=.x, REML=TRUE, na.action=na.omit), 
                                  data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="T1pred.edicore")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.edicore.T1 %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "T1pred.edicore")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including EDI-2 core symptom levels at acAN-TP1, adjusted for BMI-SDS at acAN-TP1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r lmeedidt, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# EDI-2 drive for thinness
lme.edidt <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.edidt), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.edidt +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.edidt +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id),
                                        data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="delta.edidt")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.edidt %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "edidt")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in EDI-2 core subscale drive for thinness (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Delta depressive symptoms

```{r lmebdi, results="asis", message=FALSE, warning=FALSE}
lme.bdi <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.bdi), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.bdi +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                    delta.bmisds +
    #                                    delta.bdi +
    #                                    poly(age.c, degree=2, raw=FALSE) +
    #                                    etiv.c + 
    #                                    (1|participant_id),
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, term=="delta.bdi")),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.bdi %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "bdi")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in depressive symptoms (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Trait anxiety symptoms (as a global covariate, cf. age and eTIV)

```{r lmestait, results="asis", message=FALSE, warning=FALSE}
# Trait anxiety levels at acAN-TP1
lme.stait <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, stait), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE),
                           stait.c=stait - mean(stait, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        stait.c +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                    delta.bmisds +
    #                                    stait.c +
    #                                    poly(age.c, degree=2, raw=FALSE) +
    #                                    etiv.c + 
    #                                    (1|participant_id),
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, term=="stait.c")),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.stait %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "stait")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including trait anxiety levels in all study groups as a global/general covariate") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r lmestais, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Delta state anxiety symptoms
lme.stais <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.stais), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.stais +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.stais +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id),
                                        data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="delta.stais")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.stais %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "stais")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in state anxiety symptoms (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Delta SCL-90-R GSI

```{r lmescl, results="asis", message=FALSE, warning=FALSE}
lme.sclgsi <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, 
                 e_tiv, delta.sclgsi), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.sclgsi +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy))
    #cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
    #                                    delta.bmisds +
    #                                    delta.sclgsi +
    #                                    poly(age.c, degree=2, raw=FALSE) +
    #                                    etiv.c + 
    #                                    (1|participant_id),
    #                                    data=.x, REML=TRUE, na.action=na.omit), data=.x, type="lme4")),
    #cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    #cohensD=map(cohensD, ~filter(.x, term=="delta.sclgsi")),
    #cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme.sclgsi %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, lmetest.tidy) %>%
  unnest(lmetest.tidy) %>%
  filter(str_detect(term, "sclgsi")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in general psychiatric symptoms (acAN-TP2 vs. acAN-TP1)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

# SM LMEs

## Reproduce acAN-TP1 vs. HC comparison
### SM LME

```{r smlme, results="asis", message=FALSE, warning=FALSE}
sm.lme <- sm.lmedata %>%
  filter_at(vars(por, measure, delta.bmisds.sm, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme=map(data, ~lme4::lmer(measure ~1 + por +
                                delta.bmisds.sm +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.tidy=map(lme, tidy),
    emmeans=map(lme, ~emmeans::emmeans(.x,
                                       c("por", "delta.bmisds.sm"),
                                       at=list(delta.bmisds.sm=
                                                 c(0, delta.bmisds.sm.mean)), 
                                       lmer.df="satterthwaite", type="response")),
    emmeans.tidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP1vsHC"=acAN_TP1.smlme - HC.smlme),
      #"AcAN-TP2vsAcAN-TP1"=acAN_TP2.smlme - acAN_TP1.smlme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.smlme - recAN.smlme,
      #"AcAN-TP2vsHC"=acAN_TP2.smlme - HC.smlme, # AcAN-TP2vsHC contrast as AcAN-TP1vsHC contrast + BMI-SDS increase
      #"RecANvsHC"=recAN.smlme - HC.smlme), 
      lmer.df="satterthwaite", adjust="none")), 
    contrasts.tidy=map(contrasts, tidy), 
    SDtable.sm=map(lme, ~as.tibble(lme4::VarCorr(.x))),
    SDtotal.sm=map_dbl(SDtable.sm, ~sqrt(.x$vcov[.x$grp=="participant_id"] + .x$vcov[.x$grp=="Residual"])))


sm.contrasts <- sm.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, contrasts.tidy) %>%
  unnest(contrasts.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                                formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # FDR adjustment across all computed contrasts per (sub-)region and across all (sub-)regions, whole amygdala and amygdala nuclei separately 
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

sm.contrasts %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
                                                      caption="SM LME model: Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial",
              font_size="10")
```

### Effect size statistics for SM LME

```{r smeffectsize, results="asis", message=FALSE, warning=FALSE}
cohenlist.sm=list()

for (Hemi_Region in unique(sm.lme$hemi_region)) {
  
  SDtotal.sm <- sm.lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal.sm)
  
  cohensD.sm <- sm.lme %>%
    dplyr::select(hemi_region, region, labeller.amy, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohensD.sm=map(emmeans, ~as.tibble(emmeans::eff_size(.x, sigma=SDtotal.sm, edf=Inf, method=list( 
      "AcAN-TP1vsHC"=acAN_TP1.smlme - HC.smlme))))) %>%
    unnest(cohensD.sm) %>%
    mutate(cohensD.sm_pre=formatC(effect.size, format="f", digits=2)) %>%
    mutate(cohensD.sm=abs(effect.size)) %>%
    mutate(d_formatted=ifelse(cohensD.sm<0.01, "<0.01", formatC(cohensD.sm, format="f", digits=2))) %>%
    mutate(se=formatC(SE, format="f", digits=2)) %>%
    mutate(CI_95_lower=formatC(lower.CL, format="f", digits=2)) %>%
    mutate(CI_95_upper=formatC(upper.CL, format="f", digits=2)) %>%
    mutate(bracket01="[", bracket02="]") %>%
    unite("confint_95", c(CI_95_lower, CI_95_upper), sep=",", remove=FALSE, na.rm=FALSE) %>%
    unite("confint_95", c(bracket01, confint_95, bracket02), sep="", remove=FALSE, na.rm=FALSE) %>%
    dplyr::select(hemi_region, region, labeller.amy, contrast, cohensD.sm_pre,
                  cohensD.sm, d_formatted, se, confint_95)

  cohenlist.sm[[Hemi_Region]]=cohensD.sm
  }

cohensD.sm.lme <- as.tibble(bind_rows(cohenlist.sm[1:20]))
                         
cohensD.sm.lme %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, contrast, cohensD.sm_pre, se, confint_95) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Cohen's d", "se", "95% CI"), 
               caption="SM LME model: Effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

### Bar plot visualization of LME findings: SM LME

```{r barplotssmlme, fig.cap="SM LME model barplot visualization", message=FALSE, warning=FALSE}
sm.bardata <- sm.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds.sm==0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds.sm!=0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds.sm==0 ~ "RecAN",
    por=="HCW" & delta.bmisds.sm==0 ~ "HC",
    por=="recAN" & delta.bmisds.sm!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds.sm!=0 ~ "zerobar2")) %>%
  mutate(estimate=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, estimate), 
         std.error=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, std.error)) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "zerobar1", 
                                          "RecAN", "zerobar2", 
                                          "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 20, 18)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 16, 14)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 40)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(sm.bardata$region)) {
  
  plotdata <- sm.bardata %>% filter(region %in% Region)
  
  y.position <- sm.bardata %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.85*estimate) %>%
    mutate(ymax=1.1*estimate) %>%
    mutate(sig.pos_T1.HC=(0.17*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.015) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T1.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- sm.bardata %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)

  sig_T1.HC <- sm.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP1vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=6)
  
  effsize_T1.HC <- cohensD.sm.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP1vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.sm<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=(0.96*(ymax-ymin)) + ymin) %>%
    mutate(x.eff=1)
      
  regioncolor <- color %>% 
      filter(region %in% Region)
  
  sizes <- sm.bardata %>% 
    filter(region %in% Region) %>%
    mutate(size=ifelse(str_detect(emmeans, "zero"), 0, 1.25)) %>%
    mutate(size.error=ifelse(str_detect(emmeans, "zero"), 0, 3)) 
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=sizes$size,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("crosshatch", "stripe", "none", "circle", "none", "none")) +
    scale_pattern_density_manual(values=c(0.07,0.07,0,0.25,0,0)) +
    scale_pattern_size_manual(values=c(1.5,1.5,0,1.6,0,0)) +
    scale_pattern_spacing_manual(values=c(0.08,0.08,0,0.06,0,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=sizes$size.error, color="BLACK", position=position_dodge(1)) +
    
    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=3, 
                 linetype="solid") +

    geom_signif(data=sig_T1.HC, aes(annotations=adj.signif, y_position=sig.pos_T1.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T1.HC, aes(label=d, x=x.eff, y=y.eff),
              size=y.position$effsize, hjust=0, vjust=0, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1.5, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.sm1 <- plotlist$Whole_amygdala
bp.nuclei.sm2 <- plotlist$Basal_nucleus
bp.nuclei.sm3 <- plotlist$Lateral_nucleus
bp.nuclei.sm4 <- plotlist$Accessory_basal_nucleus
bp.nuclei.sm5 <- plotlist$Cortical_nucleus
bp.nuclei.sm6 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.sm7 <- plotlist$Medial_nucleus
bp.nuclei.sm8 <- plotlist$Central_nucleus
bp.nuclei.sm9 <- plotlist$Anterior_amygdaloid_area
bp.nuclei.sm10 <- plotlist$Paralaminar_nucleus

barplotarrange.whole.sm <- ggarrange(bp.whole.sm1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.sm, path="figures", filename="smlme.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.sm <- ggarrange(bp.nuclei.sm2,
                                 bp.nuclei.sm3,
                                 bp.nuclei.sm4, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.sm, path="figures", filename="smlme.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.sm <- ggarrange(bp.nuclei.sm5,
                                 bp.nuclei.sm6,
                                 bp.nuclei.sm7, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.sm, path="figures", filename="smlme.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.sm <- ggarrange(bp.nuclei.sm8,
                                 bp.nuclei.sm9,
                                 bp.nuclei.sm10, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.sm, path="figures", filename="smlme.row3.png", 
       #width=32, height=10, dpi=600)
```

## Reproduce main LME findings including deltaBMI-SDSsquared as a predictor

Quadratic deltaBMI-SDS effects are significant for: Accessory basal
nucleus rh, Cortical nucleus lh, Medial nucleus lh, Medial nucleus rh.
DeltaBMI-SDSsquared included for all nuclei in rep. LME to be
consistent/reproduce main LME findings.

```{r reproducebmisdssquared, results="asis", message=FALSE, warning=FALSE}
rep.lme <- lmedata %>%
  filter_at(vars(por, measure, delta.bmisds, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    # Rep LME model: age and age^2 (linear and quadratic/non-linear age effects), deltaBMI-SDS and deltaBMI-SDS^2 (linear and quadratic/non-linear BMI-SDS change effects), eTIV (head size correction) 
    lme=map(data, ~lme4::lmer(measure ~1 + por +
                                poly(delta.bmisds, degree=2, raw=FALSE) +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.tidy=map(lme, tidy),
    emmeans=map(lme, ~emmeans::emmeans(.x,
                                       c("por", "delta.bmisds"),
                                       at=list(delta.bmisds=
                                                 c(0, delta.bmisds.mean)), 
                                       lmer.df="satterthwaite", type="response")),
    emmeans.tidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme, 
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme, 
      "RecANvsHC"=recAN.lme - HC.lme), 
      lmer.df="satterthwaite", adjust="none")),
    contrasts.tidy=map(contrasts, tidy), 
    SDtable.rep=map(lme, ~as.tibble(lme4::VarCorr(.x))), 
    SDtotal.rep=map_dbl(SDtable.rep, ~sqrt(.x$vcov[.x$grp=="participant_id"] + .x$vcov[.x$grp=="Residual"]))) 
 

rep.contrasts <- rep.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, contrasts.tidy) %>%
  unnest(contrasts.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                                formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # multiple comparisons adjustment: FDR across all contrasts per (sub-)region and across all (sub-)regions (subregions and whole structure separately)
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

rep.contrasts %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
               caption="Reproduce main LME model including deltaBMI-SDSsquared: Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

### Reproduce (deltaBMI-SDSsquared): Effect size statistics

```{r repeffectsize, results="asis", message=FALSE, warning=FALSE}
cohenlist.rep=list()

for (Hemi_Region in unique(rep.lme$hemi_region)) {
  
  SDtotal.rep <- rep.lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal.rep)
  
  cohensD.rep <- rep.lme %>%
    dplyr::select(hemi_region, region, labeller.amy, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohensD.rep=map(emmeans, ~as.tibble(emmeans::eff_size(.x, sigma=SDtotal.rep, edf=Inf, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme,
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme,
      "RecANvsHC"=recAN.lme - HC.lme))))) %>%
    unnest(cohensD.rep) %>%
    mutate(cohensD.rep_pre=formatC(effect.size, format="f", digits=2)) %>%
    mutate(cohensD.rep=abs(effect.size)) %>%
    mutate(d_formatted=ifelse(cohensD.rep<0.01, "<0.01", formatC(cohensD.rep, format="f", digits=2))) %>%
    mutate(se=formatC(SE, format="f", digits=2)) %>%
    mutate(CI_95_lower=formatC(lower.CL, format="f", digits=2)) %>%
    mutate(CI_95_upper=formatC(upper.CL, format="f", digits=2)) %>%
    mutate(bracket01="[", bracket02="]") %>%
    unite("confint_95", c(CI_95_lower, CI_95_upper), sep=",", remove=FALSE, na.rm=FALSE) %>%
    unite("confint_95", c(bracket01, confint_95, bracket02), sep="", remove=FALSE, na.rm=FALSE) %>%
    dplyr::select(hemi_region, region, labeller.amy, contrast, cohensD.rep_pre,
                  cohensD.rep, d_formatted, se, confint_95)

  cohenlist.rep[[Hemi_Region]]=cohensD.rep
  }

cohensD.rep.lme <- as.tibble(bind_rows(cohenlist.rep[1:20]))
                         
cohensD.rep.lme %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, contrast, cohensD.rep_pre, se, confint_95) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Cohen's d", "se", "95% CI"), 
               caption="Rep LME model including deltaBMI-SDSsquared effects: Effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

### Reproduce(deltaBMI-SDSsquared): Barplot visualization

```{r barplotsreplme, fig.cap="Reproduce main LME model findings by including quadratic deltaBMI-SDS effects", message=FALSE, warning=FALSE}
rep.bardata <- rep.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds==0 ~ "RecAN",
    por=="HCW" & delta.bmisds==0 ~ "HC",
    por=="recAN" & delta.bmisds!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds!=0 ~ "zerobar2")) %>%
  mutate(estimate=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, estimate), 
         std.error=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, std.error)) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "zerobar1", 
                                          "RecAN", "zerobar2", 
                                          "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 18, 14)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 12, 10)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 35)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(rep.bardata$region)) {
  
  plotdata <- rep.bardata %>% filter(region %in% Region)
  
  y.position <- rep.bardata %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.75*estimate) %>%
    mutate(ymax=1.25*estimate) %>%
    mutate(sig.pos_T2.T1=(0.08*(ymax-ymin)) + (estimate+std.error)) %>%
    #mutate(sig.pos_T2.recAN=(0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_recAN.HC=(0.24*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_T2.HC=(0.40*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.015) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.T1, #sig.pos_T2.recAN, 
                  sig.pos_recAN.HC, sig.pos_T2.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- rep.bardata %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)
   
  sig_T2.T1 <- rep.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2)
  
  effsize_T2.T1 <- cohensD.rep.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.rep<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.T1) %>%
    mutate(x.eff=2.15)
 
  #sig_T2.recAN <- rep.contrasts %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(xmin=2) %>%
    #mutate(xmax=4)
   
  #effsize_T2.recAN <- cohensD.rep.lme %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(label=ifelse(cohensD.rep<0.01, "d", "d=")) %>%
    #unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    #mutate(y.eff=sig.pos_T2.recAN) %>%
    #mutate(x.eff=4.15)
  
  sig_recAN.HC <- rep.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=4) %>%
    mutate(xmax=6)
   
  effsize_recAN.HC <- cohensD.rep.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.rep<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_recAN.HC) %>%
    mutate(x.eff=3.85)

  sig_T2.HC <- rep.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=2) %>%
    mutate(xmax=6)
  
  effsize_T2.HC <- cohensD.rep.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.rep<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.HC) %>%
    mutate(x.eff=3)
      
  regioncolor <- color %>% 
      filter(region %in% Region)
  
  sizes <- rep.bardata %>% 
    filter(region %in% Region) %>%
    mutate(size=ifelse(str_detect(emmeans, "zero"), 0, 1.25)) %>%
    mutate(size.error=ifelse(str_detect(emmeans, "zero"), 0, 3)) 
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=sizes$size,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("crosshatch", "stripe", "none", "circle", "none", "none")) +
    scale_pattern_density_manual(values=c(0.07,0.07,0,0.25,0,0)) +
    scale_pattern_size_manual(values=c(1.5,1.5,0,1.6,0,0)) +
    scale_pattern_spacing_manual(values=c(0.08,0.08,0,0.06,0,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=sizes$size.error, color="BLACK", position=position_dodge(1)) +
    
    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=3, 
                 linetype="solid") +
    
    geom_signif(data=sig_T2.T1, aes(annotations=adj.signif, y_position=sig.pos_T2.T1, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.T1, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    #geom_signif(data=sig_T2.recAN, aes(annotations=adj.signif, y_position=sig.pos_T2.recAN, 
                                            #xmin=xmin, xmax=xmax, tip_length=tipl),
                #textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    #geom_text(data=effsize_T2.recAN, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              #size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    geom_signif(data=sig_recAN.HC, aes(annotations=adj.signif, y_position=sig.pos_recAN.HC, 
                                            xmin=xmin, xmax=xmax, tip_length=tipl),
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_recAN.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, color="BLACK", parse=FALSE) +

    geom_signif(data=sig_T2.HC, aes(annotations=adj.signif, y_position=sig.pos_T2.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, vjust=-0.5, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1.5, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.rep1 <- plotlist$Whole_amygdala
bp.nuclei.rep2 <- plotlist$Basal_nucleus
bp.nuclei.rep3 <- plotlist$Lateral_nucleus
bp.nuclei.rep4 <- plotlist$Accessory_basal_nucleus
bp.nuclei.rep5 <- plotlist$Cortical_nucleus
bp.nuclei.rep6 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.rep7 <- plotlist$Medial_nucleus
bp.nuclei.rep8 <- plotlist$Central_nucleus
bp.nuclei.rep9 <- plotlist$Anterior_amygdaloid_area
bp.nuclei.rep10 <- plotlist$Paralaminar_nucleus

barplotarrange.whole.rep <- ggarrange(bp.whole.rep1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.rep, path="figures", filename="replme.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.rep <- ggarrange(bp.nuclei.rep2,
                                 bp.nuclei.rep3,
                                 bp.nuclei.rep4, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.rep, path="figures", filename="replme.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.rep <- ggarrange(bp.nuclei.rep5,
                                 bp.nuclei.rep6,
                                 bp.nuclei.rep7, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.rep, path="figures", filename="replme.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.rep <- ggarrange(bp.nuclei.rep8,
                                 bp.nuclei.rep9,
                                 bp.nuclei.rep10, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.rep, path="figures", filename="replme.row3.png", 
       #width=32, height=10, dpi=600)
```

## Reproduce main LME findings in acAN subsample excluding binge/purge acAN (only restrictive acAN) and former binge/purge recAN

```{r lmeR, results="asis", message=FALSE, warning=FALSE}
R.lmedata <- lmedata %>%
  left_join(redcap_clinical, by="storage_name") %>%
  mutate(subtype=ifelse(point_of_research=="T1", siabex_result_an_type, 0)) %>%
  mutate(subtype_past=ifelse(point_of_research=="recAN", siabex_past_result_an_type, 0)) %>%
  group_by(hemi_region, participant_id) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(subtype=ifelse(point_of_research=="T2",
                       lag(subtype), subtype)) %>%
  ungroup() %>%
  filter(subtype!=2) %>% # exclude binge/purge
  filter(is.na(subtype_past) | (subtype_past !=2)) %>%
  group_by(hemi_region, point_of_research) %>%
  mutate(n_groups=n()) %>%
  ungroup() %>%
  filter_at(vars(por, measure, bmisds_at_date_of_research, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  group_by(hemi_region, participant_id) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds.R=ifelse(point_of_research=="T1", 
                             bmisds_at_date_of_research - lead(bmisds_at_date_of_research), 
                             0)) %>% # delta=T1-T2
  ungroup() %>%
  mutate(delta.bmisds.R.mean=
           mean(delta.bmisds.R[delta.bmisds.R!=0], na.rm=TRUE)) %>%
  mutate(participant_id=factor(participant_id))

delta.bmisds.R.mean <- unique(R.lmedata$delta.bmisds.R.mean)

R.lme <- R.lmedata %>%
  filter_at(vars(por, measure, delta.bmisds.R, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme=map(data, ~lme4::lmer(measure ~1 + por +
                                delta.bmisds.R +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.tidy=map(lme, tidy),
    emmeans=map(lme, ~emmeans::emmeans(.x,
                                       c("por", "delta.bmisds.R"),
                                       at=list(delta.bmisds.R=
                                                 c(0, delta.bmisds.R.mean)), 
                                       lmer.df="satterthwaite", type="response")),
    emmeans.tidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme, 
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme, 
      "RecANvsHC"=recAN.lme - HC.lme), 
      lmer.df="satterthwaite", adjust="none")),
    contrasts.tidy=map(contrasts, tidy), 
    SDtable.R=map(lme, ~as.tibble(lme4::VarCorr(.x))), 
    SDtotal.R=map_dbl(SDtable.R, ~sqrt(.x$vcov[.x$grp=="participant_id"] + .x$vcov[.x$grp=="Residual"]))) 

R.lme %>% 
  unnest(data) %>%
  dplyr::select(por, n_groups) %>% distinct() %>% arrange(por) %>%
  knitr::kable(format="html", align="l", col.names=c("Study group", "n"),
               caption="Post-exclusion study groups (- binge/purge subtype)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
 

R.contrasts <- R.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, contrasts.tidy) %>%
  unnest(contrasts.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                                formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% 
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

R.contrasts %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
               caption="Reproduce main LME model excluding binge/purge subtype acAN: Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r Reffectsize, results="asis", message=FALSE, warning=FALSE}
cohenlist.R=list()

for (Hemi_Region in unique(R.lme$hemi_region)) {
  
  SDtotal.R <- R.lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal.R)
  
  cohensD.R <- R.lme %>%
    dplyr::select(hemi_region, region, labeller.amy, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohensD.R=map(emmeans, ~as.tibble(emmeans::eff_size(.x, sigma=SDtotal.R, edf=Inf, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme,
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme,
      "RecANvsHC"=recAN.lme - HC.lme))))) %>%
    unnest(cohensD.R) %>%
    mutate(cohensD.R_pre=formatC(effect.size, format="f", digits=2)) %>%
    mutate(cohensD.R=abs(effect.size)) %>%
    mutate(d_formatted=ifelse(cohensD.R<0.01, "<0.01", formatC(cohensD.R, format="f", digits=2))) %>%
    mutate(se=formatC(SE, format="f", digits=2)) %>%
    mutate(CI_95_lower=formatC(lower.CL, format="f", digits=2)) %>%
    mutate(CI_95_upper=formatC(upper.CL, format="f", digits=2)) %>%
    mutate(bracket01="[", bracket02="]") %>%
    unite("confint_95", c(CI_95_lower, CI_95_upper), sep=",", remove=FALSE, na.rm=FALSE) %>%
    unite("confint_95", c(bracket01, confint_95, bracket02), sep="", remove=FALSE, na.rm=FALSE) %>%
    dplyr::select(hemi_region, region, labeller.amy, contrast, cohensD.R_pre,
                  cohensD.R, d_formatted, se, confint_95)

  cohenlist.R[[Hemi_Region]]=cohensD.R
  }

cohensD.R.lme <- as.tibble(bind_rows(cohenlist.R[1:20]))
                         
cohensD.R.lme %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, contrast, cohensD.R_pre, se, confint_95) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Cohen's d", "se", "95% CI"), 
               caption="Reproduce main LME model excluding binge/purge subtype acAN: Effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r barplotsRlme, fig.cap="Reproduce main LME model findings by excluding binge/purge subtype acAN", message=FALSE, warning=FALSE}
R.bardata <- R.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds.R!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds.R==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds.R==0 ~ "RecAN",
    por=="HCW" & delta.bmisds.R==0 ~ "HC",
    por=="recAN" & delta.bmisds.R!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds.R!=0 ~ "zerobar2")) %>%
  mutate(estimate=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, estimate), 
         std.error=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, std.error)) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "zerobar1", 
                                          "RecAN", "zerobar2", 
                                          "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 18, 14)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 12, 10)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 35)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(R.bardata$region)) {
  
  plotdata <- R.bardata %>% filter(region %in% Region)
  
  y.position <- R.bardata %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.75*estimate) %>%
    mutate(ymax=1.25*estimate) %>%
    mutate(sig.pos_T2.T1=(0.08*(ymax-ymin)) + (estimate+std.error)) %>%
    #mutate(sig.pos_T2.recAN=(0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_recAN.HC=(0.24*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_T2.HC=(0.40*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.015) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.T1, #sig.pos_T2.recAN, 
                  sig.pos_recAN.HC, sig.pos_T2.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- R.bardata %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)
   
  sig_T2.T1 <- R.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2)
  
  effsize_T2.T1 <- cohensD.R.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.R<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.T1) %>%
    mutate(x.eff=2.15)
 
  #sig_T2.recAN <- R.contrasts %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(xmin=2) %>%
    #mutate(xmax=4)
   
  #effsize_T2.recAN <- cohensD.R.lme %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(label=ifelse(cohensD.R<0.01, "d", "d=")) %>%
    #unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    #mutate(y.eff=sig.pos_T2.recAN) %>%
    #mutate(x.eff=4.15)
  
  sig_recAN.HC <- R.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=4) %>%
    mutate(xmax=6)
   
  effsize_recAN.HC <- cohensD.R.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.R<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_recAN.HC) %>%
    mutate(x.eff=3.85)

  sig_T2.HC <- R.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=2) %>%
    mutate(xmax=6)
  
  effsize_T2.HC <- cohensD.R.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.R<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.HC) %>%
    mutate(x.eff=3)
      
  regioncolor <- color %>% 
      filter(region %in% Region)
  
  sizes <- R.bardata %>% 
    filter(region %in% Region) %>%
    mutate(size=ifelse(str_detect(emmeans, "zero"), 0, 1.25)) %>%
    mutate(size.error=ifelse(str_detect(emmeans, "zero"), 0, 3)) 
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=sizes$size,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("crosshatch", "stripe", "none", "circle", "none", "none")) +
    scale_pattern_density_manual(values=c(0.07,0.07,0,0.25,0,0)) +
    scale_pattern_size_manual(values=c(1.5,1.5,0,1.6,0,0)) +
    scale_pattern_spacing_manual(values=c(0.08,0.08,0,0.06,0,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=sizes$size.error, color="BLACK", position=position_dodge(1)) +
    
    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=3, 
                 linetype="solid") +
    
    geom_signif(data=sig_T2.T1, aes(annotations=adj.signif, y_position=sig.pos_T2.T1, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.T1, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    #geom_signif(data=sig_T2.recAN, aes(annotations=adj.signif, y_position=sig.pos_T2.recAN, 
                                            #xmin=xmin, xmax=xmax, tip_length=tipl),
                #textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    #geom_text(data=effsize_T2.recAN, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              #size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    geom_signif(data=sig_recAN.HC, aes(annotations=adj.signif, y_position=sig.pos_recAN.HC, 
                                            xmin=xmin, xmax=xmax, tip_length=tipl),
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_recAN.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, color="BLACK", parse=FALSE) +

    geom_signif(data=sig_T2.HC, aes(annotations=adj.signif, y_position=sig.pos_T2.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, vjust=-0.5, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1.5, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.R1 <- plotlist$Whole_amygdala
bp.nuclei.R2 <- plotlist$Basal_nucleus
bp.nuclei.R3 <- plotlist$Lateral_nucleus
bp.nuclei.R4 <- plotlist$Accessory_basal_nucleus
bp.nuclei.R5 <- plotlist$Cortical_nucleus
bp.nuclei.R6 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.R7 <- plotlist$Medial_nucleus
bp.nuclei.R8 <- plotlist$Central_nucleus
bp.nuclei.R9 <- plotlist$Anterior_amygdaloid_area
bp.nuclei.R10 <- plotlist$Paralaminar_nucleus

barplotarrange.whole.R <- ggarrange(bp.whole.R1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.R, path="figures", filename="Rlme.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.R <- ggarrange(bp.nuclei.R2,
                                 bp.nuclei.R3,
                                 bp.nuclei.R4, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.R, path="figures", filename="Rlme.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.R <- ggarrange(bp.nuclei.R5,
                                 bp.nuclei.R6,
                                 bp.nuclei.R7, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.R, path="figures", filename="Rlme.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.R <- ggarrange(bp.nuclei.R8,
                                 bp.nuclei.R9,
                                 bp.nuclei.R10, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.R, path="figures", filename="Rlme.row3.png", 
       #width=32, height=10, dpi=600)
```

## Reproduce main LME findings in subsamples excluding acAN and recAN with relevant co-existing psychiatric diagnoses and/or psychoactive medications

Psychiatric diagnoses (ever): depressive disorder, anxiety disorder,
obsessive-compulsive disorder, PTSD;\
Psychoactive medications (past/last 6 months): SSRI, mirtazapine.

```{r lmeexclude, results="asis", message=FALSE, warning=FALSE}
excl.lmedata <- lmedata %>%
  left_join(redcap_clinical, by="storage_name") %>%
  mutate_at(vars(depressive_disorders, anxiety_disorders, obsessivecompulsive_disorders, ptsd), 
            ~replace_na(.x, "nein")) %>%
  mutate(psych_comorbidity=ifelse((point_of_research %in% c("T1", "recAN")) & #not assessed at TP2 
                                      ((depressive_disorders=="ja") |
                                      (anxiety_disorders=="ja") | 
                                      (obsessivecompulsive_disorders=="ja") | 
                                      (ptsd=="ja")), 
                                    1, 0)) %>%
  mutate(antidepressants=ifelse((type_of_current_medication___1=="Checked") | 
                                    (type_of_recent_medication___1=="Checked"), 
                                  1, 0)) %>%
  filter((psych_comorbidity==0)&(antidepressants==0)) %>%
  group_by(hemi_region, participant_id) %>% 
  mutate(nomatch=ifelse((point_of_research %in% c("T1", "T2")) & (n()<2), TRUE, FALSE)) %>%
  ungroup() %>%
  filter(nomatch==FALSE) %>%
  group_by(hemi_region, point_of_research) %>%
  mutate(n_groups=n()) %>%
  ungroup() %>%
  filter_at(vars(por, measure, bmisds_at_date_of_research, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>%
  group_by(hemi_region, participant_id) %>% arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds.excl=ifelse(point_of_research=="T1", 
                             bmisds_at_date_of_research - lead(bmisds_at_date_of_research), 
                             0)) %>% # delta=T1-T2
  ungroup() %>%
  mutate(delta.bmisds.excl.mean=
           mean(delta.bmisds.excl[delta.bmisds.excl!=0], na.rm=TRUE)) %>%
  mutate(participant_id=factor(participant_id))

delta.bmisds.excl.mean <- unique(excl.lmedata$delta.bmisds.excl.mean)
  
excl.lme <- excl.lmedata %>%
  filter_at(vars(por, measure, delta.bmisds.excl, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  dplyr::select(-c(storage_name, point_of_research)) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme=map(data, ~lme4::lmer(measure ~1 + por +
                                delta.bmisds.excl +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=.x, REML=TRUE, na.action=na.omit)),
    lme.tidy=map(lme, tidy),
    emmeans=map(lme, ~emmeans::emmeans(.x,
                                       c("por", "delta.bmisds.excl"),
                                       at=list(delta.bmisds.excl=
                                                 c(0, delta.bmisds.excl.mean)), 
                                       lmer.df="satterthwaite", type="response")),
    emmeans.tidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme, 
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme, 
      "RecANvsHC"=recAN.lme - HC.lme), 
      lmer.df="satterthwaite", adjust="none")),
    contrasts.tidy=map(contrasts, tidy), 
    SDtable.excl=map(lme, ~as.tibble(lme4::VarCorr(.x))), 
    SDtotal.excl=map_dbl(SDtable.excl, ~sqrt(.x$vcov[.x$grp=="participant_id"] + .x$vcov[.x$grp=="Residual"]))) 

excl.lme %>% 
  unnest(data) %>%
  dplyr::select(por, n_groups) %>% distinct() %>% arrange(por) %>%
  knitr::kable(format="html", align="l", col.names=c("Study group", "n"),
               caption="Post-exclusion study groups (- co-existing psychiatric diagnoses/psychoactive medications)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
 

excl.contrasts <- excl.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, contrasts.tidy) %>%
  unnest(contrasts.tidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                                formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

excl.contrasts %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, contrast, term, p_formatted, signif, 
                p.fdr_formatted, adj.signif) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Term", 
                                                     "p", "Signif.",
                                                     "FDR-q", "Adj. signif."),
               caption="Reproduce main LME model excluding acAN and recAN participants with relevant co-existing psychiatric diagnoses and/or psychoactive medications: Contrasts table") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r excleffectsize, results="asis", message=FALSE, warning=FALSE}
cohenlist.excl=list()

for (Hemi_Region in unique(excl.lme$hemi_region)) {
  
  SDtotal.excl <- excl.lme %>% 
    filter(hemi_region %in% Hemi_Region) %>%
    pull(SDtotal.excl)
  
  cohensD.excl <- excl.lme %>%
    dplyr::select(hemi_region, region, labeller.amy, emmeans) %>%
    filter(hemi_region %in% Hemi_Region) %>%
    mutate(
    cohensD.excl=map(emmeans, ~as.tibble(emmeans::eff_size(.x, sigma=SDtotal.excl, edf=Inf, method=list(
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.lme - acAN_TP1.lme,
      #"AcAN-TP2vsRecAN"=acAN_TP2.lme - recAN.lme,
      "AcAN-TP2vsHC"=acAN_TP2.lme - HC.lme,
      "RecANvsHC"=recAN.lme - HC.lme))))) %>%
    unnest(cohensD.excl) %>%
    mutate(cohensD.excl_pre=formatC(effect.size, format="f", digits=2)) %>%
    mutate(cohensD.excl=abs(effect.size)) %>%
    mutate(d_formatted=ifelse(cohensD.excl<0.01, "<0.01", formatC(cohensD.excl, format="f", digits=2))) %>%
    mutate(se=formatC(SE, format="f", digits=2)) %>%
    mutate(CI_95_lower=formatC(lower.CL, format="f", digits=2)) %>%
    mutate(CI_95_upper=formatC(upper.CL, format="f", digits=2)) %>%
    mutate(bracket01="[", bracket02="]") %>%
    unite("confint_95", c(CI_95_lower, CI_95_upper), sep=",", remove=FALSE, na.rm=FALSE) %>%
    unite("confint_95", c(bracket01, confint_95, bracket02), sep="", remove=FALSE, na.rm=FALSE) %>%
    dplyr::select(hemi_region, region, labeller.amy, contrast, cohensD.excl_pre,
                  cohensD.excl, d_formatted, se, confint_95)

  cohenlist.excl[[Hemi_Region]]=cohensD.excl
  }

cohensD.excl.lme <- as.tibble(bind_rows(cohenlist.excl[1:20]))
                         
cohensD.excl.lme %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, contrast, cohensD.excl_pre, se, confint_95) %>%
  knitr::kable(format="html", align="l", col.names=c("Amygdala (sub-)region", "Contrast", "Cohen's d", "se", "95% CI"), 
               caption="Reproduce main LME model excluding acAN and recAN participants with relevant co-existing psychiatric diagnoses and/or psychoactive medications: Effect size statistics") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

```{r barplotsexcllme, fig.cap="Reproduce main LME model findings by excluding acAN and recAN participants with relevant co-existing psychiatric diagnoses and/or psychoactive medications", message=FALSE, warning=FALSE}
excl.bardata <- excl.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds.excl!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds.excl==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds.excl==0 ~ "RecAN",
    por=="HCW" & delta.bmisds.excl==0 ~ "HC",
    por=="recAN" & delta.bmisds.excl!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds.excl!=0 ~ "zerobar2")) %>%
  mutate(estimate=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, estimate), 
         std.error=ifelse(emmeans %in% c("zerobar1", "zerobar2"), 0, std.error)) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "zerobar1", 
                                          "RecAN", "zerobar2", 
                                          "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 18, 14)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 12, 10)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 35)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(excl.bardata$region)) {
  
  plotdata <- excl.bardata %>% filter(region %in% Region)
  
  y.position <- excl.bardata %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.75*estimate) %>%
    mutate(ymax=1.25*estimate) %>%
    mutate(sig.pos_T2.T1=(0.08*(ymax-ymin)) + (estimate+std.error)) %>%
    #mutate(sig.pos_T2.recAN=(0.18*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_recAN.HC=(0.24*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(sig.pos_T2.HC=(0.40*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.015) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.T1, #sig.pos_T2.recAN, 
                  sig.pos_recAN.HC, sig.pos_T2.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- excl.bardata %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)
   
  sig_T2.T1 <- excl.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2)
  
  effsize_T2.T1 <- cohensD.excl.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsAcAN-TP1") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.excl<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.T1) %>%
    mutate(x.eff=2.15)
 
  #sig_T2.recAN <- excl.contrasts %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(xmin=2) %>%
    #mutate(xmax=4)
   
  #effsize_T2.recAN <- cohensD.excl.lme %>%
    #filter(region %in% Region) %>%
    #filter(contrast=="AcAN-TP2vsRecAN") %>%
    #left_join(y.position, by="region") %>%
    #mutate(label=ifelse(cohensD.excl<0.01, "d", "d=")) %>%
    #unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    #mutate(y.eff=sig.pos_T2.recAN) %>%
    #mutate(x.eff=4.15)
  
  sig_recAN.HC <- excl.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=4) %>%
    mutate(xmax=6)
   
  effsize_recAN.HC <- cohensD.excl.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="RecANvsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.excl<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_recAN.HC) %>%
    mutate(x.eff=3.85)

  sig_T2.HC <- excl.contrasts %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=2) %>%
    mutate(xmax=6)
  
  effsize_T2.HC <- cohensD.excl.lme %>%
    filter(region %in% Region) %>%
    filter(contrast=="AcAN-TP2vsHC") %>%
    left_join(y.position, by="region") %>%
    mutate(label=ifelse(cohensD.excl<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=sig.pos_T2.HC) %>%
    mutate(x.eff=3)
      
  regioncolor <- color %>% 
      filter(region %in% Region)
  
  sizes <- excl.bardata %>% 
    filter(region %in% Region) %>%
    mutate(size=ifelse(str_detect(emmeans, "zero"), 0, 1.25)) %>%
    mutate(size.error=ifelse(str_detect(emmeans, "zero"), 0, 3)) 
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=sizes$size,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("crosshatch", "stripe", "none", "circle", "none", "none")) +
    scale_pattern_density_manual(values=c(0.07,0.07,0,0.25,0,0)) +
    scale_pattern_size_manual(values=c(1.5,1.5,0,1.6,0,0)) +
    scale_pattern_spacing_manual(values=c(0.08,0.08,0,0.06,0,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=sizes$size.error, color="BLACK", position=position_dodge(1)) +
    
    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=3, 
                 linetype="solid") +
    
    geom_signif(data=sig_T2.T1, aes(annotations=adj.signif, y_position=sig.pos_T2.T1, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.T1, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    #geom_signif(data=sig_T2.recAN, aes(annotations=adj.signif, y_position=sig.pos_T2.recAN, 
                                            #xmin=xmin, xmax=xmax, tip_length=tipl),
                #textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    #geom_text(data=effsize_T2.recAN, aes(label=d, x=x.eff, y=y.eff), hjust=0,
              #size=y.position$effsize, color="BLACK", parse=FALSE) +
    
    geom_signif(data=sig_recAN.HC, aes(annotations=adj.signif, y_position=sig.pos_recAN.HC, 
                                            xmin=xmin, xmax=xmax, tip_length=tipl),
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_recAN.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, color="BLACK", parse=FALSE) +

    geom_signif(data=sig_T2.HC, aes(annotations=adj.signif, y_position=sig.pos_T2.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.2, vjust=0.1, color="BLACK", manual=TRUE) +
    geom_text(data=effsize_T2.HC, aes(label=d, x=x.eff, y=y.eff), hjust=1,
              size=y.position$effsize, vjust=-0.5, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       regioncolor$color, regioncolor$color, 
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1.5, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.excl1 <- plotlist$Whole_amygdala
bp.nuclei.excl2 <- plotlist$Basal_nucleus
bp.nuclei.excl3 <- plotlist$Lateral_nucleus
bp.nuclei.excl4 <- plotlist$Accessory_basal_nucleus
bp.nuclei.excl5 <- plotlist$Cortical_nucleus
bp.nuclei.excl6 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.excl7 <- plotlist$Medial_nucleus
bp.nuclei.excl8 <- plotlist$Central_nucleus
bp.nuclei.excl9 <- plotlist$Anterior_amygdaloid_area
bp.nuclei.excl10 <- plotlist$Paralaminar_nucleus

barplotarrange.whole.excl <- ggarrange(bp.whole.excl1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.excl, path="figures", filename="excllme.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.excl <- ggarrange(bp.nuclei.excl2,
                                 bp.nuclei.excl3,
                                 bp.nuclei.excl4, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.excl, path="figures", filename="excllme.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.excl <- ggarrange(bp.nuclei.excl5,
                                 bp.nuclei.excl6,
                                 bp.nuclei.excl7, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.excl, path="figures", filename="excllme.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.excl <- ggarrange(bp.nuclei.excl8,
                                 bp.nuclei.excl9,
                                 bp.nuclei.excl10, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.excl, path="figures", filename="excllme.row3.png", 
       #width=32, height=10, dpi=600)
```

# SM scatter plots

## Percentages

**Volumes adjusted for age, age squared, and head size**\
See cross-sectional paper for percentages of acAN-TP1 vs. HC
differences: 6-11% in severely affected nuclei (see also Excel
spreadsheet for exact percentages)

```{r perc, results="asis", message=FALSE, warning=FALSE}
# AcAN-TP2 vs. AcAN-TP1
perc.T1.T2 <- lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds==0 ~ "RecAN",
    por=="HCW" & delta.bmisds==0 ~ "HC",
    por=="recAN" & delta.bmisds!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds!=0 ~ "zerobar2")) %>%
  filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
  group_by(hemi_region) %>%
  mutate(perc=100*((estimate[which(emmeans=="AcAN-TP2")] - 
                      estimate[which(emmeans=="AcAN-TP1")]) / 
                     estimate[which(emmeans=="AcAN-TP1")])) %>%
  ungroup() %>%
  distinct(hemi_region, .keep_all=TRUE) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="A. ∆BMI-SDS-related volumetric change in AcAN (contrast AcAN-TP2 – AcAN-TP1, relative to TP1)") %>%
  mutate(ytitle="%")

perc.T1.T2 %>%
  dplyr::select(labeller.amy, perc) %>%
  arrange(desc(perc)) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", 
                                                     "% increase AcAN-TP2 vs. AcAN-TP1"), 
               caption="Percentage deltaBMI-SDS related change in amygdala nuclei volumes over the course of short-term weight-restoration (adjusted for age, age squared, and eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

# AcAN-TP2 vs. HC
perc.T2.HC <- lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds==0 ~ "RecAN",
    por=="HCW" & delta.bmisds==0 ~ "HC",
    por=="recAN" & delta.bmisds!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds!=0 ~ "zerobar2")) %>%
  filter(emmeans %in% c("AcAN-TP2", "HC")) %>%
  group_by(hemi_region) %>%
  mutate(perc=100*((estimate[which(emmeans=="AcAN-TP2")] - 
                      estimate[which(emmeans=="HC")]) / 
                     estimate[which(emmeans=="HC")])) %>%
  ungroup() %>%
  distinct(hemi_region, .keep_all=TRUE) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="B. Reduced/enlarged volumes in AcAN-TP2 (contrast AcAN-TP2 – HC, relative to HC)") %>%
  mutate(ytitle="%")

perc.T2.HC %>%
  dplyr::select(labeller.amy, perc) %>% 
  arrange(perc) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", 
                                                     "% reduction AcAN-TP2 vs. HC"), 
               caption="Percentage reduction of amygdala nuclei volumes in AcAN-TP2 vs. HC (adjusted for age, age squared, and eTIV; compare to our cross-sectional findings acAN-TP1 vs. HC)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")

# RecAN vs. HC
perc.recAN.HC <- lme %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & delta.bmisds!=0 ~ "AcAN-TP1",
    por=="acAN" & delta.bmisds==0 ~ "AcAN-TP2",
    por=="recAN" & delta.bmisds==0 ~ "RecAN",
    por=="HCW" & delta.bmisds==0 ~ "HC",
    por=="recAN" & delta.bmisds!=0 ~ "zerobar1",
    por=="HCW" & delta.bmisds!=0 ~ "zerobar2")) %>%
  filter(emmeans %in% c("RecAN", "HC")) %>%
  group_by(hemi_region) %>%
  mutate(perc=100*((estimate[which(emmeans=="RecAN")] - 
                      estimate[which(emmeans=="HC")]) / 
                     estimate[which(emmeans=="HC")])) %>%
  ungroup() %>%
  distinct(hemi_region, .keep_all=TRUE) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="C. Reduced/enlarged volumes in RecAN (contrast RecAN – HC, relative to HC)") %>%
  mutate(ytitle="%")

perc.recAN.HC %>%
  dplyr::select(labeller.amy, perc) %>%
  arrange(perc) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", 
                                                     "% reduction RecAN vs. HC"), 
               caption="Percentage reduction of amygdala nuclei volumes in RecAN vs. HC (adjusted for age, age squared, and eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

## Relative changes

```{r lmerelative, results="asis", message=FALSE, warning=FALSE}
lm.beta.lmer <- function(mod) {
   b <- fixef(mod)[-1]
   sd.x <- apply(getME(mod,"X")[,-1],2,sd)
   sd.y <- sd(getME(mod,"y"))
   b*sd.x/sd.y
}

# Compare standardized regression coefficients for deltaBMI-SDS related change in amygdala nuclei volumes in relation to subcortical gray matter volume
lmedata.subcort <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter_at(vars(por, subcort_gray, delta.bmisds, age_at_date_of_research, e_tiv), ~!is.na(.x)) %>% 
  mutate(age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE)) %>%
  mutate(etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE)) %>%
  dplyr::select(-c(storage_name, point_of_research)) 

lme.subcort <- lme4::lmer(subcort_gray ~1 + por +
                                delta.bmisds +
                                poly(age.c, degree=2, raw=FALSE) +
                                etiv.c + 
                                (1|participant_id), 
                              data=lmedata.subcort, REML=TRUE, na.action=na.omit)

BMISDSchange_subcort <- lm.beta.lmer(lme.subcort) %>% tidy() %>%
  filter(str_detect(names, "bmisds")) %>%
  mutate(BMISDSchange_subcort=x) %>% pull() # subcort change is positive 

ratio.subcort <- lme %>%
  dplyr::select(hemi_region, labeller.amy, lme) %>%
  mutate( 
    beta.BMISDSchange=map(lme, ~lm.beta.lmer(.x)),
    beta.BMISDSchange=map(beta.BMISDSchange, tidy)) %>%
  unnest(beta.BMISDSchange) %>%
  filter(str_detect(names, "bmisds")) %>%
  mutate(BMISDSchange=x) %>%
  mutate(perc=100*(BMISDSchange/BMISDSchange_subcort)) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="F. ∆BMI-SDS-related volumetric change in AcAN (contrast AcAN-TP2 – AcAN-TP1) in amygdala (nuclei) volumes relative to total subcortical gray matter volume change") %>%
  mutate(ytitle="%")

ratio.subcort %>%
  dplyr::select(labeller.amy, perc) %>%
  arrange(desc(perc)) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Ratio amygdala nuclei / subcort GM"),
               caption="Ratio of deltaBMI-SDS-related changes in amygdala nuclei volumes relative to changes in subcortical gray matter volume during inpatient treatment (based on standardized regression coefficients)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10") 

# Compare standardized regression coefficients for deltaBMI-SDS related change in amygdala nuclei volumes in relation to whole amygdala volume
BMISDSchange_whole <- lme %>%
  filter(region=="Whole_amygdala") %>%
  dplyr::select(hemi_region, region, lme) %>%
  mutate( 
    beta.BMISDSchange_whole=map(lme, ~lm.beta.lmer(.x)),
    beta.BMISDSchange_whole=map(beta.BMISDSchange_whole, tidy)) %>%
  unnest(beta.BMISDSchange_whole) %>%
  filter(str_detect(names, "bmisds")) %>%
  mutate(BMISDSchange_whole=x) %>%
  dplyr::select(hemi_region, region, BMISDSchange_whole) %>%
  pivot_wider(-region, names_from="hemi_region", values_from="BMISDSchange_whole") # whole amygdala change is positive 

ratio.whole <- lme %>%
  filter(region!="Whole_amygdala") %>%
  dplyr::select(hemi_region, labeller.amy, lme) %>%
  mutate( 
    beta.BMISDSchange=map(lme, ~lm.beta.lmer(.x)),
    beta.BMISDSchange=map(beta.BMISDSchange, tidy)) %>%
  unnest(beta.BMISDSchange) %>%
  filter(str_detect(names, "bmisds")) %>%
  mutate(BMISDSchange=x) %>%
  cbind(BMISDSchange_whole) %>%
  mutate(perc=100*(ifelse(str_detect(hemi_region, "lh"), 
                                   BMISDSchange/lh_Whole_amygdala,
                                   BMISDSchange/rh_Whole_amygdala))) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="E. ∆BMI-SDS-related volumetric change in AcAN (contrast AcAN-TP2 – AcAN-TP1) in amygdala nuclei volumes relative to whole amygdala volume change") %>%
  mutate(ytitle="%")

ratio.whole %>%
  dplyr::select(labeller.amy, perc) %>%
  arrange(desc(perc)) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Ratio amygdala nuclei / whole amygdala (lh, rh)"),
               caption="Ratio of deltaBMI-SDS-related changes in amygdala nuclei volumes relative to changes in whole amygdala volume (hemispheres separately) during inpatient treatment (based on standardized regression coefficients)") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", html_font="Arial", font_size="10")
```

## Scatter plot visualizations

### A

Short-term weight-restoration related changes in amygdala nuclei volumes
compared with age-related volumetric reduction (include linear and
quadratic effects)!\
No scatter plot itself but report in figure legend: Speed of
deltaBMI-SDS (and age) related changes in amygdala nuclei volumes
(Slopes) =\>

```{r speedchangebmisdsage, results="asis", message=FALSE, warning=FALSE}
#Although polynomial regression allows for a nonlinear relationship between Y and X, polynomial regression is still considered linear regression since it is linear in the regression coefficients β1,β2,...,βh (estimates the relationship as an nth degree polynomial, parameters to be estimated are (multi-)linear)!

treat.dur.mean.inyears <- descriptive.data_T2.T1 %>% 
  mutate(treat.dur.mean.inyears = mean(delta_date_of_research_T2, na.rm=TRUE)/365) %>% 
  distinct(treat.dur.mean.inyears) %>% pull()

age_speed <- rep.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, lme.tidy) %>%
  unnest(lme.tidy) %>%
  filter(str_detect(term, "age")) %>%
  dplyr::select(hemi_region, labeller.amy, term, estimate) %>%
  group_by(hemi_region) %>%
  mutate(agechange_lin=ifelse(term=="poly(age.c, degree = 2, raw = FALSE)1", 
                                estimate*treat.dur.mean.inyears, NA)) %>%
  mutate(agechange_sq=ifelse(term=="poly(age.c, degree = 2, raw = FALSE)2", 
                                estimate*(treat.dur.mean.inyears^2), NA)) %>%
  fill(agechange_lin, .direction="down") %>%
  fill(agechange_sq, .direction="up") %>%
  mutate(agechange=agechange_lin+agechange_sq) %>% #linear and quadratic age changes/slopes for mean duration of inpatient treatment, estimate itself refers to age-related change per year (age-centering => mean age=0, i.e., mean age + treatment period = 0+treatment period)
  ungroup() %>%
  distinct(hemi_region, .keep_all=TRUE)

bmisds.age.speed <- rep.lme %>%
  dplyr::select(hemi_region, region, labeller.amy, lme.tidy) %>%
  unnest(lme.tidy) %>%
  filter(str_detect(term, "bmisds")) %>%
  dplyr::select(hemi_region, labeller.amy, term, estimate) %>%
  group_by(hemi_region) %>%
  mutate(BMISDSchange_lin=ifelse(term=="poly(delta.bmisds, degree = 2, raw = FALSE)1", 
                                estimate*abs(delta.bmisds.mean), NA)) %>% #estimate itself refers to deltaBMI-SDS-related change per SDS-unit 
  mutate(BMISDSchange_sq=ifelse(term=="poly(delta.bmisds, degree = 2, raw = FALSE)2", 
                                estimate*(delta.bmisds.mean^2), NA)) %>%
  fill(BMISDSchange_lin, .direction="down") %>%
  fill(BMISDSchange_sq, .direction="up") %>%
  mutate(BMISDSchange=BMISDSchange_lin+BMISDSchange_sq) %>% 
  ungroup() %>%
  distinct(hemi_region, .keep_all=TRUE) %>% 
  left_join(age_speed, by=c("hemi_region", "labeller.amy"), 
            suffix=c(".bmisds", ".age")) %>%
  mutate(ratio=abs(BMISDSchange/agechange)) %>%
  dplyr::select(labeller.amy, ratio)

bmisds.age.speed %>%
  arrange(desc(ratio)) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region",
                                                               #"DeltaBMI-SDS-related volume change in mm^3 (+2.43 SDS-units on average)",
                                                               #"Age-related volume change in mm^3 (88 days treatment period on average)",
                                                               "Treatment period: Ratio deltaBMI-SDS / age-related volume change"),
               caption="LME-model estimated speed of volume changes (slopes) in amygdala nuclei as function of deltaBMI-SDS and age (linear and quadratic effects)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r figureratiobmisdsage, fig.cap="Scatterplots - Ratio delta BMI-SDS:age", message=FALSE, warning=FALSE}
plot_theme_transparent_scatters=theme(axis.text.x=element_text(size=35, color="white"),
                   axis.text.y=element_text(size=35, color="white"),
                   axis.title=element_text(size=35, color="white"), 
                   axis.line=element_line(color="white", size=1.5), 
                   panel.border=element_blank(),
                   panel.grid.major=element_blank(), 
                   panel.grid.minor=element_blank(), 
                   strip.background=element_rect(color="black", fill="black"))


bmi.age.ratio.scatters <- bmisds.age.speed %>%
  mutate(labeller.amy=dplyr::recode(labeller.amy,
                                      "Whole amygdala lh"="Whole lh",
                                      "Whole amygdala rh"="Whole rh",
                                      "Basal nucleus lh"="Ba lh",
                                      "Basal nucleus rh"="Ba rh",
                                      "Lateral nucleus lh"="La lh",
                                      "Lateral nucleus rh"="La rh",
                                      "Accessory basal nucleus lh"="AB lh",
                                      "Accessory basal nucleus rh"="AB rh",
                                      "Cortical nucleus lh"="Co lh",
                                      "Cortical nucleus rh"="Co rh",
                                      "Cortico- amygdaloid transition lh"="CAT lh",
                                      "Cortico- amygdaloid transition rh"="CAT rh",
                                      "Medial nucleus lh"="Me lh",
                                      "Medial nucleus rh"="Me rh",
                                      "Central nucleus lh"="Ce lh",
                                      "Central nucleus rh"="Ce rh",
                                      "Anterior amygdaloid area lh"="AAA lh",
                                      "Anterior amygdaloid area rh"="AAA rh",
                                      "Paralaminar nucleus lh"="Para lh",
                                      "Paralaminar nucleus rh"="Para rh")) %>%
  mutate(labeller.amy=factor(labeller.amy, levels=c("Whole lh", "Whole rh", "Ba lh", "Ba rh", "La lh", "La rh", 
                                                      "AB lh", "AB rh", "Co lh", "Co rh", 
                                                      "CAT lh", "CAT rh", "Me lh", "Me rh",
                                                      "Ce lh", "Ce rh", "AAA lh", "AAA rh", "Para lh", "Para rh"))) %>%
  ggplot(aes(x=labeller.amy, y=ratio)) +
  geom_vline(aes(xintercept=labeller.amy), color="gray60", linetype=3, size=3.5, alpha=0.75) +
  geom_point(color="white", alpha=1, size=16, shape=16) +
  scale_x_discrete(expand=expansion(mult=c(0.1,0.1))) +
  scale_y_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                labels=trans_format("log10", math_format(10^.x))) +
  annotation_logticks(base=10, sides="l", color="white", alpha=1, size=2, outside=TRUE,
                      short=unit(0.4, "cm"), mid=unit(1.0, "cm"), long=unit(1.8, "cm")) +
  coord_cartesian(clip="off") +
  ggtitle("Ratio ∆BMI-SDS-related volumetric change : age-related volumetric reduction in AcAN (AcAN-TP2 – AcAN-TP1) during inpatient treatment period (∆BMI-SDS +2.43 SDS-units over the course of 88 days on average)") +
  xlab("Amygdala (sub-)regions") +
  ylab("Ratio") +
  plot_theme_transparent_scatters +
  theme(panel.background=element_rect(fill="black", color="black"), 
          plot.background=element_rect(fill="black", color="black")) +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5, size=55),
          axis.text.y=element_text(hjust=-1.2, size=70),
          axis.ticks.x=element_line(size=1.5, color="white"),
          axis.ticks.y=element_line(size=1.5, color="white"), 
          axis.title.x=element_text(size=70),
          axis.title.y=element_text(size=70, vjust=5),
          axis.ticks.length.y=unit(.25, "cm"), 
          axis.ticks.length.x=unit(.25, "cm"),
          plot.title=element_textbox_simple(size=48, hjust=0, vjust=0, face="bold",
                                            padding=unit(c(0.5,0.5,0.5,0.5), "cm"),
                                            color="white")) +
  theme(aspect.ratio=8/7) +
  guides(fill=FALSE, color=FALSE, size=FALSE) +
  theme(plot.margin=unit(c(2,2,2,2), "cm"))

#ggsave(bmi.age.ratio.scatters, filename="figures/bmi.age.ratio.scatterplots.png", width=35, height=40, dpi=600)
```

```{r figuresscatterbmisdsage, fig.cap="Scatterplots deltaBMI-SDS and age-related changes", message=FALSE, warning=FALSE}
plotlist = list()

for (Region in unique(lmedata$region)) {
  
  bmi.age.scatterdata <- lmedata %>%
    filter(region %in% Region) %>%
    dplyr::select(labeller.amy, storage_name, participant_id, por, measure, 
                age_at_date_of_research, e_tiv) %>%
    dplyr::rename(Groups=por) %>%
    mutate(labeller.amy=dplyr::recode(labeller.amy,
                                      "Cortico- amygdaloid transition lh"=
                                        "Corticoamygdaloid transition lh",
                                      "Cortico- amygdaloid transition rh"=
                                        "Corticoamygdaloid transition rh"))
  
  bmi.age.scatters <- bmi.age.scatterdata %>% 
    ggplot(aes(x=age_at_date_of_research, y=measure, 
               group=Groups, color=Groups, fill=Groups)) +
    geom_point(aes(color=Groups, fill=Groups, size=Groups), alpha=1, shape=16) +
    scale_size_manual(values=c(5.75,4.75,2.5)) +
    geom_line(aes(group=participant_id, color=Groups), size=1.75) +
    scale_x_continuous(expand=expansion(mult=c(0.08, 0.08)),
                       breaks=pretty_breaks(n=5), 
                       labels=scales::comma_format(big.mark=",",
                                              decimal.mark=".",
                                              accuracy=1L)) + 
    scale_y_continuous(expand=expansion(mult=c(0.10, 0.10)),
                       breaks=pretty_breaks(n=4), 
                       labels=scales::comma_format(big.mark=",",
                                              decimal.mark=".",
                                              accuracy=1L)) +
    scale_fill_manual(values=alpha(c("#466f91", "#AA4D0D", 
                                     "#FFF04D", "#000000"), 1)) +
    scale_color_manual(values=alpha(c("#466f91", "#AA4D0D", 
                                      "#FFF04D", "#000000"), 1)) +
    plot_theme_transparent_scatters +
    theme(panel.background=element_rect(fill="black", color="black"), 
          plot.background=element_rect(fill="black", color="black")) +
    theme(axis.text.x=element_text(size=45), 
          axis.text.y=element_text(size=45), 
          axis.title.x=element_blank(), 
          axis.title.y=element_blank(), 
          axis.ticks.x=element_line(size=1.5, color="white"),
          axis.ticks.y=element_line(size=1.5, color="white"), 
          axis.ticks.length.y=unit(.25, "cm"), 
          axis.ticks.length.x=unit(.25, "cm"),
          strip.text=element_text(size=45, color="white")) +
    theme(aspect.ratio=7/9) +
    guides(fill=FALSE, color=FALSE, size=FALSE) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free") +
    theme(panel.spacing=unit(1.5, "cm"))
  
  plotlist[[Region]]=bmi.age.scatters
  }

bmi.age.scatters.nuclei <- ggarrange(plotlist=plotlist[1:10], ncol=2, nrow=5) %>%
  annotate_figure(left=text_grob(expression(paste("Volumes (raw) in mm"^"3")), 
                                 vjust=0.5, size=75, rot=90, color="white"),
                  bottom=text_grob("Age in years", vjust=0.1, size=75, color="white"))

#ggsave(bmi.age.scatters.nuclei, filename="figures/bmi.age.scatterplots.png", width=45, height=48, dpi=300)
```

### B

B.1: Visualize percentages (3 plots: acAN-TP1 vs. acAN-TP2, acAN-TP2 vs.
HC, recAN vs. HC)\
B.2: Visualize unstandardized betas for deltaBMI-SDS-related changes in
amygdala nuclei volumes (1 plot)\
B.3: Visualize deltaBMI-SDS-related changes relative to whole amygdala
volume (1 plot)\
B.4: Visualize deltaBMI-SDS-related changes relative to subcortical GM
volume (1 plot)\
=\> 3 columns, 2 rows

```{r figuresscatterelative, fig.cap="Scatterplots - Ratios", message=FALSE, warning=FALSE}
hemi_region_mean <- lmedata %>%
  filter(point_of_research=="T1") %>%
  group_by(labeller.amy) %>%
  dplyr::summarize(hemi_region_mean=mean(measure, na.rm=TRUE))

bmisds.speed.perunit <- lme %>%
  dplyr::select(labeller.amy, lme.tidy) %>%
  unnest(lme.tidy) %>%
  filter(str_detect(term, "delta.bmisds")) %>%
  dplyr::select(labeller.amy, estimate) %>%
  mutate(perc=estimate) %>%
  dplyr::select(labeller.amy, perc) %>%
  mutate(plot="D. ∆BMI-SDS-related volumetric change in AcAN per SDS-unit (absolute)") %>%
  mutate(ytitle="∆mm\u00B3/SDS-unit")

rel.plotdata <- rbind(perc.T1.T2, perc.T2.HC, perc.recAN.HC,
                      bmisds.speed.perunit, ratio.whole, ratio.subcort) %>%
  ungroup()

plotlist = list()

for (Plot in unique(rel.plotdata$plot)) {
  
  rel.scatterdata <- rel.plotdata %>%
    mutate(labeller.amy=dplyr::recode(labeller.amy,
                                      "Whole amygdala lh"="Whole lh",
                                      "Whole amygdala rh"="Whole rh",
                                      "Basal nucleus lh"="Ba lh",
                                      "Basal nucleus rh"="Ba rh",
                                      "Lateral nucleus lh"="La lh",
                                      "Lateral nucleus rh"="La rh",
                                      "Accessory basal nucleus lh"="AB lh",
                                      "Accessory basal nucleus rh"="AB rh",
                                      "Cortical nucleus lh"="Co lh",
                                      "Cortical nucleus rh"="Co rh",
                                      "Cortico- amygdaloid transition lh"="CAT lh",
                                      "Cortico- amygdaloid transition rh"="CAT rh",
                                      "Medial nucleus lh"="Me lh",
                                      "Medial nucleus rh"="Me rh",
                                      "Central nucleus lh"="Ce lh",
                                      "Central nucleus rh"="Ce rh",
                                      "Anterior amygdaloid area lh"="AAA lh",
                                      "Anterior amygdaloid area rh"="AAA rh",
                                      "Paralaminar nucleus lh"="Para lh",
                                      "Paralaminar nucleus rh"="Para rh")) %>%
    mutate(labeller.amy=factor(labeller.amy, levels=c("Whole lh", "Whole rh", "Ba lh", "Ba rh", "La lh", "La rh", 
                                                      "AB lh", "AB rh", "Co lh", "Co rh", "CAT lh", "CAT rh", "Me lh", "Me rh",
                                                      "Ce lh", "Ce rh", "AAA lh", "AAA rh", "Para lh", "Para rh"))) %>%
    filter(plot %in% Plot)

  rel.scatters <- rel.scatterdata %>% 
    ggplot(aes(x=labeller.amy, y=perc)) +
    geom_vline(aes(xintercept=labeller.amy), color="gray60", linetype=3, size=2.5, alpha=0.75) +
    geom_point(color="white", alpha=1, size=11, shape=16) +
    scale_y_continuous(expand=expansion(mult=c(0.15, 0.15)),
                       breaks=pretty_breaks(n=5), 
                       labels=scales::comma_format(big.mark=",",
                                              decimal.mark=".",
                                              accuracy=0.01)) +
    scale_x_discrete(expand=expansion(mult=c(0.05, 0.05))) +
    plot_theme_transparent_scatters +
    theme(panel.background=element_rect(fill="black", color="black"), 
          plot.background=element_rect(fill="black", color="black")) +
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5, size=30),
          axis.text.y=element_text(size=30),
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=35, vjust=1.5), 
          axis.ticks.x=element_line(size=1.5, color="white"),
          axis.ticks.y=element_line(size=1.5, color="white"), 
          axis.ticks.length.y=unit(.25, "cm"), 
          axis.ticks.length.x=unit(.25, "cm"),
          plot.title=element_textbox_simple(size=27, hjust=0, vjust=20000,
                                            padding=unit(c(0.5,0.5,0.5,0.5), "cm"),
                                            color="white")) +
    theme(aspect.ratio=5/9) +
    ggtitle(Plot) +
    ylab(rel.scatterdata$ytitle)
    guides(fill=FALSE, color=FALSE, size=FALSE) +
    theme(plot.margin=unit(c(2,1,1,1), "cm"))
  
   plotlist[[Plot]]=rel.scatters
}

rel.scatters <- ggarrange(plotlist=plotlist[1:6], ncol=3, nrow=2) %>%
  annotate_figure(bottom=text_grob("Amygdala (sub-)regions", vjust=0.25, size=60, color="white"))

#ggsave(rel.scatters, filename="figures/rel.scatterplots.png", width=49.5, height=24, dpi=600)
```

# GLMs with clinical measures in acAN-TP2 (nuclei still significantly differing from HC)

```{r clinicalglmsT2, results="asis", message=FALSE, warning=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

redcap_labs <- read_csv("data/redcap_new.csv") %>%  
  dplyr::select(participant_id, point_of_research, date_of_research, 
                contains("ghrelin"),
                research_blood_results_ft4,
                research_blood_results_ft3,
                research_blood_results_thyreoideastimul,
                contains("bdnf"),
                research_blood_results_crp,
                research_blood_results_tnfalpha,
                research_blood_results_il6,
                research_blood_results_nfl,
                research_blood_results_tau,
                research_blood_results_gfap, 
                research_blood_results_uchl1,
                research_blood_results_b12) %>%
  mutate(ghrelin = (research_blood_results_ghrelin_deacyl + research_blood_results_ghrelin_deacyl_2)/2) %>%
  mutate(bdnf = (research_blood_results_bdnf + research_blood_results_bdnf_2)/2) %>%
  mutate(ft3=research_blood_results_ft3, ft4=research_blood_results_ft4, tsh=research_blood_results_thyreoideastimul,
         crp=research_blood_results_crp, b12=research_blood_results_b12,
         tnfa=research_blood_results_tnfalpha, il6=research_blood_results_il6, nfl=research_blood_results_nfl,
         tau=research_blood_results_tau, gfap=research_blood_results_gfap, uchl1=research_blood_results_uchl1) %>%
  mutate(il6=ifelse(il6==0, 0.03/sqrt(2), il6)) %>%
  mutate(crp=ifelse(crp==0, 0.3/sqrt(2), crp)) %>%
  mutate(log_ghrelin=log10(ghrelin), log_bdnf=log10(bdnf), log_crp=log10(crp), log_tnfa=log10(tnfa), 
         log_il6=log10(il6), log_nfl=log10(nfl), log_tau=log10(tau), log_b12=log10(b12),
         log_gfap=log10(gfap), log_uchl1=log10(uchl1), log_ft3=log10(ft3)) %>%
  mutate(ft3_ft4_ratio=ft3/ft4) %>%  
  dplyr::select(participant_id, point_of_research, date_of_research, 
                ghrelin, log_ghrelin,
                bdnf, log_bdnf,
                crp, log_crp, tnfa, log_tnfa, il6, log_il6, b12, log_b12,
                nfl, log_nfl, tau, log_tau, gfap, log_gfap, uchl1, log_uchl1,
                ft3, log_ft3, ft4, ft3_ft4_ratio, tsh)

join_labs <- lmedata %>% 
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, point_of_research, date_of_research) %>%
  left_join(redcap_labs, by=c("participant_id", "point_of_research")) %>%
  mutate(date.diff=abs(date_of_research.x-date_of_research.y)) %>%
  filter(date.diff<10) %>%
  group_by(participant_id, point_of_research) %>%
  fill(c(ghrelin:tsh), .direction="updown") %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(participant_id, point_of_research, 
                ghrelin, log_ghrelin,
                bdnf, log_bdnf,
                crp, log_crp, tnfa, log_tnfa, il6, log_il6, b12, log_b12,
                nfl, log_nfl, tau, log_tau, gfap, log_gfap, uchl1, log_uchl1,
                ft3, log_ft3, ft4, ft3_ft4_ratio, tsh)


contrasts %>%
  filter((contrast=="AcAN-TP2vsHC")&(p.fdr<0.05)) %>%
  distinct(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  left_join(join_labs, by=c("participant_id", "point_of_research")) %>%
  filter(point_of_research=="T2") %>%
  mutate(log_leptin=log10(leptin_result)) %>%
  dplyr::select(storage_name, hemi_region, labeller.amy, age_at_date_of_research, bmisds_at_date_of_research,
                e_tiv, measure, log_leptin, edi_core, resultquest_bdi2_total, stait, resultquest_scl90r_skagloba
                #, log_ft3, ft3_ft4_ratio, log_il6, log_tnfa,
                ) %>%
  pivot_longer(-c(storage_name, hemi_region, labeller.amy, age_at_date_of_research, e_tiv, measure), 
               names_to="demo_variable", values_to="value") %>%
  nest(data_pre=-c(hemi_region, labeller.amy, demo_variable)) %>%
  mutate(
    data=map(data_pre, ~drop_na(.x)),
    n=map_chr(data, ~nrow(.x)),
    data=map(data, ~mutate(.x, 
                              value.c=value - mean(value, na.rm=TRUE), # mean centering
                              age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                              etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    glm=map(data, ~lm(measure ~ value.c +
                        poly(age.c, degree=2, raw=FALSE) +
                        etiv.c,
                      data=.x, na.action=na.omit)),
    dferror=map_dbl(glm, df.residual),
    glm.tidy=map(glm, tidy)) %>%
  unnest(glm.tidy) %>%
  filter(str_detect(term, "value")) %>%
  nest(effdata=c(statistic, dferror)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$dferror, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  mutate(beta=formatC(estimate, format="f", digits=2)) %>%
  mutate(se=formatC(std.error, format="f", digits=2)) %>%
  mutate(t=formatC(statistic, format="f", digits=2)) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # FDR adjustment across all tests
  mutate(q=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(demo_variable, hemi_region) %>%
  dplyr::select(labeller.amy, demo_variable, n, beta, se, t, p, q, d) %>%
  pivot_longer(-c(labeller.amy, demo_variable), 
               names_to="Model statistics", values_to="value") %>%
  dplyr::rename(Subregion=labeller.amy)  %>%
  mutate(demo_variable=dplyr::recode(demo_variable,
                                     "log_leptin"="Log10-leptin",
                                     #"log_ft3"="Log10-FT3",
                                     #"ft3_ft4_ratio"="FT3/FT4 ratio",
                                     "edi_core"="EDI-2 core symptoms",
                                     "resultquest_bdi2_total"="BDI-II total",
                                     "stait"="Trait anxiety",
                                     "resultquest_scl90r_skagloba"="SCL-90-R GSI")) %>%
  pivot_wider(names_from="demo_variable", values_from="value") %>%
  knitr::kable(format="html", align="l",
               caption="GLMs in acAN at TP2 including clinical measures (amygdala nuclei volume ~ clinical measure + age + age^2 + eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

# GLMs with clinical measures in recAN (nuclei still nominally differing from HC before FDR-adjustment)

```{r clinicalglmsrecAN, results="asis", message=FALSE, warning=FALSE}
contrasts %>%
  filter((contrast=="RecANvsHC")&(p.value<0.05)) %>%
  distinct(hemi_region) %>%
  left_join(lmedata, by="hemi_region") %>%
  left_join(join_labs, by=c("participant_id", "point_of_research")) %>%
  filter(point_of_research=="recAN") %>%
  mutate(log_leptin=log10(leptin_result)) %>%
  dplyr::select(storage_name, hemi_region, labeller.amy, age_at_date_of_research, e_tiv,
                measure, bmisds_at_date_of_research, log_leptin, dor,
                edi_core, resultquest_bdi2_total, stait, resultquest_scl90r_skagloba
                #, log_ft3 
                ) %>%
  pivot_longer(-c(storage_name, hemi_region, labeller.amy, age_at_date_of_research, e_tiv, measure), 
               names_to="demo_variable", values_to="value") %>%
  nest(data_pre=-c(hemi_region, labeller.amy, demo_variable)) %>%
  mutate(
    data=map(data_pre, ~drop_na(.x)),
    n=map_chr(data, ~nrow(.x)),
    data=map(data, ~mutate(.x, 
                              value.c=value - mean(value, na.rm=TRUE), # mean centering
                              age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                              etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    glm=map(data, ~lm(measure ~ value.c + 
                         poly(age.c, degree=2, raw=FALSE) +
                         etiv.c,
                       data=.x, na.action=na.omit)),
    dferror=map_dbl(glm, df.residual),
    glm.tidy=map(glm, tidy)) %>%
  unnest(glm.tidy) %>%
  filter(str_detect(term, "value")) %>%
  nest(effdata=c(statistic, dferror)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$dferror, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  mutate(beta=formatC(estimate, format="f", digits=2)) %>%
  mutate(se=formatC(std.error, format="f", digits=2)) %>%
  mutate(t=formatC(statistic, format="f", digits=2)) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # FDR adjustment across all tests
  mutate(q=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(demo_variable, hemi_region) %>%
  #filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, demo_variable, n, beta, se, t, p, q, d) %>%
  pivot_longer(-c(labeller.amy, demo_variable), 
               names_to="Model statistics", values_to="value") %>%
  dplyr::rename(Subregion=labeller.amy) %>%
  mutate(demo_variable=dplyr::recode(demo_variable,
                                     "bmisds_at_date_of_research"="BMI-SDS",
                                     "log_leptin"="Log10-leptin",
                                     #"log_ft3"="Log10-FT3",
                                     "dor"="Duration of recovery",
                                     "edi_core"="EDI-2 core symptoms",
                                     "resultquest_bdi2_total"="BDI-II total",
                                     "stait"="Trait anxiety",
                                     "resultquest_scl90r_skagloba"="SCL-90-R GSI")) %>%
  pivot_wider(names_from="demo_variable", values_from="value") %>%
  knitr::kable(format="html", align="l",
               caption="GLMs in recAN including clinical measures (amygdala nuclei volume ~ clinical measure + age + age^2 + eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r clinicalglmsHC, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Exploratory: GLMs with clinical measures in HC
lmedata %>%
  filter(point_of_research=="HCW") %>%
  mutate(log_leptin=log10(leptin_result)) %>%
  dplyr::select(storage_name, hemi_region, labeller.amy, age_at_date_of_research, e_tiv,
                measure, bmisds_at_date_of_research, log_leptin,
                edi_core, resultquest_bdi2_total, stai_t, resultquest_scl90r_skagloba) %>%
  pivot_longer(-c(storage_name, hemi_region, labeller.amy, age_at_date_of_research, e_tiv, measure), 
               names_to="demo_variable", values_to="value") %>%
  nest(data_pre=-c(hemi_region, labeller.amy, demo_variable)) %>%
  mutate(
    data=map(data_pre, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                              value.c=value - mean(value, na.rm=TRUE), # mean centering
                              age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                              etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    glm=map(data, ~lm(measure ~ value.c + 
                         poly(age.c, degree=2, raw=FALSE) +
                         etiv.c,
                       data=.x, na.action=na.omit)),
    glm.tidy=map(glm, tidy)) %>%
  unnest(glm.tidy) %>%
  filter(str_detect(term, "value")) %>%
  mutate(beta=formatC(estimate, format="f", digits=2)) %>%
  mutate(se=formatC(std.error, format="f", digits=2)) %>%
  mutate(t=formatC(statistic, format="f", digits=2)) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>% # FDR adjustment across all tests
  mutate(q=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region) %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy, demo_variable, beta, se, t, p, q) %>%
  pivot_longer(-c(labeller.amy, demo_variable), 
               names_to="Model statistics", values_to="value") %>%
  dplyr::rename(Subregion=labeller.amy)  %>%
  mutate(demo_variable=dplyr::recode(demo_variable,
                                     "bmisds_at_date_of_research"="BMI-SDS",
                                     "log_leptin"="Log10-leptin",
                                     "edi_core"="EDI-2 core symptoms",
                                     "resultquest_bdi2_total"="BDI-II total",
                                     "stai_s"="State anxiety",
                                     "stai_t"="Trait anxiety",
                                     "resultquest_scl90r_skagloba"="SCL-90-R GSI")) %>%
  pivot_wider(names_from="demo_variable", values_from="value") %>%
  knitr::kable(format="html", align="l",
               caption="Exploratory GLMs in HC including clinical measures (amygdala nuclei volume ~ clinical measure + age + age^2 + eTIV)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10") %>%
  add_header_above(c("Significant associations are filtered. Findings in HC for EDI-2 core symptoms might be of interest but did not survive FDR-adjustment."=8))
```

# Paired-samples t-tests acAN-TP2 vs. acAN-TP1

```{r acANpairedttest, results="asis", message=FALSE, warning=FALSE}
t.tests.T2.T1 <- sample %>%
  filter(por=="acAN") %>%
  mutate(point_of_research=factor(point_of_research, levels=c("T1", "T2"))) %>%
  dplyr::select(hemi_region, region, labeller.amy, whole.sub, participant_id, 
                point_of_research, measure) %>%
  mutate(point_of_research=relevel(point_of_research, ref="T2")) %>%
  nest(-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    ttest=map(data, ~t.test(measure ~point_of_research, data=.x, paired=TRUE, alternative="two.sided",
                               var.equal=FALSE)), # paired t-tests: df=n-1
    ttesttidy=map(ttest, tidy),
    cohensD=map(data, ~lsr::cohensD(measure ~point_of_research, method="paired", data=.x))) %>%
  unnest(ttesttidy, cohensD) %>%
  mutate(cohensD=abs(cohensD)) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(d_formatted=ifelse(cohensD<0.01, "<0.01", formatC(cohensD, format="f", digits=2))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

t.tests.T2.T1 %>%
  filter(p.value<0.05) %>% 
  dplyr::select(labeller.amy, statistic, p_formatted, p.fdr_formatted, adj.signif,
                d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "t", "p", 
                                                           "FDR-q", "Adj. signif.", "Cohen's d"), 
               caption="AcAN-TP2 vs. acAN-TP1 (main sample): paired-samples t-tests") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

means.t.tests.T2.T1 <- sample %>%
  filter(por=="acAN") %>%
  group_by(hemi_region, point_of_research) %>%
  mutate(mean=mean(measure, na.rm=TRUE)) %>%
  mutate(std.error=std.error(measure, na.rm=TRUE)) %>%
  distinct(hemi_region, .keep_all=TRUE) %>%
  ungroup() %>%
  dplyr::select(hemi_region, region, labeller.amy, point_of_research, mean, std.error)
```

## Barplot visualization acAN-TP2 vs. acAN-TP1

```{r barplotsT2vsT1, fig.cap="SM Paired samples t-tests acAN-TP2 vs. acAN-TP1", message=FALSE, warning=FALSE}
sm.bardata.ttest <- means.t.tests.T2.T1 %>%
  mutate(emmeans=case_when(
    point_of_research=="T1" ~ "AcAN-TP1",
    point_of_research=="T2" ~ "AcAN-TP2")) %>%
  mutate(estimate=mean) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 20, 18)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 16, 14)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 40)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(sm.bardata.ttest$region)) {
  
  plotdata <- sm.bardata.ttest %>% filter(region %in% Region)
  
  y.position <- sm.bardata.ttest %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.85*estimate) %>%
    mutate(ymax=1.1*estimate) %>%
    mutate(sig.pos_T2.T1=(0.12*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.08) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.T1, tipl, 
                  sigsize, effsize, stripsize, ysize)

   longi.line <- sm.bardata.ttest %>% 
    filter(region %in% Region) %>%
    filter(emmeans %in% c("AcAN-TP1", "AcAN-TP2")) %>%
    mutate(y=dplyr::recode(emmeans,
                                   "AcAN-TP1"="y",
                                   "AcAN-TP2"="yend")) %>% 
    dplyr::select(labeller.amy, y, estimate) %>%
    pivot_wider(names_from=y, values_from=estimate) %>%
    mutate(x=1) %>%
    mutate(xend=2)

  sig_T2.T1 <- t.tests.T2.T1 %>%
    filter(region %in% Region) %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2) %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=(0.96*(ymax-ymin)) + ymin) %>%
    mutate(x.eff=1)

  regioncolor <- color %>% 
      filter(region %in% Region)
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=1.25,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("crosshatch", "stripe")) +
    scale_pattern_density_manual(values=c(0.06,0.06)) +
    scale_pattern_size_manual(values=c(1.5,1.5)) +
    scale_pattern_spacing_manual(values=c(0.1,0.1)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=5, color="BLACK", position=position_dodge(1)) +

    geom_segment(data=longi.line, aes(x=x, xend=xend, y=y, yend=yend), color="BLACK", size=5, 
                 linetype="solid") +

    geom_signif(data=sig_T2.T1, aes(annotations=adj.signif, y_position=sig.pos_T2.T1, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.5, vjust=0, color="BLACK", manual=TRUE) +
    geom_text(data=sig_T2.T1, aes(label=d, x=x.eff, y=y.eff),
              size=y.position$effsize, hjust=0, vjust=0, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1, size=40),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP1", "AcAN-TP2")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.sm1.T2.T1 <- plotlist$Whole_amygdala
bp.nuclei.sm2.T2.T1 <- plotlist$Basal_nucleus
bp.nuclei.sm3.T2.T1 <- plotlist$Lateral_nucleus
bp.nuclei.sm4.T2.T1 <- plotlist$Accessory_basal_nucleus
bp.nuclei.sm5.T2.T1 <- plotlist$Cortical_nucleus
bp.nuclei.sm6.T2.T1 <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.sm7.T2.T1 <- plotlist$Medial_nucleus
bp.nuclei.sm8.T2.T1 <- plotlist$Central_nucleus
bp.nuclei.sm9.T2.T1 <- plotlist$Anterior_amygdaloid_area
bp.nuclei.sm10.T2.T1 <- plotlist$Paralaminar_nucleus

barplotarrange.whole.sm.T2.T1 <- ggarrange(bp.whole.sm1.T2.T1) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (raw, Mean ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.sm.T2.T1, path="figures", filename="T2.T1.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.sm.T2.T1 <- ggarrange(bp.nuclei.sm2.T2.T1,
                                 bp.nuclei.sm3.T2.T1,
                                 bp.nuclei.sm4.T2.T1, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.sm.T2.T1, path="figures", filename="T2.T1.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.sm.T2.T1 <- ggarrange(bp.nuclei.sm5.T2.T1,
                                 bp.nuclei.sm6.T2.T1,
                                 bp.nuclei.sm7.T2.T1, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.sm.T2.T1, path="figures", filename="T2.T1.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.sm.T2.T1 <- ggarrange(bp.nuclei.sm8.T2.T1,
                                 bp.nuclei.sm9.T2.T1,
                                 bp.nuclei.sm10.T2.T1, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.sm.T2.T1, path="figures", filename="T2.T1.row3.png", 
       #width=32, height=10, dpi=600)
```

# GLM with age-matched samples: AcAN-TP2 vs. HC

```{r agematchT2HC, message=FALSE, warning=FALSE}
prematch.sample.T2.HC <- sample %>%
  filter(point_of_research %in% c("T2", "HCW")) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, point_of_research, age_at_date_of_research) %>%
  mutate(point_of_research=as.numeric(dplyr::recode(point_of_research,
                                    "HCW"=0, # 0 for the control group
                                    "T2"=1))) %>%
  matchit(point_of_research ~age_at_date_of_research, data=., 
          method="nearest",
          ratio=1) 

summary(prematch.sample.T2.HC, standardize=FALSE)

match.sample.T2.HC <- match.data(prematch.sample.T2.HC)

age.m.sample.T2.HC <- sample %>%
  semi_join(match.sample.T2.HC, by="storage_name") 
```

```{r glmT2HC, results="asis", message=FALSE, warning=FALSE}
glm.T2.HC.longi <- age.m.sample.T2.HC %>% # age-matched sample
  filter_at(vars(measure, point_of_research, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  mutate(point_of_research=relevel(point_of_research, ref="HCW")) %>%
  nest(data=-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lm=map(data, ~lm(measure ~point_of_research + 
                          poly(age.c, degree=2, raw=FALSE) +
                          etiv.c,
                        data=.x, na.action=na.omit)),
    lm.tidy=map(lm, tidy),
    dferror=map_dbl(lm, df.residual),
    emmeans=map(lm, ~emmeans::emmeans(.x, "point_of_research", type="response")),
    emmeans.tidy=map(emmeans, tidy)) %>%
  unnest(lm.tidy) %>%
  dplyr::select(-c(lm, emmeans)) %>%
  filter(str_detect(term, "point_of_research")) %>%
  nest(effdata=c(statistic, dferror)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$dferror, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(cohensD=abs(d)) %>%
  mutate(d_formatted=ifelse(cohensD<0.01, "<0.01", 
                            formatC(cohensD, format="f", digits=2))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  arrange(hemi_region)

glm.T2.HC.longi %>% 
  filter(p.value<0.05) %>% 
  dplyr::select(labeller.amy, statistic, p_formatted, signif, p.fdr_formatted, adj.signif,
                d_formatted) %>% 
  knitr::kable(format="html", digits=2, 
               col.names=c("Amygdala (sub-)region", "t", "p", "Signif.", "FDR-q", 
                           "Adj. signif.", "Cohen's d"),
               align="l", 
               caption="Age-matched acAN-TP2 vs. HC (main sample): age- and eTIV-adjusted GLM") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

emmeans.glm.T2.HC.longi <- glm.T2.HC.longi %>%
  dplyr::select(hemi_region, region, labeller.amy, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>% 
  dplyr::select(hemi_region, region, labeller.amy, point_of_research, estimate, std.error)
```

## Barplot visualization acAN-TP2 vs. HC

```{r barplotsT2vsHC, fig.cap="SM GLMs age-matched acAN-TP2 vs. HC", message=FALSE, warning=FALSE}
sm.bardata.T2.HC <- emmeans.glm.T2.HC.longi %>%
  mutate(emmeans=case_when(
    point_of_research=="T2" ~ "AcAN-TP2",
    point_of_research=="HCW" ~ "HC")) %>%
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP2", "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 20, 18)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 16, 14)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 40)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(sm.bardata.T2.HC$region)) {
  
  plotdata <- sm.bardata.T2.HC %>% filter(region %in% Region)
  
  y.position <- sm.bardata.T2.HC %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.85*estimate) %>%
    mutate(ymax=1.1*estimate) %>%
    mutate(sig.pos_T2.HC=(0.12*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.08) %>%
    dplyr::select(region, ymin, ymax, sig.pos_T2.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

  sig_T2.HC <- glm.T2.HC.longi %>%
    filter(region %in% Region) %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2) %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=(0.96*(ymax-ymin)) + ymin) %>%
    mutate(x.eff=1)

  regioncolor <- color %>% 
      filter(region %in% Region)
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=1.25,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("stripe", "none")) +
    scale_pattern_density_manual(values=c(0.08,0)) +
    scale_pattern_size_manual(values=c(1.8,0)) +
    scale_pattern_spacing_manual(values=c(0.1,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=5, color="BLACK", position=position_dodge(1)) +
    
    geom_signif(data=sig_T2.HC, aes(annotations=adj.signif, y_position=sig.pos_T2.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.5, vjust=0, color="BLACK", manual=TRUE) +
    geom_text(data=sig_T2.HC, aes(label=d, x=x.eff, y=y.eff),
              size=y.position$effsize, hjust=0, vjust=0, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1, size=40),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("AcAN-TP2", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.sm1.T2.HC <- plotlist$Whole_amygdala
bp.nuclei.sm2.T2.HC <- plotlist$Basal_nucleus
bp.nuclei.sm3.T2.HC <- plotlist$Lateral_nucleus
bp.nuclei.sm4.T2.HC <- plotlist$Accessory_basal_nucleus
bp.nuclei.sm5.T2.HC <- plotlist$Cortical_nucleus
bp.nuclei.sm6.T2.HC <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.sm7.T2.HC <- plotlist$Medial_nucleus
bp.nuclei.sm8.T2.HC <- plotlist$Central_nucleus
bp.nuclei.sm9.T2.HC <- plotlist$Anterior_amygdaloid_area
bp.nuclei.sm10.T2.HC <- plotlist$Paralaminar_nucleus

barplotarrange.whole.sm.T2.HC <- ggarrange(bp.whole.sm1.T2.HC) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.sm.T2.HC, path="figures", filename="T2.HC.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.sm.T2.HC <- ggarrange(bp.nuclei.sm2.T2.HC,
                                 bp.nuclei.sm3.T2.HC,
                                 bp.nuclei.sm4.T2.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.sm.T2.HC, path="figures", filename="T2.HC.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.sm.T2.HC <- ggarrange(bp.nuclei.sm5.T2.HC,
                                 bp.nuclei.sm6.T2.HC,
                                 bp.nuclei.sm7.T2.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.sm.T2.HC, path="figures", filename="T2.HC.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.sm.T2.HC <- ggarrange(bp.nuclei.sm8.T2.HC,
                                 bp.nuclei.sm9.T2.HC,
                                 bp.nuclei.sm10.T2.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.sm.T2.HC, path="figures", filename="T2.HC.row3.png", 
       #width=32, height=10, dpi=600)
```

# GLM with age-matched samples: RecAN vs. HC

```{r agematchrecANHC, message=FALSE, warning=FALSE}
prematch.sample.recAN.HC <- sample %>%
  filter(point_of_research %in% c("recAN", "HCW")) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, point_of_research, age_at_date_of_research) %>%
  mutate(point_of_research=as.numeric(dplyr::recode(point_of_research,
                                    "HCW"=0, # 0 for the control group
                                    "recAN"=1))) %>%
  matchit(point_of_research ~age_at_date_of_research, data=.,
          method="nearest",
          ratio=1) 

summary(prematch.sample.recAN.HC, standardize=FALSE)

match.sample.recAN.HC <- match.data(prematch.sample.recAN.HC)

age.m.sample.recAN.HC <- sample %>%
  semi_join(match.sample.recAN.HC, by="storage_name")
```

```{r glmrecANHC, results="asis", message=FALSE, warning=FALSE}
glm.recAN.HC.longi <- age.m.sample.recAN.HC %>% # age-matched sample
  filter_at(vars(measure, point_of_research, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  mutate(point_of_research=relevel(point_of_research, ref="HCW")) %>%
  nest(data=-c(hemi_region, region, labeller.amy, whole.sub)) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lm=map(data, ~lm(measure ~point_of_research + 
                          poly(age.c, degree=2, raw=FALSE) +
                          etiv.c,
                        data=.x, na.action=na.omit)),
    lm.tidy=map(lm, tidy),
    dferror=map_dbl(lm, df.residual),
    emmeans=map(lm, ~emmeans::emmeans(.x, "point_of_research", type="response")),
    emmeans.tidy=map(emmeans, tidy)) %>%
  unnest(lm.tidy) %>%
  dplyr::select(-c(lm, emmeans)) %>%
  filter(str_detect(term, "point_of_research")) %>%
  nest(effdata=c(statistic, dferror)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$dferror, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(cohensD=abs(d)) %>%
  mutate(d_formatted=ifelse(cohensD<0.01, "<0.01", 
                            formatC(cohensD, format="f", digits=2))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(cohensD = abs((2*statistic)/sqrt(dferror))) %>% # calculate effect size
  mutate(d_formatted=ifelse(cohensD<0.01, "<0.01", formatC(cohensD, format="f", digits=2))) %>%
  arrange(hemi_region)

glm.recAN.HC.longi %>% 
  filter(p.value<0.05) %>% 
  dplyr::select(labeller.amy, statistic, p_formatted, signif, p.fdr_formatted, adj.signif,
                d_formatted) %>% 
  knitr::kable(format="html", digits=2, 
               col.names=c("Amygdala (sub-)region", "t", "p", "Signif.", "FDR-q", 
                           "Adj. signif.", "Cohen's d"),
               align="l", 
               caption="Age-matched recAN vs. HC (main sample): age- and eTIV-adjusted GLM") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

emmeans.glm.recAN.HC.longi <- glm.recAN.HC.longi %>%
  dplyr::select(hemi_region, region, labeller.amy, emmeans.tidy) %>%
  unnest(emmeans.tidy) %>% 
  dplyr::select(hemi_region, region, labeller.amy, point_of_research, estimate, std.error)
```

## Barplot visualization recAN vs. HC

```{r barplotsrecANvsHC, fig.cap="SM GLMs age-matched recAN vs. HC", message=FALSE, warning=FALSE}
sm.bardata.recAN.HC <- emmeans.glm.recAN.HC.longi %>%
  mutate(emmeans=case_when(
    point_of_research=="recAN" ~ "RecAN",
    point_of_research=="HCW" ~ "HC")) %>%
  mutate(emmeans=factor(emmeans, levels=c("RecAN", "HC"))) %>%
  arrange(region) %>%
  mutate(sigsize=ifelse(region=="Whole_amygdala", 20, 18)) %>%
  mutate(effsize=ifelse(region=="Whole_amygdala", 16, 14)) %>%
  mutate(stripsize=ifelse(region=="Whole_amygdala", 35, 35)) %>%
  mutate(ysize=ifelse(region=="Whole_amygdala", 45, 40)) %>%
  mutate(xlabels=ifelse(region=="Whole_amygdala", TRUE, FALSE))

plotlist=list()

for (Region in unique(sm.bardata.recAN.HC$region)) {
  
  plotdata <- sm.bardata.recAN.HC %>% filter(region %in% Region)
  
  y.position <- sm.bardata.recAN.HC %>% 
    filter(region %in% Region) %>%
    arrange(desc(estimate), .by_group=TRUE) %>%
    slice_head(n=1) %>%
    mutate(ymin=0.8*estimate) %>%
    mutate(ymax=1.15*estimate) %>%
    mutate(sig.pos_recAN.HC=(0.12*(ymax-ymin)) + (estimate+std.error)) %>%
    mutate(tipl=0.08) %>%
    dplyr::select(region, ymin, ymax, sig.pos_recAN.HC, tipl, 
                  sigsize, effsize, stripsize, ysize)

  sig_recAN.HC <- glm.recAN.HC.longi %>%
    filter(region %in% Region) %>%
    left_join(y.position, by="region") %>%
    mutate(xmin=1) %>%
    mutate(xmax=2) %>%
    mutate(label=ifelse(cohensD<0.01, "d", "d=")) %>%
    unite("d", c(label, d_formatted), sep="", remove=TRUE, na.rm=FALSE) %>%
    mutate(y.eff=(0.96*(ymax-ymin)) + ymin) %>%
    mutate(x.eff=1)

  regioncolor <- color %>% 
      filter(region %in% Region)
    
  barplots <- plotdata %>%
    ggplot(aes(x=emmeans, y=estimate)) +
    geom_col_pattern(aes(fill=emmeans, color=emmeans, pattern=emmeans,
                         pattern_density=emmeans,
                         pattern_size=emmeans, pattern_spacing=emmeans),
                     stat="identity", color="BLACK", 
                     size=1.25,
                     position=position_dodge(1),
                     pattern_color="gray80",
                     pattern_fill = "gray80", pattern_alpha=1) +
    scale_pattern_manual(
    values = c("circle", "none")) +
    scale_pattern_density_manual(values=c(0.3,0)) +
    scale_pattern_size_manual(values=c(1.5,0)) +
    scale_pattern_spacing_manual(values=c(0.1,0)) +
    geom_errorbar(aes(x=emmeans, y=estimate, color=emmeans, fill=emmeans, 
                      ymin=estimate-std.error, ymax=estimate+std.error), width=0.5, 
                  size=5, color="BLACK", position=position_dodge(1)) +
    
    geom_signif(data=sig_recAN.HC, aes(annotations=adj.signif, y_position=sig.pos_recAN.HC, 
                                         xmin=xmin, xmax=xmax, tip_length=tipl), 
                textsize=y.position$sigsize, size=1.5, vjust=0, color="BLACK", manual=TRUE) +
    geom_text(data=sig_recAN.HC, aes(label=d, x=x.eff, y=y.eff),
              size=y.position$effsize, hjust=0, vjust=0, color="BLACK", parse=FALSE) +
    
    coord_cartesian(ylim=c(y.position$ymin, y.position$ymax)) +
    scale_y_continuous(breaks=pretty_breaks(n=4), labels=scales::comma_format(big.mark=",",
                                                                                  decimal.mark=".",
                                                                                  accuracy=1L)) +
    plot_theme_transparent_bars + 
    scale_fill_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    scale_color_manual(values = alpha(c(regioncolor$color, regioncolor$color,
                                       "#000000"), 1.0)) +
    theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
          axis.text.x=element_text(angle=45, hjust=1, size=40),
          axis.text.y=element_text(size=y.position$ysize),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(.35, "cm"),
          axis.ticks.length.y=unit(.35, "cm"),
          strip.text=element_text(size=y.position$stripsize, color="black"),
          strip.text.x=element_text(size=y.position$stripsize, color="black"),
          strip.background=element_rect(fill=alpha(regioncolor$color, 0.5))) +
    theme(legend.position="none") + 
    scale_x_discrete(breaks=c("RecAN", "HC")) +
    theme(plot.margin=unit(c(1,1,1,1), "cm")) +
    facet_wrap(~labeller.amy, scales="free_x", labeller=label_wrap_gen(width=15)) +
    theme(panel.spacing=unit(1, "cm"))
    
  if(plotdata$xlabels==FALSE) {
    barplots=barplots + 
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
  }

 plotlist[[Region]]=barplots
 }

bp.whole.sm1.recAN.HC <- plotlist$Whole_amygdala
bp.nuclei.sm2.recAN.HC <- plotlist$Basal_nucleus
bp.nuclei.sm3.recAN.HC <- plotlist$Lateral_nucleus
bp.nuclei.sm4.recAN.HC <- plotlist$Accessory_basal_nucleus
bp.nuclei.sm5.recAN.HC <- plotlist$Cortical_nucleus
bp.nuclei.sm6.recAN.HC <- plotlist$Corticoamygdaloid_transitio
bp.nuclei.sm7.recAN.HC <- plotlist$Medial_nucleus
bp.nuclei.sm8.recAN.HC <- plotlist$Central_nucleus
bp.nuclei.sm9.recAN.HC <- plotlist$Anterior_amygdaloid_area
bp.nuclei.sm10.recAN.HC <- plotlist$Paralaminar_nucleus

barplotarrange.whole.sm.recAN.HC <- ggarrange(bp.whole.sm1.recAN.HC) %>%
  annotate_figure(left = text_grob(expression(paste("Volumes (EMM ± SEM) in mm"^"3")), 
                                   size=50, rot=90))
#ggsave(barplotarrange.whole.sm.recAN.HC, path="figures", filename="RecAN.HC.whole.png", 
       #width=12, height=30, dpi=600)

barplotarrange.row1.sm.recAN.HC <- ggarrange(bp.nuclei.sm2.recAN.HC,
                                 bp.nuclei.sm3.recAN.HC,
                                 bp.nuclei.sm4.recAN.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row1.sm.recAN.HC, path="figures", filename="RecAN.HC.row1.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row2.sm.recAN.HC <- ggarrange(bp.nuclei.sm5.recAN.HC,
                                 bp.nuclei.sm6.recAN.HC,
                                 bp.nuclei.sm7.recAN.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row2.sm.recAN.HC, path="figures", filename="RecAN.HC.row2.png", 
       #width=32, height=10, dpi=600)

barplotarrange.row3.sm.recAN.HC <- ggarrange(bp.nuclei.sm8.recAN.HC,
                                 bp.nuclei.sm9.recAN.HC,
                                 bp.nuclei.sm10.recAN.HC, ncol=3, nrow=1)
#ggsave(barplotarrange.row3.sm.recAN.HC, path="figures", filename="RecAN.HC.row3.png", 
       #width=32, height=10, dpi=600)
```

```{r aseg, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# Aseg whole amygdala volumes (paired t-tests and age-matched GLMs)
sample %>%
  filter(por=="acAN") %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, point_of_research) %>%
  left_join(fsdata_aseg_long, by="storage_name") %>%
  filter(str_detect(analysis_aseg, "amygdala")) %>%
  mutate(point_of_research=factor(point_of_research, levels=c("T1", "T2"))) %>%
  mutate(point_of_research=relevel(point_of_research, ref="T2")) %>%
  nest(data=-analysis_aseg) %>%
  mutate(
    ttest=map(data, ~t.test(measure ~point_of_research, data=.x, paired=TRUE, alternative="two.sided",
                               var.equal=FALSE)),
    ttesttidy=map(ttest, tidy)) %>%
  unnest(ttesttidy) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(analysis_aseg, statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", col.names=c("Amygdala (sub-)region", "t", "p"), 
               caption="AcAN-TP2 vs. acAN-TP1 (main sample): aseg whole amygdala volumes, paired-samples t-tests") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


age.m.sample.T2.HC %>% 
  dplyr::select(storage_name, point_of_research, age_at_date_of_research, e_tiv) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(fsdata_aseg_long, by="storage_name") %>%
  filter(str_detect(analysis_aseg, "amygdala")) %>%
  filter_at(vars(measure, point_of_research, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  mutate(point_of_research=relevel(point_of_research, ref="HCW")) %>%
  nest(data=-analysis_aseg) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lm=map(data, ~lm(measure ~point_of_research + 
                          poly(age.c, degree=2, raw=FALSE) +
                          etiv.c,
                        data=.x, na.action=na.omit)),
    lm.tidy=map(lm, tidy)) %>%
  unnest(lm.tidy) %>%
  filter(str_detect(term, "point_of_research")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(analysis_aseg, statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, 
               col.names=c("Amygdala (sub-)region", "t", "p"),
               align="l", 
               caption="Age-matched acAN-TP2 vs. HC (main sample): aseg whole amygdala volumes, age- and eTIV-adjusted GLM") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

age.m.sample.recAN.HC %>% 
  dplyr::select(storage_name, point_of_research, age_at_date_of_research, e_tiv) %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  left_join(fsdata_aseg_long, by="storage_name") %>%
  filter(str_detect(analysis_aseg, "amygdala")) %>%
  filter_at(vars(measure, point_of_research, age_at_date_of_research, e_tiv), 
            ~!is.na(.x)) %>% # filter missing values before mean centering
  mutate(point_of_research=relevel(point_of_research, ref="HCW")) %>%
  nest(data=-analysis_aseg) %>%
  mutate(
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lm=map(data, ~lm(measure ~point_of_research + 
                          poly(age.c, degree=2, raw=FALSE) +
                          etiv.c,
                        data=.x, na.action=na.omit)),
    lm.tidy=map(lm, tidy)) %>%
  unnest(lm.tidy) %>%
  filter(str_detect(term, "point_of_research")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(analysis_aseg, statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, 
               col.names=c("Amygdala (sub-)region", "t", "p"),
               align="l", 
               caption="Age-matched recAN vs. HC (main sample): aseg whole amygdala volumes, age- and eTIV-adjusted GLM") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

# Figure legends

```{r figurelegends, message=FALSE, warning=FALSE, eval=FALSE}
# Figure legend raincloud plots
legend.all.raincloud <- rcdata %>%
  dplyr::rename(Groups=point_of_research) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent + 
  scale_fill_manual(values=alpha(c("#1E3F5A", "#466f91", 
                                   "#AA4D0D", "#7b848f", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("#1E3F5A", "#466f91", 
                                    "#AA4D0D", "#7b848f", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12), legend.title=element_text(size=16),
        legend.key=element_rect(color="black", size=1.5))
#ggsave(legend.all.raincloud, path="figures", filename="legend.all.raincloud.png",
       #width=10, height=10, dpi=150)

# Figure legend barplots
legend.all.barplot <- rcdata %>%
  dplyr::rename(Groups=point_of_research) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent + 
  scale_fill_manual(values=alpha(c("gray35", "gray35", 
                                   "gray35", "gray35", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("gray35", "gray35", 
                                   "gray35", "gray35", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12), legend.title=element_text(size=16),
        legend.key=element_rect(color="black", size=1.5))
#ggsave(legend.all.barplot, path="figures", filename="legend.all.barplot.png",
       #width=10, height=10, dpi=150)

legend_T2.T1 <- rcdata %>%
  dplyr::rename(Groups=point_of_research) %>%
  filter(Groups %in% c("AcAN-TP1", "AcAN-TP2")) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent + 
  scale_fill_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12), legend.title=element_text(size=16),
        legend.key=element_rect(color="black", size=1.5))
#ggsave(legend_T2.T1, path="figures", filename="legend_T2.T1.png", 
       #width=10, height=10, dpi=150)

legend_T2.HC <- rcdata %>%
  dplyr::rename(Groups=point_of_research) %>%
  filter(Groups %in% c("AcAN-TP2", "HC")) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent + 
  scale_fill_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12), legend.title=element_text(size=16),
        legend.key=element_rect(color="black", size=1.5))
#ggsave(legend_T2.HC, path="figures", filename="legend_T2.HC.png", 
       #width=10, height=10, dpi=150)

legend_recAN.HC <- rcdata %>%
  dplyr::rename(Groups=point_of_research) %>%
  filter(Groups %in% c("RecAN", "HC")) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent + 
  scale_fill_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("gray35", "gray35", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12), legend.title=element_text(size=16),
        legend.key=element_rect(color="black", size=1.5))
#ggsave(legend_recAN.HC, path="figures", filename="legend_recAN.HC.png", 
       #width=10, height=10, dpi=150)

# SM BMI-SDS/age-related changes scatter plots 
legend.all.scatters <- rcdata %>%
  mutate(por=dplyr::recode(por,
                           "acAN"="AcAN",
                           "recAN"="RecAN",
                           "HCW"="HC")) %>%
  dplyr::rename(Groups=por) %>%
  filter(labeller.amy=="Whole amygdala lh") %>%
  ggplot(aes(x=Groups, y=measure)) +
  geom_col(aes(fill=Groups, color=Groups),
               position=position_dodge(), alpha=1) +
  plot_theme_transparent_scatters +
  theme(panel.background=element_rect(fill="black", color="black"), 
        plot.background=element_rect(fill="black")) +
  scale_fill_manual(values=alpha(c("#466f91", "#AA4D0D", 
                                     "#FFF04D", "#000000"), 1.0)) + 
  scale_color_manual(values=alpha(c("#466f91", "#AA4D0D", 
                                     "#FFF04D", "#000000"), 1.0)) +
  theme(legend.text=element_text(size=12, color="white"), legend.title=element_text(size=16, color="white"),
        legend.key=element_rect(color="white", size=1.5), legend.background=element_rect(fill="black", color="black"))
#ggsave(legend.all.scatters, path="figures", filename="legend.all.smscatters.png",
       #width=10, height=10, dpi=150)
```

# Mediation analysis - leptin and psychiatric symptoms via amygdala nuclei

Example for reporting:\
"The effect of sepal length on likelihood of pollination was fully
mediated via the attractiveness of the bloom. As Figure 1 illustrates,
the regression coefficient between sepal length and likelihood to be
pollinated and the regression coefficient between attractiveness and
likelihood of pollination was significant. The indirect effect was
(.30)\*(.37) = .11. We tested the significance of this indirect effect
using bootstrapping procedures. Unstandardized indirect effects were
computed for each of 1'000 bootstrapped samples, and the 95% confidence
interval was computed by determining the indirect effects at the 2.5th
and 97.5th percentiles. The bootstrapped unstandardized indirect effect
was .11, and the 95% confidence interval ranged from .06 to .17. Thus,
the indirect effect was statistically significant (p\<.001). If the IV
were still significant, we would speak of an "incomplete/partial
mediation" which is also perfectly OK. An incomplete mediation implies
another effect of the IV on the DV, which does not go through the
mediator."

One may wish to use the default (1000) or even larger number if the
estimates vary too much from one simulation to another. The default
simulation type is the quasi-Bayesian Monte Carlo method based on normal
approximation (Imai et al. 2010a).

Imputation:\
Our level of confidence in a particular imputed value is expressed as
the variation across the m completed datasets (between-imputation
variability). Not recommended workflow: The reported standard errors and
p-values after data-averaging are generally too low. Analysis of the
average data cannot give a fair representation of the uncertainties
associated with the underlying data, and hence is not recommended."

## OLS - Ordinary least squares regression - Mediaion model paths (!!!one-tailed testing!!!)

```{r medpathsols, results="asis", message=FALSE, warning=FALSE}
set.seed(123456)

ols.med.model <- lme.leptin_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  left_join(psycho, by=c("participant_id", "por", "delta.bmisds")) %>%
  dplyr::rename(bdi2=resultquest_bdi2_total, sclgsi=resultquest_scl90r_skagloba) %>%
  filter(por=="acAN") %>%
  group_by(rn.hemi_region, rn.total, region, labeller.amy, participant_id) %>%
  filter(n()>1) %>%
  arrange(delta.bmisds, .by_group=TRUE) %>%
  mutate(delta.measure=measure - lead(measure)) %>%
  mutate(delta.etiv=e_tiv - lead(e_tiv)) %>%
  mutate(delta.age=age_at_date_of_research - lead(age_at_date_of_research)) %>%
  ungroup() %>%
  filter(!is.na(delta.measure)) %>%
  dplyr::select(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                delta.measure, delta.bmisds, delta.age, delta.etiv,
                delta.log_leptin.clmi, delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq,
                delta.edicore, delta.bdi, delta.sclgsi) %>%
  pivot_longer(-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                  delta.measure, delta.bmisds, delta.age, delta.etiv,
                  delta.log_leptin.clmi, delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq), 
               names_to="demo_variable", values_to="delta.psych") %>%
  filter(labeller.amy %in% c("Medial nucleus lh", "Medial nucleus rh", # Nuclei with significant deltaLogLeptin effect
                             "Cortico- amygdaloid transition lh")) %>%
  nest(data_pre=-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, demo_variable)) %>%
  mutate(rn.total_psycho=row_number()) %>%
  mutate(labeller.amy.join=dplyr::recode(labeller.amy,
                                         "Medial nucleus lh"="MeNu_lh",
                                         "Medial nucleus rh"="MeNu_rh",
                                         "Cortico- amygdaloid transition lh"="CAT_lh")) %>%
  unite("rn", c(rn.total_psycho, demo_variable, labeller.amy.join), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(-c(rn.total_psycho, labeller.amy.join)) %>%
  mutate(
    lmdata=map(data_pre, ~drop_na(.x)),
    n_lm=map_dbl(lmdata, ~nrow(.x)),
    lm.mediator=map(lmdata, ~lm(delta.measure ~ delta.bmisds +
                                  delta.log_leptin.clmi.ortho +
                                  delta.age + I(delta.age^2),
                                data=.x, na.action=na.omit)),
    lm.mediator.sq=map(lmdata, ~lm(delta.measure ~ poly(delta.bmisds, degree=2, raw=FALSE) +
                                     delta.log_leptin.clmi.ortho.sq +
                                     delta.age + I(delta.age^2), 
                                data=.x, na.action=na.omit)),
    lm.dv=map(lmdata, ~lm(delta.psych ~ delta.bmisds +
                            delta.log_leptin.clmi.ortho +
                            delta.measure +
                            delta.age + I(delta.age^2), 
                          data=.x, na.action=na.omit)),
    lm.te=map(lmdata, ~lm(delta.psych ~ delta.bmisds +
                            delta.log_leptin.clmi.ortho +
                            delta.age + I(delta.age^2), 
                          data=.x, na.action=na.omit)))

ols.med.model.pool <- ols.med.model %>%
  dplyr::select(demo_variable, labeller.amy, n_lm, lm.mediator, lm.dv, lm.te) %>%
  nest(pooldata=-c(demo_variable, labeller.amy, n_lm)) %>%
  mutate(
    pool.lm.mediator=map(pooldata, ~mice::pool(.x$lm.mediator, 
                                            dfcom=NULL, rule="rubin1987")),
    pool.lm.mediator.summary=map(pool.lm.mediator, ~summary(.x, conf.int=TRUE, 
                                                              conf.level=0.95)),
    pool.lm.dv=map(pooldata, ~mice::pool(.x$lm.dv, 
                                      dfcom=NULL, rule="rubin1987")),
    pool.lm.dv.summary=map(pool.lm.dv, ~summary(.x, conf.int=TRUE, 
                                                  conf.level=0.95)),
    pool.lm.te=map(pooldata, ~mice::pool(.x$lm.te, 
                                      dfcom=NULL, rule="rubin1987")),
    pool.lm.te.summary=map(pool.lm.te, ~summary(.x, conf.int=TRUE, 
                                                  conf.level=0.95))) %>%
  dplyr::select(demo_variable, labeller.amy, n_lm, 
                pool.lm.mediator.summary, pool.lm.dv.summary, pool.lm.te.summary)

ols.mediator.path <- ols.med.model.pool %>%
  unnest(pool.lm.mediator.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) 

ols.mediator.path %>%
  dplyr::select(demo_variable, labeller.amy, n_lm, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted) %>%
  filter(term=="delta.log_leptin.clmi.ortho") %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               caption="Mediator OLS/Linear model (deltaAmyMeasure ~ deltaBMI-SDS + deltaLog10Leptin + deltaAge + deltaAge^2") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


ols.dependent.path <- ols.med.model.pool %>%
  unnest(pool.lm.dv.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  mutate(assumption=ifelse((term=="delta.measure")&(p.value<0.05), TRUE, FALSE))  

ols.dependent.path %>%
  dplyr::select(demo_variable, labeller.amy, n_lm, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted, assumption) %>%
  filter(term %in% c("delta.log_leptin.clmi.ortho", "delta.measure")) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D", "Mediation assumption met?"), 
               caption="Dependent Variable/Outcome OLS/Linear model (deltaPsychiatric symptoms ~ deltaBMI-SDS + deltaLog10Leptin + deltaAmyMeasure + deltaAge + deltaAge^2") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

#ols.te.path <- ols.med.model.pool %>%
  #unnest(pool.lm.te.summary) %>%
  #mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            #formatC(p.value, format="f", digits=3))) %>%
  #mutate(signif=as.character(asterisk_function(p.value))) %>%
  #nest(effdata=c(statistic, df)) %>%
  #mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      #alternative="two.sided"))) %>%
  #unnest(effdata, d) %>%
  #mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            #formatC(abs(d), format="f", digits=2)))

#ols.te.path %>%
  #dplyr::select(demo_variable, labeller.amy, n_lm, term,
                #estimate, std.error, statistic, p_formatted, signif, 
                #d_formatted) %>%
  #filter(term %in% c("delta.log_leptin.clmi.ortho")) %>%
  #knitr::kable(format="html", digits=2, align="l", 
               #col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           #"N(acAN)", "Term", 
                           #"beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               #caption="Total effect OLS/Linear model (deltaPsychiatric symptoms ~ deltaBMI-SDS + deltaLog10Leptin + deltaAge + deltaAge^2") %>%
  #kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              #html_font="Arial", font_size="10")

#lme.leptin_nt_pre %>%
  #unnest(data, ortho) %>%
  #dplyr::rename(bdi2=resultquest_bdi2_total, sclgsi=resultquest_scl90r_skagloba) %>%
  #filter(por=="acAN") %>%
  #group_by(rn.hemi_region, rn.total, region, labeller.amy, participant_id) %>%
  #filter(n()>1) %>%
  #arrange(delta.bmisds, .by_group=TRUE) %>%
  #mutate(delta.measure=measure - lead(measure)) %>%
  #mutate(delta.etiv=e_tiv - lead(e_tiv)) %>%
  #mutate(delta.age=age_at_date_of_research - lead(age_at_date_of_research)) %>%
  #ungroup() %>%
  #filter(!is.na(delta.measure)) %>% 
  #dplyr::select(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                #delta.measure, delta.bmisds, delta.age, delta.etiv,
                #delta.leptin.clmi, delta.leptin.clmi.ortho,
                #delta.edicore, delta.bdi, delta.sclgsi) %>%
  #pivot_longer(-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                  #delta.measure, delta.bmisds, delta.age, delta.etiv,
                  #delta.leptin.clmi, delta.leptin.clmi.ortho), 
               #names_to="demo_variable", values_to="delta.psych") %>%
  #filter(labeller.amy %in% c("Medial nucleus lh", "Medial nucleus rh", # Nuclei with significant deltaLogLeptin effect
                             #"Cortico- amygdaloid transition lh")) %>%
  #nest(data_pre=-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, demo_variable)) %>%
  #mutate(rn.total_psycho=row_number()) %>%
  #mutate(labeller.amy.join=dplyr::recode(labeller.amy,
                                         #"Medial nucleus lh"="MeNu_lh",
                                         #"Medial nucleus rh"="MeNu_rh",
                                         #"Cortico- amygdaloid transition lh"="CAT_lh")) %>%
  #unite("rn", c(rn.total_psycho, demo_variable, labeller.amy.join), sep="_", 
        #remove=FALSE, na.rm=FALSE) %>%
  #dplyr::select(-c(rn.total_psycho, labeller.amy.join)) %>%
  #mutate(
    #lmdata=map(data_pre, ~drop_na(.x)),
    #n_lm=map_dbl(lmdata, ~nrow(.x)),
    #lm.te=map(lmdata, ~lm(delta.psych ~ delta.bmisds +
                            #delta.leptin.clmi.ortho 
                          #+ poly(delta.age, degree=2, raw=FALSE) 
                          # data=.x, na.action=na.omit))) %>%
  #dplyr::select(demo_variable, labeller.amy, n_lm, lm.te) %>%
  #nest(pooldata=-c(demo_variable, labeller.amy, n_lm)) %>%
  #mutate(
    #pool.lm.te=map(pooldata, ~mice::pool(.x$lm.te, 
                                      #dfcom=NULL, rule="rubin1987")),
    #pool.lm.te.summary=map(pool.lm.te, ~summary(.x, conf.int=TRUE, 
                                                  #conf.level=0.95))) %>%
  #dplyr::select(demo_variable, labeller.amy, n_lm, pool.lm.te.summary) %>%
  #unnest(pool.lm.te.summary) %>%
  #mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            #formatC(p.value, format="f", digits=3))) %>%
  #mutate(signif=as.character(asterisk_function(p.value))) %>%
  #nest(effdata=c(statistic, df)) %>%
  #mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      #alternative="two.sided"))) %>%
  #unnest(effdata, d) %>%
  #mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            #formatC(abs(d), format="f", digits=2))) %>%
  #dplyr::select(demo_variable, labeller.amy, n_lm, term, estimate, std.error, 
                #statistic, p_formatted, signif, d_formatted) %>%
  #filter(term=="delta.leptin.clmi.ortho") %>%
  #knitr::kable(format="html", digits=2, align="l", 
               #col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           #"N(acAN)", "Term", 
                           #"beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               #caption="Total effect OLS/Linear model (deltaPsychiatric symptoms ~ deltaBMI-SDS + deltaLeptin (non-transformed) + deltaAge + deltaAge^2") %>%
  ##kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              #html_font="Arial", font_size="10")
```

### OLS Mediation model for CAT lh, EDI-2 core score

!!! Remember to set bootstrap simulations to 10,000 !!!

```{r olsmedmodCATlhEdicore, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.edicore_CAT_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_edi_core_CAT_lh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_edi_core_CAT_lh[[RN]]=med.model
}

ols.delta.edicore_CAT_lh <- summary(mice::pool(ols.medlist_edi_core_CAT_lh, dfcom=NULL, rule="rubin1987"), 
                           conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.edicore_CAT_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.edicore_CAT_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Corticoamygdaloid transition lh, DeltaEDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for CAT lh, BDI-II total score

```{r olsmedmodCATlhbdi2, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.bdi_CAT_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_bdi2_CAT_lh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_bdi2_CAT_lh[[RN]]=med.model
}

ols.delta.bdi_CAT_lh <- summary(mice::pool(ols.medlist_bdi2_CAT_lh, dfcom=NULL, rule="rubin1987"),
                       conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.bdi_CAT_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.bdi_CAT_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Corticoamygdaloid transition lh, DeltaBDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for CAT lh, SCL-90-R GSI

```{r olsmedmodCATlhscl, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.sclgsi_CAT_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_sclgsi_CAT_lh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_sclgsi_CAT_lh[[RN]]=med.model
}

ols.delta.sclgsi_CAT_lh <- summary(mice::pool(ols.medlist_sclgsi_CAT_lh, dfcom=NULL, rule="rubin1987"), 
                         conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.sclgsi_CAT_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.sclgsi_CAT_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Corticoamygdaloid transition lh, 
               DeltaSCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus lh, EDI-2 core symptoms

```{r olsmedmodMeNulhEdicore, results="asis", message=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.edicore_MeNu_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_edi_core_MeNu_lh=list()

for (RN in unique(ols.med$rn)) {
                                      
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_edi_core_MeNu_lh[[RN]]=med.model
}

ols.delta.edicore_MeNu_lh <- summary(mice::pool(ols.medlist_edi_core_MeNu_lh, dfcom=NULL, rule="rubin1987"), 
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.edicore_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.edicore_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus lh, DeltaEDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus lh, BDI-II total score

```{r olsmedmodMeNulhbdi2, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.bdi_MeNu_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_bdi2_MeNu_lh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_bdi2_MeNu_lh[[RN]]=med.model
}

ols.delta.bdi_MeNu_lh <- summary(mice::pool(ols.medlist_bdi2_MeNu_lh, dfcom=NULL, rule="rubin1987"),
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.bdi_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.bdi_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus lh, DeltaBDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus lh, SCL-90-R GSI

```{r olsmedmodMeNulhsclgsi, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.sclgsi_MeNu_lh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_scl_MeNu_lh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_scl_MeNu_lh[[RN]]=med.model
}

ols.delta.sclgsi_MeNu_lh <- summary(mice::pool(ols.medlist_scl_MeNu_lh, dfcom=NULL, rule="rubin1987"), 
                          conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.sclgsi_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.sclgsi_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus lh, DeltaSCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus rh, EDI-2 core symptoms

```{r olsmedmodMeNurhEdicore, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.edicore_MeNu_rh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_edi_core_MeNu_rh=list()

for (RN in unique(ols.med$rn)) {
                                      
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_edi_core_MeNu_rh[[RN]]=med.model
}

ols.delta.edicore_MeNu_rh <- summary(mice::pool(ols.medlist_edi_core_MeNu_rh, dfcom=NULL, rule="rubin1987"), 
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.edicore_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.edicore_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus rh, DeltaEDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus rh, BDI-II total score

```{r olsmedmodMeNurhbdi2, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.bdi_MeNu_rh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_bdi2_MeNu_rh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_bdi2_MeNu_rh[[RN]]=med.model
}

ols.delta.bdi_MeNu_rh <- summary(mice::pool(ols.medlist_bdi2_MeNu_rh, dfcom=NULL, rule="rubin1987"),
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.bdi_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.bdi_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus rh, DeltaBDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### OLS Mediation model for Medial nucleus rh, SCL-90-R GSI

```{r olsmedmodMeNurhsclgsi, results="asis", message=FALSE, warning=FALSE}
ols.med <- ols.med.model %>%
  filter(str_detect(rn, "delta.sclgsi_MeNu_rh")) %>%
  dplyr::select(rn, lm.mediator, lm.dv)

ols.medlist_scl_MeNu_rh=list()

for (RN in unique(ols.med$rn)) {
  
  lm <- ols.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=10000, 
                                  boot=TRUE, boot.ci.type = "perc")
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  ols.medlist_scl_MeNu_rh[[RN]]=med.model
}

ols.delta.sclgsi_MeNu_rh <- summary(mice::pool(ols.medlist_scl_MeNu_rh, dfcom=NULL, rule="rubin1987"), 
                          conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p.value=p.value/2) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_lower=..5.., CI_upper=..95..) %>%
  mutate(model="ols.delta.sclgsi_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_lower, CI_upper, t, p, signif)

ols.delta.sclgsi_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "CI lower", "CI upper", "t", "p", "Signif."), 
               caption="OLS Mediation model: Medial nucleus rh, DeltaSCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Mediation analysis plot visualization

```{r figuremediationlong, fig.cap="Visualize mediation analysis", message=FALSE, warning=FALSE}
mediationplotdata <- bind_rows(
  ols.delta.edicore_CAT_lh,
  ols.delta.bdi_CAT_lh,
  ols.delta.sclgsi_CAT_lh,
  ols.delta.edicore_MeNu_lh,
  ols.delta.bdi_MeNu_lh,
  ols.delta.sclgsi_MeNu_lh, 
  ols.delta.edicore_MeNu_rh,
  ols.delta.bdi_MeNu_rh,
  ols.delta.sclgsi_MeNu_rh) %>%
  filter(str_detect(term, "mediation")) %>%
  mutate(label_t="t=") %>%
  unite("label_t", c(label_t, t), sep="", remove=TRUE, na.rm=FALSE) %>%
  mutate(label_p="p=") %>%
  unite("label_p", c(label_p, p), sep="", remove=TRUE, na.rm=FALSE) %>%
  unite("label_t_p", c(label_t, label_p), sep="; ", remove=TRUE, na.rm=FALSE) %>%
  mutate(symptom=factor(ifelse(str_detect(model, "edicore"), "EDI-2 core", 
                        ifelse(str_detect(model, "bdi"), "BDI-II total", "SCL-90-R GSI")), 
                        levels=c("EDI-2 core", "BDI-II total", "SCL-90-R GSI"))) %>%
  mutate(labeller.amy=factor(ifelse(str_detect(model, "CAT_lh"), 
                                    "Corticoamygdaloid transition lh", 
                        ifelse(str_detect(model, "MeNu_lh"), "Medial nucleus lh",
                               "Medial nucleus rh")), levels=c("Medial nucleus rh",
                                                               "Medial nucleus lh",
                                                               "Corticoamygdaloid transition lh"))) %>%
  arrange(labeller.amy, symptom)

mediationplot <- mediationplotdata %>% 
  ggplot(aes(x=estimate, y=symptom)) +
  geom_vline(aes(xintercept=0), color="gray40", linetype=3, size=3.5, alpha=1) +
  geom_segment(aes(x=estimate, xend=CI_upper, y=symptom, yend=symptom), color="white", size=2, 
               linetype="solid") +
  geom_point(color="white", alpha=1, size=10, shape=16) +
  geom_text(aes(label=label_t_p, x=CI_upper, y=symptom),
              size=11, hjust=-0.1, vjust=0.5, color="white", parse=FALSE) +
  scale_x_continuous(limits=c(-0.6,2.0), expand=expansion(mult=c(0.05,0.05)),
                     breaks=c(-0.6,-0.4,-0.2,0.0,
                              0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6,1.8,2.0),
                     labels=scales::comma_format(big.mark=",",
                                                 decimal.mark=".",
                                                 accuracy=0.1)) +
  scale_y_discrete(expand=expansion(mult=c(0.25, 0.25))) +
  plot_theme_transparent_scatters +
  theme(panel.background=element_rect(fill="black", color="black"), 
          plot.background=element_rect(fill="black", color="black")) +
  theme(axis.text.x=element_text(angle=0, vjust=0, size=35),
          axis.text.y=element_text(hjust=0.90, vjust=0.5, size=35),
          axis.title.y=element_text(size=50, face="bold", vjust=3), 
          axis.title.x=element_text(vjust=-2.75), 
          axis.ticks.x=element_line(size=2, color="white"),
          axis.ticks.y=element_line(size=2, color="white"), 
          axis.ticks.length.y=unit(.5, "cm"), 
          axis.ticks.length.x=unit(.5, "cm")) +
  guides(fill=FALSE, color=FALSE, size=FALSE) +
  facet_wrap(~labeller.amy, ncol=1, nrow=3, scales="free_y", switch="y",  dir="v",
             strip.position="left", 
             labeller=label_wrap_gen(width=15)) +
  xlab("Estimate (unst.) [95% CI]") +
  ylab("Average causal mediation effect") +
  theme(strip.placement="outside",
        strip.text.y=element_text(size=40, color="white", vjust=-0.1),
        strip.text.x=element_text(size=40, color="white"),
        strip.background=element_blank()) +
  theme(panel.spacing=unit(3, "cm")) +
  theme(plot.margin=unit(c(1,1,1,1), "cm"))

#ggsave(mediationplot, filename="figures/sm.mediationplot.png", width=28, height=25, dpi=600)
```

#### Reproduce analysis using Hayes PROCESS mediation analysis

```{r medmodMeNulhbdi_hayes, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
process.data <- lme.leptin_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  left_join(psycho, by=c("participant_id", "por", "delta.bmisds")) %>%
  dplyr::rename(bdi2=resultquest_bdi2_total, sclgsi=resultquest_scl90r_skagloba) %>%
  filter(por=="acAN") %>%
  group_by(rn.hemi_region, rn.total, region, labeller.amy, participant_id) %>%
  filter(n()>1) %>%
  arrange(delta.bmisds, .by_group=TRUE) %>%
  mutate(delta.measure=measure - lead(measure)) %>%
  mutate(delta.etiv=e_tiv - lead(e_tiv)) %>%
  mutate(delta.age=age_at_date_of_research - lead(age_at_date_of_research)) %>%
  ungroup() %>%
  filter(!is.na(delta.measure)) %>%
  dplyr::select(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                delta.measure, delta.bmisds, delta.age, delta.etiv,
                delta.log_leptin.clmi, delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq,
                delta.edicore, delta.bdi, delta.sclgsi) %>%
  pivot_longer(-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                  delta.measure, delta.bmisds, delta.age, delta.etiv,
                  delta.log_leptin.clmi, delta.log_leptin.clmi.ortho,
                  delta.log_leptin.clmi.ortho.sq), 
               names_to="demo_variable", values_to="delta.psych") %>%
  filter(labeller.amy %in% c("Medial nucleus lh"
                             #,"Medial nucleus rh"
                             #,"Cortico- amygdaloid transition lh"
                             )) %>%
  filter(demo_variable=="delta.edicore") %>%
  filter(rn.hemi_region==1)
  
source("process.R")
process(data=process.data, y="delta.psych", x="delta.log_leptin.clmi.ortho", 
        m="delta.measure", cov=c("delta.age"), model=4) 
```

## LME model based mediation analysis

```{r medpathslme, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
# https://towardsdatascience.com/doing-and-reporting-your-first-mediation-analysis-in-r-2fe423b92171
# https://data.library.virginia.edu/introduction-to-mediation-analysis/
# Mediator and outcome models: Usually same sets of covariates
# First, users simulate multiple data sets using their preferred imputation software. Next, run mediate on each data set by simply passing the data sets through the "mediations" function. Next, pass the output of "mediations" to the "amelidiate" function, which combines the components of the output from "mediations" into a format that can be analyzed with the standard summary commands.

lme.med.model <- lme.leptin_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  group_by(rn.hemi_region, rn.total, region, labeller.amy, participant_id) %>%
  arrange(delta.bmisds, .by_group=TRUE) %>%
  mutate(delta.measure=ifelse(delta.bmisds<0, measure - lead(measure), 0)) %>%
  ungroup() %>%
  left_join(psycho, by=c("participant_id", "por", "delta.bmisds")) %>%
  dplyr::rename(bdi2=resultquest_bdi2_total, sclgsi=resultquest_scl90r_skagloba) %>%
  dplyr::select(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                measure, delta.measure, e_tiv,
                age_at_date_of_research, delta.bmisds, bmisds_at_date_of_research, 
                delta.log_leptin.clmi, delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq, 
                edi_core, bdi2, sclgsi) %>%
  pivot_longer(-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, participant_id, por, 
                  measure, delta.measure, e_tiv,
                  age_at_date_of_research, delta.bmisds, bmisds_at_date_of_research,
                  delta.log_leptin.clmi, delta.log_leptin.clmi.ortho, delta.log_leptin.clmi.ortho.sq), 
               names_to="demo_variable", values_to="psych") %>%
  filter(labeller.amy %in% c("Medial nucleus lh", "Medial nucleus rh", # Nuclei with significant deltaLogLeptin effect
                             "Cortico- amygdaloid transition lh")) %>%
  nest(data_pre=-c(rn.hemi_region, rn.total, region, labeller.amy, whole.sub, demo_variable)) %>%
  mutate(rn.total_psycho=row_number()) %>%
  mutate(labeller.amy.join=dplyr::recode(labeller.amy,
                                         "Medial nucleus lh"="MeNu_lh",
                                         "Medial nucleus rh"="MeNu_rh",
                                         "Cortico- amygdaloid transition lh"="CAT_lh")) %>%
  unite("rn", c(rn.total_psycho, demo_variable, labeller.amy.join), sep="_", 
        remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(-c(rn.total_psycho, labeller.amy.join)) %>%
  mutate(
    lmedata=map(data_pre, ~drop_na(.x)),
    lmedata=map(lmedata, ~group_by(.x, participant_id)),
    lmedata=map(lmedata, ~mutate(.x, nomatch=ifelse((por=="acAN") & (n()<2) & (delta.bmisds<0), TRUE, FALSE))),
    lmedata=map(lmedata, ~ungroup(.x)),
    lmedata=map(lmedata, ~filter(.x, nomatch==FALSE)),
    lmedata=map(lmedata, ~mutate(.x,
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    n_lme=map_dbl(lmedata, ~nrow(.x)),
    n_lme_T1=map_dbl(lmedata, ~sum(.x$delta.bmisds<0)),
    lme.mediator=map(lmedata, ~lme4::lmer(delta.measure ~1 + por + # LME for mediator
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.mediator.sq=map(lmedata, ~lme4::lmer(delta.measure ~1 + por + # LME for mediator (deltaBMI-SDS^2)
                                        poly(delta.bmisds, degree=2, raw=FALSE) +
                                        delta.log_leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv=map(lmedata, ~lme4::lmer(psych ~1 + por + # LME for dependent variable
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        delta.measure +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.te=map(lmedata, ~lme4::lmer(psych ~1 + por + # LME for total effect
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)))

lme.med.model.pool <- lme.med.model %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, lme.mediator, 
                lme.dv, lme.te) %>%
  nest(pooldata=-c(demo_variable, labeller.amy, n_lme, n_lme_T1)) %>%
  mutate(
    pool.lme.mediator=map(pooldata, ~mice::pool(.x$lme.mediator, 
                                            dfcom=NULL, rule="rubin1987")),
    pool.lme.mediator.summary=map(pool.lme.mediator, ~summary(.x, conf.int=TRUE, 
                                                              conf.level=0.95)),
    pool.lme.dv=map(pooldata, ~mice::pool(.x$lme.dv, 
                                      dfcom=NULL, rule="rubin1987")),
    pool.lme.dv.summary=map(pool.lme.dv, ~summary(.x, conf.int=TRUE, 
                                                  conf.level=0.95)),
    pool.lme.te=map(pooldata, ~mice::pool(.x$lme.te, 
                                      dfcom=NULL, rule="rubin1987")),
    pool.lme.te.summary=map(pool.lme.te, ~summary(.x, conf.int=TRUE, 
                                                  conf.level=0.95))) %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, 
                pool.lme.mediator.summary, pool.lme.dv.summary, pool.lme.te.summary)

mediator.path <- lme.med.model.pool %>%
  unnest(pool.lme.mediator.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) 

mediator.path %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted) %>%
  filter(term=="delta.log_leptin.clmi.ortho") %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N", "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               caption="Mediator LME model (deltaAmyMeasure ~ deltaBMI-SDS + deltaLog10Leptin + age + age^2 + eTIV") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


dependent.path <- lme.med.model.pool %>%
  unnest(pool.lme.dv.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  mutate(assumption=ifelse((term=="delta.measure")&(p.value<0.05), TRUE, FALSE))  

dependent.path %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted, assumption) %>%
  filter(term %in% c("delta.log_leptin.clmi.ortho", "delta.measure")) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N", "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D", "Mediation assumption met?"), 
               caption="Dependent Variable/Outcome LME model (Psychiatric symptoms (change/contrast acAN-TP2 vs. acAN-TP1) ~ deltaBMI-SDS + deltaLog10Leptin + deltaAmyMeasure + age + age^2 + eTIV") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

dependent.path %>%
  filter(assumption==TRUE) %>%
  dplyr::select(demo_variable, labeller.amy, term) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", "Term"),
               caption="Mediation analysis assumption met only for medial nucleus lh: Mediator affects outcome, controlling for IV") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


total.path <- lme.med.model.pool %>%
  unnest(pool.lme.te.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2)))

total.path %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted) %>%
  filter(term=="delta.log_leptin.clmi.ortho") %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N", "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               caption="Total/direct effect LME model (Psychiatric symptoms (change/contrast acAN-TP2 vs. acAN-TP1) ~ deltaBMI-SDS + deltaLog10Leptin + age + age^2 + eTIV") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

Mediation assumption checks LME models

Product-of-coefficients method: We regress the outcome on the exposure,
the mediator, and the covariates. We then regress the mediator itself on
the exposure and the covariates.

Same covariates in all equations!

Step 1: Causal variable is correlated with the outcome (effect that may
be mediated).\
**This is the case, leptin increase is associated with decrease in
psychiatric symptom levels.**

Step 2: Causal variable is correlated with the mediator.\
**This is the case, deltaLogLeptin is positively associated with
deltaAmygdalaVolumes (see mediator path model above).**

Step 3: Mediator should affect dependent variable controlling for the
causal/independent variable.\
**This is the case, deltaMedialNucleusVolume lh significantly predicts
psychiatric symptom levels (see dependent variable path model above).**

Mediation analysis will only be performed for Medial nucleus lh! (since
mediation assumptions are met and )

LME models: Check significance of deltaBMI-SDS squared

```{r medsqlme, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med.model.pool.sq <- lme.med.model %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, lme.mediator.sq) %>%
  nest(pooldata=-c(demo_variable, labeller.amy, n_lme, n_lme_T1)) %>%
  mutate(
    pool.lme.mediator.sq=map(pooldata, ~mice::pool(.x$lme.mediator.sq, 
                                            dfcom=NULL, rule="rubin1987")),
    pool.lme.mediator.sq.summary=map(pool.lme.mediator.sq, ~summary(.x, conf.int=TRUE, 
                                                              conf.level=0.95))) %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, 
                pool.lme.mediator.sq.summary)

lme.med.model.pool.sq %>%
  unnest(pool.lme.mediator.sq.summary) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="two.sided"))) %>%
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  filter(term=="poly(delta.bmisds, degree = 2, raw = FALSE)2") %>%
  dplyr::select(demo_variable, labeller.amy, n_lme, n_lme_T1, term,
                estimate, std.error, statistic, p_formatted, signif, 
                d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Psychiatric symptoms", "Amygdala (sub-)region", 
                           "N", "N(acAN)", "Term", 
                           "beta", "se", "t", "p", "Signif.", "Cohen's D"), 
               caption="Sq.Mediator LME model (deltaAmyMeasure ~ deltaBMI-SDS + deltaBMI-SDS^2 + deltaLog10Leptin + age + age^2 + eTIV") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

LME Mediation model for Medial nucleus lh, EDI-2 core symptoms

```{r medmodMeNulhEdicore, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "edi_core_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_edi_core_MeNu_lh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation (King et al. 2000)
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_edi_core_MeNu_lh[[RN]]=med.model
}

edi_core_MeNu_lh <- summary(mice::pool(medlist_edi_core_MeNu_lh, dfcom=NULL, rule="rubin1987"), 
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="edi_core_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

edi_core_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus lh, EDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

# Look at statistics (p-values) on single imputed data sets
## lapply(medlist_edi_core_MeNu_lh, tidy) %>%
  ## bind_rows() %>%
  ## filter(term=="acme_0") %>%
  ## arrange(desc(p.value))
```

LME Mediation model for Medial nucleus lh, BDI-II total score

```{r medmodMeNulhbdi2, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "bdi2_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_bdi2_MeNu_lh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_bdi2_MeNu_lh[[RN]]=med.model
}

bdi2_MeNu_lh <- summary(mice::pool(medlist_bdi2_MeNu_lh, dfcom=NULL, rule="rubin1987"),
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="bdi2_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

bdi2_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus lh, BDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

# Look at statistics (p-values) on single imputed data sets
##lapply(medlist_bdi2_MeNu_lh, tidy) %>%
  ##bind_rows() %>%
  ##filter(term=="acme_0") %>%
  ##arrange(desc(p.value))
```

LME Mediation model for Medial nucleus lh, SCL-90-R GSI

```{r medmodMeNulhsclgsi, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "sclgsi_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_sclgsi_MeNu_lh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_sclgsi_MeNu_lh[[RN]]=med.model
}

sclgsi_MeNu_lh <- summary(mice::pool(medlist_sclgsi_MeNu_lh, dfcom=NULL, rule="rubin1987"), 
                          conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="sclgsi_MeNu_lh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

sclgsi_MeNu_lh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus lh, SCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
        
#Look at statistics (p-values) on single imputed data sets
##lapply(medlist_sclgsi_MeNu_lh, tidy) %>%
  ##bind_rows() %>%
  ##filter(term=="acme_0") %>%
  ##arrange(desc(p.value))
```

LME Mediation model for Medial nucleus rh, EDI-2 core symptoms

```{r medmodMeNurhEdicore, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "edi_core_MeNu_rh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_edi_core_MeNu_rh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=1000, boot=FALSE) # quasi-Bayesian approximation (King et al. 2000)
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_edi_core_MeNu_rh[[RN]]=med.model
}

edi_core_MeNu_rh <- summary(mice::pool(medlist_edi_core_MeNu_rh, dfcom=NULL, rule="rubin1987"), 
                            conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="edi_core_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

edi_core_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus rh, EDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

LME Mediation model for Medial nucleus rh, BDI-II total score

```{r medmodMeNurhbdi2, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "bdi2_MeNu_rh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_bdi2_MeNu_rh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_bdi2_MeNu_rh[[RN]]=med.model
}

bdi2_MeNu_rh <- summary(mice::pool(medlist_bdi2_MeNu_rh, dfcom=NULL, rule="rubin1987"), 
                        conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="bdi2_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

bdi2_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus rh, BDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

LME Mediation model for Medial nucleus rh, SCL-90-R GSI

```{r medmodMeNurhsclgsi, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "sclgsi_MeNu_rh")) %>%
  dplyr::select(rn, lme.mediator, lme.dv)

medlist_sclgsi_MeNu_rh=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_sclgsi_MeNu_rh[[RN]]=med.model
}

sclgsi_MeNu_rh <- summary(mice::pool(medlist_sclgsi_MeNu_rh, dfcom=NULL, rule="rubin1987"),
                          conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="sclgsi_MeNu_rh") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif)

sclgsi_MeNu_rh %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model: Medial nucleus rh, SCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

Mediation analysis visualization (only medial nucleus lh)

```{r figuremediation, fig.cap="Visualize mediation analysis", message=FALSE, warning=FALSE, eval=FALSE}
mediationplotdata <- bind_rows(
          edi_core_MeNu_lh,
          bdi2_MeNu_lh,
          sclgsi_MeNu_lh) %>%
  filter(str_detect(term, "mediation")) %>%
  mutate(label_t="t=") %>%
  unite("label_t", c(label_t, t), sep=" ", remove=TRUE, na.rm=FALSE) %>%
  mutate(label_p="p=") %>%
  unite("label_p", c(label_p, p), sep=" ", remove=TRUE, na.rm=FALSE) %>%
  unite("label_t_p", c(label_t, label_p), sep="; ", remove=TRUE, na.rm=FALSE) %>%
  mutate(symptom=factor(ifelse(str_detect(model, "edi_core"), "EDI-2 core", 
                        ifelse(str_detect(model, "bdi2"), "BDI-II total",
                               "SCL-90-R GSI")), levels=c("SCL-90-R GSI", "BDI-II total", "EDI-2 core"))) %>%
  mutate(labeller.amy="Medial nucleus lh") %>%
  arrange(labeller.amy, symptom)

mediationplot <- mediationplotdata %>% 
  ggplot(aes(x=estimate, y=symptom)) +
  geom_vline(aes(xintercept=0), color="gray40", linetype=3, size=3, alpha=1) +
  geom_segment(aes(x=estimate, xend=CI_upper, y=symptom, yend=symptom), color="white", size=2, 
               linetype="solid") +
  geom_point(color="white", alpha=1, size=10, shape=16) +
  geom_text(aes(label=label_t_p, x=estimate, y=symptom),
              size=10, hjust=1.12, vjust=0.5, color="white", parse=FALSE) +
  scale_x_continuous(limits=c(-0.7,0.1), expand=expansion(mult=c(0.15,0.1)),
                     breaks=c(-0.7,-0.6,-0.5,-0.4,-0.3,-0.2,-0.1,0.0,0.1),
                     labels=scales::comma_format(big.mark=",",
                                                 decimal.mark=".",
                                                 accuracy=0.1)) +
  scale_y_discrete(expand=expansion(mult=c(0.25, 0.25))) +
  plot_theme_transparent_scatters +
  theme(panel.background=element_rect(fill="black", color="black"), 
          plot.background=element_rect(fill="black", color="black")) +
  theme(axis.text.x=element_text(angle=0, vjust=0, size=35),
          axis.text.y=element_text(hjust=0.85, vjust=0.5, size=35),
          axis.title.y=element_text(size=40, face="bold", vjust=3), 
          axis.title.x=element_text(vjust=-3, size=40), 
          axis.ticks.x=element_line(size=2, color="white"),
          axis.ticks.y=element_line(size=2, color="white"), 
          axis.ticks.length.y=unit(.5, "cm"), 
          axis.ticks.length.x=unit(.5, "cm")) +
  guides(fill=FALSE, color=FALSE, size=FALSE) +
  facet_wrap(~labeller.amy, ncol=1, nrow=3, scales="free_y", switch="y",  dir="v", strip.position="left", 
             labeller=label_wrap_gen(width=40)) +
  xlab("Estimate (95% CI)") +
  ylab("Average causal mediation effect") +
  theme(strip.placement="outside",
        strip.text.y=element_text(size=40, color="white", vjust=-0.1),
        strip.text.x=element_text(size=40, color="white"),
        strip.background=element_blank()) +
  theme(panel.spacing=unit(3, "cm")) +
  theme(plot.margin=unit(c(1,1,1,1), "cm"))

#ggsave(mediationplot, filename="figures/mediationplot.png", width=20, height=10, dpi=600)
```

LME Mediation models for medial nucleus lh: Test quadratic deltaBMI-SDS
effects\
LME Sq. Mediation model for Medial nucleus lh, EDI-2 core symptoms

```{r medmodMeNulhEdicoresq, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "edi_core_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator.sq, lme.dv)

medlist_edi_core_MeNu_lh_sq=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator.sq[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation (King et al. 2000)
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
 medlist_edi_core_MeNu_lh_sq[[RN]]=med.model
}

summary(mice::pool(medlist_edi_core_MeNu_lh_sq, dfcom=NULL, rule="rubin1987"), 
        conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="edi_core_MeNu_lh_sq") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model (linear and quadratic deltaBMI-SDS effects): Medial nucleus lh, EDI-2 core symptoms") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

LME Sq. Mediation model for Medial nucleus lh, BDI-II total score

```{r medmodMeNulhbdi2sq, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "bdi2_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator.sq, lme.dv)

medlist_bdi2_MeNu_lh_sq=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator.sq[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_bdi2_MeNu_lh_sq[[RN]]=med.model
}

summary(mice::pool(medlist_bdi2_MeNu_lh_sq, dfcom=NULL, rule="rubin1987"),
        conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="bdi2_MeNu_lh_sq") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model (linear and quadratic deltaBMI-SDS effects): Medial nucleus lh, BDI-II total score") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

LME Sq. Mediation model for Medial nucleus lh, SCL-90-R GSI

```{r medmodMeNulhsclgsisq, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.med <- lme.med.model %>%
  filter(str_detect(rn, "sclgsi_MeNu_lh")) %>%
  dplyr::select(rn, lme.mediator.sq, lme.dv)

medlist_sclgsi_MeNu_lh_sq=list()

for (RN in unique(lme.med$rn)) {
  
  lme <- lme.med %>% filter(rn==RN)
  
  lme.mediator <- lme$lme.mediator.sq[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", std=FALSE, sims=1000, boot=FALSE) # quasi-Bayesian approximation is used for confidence intervals; if 'TRUE' nonparametric bootstrap will be used
  
  class(med.model) <- "mediate" # change model class so that tidy and pooling methods can be applied
  
  medlist_sclgsi_MeNu_lh_sq[[RN]]=med.model
}

summary(mice::pool(medlist_sclgsi_MeNu_lh_sq, dfcom=NULL,
                   rule="rubin1987"), 
        conf.int=TRUE, conf.level=0.90) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(str_detect(term, "_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects", # indirect effect of the IV on the DV that goes through the mediator
                            "ade_0"="Average direct effects")) %>% # direct effect of the IV on the DV when controlling for the mediator
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                  formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  dplyr::rename(CI_upper=..95..) %>%
  mutate(model="sclgsi_MeNu_lh_sq") %>%
  dplyr::select(model, term,
                estimate, std.error, CI_upper, t, p, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Model", "Term", 
                           "beta", "se", "95% CI upper", "t", "p", "Signif."), 
               caption="Mediation model (linear and quadratic deltaBMI-SDS effects): Medial nucleus lh, SCL-90-R GSI") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

# EMA analysis

## EMA rumination - TP1

```{r ruminationT1, results="asis", message=FALSE, warning=FALSE}
library(readxl)

setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

emm_options(lmerTest.limit = 100000)

ema.person_rumination <- read_excel("cache/20220517_Rumination_Personlevel.xlsx") %>%
  filter(!is.na(StudyID)&!is.na(ema_movisens_id)) %>%
  filter(str_detect(StudyID, "T1")) %>%
  dplyr::select(StudyID, ema_movisens_id, Compliance) %>% 
  dplyr::rename(ema_id=ema_movisens_id)

ema.prompt_rumination <- read_excel("cache/20220517_Rumination_Promptlevel.xlsx") %>%
  filter(!is.na(ema_movisens_id)&!is.na(Triggercounter)) %>%
  dplyr::select(ema_movisens_id, Triggercounter, TaF, TaW, contains("MDMQ"), time, day) %>%
  dplyr::rename(ema_id=ema_movisens_id, trigger=Triggercounter)

ema.lmedata <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(storage_name, participant_id, point_of_research, 
                hemi_region, labeller.amy,
                measure, e_tiv, age_at_date_of_research,
                bmisds_at_date_of_research) %>%
  unite(StudyID, c("participant_id", "point_of_research"), sep="_", 
        remove=TRUE, na.rm=FALSE)

ema_lme_rumination.data <- inner_join(ema.prompt_rumination, 
                                 ema.person_rumination, by="ema_id") %>%
  inner_join(ema.lmedata, by="StudyID") %>%
  mutate(participant_id=factor(StudyID)) %>%
  pivot_longer(c(TaF, TaW),
               names_to="ema_variable", values_to="ema_value") %>%
  filter_at(vars(measure, ema_value), ~ !is.na(.x))

ema_lme_rumination.data %>% distinct(storage_name) %>% count(.) 
  
ema_lme_rumination <- ema_lme_rumination.data %>% 
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    n=map_dbl(data, ~length(unique(.x$storage_name))),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
   lme.comp.trigger=map(data, ~anova(
      lme4::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 | participant_id),
                                        data=.x, REML=FALSE, na.action=na.omit),
      lme4::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 + trigger | participant_id),
                                        data=.x, REML=FALSE, na.action=na.omit))),
     
   lme.comp.trigger.cor=map(data, ~anova(
        lme4::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 + trigger | participant_id),
                                        data=.x, REML=FALSE, na.action=na.omit),
        lme4::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 + trigger || participant_id),
                                        data=.x, REML=FALSE, na.action=na.omit))),
    
   lme.comp.time=map(data, ~anova(
      lme4::lmer(ema_value ~1 + 
                   bmisds_at_date_of_research + 
                   measure + 
                   poly(age.c, degree=2, raw=FALSE) +
                   e_tiv +
                   time +
                   (1 | participant_id) +
                   (1 | participant_id:day),
                 data=.x, REML=FALSE, na.action=na.omit),
      lme4::lmer(ema_value ~1 + 
                   bmisds_at_date_of_research + 
                   measure + 
                   poly(age.c, degree=2, raw=FALSE) +
                   e_tiv +
                   time +
                   (1 + time | participant_id) +
                   (1 | participant_id:day),
                 data=.x, REML=FALSE, na.action=na.omit),
      lme4::lmer(ema_value ~1 + 
                   bmisds_at_date_of_research + 
                   measure + 
                   poly(age.c, degree=2, raw=FALSE) +
                   e_tiv +
                   time +
                   (1 + time | participant_id) +
                   (1 + time | participant_id:day),
                 data=.x, REML=FALSE, na.action=na.omit))),
   
    lme.ema=map(data, ~lmerTest::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
   lme.ema.tidy=map(lme.ema, tidy),
   
   lme.ema.ranova=map(lme.ema, ~ranova(.x)),
   lme.ema.ranova=map(lme.ema.ranova, ~rownames_to_column(.x, "term")),

   lme.ema.adj.affect=map(data, ~lmerTest::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        MDMQ_Valence +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.ema.adj.affect.tidy=map(lme.ema.adj.affect, tidy),
   
    lme.ema.adj.tension=map(data, ~lmerTest::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        MDMQ_Calmness +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lme.ema.adj.tension.tidy=map(lme.ema.adj.tension, tidy))

# To-Do: Adjust for compliance as well!


ema_lme_rumination %>%
  dplyr::select(ema_variable, hemi_region, labeller.amy, lme.comp.trigger) %>%
  unnest(lme.comp.trigger) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(model=case_when(
    npar==9 ~ "Two-level (trigger within participant), random intercept only",
    npar==11 ~ "Two-level (trigger within participant), random intercept and random slope")) %>%
  mutate(p=formatC(Pr..Chisq., format="f", digits=3)) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, model, AIC, BIC, logLik, Chisq, p) %>%
  knitr::kable(format="html", digits=2, align="l",
               caption="LME model fit comparisons 1 - Trigger model (intercept/slope)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

ema_lme_rumination %>%
  dplyr::select(ema_variable, hemi_region, labeller.amy, lme.comp.trigger.cor) %>%
  unnest(lme.comp.trigger.cor) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(model=case_when(
    npar==10 ~ "Two-level, random intercept + level-1 random slopes at level 3 (participant) => correlated",
    npar==11 ~ "Two-level, random intercept + level-1 random slopes at level 3 (participant) => uncorrelated")) %>%
  mutate(p=formatC(Pr..Chisq., format="f", digits=3)) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, model, AIC, BIC, logLik, Chisq, p) %>%
  knitr::kable(format="html", digits=2, align="l",
               caption="LME model fit comparisons 2 - Trigger model (correlated/uncorrelated)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

ema_lme_rumination %>%
  dplyr::select(ema_variable, hemi_region, labeller.amy, lme.comp.time) %>%
  unnest(lme.comp.time) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(model=case_when(
    npar==10 ~ "Three-level (trigger within day within participant), random intercept only",
    npar==12 ~ "Three-level (trigger within day within participant), random intercept and random slope at level 3",
    npar==14 ~ "Two-level (trigger within day within participant), random intercept and random slope at levels 2 + 3")) %>%
  mutate(p=formatC(Pr..Chisq., format="f", digits=3)) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, model, AIC, BIC, logLik, Chisq, p) %>%
  knitr::kable(format="html", digits=2, align="l",
               caption="LME model fit comparisons 3 - Time model") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

ema_lme_rumination.out <- ema_lme_rumination %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, n, lme.ema.tidy) %>%
  filter(hemi_region %in% c("lh_Accessory_basal_nucleus", "rh_Accessory_basal_nucleus",
                             "lh_Cortical_nucleus", "rh_Cortical_nucleus",
                             "lh_Corticoamygdaloid_transitio", 
                             "rh_Corticoamygdaloid_transitio", "lh_Medial_nucleus")) %>% 
  unnest(lme.ema.tidy) %>%
  filter(term %in% c("measure"))

ema_lme_rumination.out %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, n,
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "N", "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (N=52, longitudinal processing, cross-sectional processing yields similar results): Rumination, predicted by amygdala volumes (rostral-medial cluster filtered, time model)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

ema_lme_rumination %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, lme.ema.ranova) %>%
  filter(hemi_region %in% c("lh_Accessory_basal_nucleus", "rh_Accessory_basal_nucleus",
                             "lh_Cortical_nucleus", "rh_Cortical_nucleus",
                             "lh_Corticoamygdaloid_transitio", 
                             "rh_Corticoamygdaloid_transitio", "lh_Medial_nucleus",
                             "rh_Medial_nucleus")) %>% 
  unnest(lme.ema.ranova) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(p_formatted=ifelse(Pr..Chisq.<0.001, "<0.001", 
                            formatC(Pr..Chisq., format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  mutate(ema_variable=dplyr::recode(ema_variable,
                                    "TaF"="Thoughts about food",
                                    "TaW"="Thoughts about weight")) %>%
  dplyr::select(ema_variable, labeller.amy, term, logLik, AIC, LRT, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l",
               caption="HLM/LME models in AcAN-TP1 (N=52): Random effects ANOVA") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

# Adjustments
ema_lme_rumination.out %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region, ema_variable) %>%
  left_join(ema_lme_rumination, by=c("hemi_region", "ema_variable")) %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, n, 
                lme.ema.adj.affect.tidy) %>%
  unnest(lme.ema.adj.affect.tidy) %>%
  filter(term %in% c("measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, n, 
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "N", "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (N=52): Rumination, predicted by amygdala volumes (time model, adjusted for MDMQ Negative affect)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

ema_lme_rumination.out %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region, ema_variable) %>%
  left_join(ema_lme_rumination, by=c("hemi_region", "ema_variable")) %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, n, 
                lme.ema.adj.tension.tidy) %>%
  unnest(lme.ema.adj.tension.tidy) %>%
  filter(term %in% c("measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, n,
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "N", "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (N=52): Rumination, predicted by amygdala volumes (time model, adjusted for MDMQ Tension)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

```{r ruminationT1adjustbdistai, results="asis", message=FALSE, warning=FALSE}
ema.lmedata.bdi.stai <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(storage_name, participant_id, point_of_research, 
                hemi_region, labeller.amy,
                measure, e_tiv, age_at_date_of_research,
                bmisds_at_date_of_research,
                resultquest_bdi2_total, stait) %>%
  unite(StudyID, c("participant_id", "point_of_research"), sep="_", 
        remove=TRUE, na.rm=FALSE)

ema_lme_rumination.data.bdi.stai <- inner_join(ema.prompt_rumination, 
                                 ema.person_rumination, by="ema_id") %>%
  inner_join(ema.lmedata.bdi.stai, by="StudyID") %>%
  mutate(participant_id=factor(StudyID)) %>%
  pivot_longer(c(TaF, TaW),
               names_to="ema_variable", values_to="ema_value") %>%
  filter_at(vars(measure, ema_value), ~ !is.na(.x))
  
ema_lme_rumination.bdi.stai <- ema_lme_rumination.data.bdi.stai %>% 
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    n=map_dbl(data, ~length(unique(.x$storage_name))),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.ema.bdi.stai=map(data, ~lmerTest::lmer(ema_value ~1 +
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        resultquest_bdi2_total + 
                                        stait +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
   lme.ema.bdi.stai.tidy=map(lme.ema.bdi.stai, tidy))

ema_lme_rumination.out %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region, ema_variable) %>%
  left_join(ema_lme_rumination.bdi.stai, 
            by=c("hemi_region", "ema_variable")) %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, n,
                lme.ema.bdi.stai.tidy) %>%
  unnest(lme.ema.bdi.stai.tidy) %>%
  filter(term %in% c("measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, n,
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", "N",
                           "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (N=52): Rumination, predicted by amygdala volumes (time model, adjusted for BDI-II total score and STAI trait anxiety)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

```{r ruminationT1adjustptq, results="asis", message=FALSE, warning=FALSE}
ema.lmedata.bdi.stai <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(storage_name, participant_id, point_of_research, 
                hemi_region, labeller.amy,
                measure, e_tiv, age_at_date_of_research,
                bmisds_at_date_of_research,
                resultquest_bdi2_total, stai_t) %>%
  unite(StudyID, c("participant_id", "point_of_research"), sep="_", 
        remove=TRUE, na.rm=FALSE)

ema_lme_rumination.data.bdi.stai <- inner_join(ema.prompt_rumination, 
                                 ema.person_rumination, by="ema_id") %>%
  inner_join(ema.lmedata.bdi.stai, by="StudyID") %>%
  mutate(participant_id=factor(StudyID)) %>%
  pivot_longer(c(TaF, TaW),
               names_to="ema_variable", values_to="ema_value") %>%
  filter_at(vars(measure, ema_value), ~ !is.na(.x))
  
ema_lme_rumination.bdi.stai <- ema_lme_rumination.data.bdi.stai %>% 
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.ema.bdi.stai=map(data, ~lmerTest::lmer(ema_value ~1 +
                                        bmisds_at_date_of_research + 
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        resultquest_bdi2_total + 
                                        stai_t +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
   lme.ema.bdi.stai.tidy=map(lme.ema.bdi.stai, tidy))

ema_lme_rumination.out %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region, ema_variable) %>%
  left_join(ema_lme_rumination.bdi.stai, 
            by=c("hemi_region", "ema_variable")) %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, 
                lme.ema.bdi.stai.tidy) %>%
  unnest(lme.ema.bdi.stai.tidy) %>%
  filter(term %in% c("measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, 
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (N=52): Rumination, predicted by amygdala volumes (time model, adjusted for BDI-II total score and STAI trait anxiety)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```


```{r smleptindata, results="asis", message=FALSE, warning=FALSE}
participant_id_join_T1.sm <- sm.lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  filter(!is.na(leptin_result)) %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(participant_id)

sm.lme.leptin_pre <- sm.leptin_impute %>%
  dplyr::select(region, labeller.amy, whole.sub, extract.clmi) %>%
  group_by(labeller.amy) %>%
  mutate(rn.hemi_region=row_number()) %>%
  ungroup() %>%
  mutate(rn.total=row_number()) %>%
  mutate(
    extract.clmi.filter=map(extract.clmi, ~dplyr::select(.x, hemi_region, participant_id,
                                                         por, measure,
                                                         leptin_transform_imputed, 
                                                         age_at_date_of_research,
                                                         bmisds_at_date_of_research,
                                                         e_tiv,
                                                         leptin_batch_recoded_batch1,
                                                         leptin_batch_recoded_batch2,
                                                         leptin_batch_recoded_batch3,
                                                         leptin_batch_recoded_batch4)),
    gsdata=map(extract.clmi.filter, ~dplyr::select(.x, participant_id,
                                      bmisds_at_date_of_research, 
                                      leptin_transform_imputed)),
    gsdata=map(gsdata, ~arrange(.x, participant_id)),
    ortho_ti=map(gsdata, ~matlib::GramSchmidt(matrix(c(.x$bmisds_at_date_of_research,
                                                    .x$leptin_transform_imputed),
                                                  ncol=2, byrow=FALSE), normalize=FALSE,
                                           verbose=FALSE)),
    ortho_ti=map(ortho_ti, ~as.tibble(.x)),
    ortho_ti=map(ortho_ti, ~dplyr::rename(.x, log_leptin.clmi.ortho=V2)),
    ortho_ti=map(ortho_ti, ~dplyr::select(.x, log_leptin.clmi.ortho)),
    ortho_ti=map(ortho_ti, ~cbind(.x, participant_id_join_T1.sm)),
    ortho_ti=map(ortho_ti, ~arrange(.x, participant_id))) %>%
  dplyr::select(region, labeller.amy, whole.sub, rn.hemi_region, rn.total, gsdata, ortho_ti)
```

```{r emaruminationleptin, message=FALSE, warning=FALSE}
storage_name_join.T1 <- sm.lmedata %>%
  filter(point_of_research=="T1") %>%
  dplyr::select(storage_name, participant_id, hemi_region, labeller.amy)

mdata.leptin <- sm.lme.leptin_pre %>%
  filter(rn.hemi_region==5) %>%
  unnest(gsdata, ortho_ti) %>%
  left_join(storage_name_join.T1, by=c("participant_id", "labeller.amy")) %>%
  dplyr::select(storage_name, hemi_region, leptin_transform_imputed, log_leptin.clmi.ortho)

lme.ema.m.leptin <- ema_lme_rumination.data %>% 
  inner_join(mdata.leptin, by=c("storage_name", "hemi_region")) %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>%
  mutate(
    data=map(data, ~drop_na(.x)),
    n=map_dbl(data, ~length(unique(.x$storage_name))),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE),
                           measure.c=measure - mean(measure, na.rm=TRUE),
                           bmisds.c=bmisds_at_date_of_research -
                             mean(bmisds_at_date_of_research, na.rm=TRUE),
                           log_leptin.clmi.ortho.c=log_leptin.clmi.ortho - 
                             mean(log_leptin.clmi.ortho, na.rm=TRUE),
                           time.c=time - mean(time, na.rm=TRUE))),
    lme.emaleptin.i=map(data, ~lmerTest::lmer(ema_value ~1 +
                                                bmisds_at_date_of_research +
                                                measure*leptin_transform_imputed +
                                                poly(age.c, degree=2, raw=FALSE) +
                                                e_tiv +
                                                time +
                                                (1 | participant_id) + 
                                                (1 | participant_id:day),
                                     data=.x, REML=TRUE, na.action=na.omit)),
    lme.emaleptin.i.tidy=map(lme.emaleptin.i, tidy))

lme.ema.m.leptin %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, n, lme.emaleptin.i.tidy) %>%
  filter(hemi_region %in% c("lh_Accessory_basal_nucleus", "rh_Accessory_basal_nucleus",
                             "lh_Cortical_nucleus", "rh_Cortical_nucleus",
                             "lh_Corticoamygdaloid_transitio", 
                             "rh_Corticoamygdaloid_transitio", 
                            "lh_Medial_nucleus")) %>% 
  unnest(lme.emaleptin.i.tidy) %>%
  filter(str_detect(term, c("measure", "leptin"))) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif = as.character(asterisk_function(p.value))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, n,
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", "N",
                           "ß", "se", "t", "p", "FDR-q", "Signif?"),
               caption="HLM/LME models in AcAN-TP1 (longitudinal processing): Rumination, interaction effect measure:leptin") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

## EMA rumination - longi over course of weight-restoration

```{r ruminationlongi, results="asis", message=FALSE, warning=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

ema.person_rumination.longi <- read_excel("cache/20220517_Rumination_Personlevel.xlsx") %>%
  filter(!is.na(StudyID)&!is.na(ema_movisens_id)) %>%
  dplyr::select(StudyID, ema_movisens_id, Compliance) %>% 
  mutate(point_of_research=ifelse(str_detect(StudyID, "T1") | str_detect(StudyID, "T2"), "", 
                                  ifelse(str_detect(StudyID, "64-23-"), "_HCW", "_recAN"))) %>% 
  unite(StudyID, c("StudyID", "point_of_research"), sep="", remove=TRUE, na.rm=FALSE) %>% 
  dplyr::rename(ema_id=ema_movisens_id) %>% 
  filter(Compliance>=40)

ema.prompt_rumination.longi <- read_excel("cache/20220517_Rumination_Promptlevel.xlsx") %>%
  filter(!is.na(ema_movisens_id)&!is.na(Triggercounter)) %>%
  dplyr::select(ema_movisens_id, Triggercounter, TaF, TaW, contains("MDMQ"), time, day) %>%
  dplyr::rename(ema_id=ema_movisens_id, trigger=Triggercounter)

ema.lmedata.longi <- lmedata %>%
  unite(StudyID, c("participant_id", "point_of_research"), sep="_", remove=FALSE, na.rm=FALSE) %>%
  inner_join(ema.person_rumination.longi, by="StudyID") %>%
  semi_join(ema.prompt_rumination.longi, by="ema_id") %>%
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                          as.character(point_of_research)), levels=c("T1", "T2"))) %>%
  dplyr::select(storage_name, participant_id, point_of_research, por, tp, ema_id, Compliance, 
                hemi_region, labeller.amy,
                measure, e_tiv, age_at_date_of_research, bmisds_at_date_of_research) %>%
  group_by(hemi_region, participant_id) %>%
  arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.bmisds=ifelse(point_of_research=="T1", 
                             bmisds_at_date_of_research - lead(bmisds_at_date_of_research), 
                             0)) %>% # delta=T1-T2
  mutate(delta.measure=ifelse(point_of_research=="T1", 
                              measure - lead(measure), 0)) %>%
  ungroup() %>%
  filter(!is.na(delta.bmisds)) %>%
  inner_join(ema.prompt_rumination.longi, by="ema_id") %>%
  pivot_longer(c(TaF, TaW),
               names_to="ema_variable", values_to="ema_value")

ema.lmedata.longi %>% distinct(storage_name, .keep_all=TRUE) %>% count(point_of_research)

ema_lme_rumination.longi <- ema.lmedata.longi %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
     lme.ema=map(data, ~lmerTest::lmer(ema_value ~1 + por + 
                                        delta.bmisds +
                                        delta.measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day),
                                        data=.x, REML=TRUE, na.action=na.omit)),
     lme.ema.tidy=map(lme.ema, tidy),
     lme.ema.ranova=map(lme.ema, ~ranova(.x)),
     lme.ema.ranova=map(lme.ema.ranova, ~rownames_to_column(.x, "term")))

# LME implementation Time
ema_lme_rumination.out %>%
  filter(p.value<0.05) %>%
  dplyr::select(hemi_region, ema_variable) %>%
  left_join(ema_lme_rumination.longi, by=c("hemi_region", "ema_variable")) %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable,
                lme.ema.tidy) %>%
  unnest(lme.ema.tidy) %>%
  filter(term %in% c("delta.measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.adj))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  mutate(ema_variable=dplyr::recode(ema_variable,
                                    "TaF"="Thoughts about food",
                                    "TaW"="Thoughts about weight")) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, 
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif, adj.signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "ß", "se", "t", "p", "FDR-q", "Signif?", "Signif after FDR?"),
               caption="HLM/LME models in longitudinal sample (N=35 AcAN, N=23 RecAN, N=82 HC): Longitudinal change in rumination over the course of short-term weight-restoration, predicted by change in amygdala nuclei volumes (rostral-medial cluster filtered, Time model)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

ema_lme_rumination.longi %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, lme.ema.ranova) %>%
  filter(hemi_region %in% c("lh_Accessory_basal_nucleus", "rh_Accessory_basal_nucleus",
                             "lh_Cortical_nucleus", "rh_Cortical_nucleus",
                             "lh_Corticoamygdaloid_transitio", 
                             "rh_Corticoamygdaloid_transitio", "lh_Medial_nucleus",
                             "rh_Medial_nucleus")) %>% 
  unnest(lme.ema.ranova) %>%
  as.tibble(., .name_repair="universal") %>%
  mutate(p_formatted=ifelse(Pr..Chisq.<0.001, "<0.001", 
                            formatC(Pr..Chisq., format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  mutate(ema_variable=dplyr::recode(ema_variable,
                                    "TaF"="Thoughts about food",
                                    "TaW"="Thoughts about weight")) %>%
  dplyr::select(ema_variable, labeller.amy, term, logLik, AIC, LRT, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l",
               caption="HLM/LME models in the longitudinal study sample (Time model) - Random effects ANOVA") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")


# LME models in AcAN study group
ema_lme_rumination.acAN <- ema.lmedata.longi %>%
  filter(por=="acAN") %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.ema.v1=map(data, ~lmerTest::lmer(ema_value ~1 + tp +
                                        bmisds_at_date_of_research +
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        trigger +
                                        (1 + trigger | participant_id) +
                                        (1 | participant_id:day),
                                        data=.x, REML=TRUE, na.action=na.omit)),
     lme.ema.v1.tidy=map(lme.ema.v1, tidy),
     lme.ema.v1.ranova=map(lme.ema.v1, ~ranova(.x)),
     lme.ema.v1.ranova=map(lme.ema.v1.ranova, ~rownames_to_column(.x, "term")))

ema_lme_rumination.v1 %>%
  filter(p.adj<0.05) %>%
  distinct(hemi_region) %>%
  inner_join(ema_lme_rumination.acAN, by="hemi_region")  %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, lme.ema.v1.tidy) %>%
  unnest(lme.ema.v1.tidy) %>%
  filter(str_detect(term, "measure")) %>%
  mutate(p.adj=p.adjust(p.value, method="fdr")) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.adj))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(p.adj_formatted=ifelse(p.adj<0.001, "<0.001", 
                            formatC(p.adj, format="f", digits=3))) %>%
  arrange(hemi_region) %>%
  mutate(ema_variable=dplyr::recode(ema_variable,
                                    "TaF"="Thoughts about food",
                                    "TaW"="Thoughts about weight")) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, 
                estimate, std.error, statistic, 
                p_formatted, p.adj_formatted, signif, adj.signif) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", 
                           "ß", "se", "t", "p", "FDR-q", "Signif?", "Signif after FDR?"),
               caption="HLM/LME models in AcAN (longitudinal, N=35): Rumination, predicted by amygdala volumes (rostral-medial cluster filtered, Trigger model)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

   
### Rumination: Longitudinal leptin
```{r ruminationlongileptin, results="asis", message=FALSE, warning=FALSE}
storage_name_join <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, delta.bmisds)

lme.ema.leptin.data <- lme.leptin_pre %>%
  unnest(data, ortho, ortho_ti) %>%
  filter(hemi_region=="lh_Medial_nucleus") %>%
  filter(rn.hemi_region==50) %>%
  left_join(storage_name_join, by=c("participant_id", "delta.bmisds")) %>%
  dplyr::select(storage_name, participant_id, por, hemi_region, delta.log_leptin.clmi.ortho,
                leptin_transform_imputed, log_leptin.clmi.ortho,
                #rn.hemi_region, rn.total
                ) %>%
  group_by(participant_id) %>% 
  mutate(nomatch=ifelse((por=="acAN") & (n()<2), TRUE, FALSE)) %>%
  ungroup() %>%
  filter(nomatch==FALSE) %>%
  left_join(ema.lmedata.longi, by=c("storage_name", "hemi_region", "participant_id", "por")) %>%
  filter(!is.na(trigger) & !is.na(delta.log_leptin.clmi.ortho)) 

lme.ema.leptin.data %>% distinct(storage_name, .keep_all=TRUE) %>% count(point_of_research)

lme.ema.leptin <- lme.ema.leptin.data %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.te=map(data, ~lmerTest::lmer(ema_value ~1 + por +
                                       delta.bmisds +
                                       delta.log_leptin.clmi.ortho + 
                                       poly(age.c, degree=2, raw=FALSE) +
                                       etiv.c +
                                       trigger +
                                       (1 + trigger | participant_id) +
                                       (1 | participant_id:day),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.te.tidy=map(lme.te, tidy), 
    lme.dv=map(data, ~lmerTest::lmer(ema_value ~1 + por +
                                       delta.bmisds +
                                       delta.log_leptin.clmi.ortho*delta.measure + 
                                       poly(age.c, degree=2, raw=FALSE) +
                                       etiv.c +
                                       time +
                                       (1 | participant_id) +
                                       (1 | participant_id:day),
                                     data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv.tidy=map(lme.dv, tidy))

lme.ema.leptin.out <- lme.ema.leptin %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.te.tidy) %>%
  unnest(lme.te.tidy) %>%
  filter(str_detect(term, c("leptin"))) %>%
  arrange(p.value) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3)))

lme.ema.leptin.out %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) 

lme.ema.leptin %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.dv.tidy) %>%
  unnest(lme.dv.tidy) %>%
  #filter(str_detect(term, c("leptin"))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models: Change in log10-leptin*AmyVolume interaction as predictor for EMA rumination (N=27 AcAN, N=23 RecAN, N=82 HC)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")




lme.ema.leptin.acAN <- lme.ema.leptin.data %>%
  filter(por=="acAN") %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.te=map(data, ~lmerTest::lmer(ema_value ~1 + tp +
                                        bmisds_at_date_of_research +
                                        log_leptin.clmi.ortho + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 + trigger | participant_id) +
                                        (1 | participant_id:day),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.te.tidy=map(lme.te, tidy),
    lme.dv=map(data, ~lmerTest::lmer(ema_value ~1 +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho*delta.measure +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c+
                                        time +
                                        (1 | participant_id) +
                                        (1 | participant_id:day),
                                     data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv.tidy=map(lme.dv, tidy))

lme.ema.leptin.acAN %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.te.tidy) %>%
  unnest(lme.te.tidy) %>%
  #filter(str_detect(term, c("leptin"))) %>%
  #arrange(p.value) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models: Change in log10-leptin as predictor for EMA rumination (N=27 AcAN)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

lme.ema.leptin.acAN %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.dv.tidy) %>%
  unnest(lme.dv.tidy) %>%
  filter(str_detect(term, c("measure|leptin"))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted)  %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models: Change in log10-leptin as predictor for EMA rumination (N=27 AcAN)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")




lme.ema.mediation <- lme.ema.leptin.data %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.mediator=map(data, ~lme4::lmer(delta.measure ~1 +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        trigger +
                                        (1 + trigger | participant_id),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv=map(data, ~lme4::lmer(ema_value ~1 +
                                       delta.bmisds +
                                       delta.log_leptin.clmi.ortho*delta.measure +
                                       poly(age.c, degree=2, raw=FALSE) +
                                       etiv.c +
                                       trigger +
                                       (1 + trigger | participant_id),
                                     data=.x, REML=TRUE, na.action=na.omit))) %>% 
  unite("med.term", c(ema_variable, hemi_region), sep="_", remove=FALSE, na.rm=FALSE)

set.seed(123456)

medlist_ema=list()

for (MedTerm in unique(lme.ema.mediation$med.term)) {
  
  lme <- lme.ema.mediation %>% filter(med.term==MedTerm)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=100, boot=FALSE)
  
  class(med.model) <- "mediate"
  
  med.model <- tidy(med.model)
  
  medlist_ema[[MedTerm]]=med.model
}

tibble(names(medlist_ema), medlist_ema) %>%
  unnest(medlist_ema) %>%
  filter(str_detect(term, "acme_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects")) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::rename(med.term="names(medlist_ema)") %>%
  dplyr::select(med.term, term, estimate, std.error, p) %>%
  knitr::kable(format="html", digits=4, align="l", 
               col.names=c("EMA_Nucleus", "Mediation term",
                           "beta", "se", "p"), 
               caption="Mediation models - Leptin (log10)/AmyVolume/EMA data") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")


lme.ema.mediation.acan <- lme.ema.leptin.data %>%
  filter(por=="acAN") %>% 
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.mediator=map(data, ~lme4::lmer(measure ~1 + tp +
                                        bmisds_at_date_of_research +
                                        log_leptin.clmi.ortho + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        trigger +
                                        (1 + trigger | participant_id),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv=map(data, ~lme4::lmer(ema_value ~1 + tp + 
                                       bmisds_at_date_of_research +
                                       log_leptin.clmi.ortho + 
                                       measure +
                                       poly(age.c, degree=2, raw=FALSE) +
                                       etiv.c +
                                       time +
                                   (1 | participant_id) +
                                   (1 | participant_id:day),
                                 data=.x, REML=TRUE, na.action=na.omit))) %>% 
  unite("med.term", c(ema_variable, hemi_region), sep="_", remove=FALSE, na.rm=FALSE)

set.seed(123456)

medlist_ema.acan=list()

for (MedTerm in unique(lme.ema.mediation.acan$med.term)) {
  
  lme <- lme.ema.mediation.acan %>% filter(med.term==MedTerm)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="log_leptin.clmi.ortho", 
                                  mediator="measure", sims=1000, boot=FALSE)
  
  class(med.model) <- "mediate"
  
  med.model <- tidy(med.model)
  
  medlist_ema.acan[[MedTerm]]=med.model
}

tibble(names(medlist_ema.acan), medlist_ema.acan) %>%
  unnest(medlist_ema.acan) %>%
  #filter(str_detect(term, "acme_0")) %>%
  #mutate(term=dplyr::recode(term,
                            #"acme_0"="Average causal mediation effects")) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::rename(med.term="names(medlist_ema.acan)") %>%
  dplyr::select(med.term, term, estimate, std.error, p) %>%
  knitr::kable(format="html", digits=4, align="l", 
               col.names=c("EMA_Nucleus", "Mediation term",
                           "beta", "se", "p"), 
               caption="Mediation models - Leptin (log10)/AmyVolume/EMA data in AcAN") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```







## EMA descriptives

```{r emaNegativeAffectdesc, results="asis", message=FALSE, warning=FALSE}
# Note: D.f. calculations have been disabled because the number of observations exceeds 3000.
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

emm_options(lmerTest.limit = 100000)

redcap_ema_desc <- redcap %>% # Compliance >=40%
  filter(!is.na(ema_movisens_id)) %>%
  semi_join(sm.sample, by="storage_name") %>%
  dplyr::select(storage_name, participant_id, point_of_research, 
                ema_paradigm, 
                #ema_movisens_id, ema_rumination_food, ema_rumination_weight, 
                ema_compliance, age_at_date_of_research)

redcap_ema <- redcap %>% # Compliance >=40%
  filter(!is.na(ema_movisens_id)) %>%
  dplyr::select(storage_name, 
                ema_paradigm, 
                #ema_movisens_id, ema_rumination_food, ema_rumination_weight, 
                ema_compliance)

lmedata_ema <- lmedata %>%
  dplyr::select(-c(contains("delta."), contains("T1"))) %>%
  group_by(hemi_region, participant_id) %>% 
  arrange(point_of_research, .by_groucase_whenp=TRUE) %>%
  mutate(delta.bmisds=ifelse(point_of_research=="T1", 
                             bmisds_at_date_of_research - 
                               lead(bmisds_at_date_of_research), 
                             0)) %>% # delta=T1-T2
  mutate(delta.measure=ifelse(point_of_research=="T1", 
                                 measure - lead(measure),
                                 0)) %>%
  mutate(delta.age=ifelse(point_of_research=="T1", 
                          age_at_date_of_research - lead(age_at_date_of_research),
                          0)) %>%
  ungroup() 

# Negative affect
ema.data.person_na <- read_delim("cache/ema_person.csv", delim=",") %>% 
  filter(!storage_name %in% c("64-10-380-1_T2_conni", "64-10-384-1_T2_conni")) %>% # Remove matching errors/duplicate EMA IDs
  dplyr::select(StudyID, participant_id, ema_movisens_id, point_of_research) %>% 
  dplyr::rename(ema_id=ema_movisens_id) %>% 
  extract(StudyID, "StudyID_comp", "([^.|^_]*)", remove=FALSE) %>%
  mutate(id.match_correct=ifelse(StudyID_comp==participant_id, TRUE, FALSE)) %>%
  mutate(point_of_research=factor(dplyr::recode(point_of_research,
                                         "0"="T1",
                                         "1"="T2",
                                         "2"="recAN",
                                         "3"="HCW"))) %>%
  dplyr::select(ema_id, participant_id, point_of_research)

ema.lme.data <- read_delim("cache/ema_prompt.csv", delim=",") %>%
  dplyr::rename(ema_id=ema_movisens_id, trigger=Triggercounter) %>%
  dplyr::select(-participant_id) %>%
  filter(!is.na(trigger)) %>%
  group_by(ema_id, trigger) %>%
  distinct(trigger, .keep_all=TRUE) %>%
  ungroup() %>%
  left_join(ema.data.person_na, by="ema_id") %>%
  filter(!is.na(participant_id)) %>%
  inner_join(lmedata_ema, by=c("participant_id", "point_of_research")) %>%
  left_join(redcap_ema, by="storage_name") %>%
  filter(ema_compliance>=40) %>%
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                          as.character(point_of_research)), levels=c("T1", "T2"))) %>%
  mutate(study_day=case_when(
    ema_paradigm=="Rumination" & trigger %in% c(1:7) ~ 1, # Rumination study: 7 prompts/day
    ema_paradigm=="Rumination" & trigger %in% c(8:14) ~ 2,
    ema_paradigm=="Rumination" & trigger %in% c(15:21) ~ 3,
    ema_paradigm=="Rumination" & trigger %in% c(22:28) ~ 4,
    ema_paradigm=="Rumination" & trigger %in% c(29:35) ~ 5,
    ema_paradigm=="Rumination" & trigger %in% c(36:42) ~ 6,
    ema_paradigm=="Rumination" & trigger %in% c(43:49) ~ 7,
    ema_paradigm=="Rumination" & trigger %in% c(50:56) ~ 8,
    ema_paradigm=="Rumination" & trigger %in% c(57:63) ~ 9,
    ema_paradigm=="Rumination" & trigger %in% c(64:70) ~ 10,
    ema_paradigm=="Rumination" & trigger %in% c(71:77) ~ 11,
    ema_paradigm=="Rumination" & trigger %in% c(78:84) ~ 12,
    ema_paradigm=="Rumination" & trigger %in% c(85:91) ~ 13,
    ema_paradigm=="Rumination" & trigger %in% c(92:98) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(1:8) ~ 1, # Habit study: 8 prompts/day
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(9:16) ~ 2,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(17:24) ~ 3,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(25:32) ~ 4,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(33:40) ~ 5,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(41:48) ~ 6,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(49:56) ~ 7,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(47:64) ~ 8,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(65:72) ~ 9,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(73:80) ~ 10,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(81:88) ~ 11,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(89:96) ~ 12,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(97:104) ~ 13,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(105:112) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(113:120) ~ 15)) %>%
  mutate(participant_id=factor(participant_id), por=factor(por)) %>%
  pivot_longer(c(MDMQ_Calmness, MDMQ_Valence),
               names_to="ema_variable", values_to="ema_value") %>% 
  dplyr::select(storage_name, participant_id, ema_id, ema_variable,
                hemi_region, region, labeller.amy, por, tp, trigger, study_day, 
                delta.bmisds, bmisds_at_date_of_research, age_at_date_of_research, e_tiv, 
                delta.age, delta.measure, measure,
                ema_value)

# Descriptive statistics/group differences
ema.data_na_descriptives <- read_delim("cache/ema_prompt.csv", delim=",") %>%
  dplyr::rename(ema_id=ema_movisens_id, trigger=Triggercounter) %>%
  dplyr::select(-participant_id) %>%
  filter(!is.na(trigger)) %>%
  group_by(ema_id, trigger) %>%
  distinct(trigger, .keep_all=TRUE) %>%
  ungroup() %>%
  left_join(ema.data.person_na, by="ema_id") %>%
  filter(!is.na(participant_id)) %>%
  inner_join(redcap_ema_desc, by=c("participant_id", "point_of_research")) %>%
  filter(ema_compliance>=40) %>%
  mutate(study_day=case_when(
    ema_paradigm=="Rumination" & trigger %in% c(1:7) ~ 1, # Rumination study: 7 prompts/day
    ema_paradigm=="Rumination" & trigger %in% c(8:14) ~ 2,
    ema_paradigm=="Rumination" & trigger %in% c(15:21) ~ 3,
    ema_paradigm=="Rumination" & trigger %in% c(22:28) ~ 4,
    ema_paradigm=="Rumination" & trigger %in% c(29:35) ~ 5,
    ema_paradigm=="Rumination" & trigger %in% c(36:42) ~ 6,
    ema_paradigm=="Rumination" & trigger %in% c(43:49) ~ 7,
    ema_paradigm=="Rumination" & trigger %in% c(50:56) ~ 8,
    ema_paradigm=="Rumination" & trigger %in% c(57:63) ~ 9,
    ema_paradigm=="Rumination" & trigger %in% c(64:70) ~ 10,
    ema_paradigm=="Rumination" & trigger %in% c(71:77) ~ 11,
    ema_paradigm=="Rumination" & trigger %in% c(78:84) ~ 12,
    ema_paradigm=="Rumination" & trigger %in% c(85:91) ~ 13,
    ema_paradigm=="Rumination" & trigger %in% c(92:98) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(1:8) ~ 1, # Habit study: 8 prompts/day
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(9:16) ~ 2,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(17:24) ~ 3,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(25:32) ~ 4,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(33:40) ~ 5,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(41:48) ~ 6,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(49:56) ~ 7,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(47:64) ~ 8,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(65:72) ~ 9,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(73:80) ~ 10,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(81:88) ~ 11,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(89:96) ~ 12,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(97:104) ~ 13,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(105:112) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(113:120) ~ 15)) %>%
  mutate(participant_id=factor(participant_id)) %>%
  mutate(point_of_research=factor(point_of_research,
                                  levels=c("T1", "T2", "recAN", "HCW"))) %>%
  mutate(por=factor(ifelse(point_of_research %in% c("recAN", "HCW"),
                                as.character(point_of_research), "acAN"),
                    levels=c("acAN", "recAN", "HCW"))) %>% 
  mutate(tp=factor(ifelse(point_of_research %in% c("recAN", "HCW"), "T1",
                             as.character(point_of_research)), levels=c("T1", "T2"))) %>%
  pivot_longer(c(MDMQ_Calmness, MDMQ_Energy, MDMQ_Valence),
               names_to="ema_variable", values_to="ema_value") 

ema.data_na_descriptives %>% 
  distinct(storage_name, .keep_all=TRUE) %>% 
  group_by(point_of_research) %>% count() %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Study groups", "N"), 
               caption="Number of participants with EMA Negative Affect Data") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")

# Custom contrast setting
acAN_TP1.ema=c(1, 0, 0, 0, 0, 0)
recAN.ema=c(0, 1, 0, 0, 0, 0)
HC.ema=c(0, 0, 1, 0, 0, 0)
acAN_TP2.ema=c(0, 0, 0, 1, 0, 0)

anovas.ema <- ema.data_na_descriptives %>% 
  nest(data=-ema_variable) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    lme.ema=map(data, ~lme4::lmer(ema_value ~1 + por + tp +
                                    trigger +
                                    (1 | participant_id) +
                                    (1 | participant_id : study_day),
                                   # (1 | Subj / Day) => (1 | Subj) + (1 | Subj : Day) 
                                  data=.x, REML=TRUE, na.action=na.omit)),
    emmeans=map(lme.ema, ~emmeans::emmeans(.x, c("por", "tp"), 
                                       lmer.df="satterthwaite", type="response")),
    emmeanstidy=map(emmeans, tidy),
    contrasts=map(emmeans, ~emmeans::contrast(.x, method=list(
      "AcAN-TP1vsHC"=acAN_TP1.ema - HC.ema,
      "AcAN-TP2vsAcAN-TP1"=acAN_TP2.ema - acAN_TP1.ema,
      #"AcAN-TP2vsRecAN"=acAN_TP2.ema - recAN.ema,
      "AcAN-TP2vsHC"=acAN_TP2.ema - HC.ema,
      "RecANvsHC"=recAN.ema - HC.ema), lmer.df="satterthwaite", adjust="fdr")),
    contraststidy=map(contrasts, tidy),
    anova=map(data, ~anova(lmerTest::lmer(ema_value ~1 + por + tp + 
                                            trigger + 
                                            (1 | participant_id) +
                                            (1 | participant_id : study_day),
                                          data=.x, REML=TRUE, na.action=na.omit),
                              type="III", ddf="Satterthwaite")),
    anova=map(anova, ~rownames_to_column(.x, "term"))) %>%
  dplyr::select(ema_variable, anova, contraststidy, emmeanstidy)

anovas.ema.out <- anovas.ema %>%
  dplyr::select(ema_variable, anova) %>%
  unnest(anova) %>%
  as.tibble(., .name_repair="universal") %>%
  filter(term %in% c("por", "tp")) %>%
  nest(effdata=c(F.value, NumDF, DenDF)) %>%
  mutate(p.eta.sq=map(effdata, ~F_to_eta2(.x$F.value, .x$NumDF, .x$DenDF, ci=0.95,
                                            alternative="two.sided"))) %>%
  unnest(effdata, p.eta.sq) %>%
  mutate(p.eta.sq_formatted=ifelse(abs(Eta2_partial)<0.01, "<0.01", 
                            formatC(abs(Eta2_partial), format="f", digits=2))) %>%
  group_by(ema_variable) %>%
  mutate(F.value=formatC(F.value, format="f", big.mark=",", digits=2)) %>%
  mutate(F.value=paste(F.value, collapse=" | ")) %>%
  mutate(p_formatted=ifelse(Pr..F.<0.001, "<0.001", 
                            formatC(Pr..F., format="f", digits=3))) %>%
  mutate(p_formatted=paste(p_formatted, collapse=" | ")) %>%
  mutate(p.eta.sq_formatted=paste(p.eta.sq_formatted, collapse=" | ")) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(ema_variable, F.value, p_formatted, p.eta.sq_formatted)
  
contrasts.ema.out <- anovas.ema %>%
  dplyr::select(ema_variable, contraststidy) %>%
  unnest(contraststidy) %>%
  mutate(comparison=ifelse(statistic>0, ">", "<")) %>%
  mutate(comparison=str_replace(contrast, "vs", comparison)) %>%
  filter(adj.p.value<0.05) %>% # only significant post-hoc contrasts are shown
  mutate(p.fdr_formatted=ifelse(adj.p.value<0.001, "<0.001", 
                                formatC(adj.p.value, format="f", digits=3))) %>%
  mutate(brackets01=ifelse(adj.p.value<0.001, " (p", " (p=")) %>%
  mutate(brackets02=")") %>%
  unite("posthoc", c(comparison, brackets01, p.fdr_formatted, brackets02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  group_by(ema_variable) %>%
  dplyr::summarize(posthoc=paste(posthoc, collapse=" | ")) %>%
  dplyr::select(ema_variable, posthoc)

# Based on estimated marginal means (model estimates)
emmeans.ema.out <- anovas.ema %>%
  dplyr::select(ema_variable, emmeanstidy) %>%
  unnest(emmeanstidy) %>%
  mutate(emmeans=case_when(
    por=="acAN" & tp=="T1" ~ "AcAN-TP1",
    por=="acAN" & tp=="T2" ~ "AcAN-TP2",
    por=="recAN" & tp=="T1" ~ "RecAN",
    por=="HCW" & tp=="T1" ~ "HC")) %>%
  filter(!is.na(emmeans)) %>% 
  mutate(emmeans=factor(emmeans, levels=c("AcAN-TP1", "AcAN-TP2", "RecAN", "HC"))) %>%
  mutate(estimate=formatC(estimate, format="f", digits=2),
         std.error=formatC(std.error, format="f", digits=2)) %>%
  unite("emm_sem", c(estimate, std.error), sep=" ± ", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(ema_variable, emmeans, emm_sem)
  
emmeans.ema.out.T1 <- emmeans.ema.out %>%
  filter(emmeans=="AcAN-TP1") %>%
  dplyr::select(ema_variable, emm_sem)

emmeans.ema.out.T2 <- emmeans.ema.out %>%
  filter(emmeans=="AcAN-TP2") %>%
  dplyr::select(ema_variable, emm_sem)

emmeans.ema.out.recAN <- emmeans.ema.out %>%
  filter(emmeans=="RecAN") %>%
  dplyr::select(ema_variable, emm_sem)

emmeans.ema.out.HC <- emmeans.ema.out %>%
  filter(emmeans=="HC") %>%
  dplyr::select(ema_variable, emm_sem)

emmeans.ema.out.T1 %>%
  left_join(emmeans.ema.out.T2, by="ema_variable") %>%
  left_join(emmeans.ema.out.recAN, by="ema_variable") %>%
  left_join(emmeans.ema.out.HC, by="ema_variable") %>%
  left_join(anovas.ema.out, by="ema_variable") %>%
  left_join(contrasts.ema.out, by="ema_variable") %>%
  knitr::kable(format="html", align="l", 
               col.names=c("EMA variable", 
                           "AcAN-TP1 (EMM +/- SEM",
                           "AcAN-TP2 (EMM +/- SEM",
                           "RecAN (EMM +/- SEM)",
                           "HC (EMM +/- SEM)",
                           "F", "p", "Partial eta sq.",
                           "Post-hoc contrasts (q<0.05)"),
               caption="EMA - HLM/linear mixed effects model group comparisons") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## EMA in AcAN-TP1

```{r emaNegativeAffectlmeT1, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
setwd("/Users/marie-louis/Desktop/Projects/02_Amygdala_Hippocampus/02_longi_project/analyses")
getwd()

# LME models in acAN at TP1
reduce.T1 <- sm.contrasts %>%
  filter(p.fdr_formatted<0.05) %>%
  dplyr::select(hemi_region)

ema.lme.T1.longi <- read_delim("cache/ema_prompt.csv", delim=",") %>%
  dplyr::rename(ema_id=ema_movisens_id, trigger=Triggercounter) %>%
  dplyr::select(-participant_id) %>%
  filter(!is.na(trigger)) %>%
  group_by(ema_id, trigger) %>%
  distinct(trigger, .keep_all=TRUE) %>%
  ungroup() %>%
  left_join(ema.data.person_na, by="ema_id") %>%
  filter(!is.na(participant_id)) %>%
  inner_join(lmedata_ema, by=c("participant_id", "point_of_research")) %>%
  left_join(redcap_ema, by="storage_name") %>%
  filter(ema_compliance>=40) %>%
  filter(point_of_research=="T1") %>%
  #semi_join(reduce.T1, by="hemi_region") %>%
  mutate(study_day=case_when(
    ema_paradigm=="Rumination" & trigger %in% c(1:7) ~ 1, # Rumination study: 7 prompts/day
    ema_paradigm=="Rumination" & trigger %in% c(8:14) ~ 2,
    ema_paradigm=="Rumination" & trigger %in% c(15:21) ~ 3,
    ema_paradigm=="Rumination" & trigger %in% c(22:28) ~ 4,
    ema_paradigm=="Rumination" & trigger %in% c(29:35) ~ 5,
    ema_paradigm=="Rumination" & trigger %in% c(36:42) ~ 6,
    ema_paradigm=="Rumination" & trigger %in% c(43:49) ~ 7,
    ema_paradigm=="Rumination" & trigger %in% c(50:56) ~ 8,
    ema_paradigm=="Rumination" & trigger %in% c(57:63) ~ 9,
    ema_paradigm=="Rumination" & trigger %in% c(64:70) ~ 10,
    ema_paradigm=="Rumination" & trigger %in% c(71:77) ~ 11,
    ema_paradigm=="Rumination" & trigger %in% c(78:84) ~ 12,
    ema_paradigm=="Rumination" & trigger %in% c(85:91) ~ 13,
    ema_paradigm=="Rumination" & trigger %in% c(92:98) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(1:8) ~ 1, # Habit study: 8 prompts/day
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(9:16) ~ 2,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(17:24) ~ 3,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(25:32) ~ 4,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(33:40) ~ 5,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(41:48) ~ 6,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(49:56) ~ 7,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(47:64) ~ 8,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(65:72) ~ 9,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(73:80) ~ 10,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(81:88) ~ 11,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(89:96) ~ 12,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(97:104) ~ 13,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(105:112) ~ 14,
    ema_paradigm=="Habit/Self-Control" & trigger %in% c(113:120) ~ 15)) %>%
  mutate(participant_id=factor(participant_id)) %>%
  dplyr::select(storage_name, ema_id, participant_id, point_of_research,
                hemi_region, region, labeller.amy, bmisds_at_date_of_research,
                MDMQ_Calmness, MDMQ_Valence, trigger, study_day,
                age_at_date_of_research, e_tiv, measure) %>% 
  pivot_longer(c(MDMQ_Calmness, MDMQ_Valence),
               names_to="ema_variable", values_to="ema_value") %>% 
  nest(data=-c(ema_variable, hemi_region, region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE))),
    lme.ema=map(data, ~lmerTest::lmer(ema_value ~1 + 
                                        bmisds_at_date_of_research +
                                        measure + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        e_tiv +
                                        trigger +
                                        (1 + trigger | participant_id),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.ema.tidy=map(lme.ema, tidy))


ema.lme.T1.longi %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, lme.ema.tidy) %>%
  unnest(lme.ema.tidy) %>%
  filter(term=="measure") %>%
  filter(p.value<0.05) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, term, effect, 
                #estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("EMA variable","AmyVolume", "Term", "LME effect", #"ß", "se", 
                           "t", "p"),
               caption="HLM/LME models in AcAN-TP1 (longi processing): (negative) affect, predicted by amygdala volumes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

## EMA all groups

LME model with level-1 random effects

```{r emaNegativeAffectlmeALL, results="asis", message=FALSE, warning=FALSE}
#ema.lme.data %>%
  #filter((ema_variable=="MDMQ_Calmness")&(hemi_region=="lh_Medial_nucleus")) %>%
  #write_csv("emadata.csv")

# LME models change
ema.lme <- ema.lme.data %>%
  nest(data=-c(ema_variable, hemi_region, region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE))),
    lme.ema=map(data, ~lmerTest::lmer(ema_value ~1 + por + # por stands for AcAN, RecAN, HC
                                        delta.bmisds + # distinguishes AcAN-TP1 vs. AcAN-TP2
                                        delta.measure + # significant volumetric change (increase) in AcAN
                                        poly(age.c, degree=2, raw=FALSE) + # global covariate
                                        #delta.etiv + # equals 0, no change in eTIV, delta.eTIV is not relevant for RecAN and HC since delta.measure is 0
                                        trigger +
                                        (1 + trigger | participant_id),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.ema.tidy=map(lme.ema, tidy))

contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>%
  left_join(ema.lme, by="hemi_region")  %>%
  dplyr::select(labeller.amy, hemi_region, ema_variable, lme.ema.tidy) %>%
  unnest(lme.ema.tidy) %>%
  filter(str_detect(term, c("delta.measure"))) %>%
  #filter(p.value<0.05) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  mutate(estimate=formatC(estimate, format="f", digits=2)) %>%
  mutate(std.error=formatC(std.error, format="f", digits=2)) %>%
  mutate(statistic=formatC(statistic, format="f", digits=2)) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error,
                statistic, p_formatted) %>%
  #write_csv("lmeoutput_example.csv")
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models in all study groups: (negative) affect, 
              predicted by amygdala volumes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

## EMA longitudinal AcAN

```{r emaAcAN, results="asis", message=FALSE, warning=FALSE}
ema.lme.acan <- ema.lme.data %>%
  filter(por=="acAN") %>%
  dplyr::select(storage_name, participant_id, tp, 
                ema_variable, hemi_region, labeller.amy,
                trigger, study_day, 
                delta.bmisds, bmisds_at_date_of_research, 
                delta.age, age_at_date_of_research,
                delta.measure, measure, e_tiv,
                ema_value) %>% 
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)),
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.ema.acan=map(data, ~lmerTest::lmer(ema_value ~1 + tp +
                                             bmisds_at_date_of_research +
                                             measure +
                                             poly(age.c, degree=2, raw=FALSE) +
                                             e_tiv +
                                             trigger +
                                             (1 + trigger | participant_id) +
                                             (1 | participant_id : study_day),
                                           data=.x, REML=TRUE, na.action=na.omit)),
    lme.ema.tidy.acan=map(lme.ema.acan, tidy))

contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>%
  left_join(ema.lme.acan, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable,lme.ema.tidy.acan) %>%
  unnest(lme.ema.tidy.acan) %>%
  #filter(str_detect(term, c("measure"))) %>%
  #filter(p.value<0.05) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models in AcAN (longitudinal): (negative) affect") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```

# EMA leptin levels

```{r emaLeptin, results="asis", message=FALSE, warning=FALSE}
storage_name_join <- lmedata %>%
  distinct(storage_name, .keep_all=TRUE) %>%
  dplyr::select(storage_name, participant_id, por, delta.bmisds)

lme.ema.leptin.data <- lme.leptin.lin %>%
  filter(p.value<0.05) %>%
  dplyr::select(labeller.amy) %>%
  left_join(lme.leptin_pre, by="labeller.amy") %>%
  unnest(data, ortho, ortho_ti) %>%
  filter(rn.hemi_region==50) %>%
  left_join(storage_name_join, by=c("participant_id", "por", "delta.bmisds")) %>%
  dplyr::select(storage_name, hemi_region, delta.log_leptin.clmi.ortho,
                leptin_transform_imputed, log_leptin.clmi.ortho,
                #rn.hemi_region, rn.total, leptin_transform_imputed, 
                #delta.log_leptin.clmi, delta.log_leptin.clmi.ortho,
                #leptin_batch_recoded_batch1, leptin_batch_recoded_batch2,
                #leptin_batch_recoded_batch3, leptin_batch_recoded_batch4
                ) %>%
  left_join(ema.lme.data, by=c("storage_name", "hemi_region")) %>%
  filter(!is.na(trigger)) %>% filter(!is.na(delta.log_leptin.clmi.ortho)) 

lme.ema.leptin <- lme.ema.leptin.data %>%
  #filter(por=="acAN") %>%
  nest(data=-c(ema_variable, hemi_region, region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.te=map(data, ~lmerTest::lmer(ema_value ~1 + por +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        #etiv.c +
                                        trigger +
                                        (1 + trigger | participant_id) +
                                        (1 | participant_id : study_day),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    #lme.te=map(data, ~lmerTest::lmer(ema_value ~1 +
                                       #bmisds_at_date_of_research +
                                       #log_leptin.clmi.ortho +
                                       #poly(age.c, degree=2, raw=FALSE) +
                                       #e_tiv +
                                       #trigger +
                                       #(1 | participant_id),
                                #data=.x, REML=TRUE, na.action=na.omit)),
    lme.te.tidy=map(lme.te, tidy))

lme.ema.leptin.out <- lme.ema.leptin %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.te.tidy) %>%
  unnest(lme.te.tidy) %>%
  filter(str_detect(term, c("leptin"))) %>%
  arrange(p.value) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3)))

lme.ema.leptin.out %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models: Change in log10-leptin as predictor for EMA negative affect") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")



lme.ema.leptin %>%
  dplyr::select(hemi_region, labeller.amy, ema_variable, lme.dv.tidy) %>%
  unnest(lme.dv.tidy) %>%
  #filter(str_detect(term, c("leptin"))) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(ema_variable, labeller.amy, effect, term,
                estimate, std.error, 
                statistic, p_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               caption="HLM/LME models: Change in log10-leptin*AmyVolume interaction as predictor for EMA rumination (N=27 AcAN, N=23 RecAN, N=82 HC)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")


lme.ema.mediation <- lme.ema.leptin.data %>%
  #filter(por=="acAN") %>%
  nest(data=-c(ema_variable, hemi_region, labeller.amy)) %>% 
  mutate(
    data=map(data, ~drop_na(.x)), 
    data=map(data, ~mutate(.x, 
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme.mediator=map(data, ~lme4::lmer(delta.measure ~1 +
                                        delta.bmisds +
                                        delta.log_leptin.clmi.ortho + 
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c +
                                        trigger +
                                        (1 + trigger | participant_id),
                                  data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv=map(data, ~lmerTest::lmer(ema_value ~1 +
                                       delta.bmisds +
                                       delta.measure*delta.log_leptin.clmi.ortho + 
                                       poly(age.c, degree=2, raw=FALSE) +
                                       etiv.c +
                                       trigger +
                                       (1 + trigger | participant_id),
                                     data=.x, REML=TRUE, na.action=na.omit)),
    lme.dv.tidy=map(lme.dv, tidy)) %>% 
  unite("med.term", c(ema_variable, hemi_region), sep="_", remove=FALSE, na.rm=FALSE)

lme.ema.mediation %>%
  dplyr::select(ema_variable, labeller.amy, lme.dv.tidy)  %>%
  unnest(lme.dv.tidy) %>%
  filter(str_detect(term, c("measure|leptin"))) %>%
  dplyr::select(-df) %>%
  knitr::kable(format="html", digits=4, align="l", 
               caption="HLM/LME models: Change in log10-leptin as predictor for EMA negative affect") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

set.seed(123456)

medlist_ema=list()

for (MedTerm in unique(lme.ema.mediation$med.term)) {
  
  lme <- lme.ema.mediation %>% filter(med.term==MedTerm)
  
  lme.mediator <- lme$lme.mediator[[1]]
  
  lme.dv <- lme$lme.dv[[1]]
  
  med.model <- mediation::mediate(lme.mediator, lme.dv, 
                                  treat="delta.log_leptin.clmi.ortho", 
                                  mediator="delta.measure", sims=100, boot=FALSE)
  
  class(med.model) <- "mediate"
  
  med.model <- tidy(med.model)
  
  medlist_ema[[MedTerm]]=med.model
}

tibble(names(medlist_ema), medlist_ema) %>%
  unnest(medlist_ema) %>%
  filter(str_detect(term, "acme_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects")) %>%
  arrange(p.value) %>%
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::rename(med.term="names(medlist_ema)") %>%
  dplyr::select(med.term, term, estimate, std.error, p) %>%
  knitr::kable(format="html", digits=4, align="l", 
               col.names=c("EMA_Nucleus", "Mediation term",
                           "beta", "se", "p"), 
               caption="Mediation models - Leptin (log10)/AmyVolume/EMA data") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

```{r mediationlogleptin, message=FALSE, warning=FALSE}
set.seed(123456)

medlist_leptin=list()

for (RN in unique(lm.med$rn)) {
  
  lm <- lm.med %>% filter(rn==RN)
  
  lm.mediator <- lm$lm.mediator[[1]]
  
  lm.dv <- lm$lm.dv[[1]]
  
  med.model <- mediation::mediate(lm.mediator, lm.dv, 
                                  treat="leptin.ortho", 
                                  mediator="measure", sims=100, boot=TRUE,
                                  boot.ci.type="perc") 
  
  class(med.model) <- "mediate"
  
  medlist_leptin[[RN]]=med.model
}

tibble(names(medlist_leptin), medlist_leptin) %>%
  dplyr::rename(names="names(medlist_leptin)") %>%
  extract(names, c("med.term"), "([^0-9]*)", remove=FALSE) %>%
  nest(pooldata=-med.term) %>%
  mutate(
    pool.med=map(pooldata, ~summary(mice::pool(.x$medlist_leptin,
                                               dfcom=NULL, rule="rubin1987"),
                                    conf.int=TRUE, conf.level=0.95)),
    pool.med=map(pool.med, ~as.tibble(., .name_repair="universal"))) %>%
  unnest(pool.med) %>%
  filter(str_detect(term, "acme_0")) %>%
  mutate(term=dplyr::recode(term,
                            "acme_0"="Average causal mediation effects" # indirect effect of the IV on the DV that goes through the mediator
                            #, "ade_0"="Average direct effects" # direct effect of the IV on the DV when controlling for the mediator
                            )) %>%
  arrange(p.value) %>%
  mutate(t=formatC(statistic, format="f", digits=2)) %>% 
  mutate(p=ifelse(p.value<0.001, "<0.001", 
                            formatC(p.value, format="f", digits=3))) %>%
  dplyr::select(med.term, term, estimate, std.error, t, p) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Nucleus, Symptom", "Mediation term",
                           "beta", "se", "t", "p"), 
               caption="Mediation models - Leptin (log10)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

## Exploratory analyses including non-log-transformed but multiply imputed leptin levels (change scores)

```{r lmeleptinNT, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme.leptin_nt <- lme.leptin_nt_pre %>%
  unnest(data, ortho, ortho.sq) %>%
  dplyr::select(rn.hemi_region, rn.total, region, hemi_region, labeller.amy, whole.sub, 
                participant_id, por, measure, e_tiv,
                age_at_date_of_research, delta.bmisds, delta.leptin.clmi, delta.leptin.clmi.ortho) %>%
  nest(lmedata=-c(region, hemi_region, labeller.amy, whole.sub, rn.hemi_region, rn.total)) %>%
  mutate(
    lmedata=map(lmedata, ~mutate(.x,
                           age.c=age_at_date_of_research - mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lme_nt=map(lmedata, ~lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.leptin.clmi.ortho +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit))) %>%
  nest(pooldata=-c(region, hemi_region, labeller.amy, whole.sub)) %>%
  mutate(
    pool.lme_nt=map(pooldata, ~mice::pool(.x$lme_nt, 
                                           dfcom=NULL, rule="rubin1987")),
    pool.lme_nt.tidy=map(pool.lme_nt, tidy),
    pool.lme_nt.summary=map(pool.lme_nt, ~summary(.x, conf.int=TRUE,
                                                    conf.level=0.95)))
    
contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  semi_join(hemi_region_cross, by="hemi_region") %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lme.leptin_nt, by="hemi_region") %>%
  dplyr::select(hemi_region, labeller.amy, whole.sub, pool.lme_nt.summary) %>%
  unnest(pool.lme_nt.summary) %>%
  filter(str_detect(term, "leptin")) %>%
  mutate(p.value=p.value/2) %>% # one-sided significance testing
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  nest(effdata=c(statistic, df)) %>%
  mutate(d=map(effdata, ~t_to_d(t=.x$statistic, df_error=.x$df, paired=FALSE, ci=0.95,
                                      alternative="less"))) %>% # one-sided significance testing
  unnest(effdata, d) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", 
                            formatC(abs(d), format="f", digits=2))) %>%
  arrange(hemi_region) %>%
  dplyr::select(labeller.amy, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in Leptin levels (CLMI-imputed, orthogonalized, NOT log-transformed)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```

### Exploratory analyses including other lab parameters

```{r ghrelincytokines, results="asis", message=FALSE, warning=FALSE, eval=FALSE}
lme_labs <- contrasts %>%
  filter((contrast=="AcAN-TP2vsAcAN-TP1")&(p.fdr<0.05)) %>%
  dplyr::select(hemi_region) %>%
  rbind(hemi_region_add) %>% # add rh medial nucleus
  left_join(lmedata, by="hemi_region") %>%
  left_join(join_labs, by=c("participant_id", "point_of_research")) %>%
  #mutate(low_T3=ifelse(((point_of_research=="T1")&(age_at_date_of_research<=20)&(ft3<3.93)) | 
                         #((point_of_research=="T1")&(age_at_date_of_research>20)&(ft3<3.13)), 
                       #TRUE, FALSE)) %>% # Low-FT3 syndrome: FT3: 3.93–7.70 pmol/L (for participants of >11.0≤20.0 years of age), 3.13–6.76 pmol/L (>20.0 years)
  #filter((point_of_research %in% c("T2", "recAN", "HCW")) | (low_T3==TRUE)) %>%
  group_by(hemi_region, participant_id) %>% 
  #mutate(nomatch=ifelse((por=="acAN") & (n()<2), TRUE, FALSE)) %>%
  #filter(nomatch==FALSE) %>% 
  arrange(point_of_research, .by_group=TRUE) %>%
  mutate(delta.measure=ifelse(point_of_research=="T1", 
                             measure - lead(measure), 0)) %>%
  mutate(delta.log_ghrelin=ifelse(point_of_research=="T1", 
                             log_ghrelin - lead(log_ghrelin), 0)) %>%
  mutate(delta.log_bdnf=ifelse(point_of_research=="T1", 
                             log_bdnf - lead(log_bdnf), 0)) %>%
  mutate(delta.log_il6=ifelse(point_of_research=="T1", 
                             log_il6 - lead(log_il6), 0)) %>%
  mutate(delta.log_tnfa=ifelse(point_of_research=="T1", 
                             log_tnfa - lead(log_tnfa), 0)) %>%
  mutate(delta.log_ft3=ifelse(point_of_research=="T1", 
                             log_ft3 - lead(log_ft3), 0)) %>%
  mutate(T1pred.log_ft3=ifelse(point_of_research=="T1", 
                                 log_ft3, 0)) %>%
  mutate(delta.ft3_ft4_ratio=ifelse(point_of_research=="T1", 
                             ft3_ft4_ratio - lead(ft3_ft4_ratio), 0)) %>%
  mutate(T1pred.ft3_ft4_ratio=ifelse(point_of_research=="T1", 
                             ft3_ft4_ratio, 0)) %>%
  mutate(delta.log_b12=ifelse(point_of_research=="T1", 
                             log_b12 - lead(log_b12), 0)) %>%
  ungroup() %>%
  dplyr::select(participant_id, por, hemi_region, region, labeller.amy, whole.sub, measure, delta.bmisds,
                T1pred.bmisds, age_at_date_of_research, e_tiv, delta.log_b12,
                delta.log_ghrelin, delta.log_bdnf, delta.log_il6, delta.log_tnfa, delta.log_ft3, delta.ft3_ft4_ratio
                #T1pred.log_ft3, T1pred.ft3_ft4_ratio
                ) %>%
  pivot_longer(-c(participant_id, por, hemi_region, region, labeller.amy, whole.sub, measure, delta.bmisds,
                  T1pred.bmisds, age_at_date_of_research, e_tiv), 
               names_to="demo_variable", values_to="delta.value") %>%
  nest(data_pre=-c(hemi_region, region, labeller.amy, whole.sub, demo_variable)) %>%
  mutate(
    data=map(data_pre, ~drop_na(.x)),
    n=map_dbl(data, ~sum(.x$delta.value!=0)),
    data=map(data, ~mutate(.x,
                           age.c=age_at_date_of_research - 
                             mean(age_at_date_of_research, na.rm=TRUE),
                           etiv.c=e_tiv - mean(e_tiv, na.rm=TRUE))),
    lmetest=map(data, ~lmerTest::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.value +
                                        #T1pred.bmisds +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id), 
                                      data=.x, REML=TRUE, na.action=na.omit)),
    lmetest.tidy=map(lmetest, tidy),
    cohensD=map(data, ~lme.dscore(lme4::lmer(measure ~1 + por +
                                        delta.bmisds +
                                        delta.value +
                                        #T1pred.bmisds +
                                        poly(age.c, degree=2, raw=FALSE) +
                                        etiv.c + 
                                        (1|participant_id),
                                        data=.x, REML=TRUE, na.action=na.omit), 
                                  data=.x, type="lme4")),
    cohensD=map(cohensD, ~rownames_to_column(.x, "term")),
    cohensD=map(cohensD, ~filter(.x, term=="delta.value")),
    cohensD=map(cohensD, ~dplyr::select(.x, d)))

lme_labs %>%
  dplyr::select(labeller.amy, hemi_region, whole.sub, demo_variable, n, lmetest.tidy, cohensD) %>%
  unnest(lmetest.tidy, cohensD) %>%
  filter(str_detect(term, "delta.value")) %>%
  mutate(p_formatted=ifelse(p.value<0.001, "<0.001", formatC(p.value, format="f", digits=3))) %>%
  mutate(signif=as.character(asterisk_function(p.value))) %>%
  group_by(whole.sub) %>%
  mutate(p.fdr=p.adjust(p.value, method="fdr")) %>%
  ungroup() %>%
  mutate(p.fdr_formatted=ifelse(p.fdr<0.001, "<0.001", formatC(p.fdr, format="f", digits=3))) %>%
  mutate(adj.signif=as.character(asterisk_function(p.fdr))) %>%
  mutate(d_formatted=ifelse(abs(d)<0.01, "<0.01", formatC(abs(d), format="f", digits=2))) %>%
  arrange(demo_variable, hemi_region) %>%
  filter(p.value<0.1) %>%
  dplyr::select(demo_variable, labeller.amy, n, effect, term, estimate, std.error, statistic, p_formatted, signif,
                p.fdr_formatted, adj.signif, d_formatted) %>%
  knitr::kable(format="html", digits=2, align="l", 
               col.names=c("Amygdala (sub-)region", "Variable", "N", "Effect", "Term", "beta", "se", 
                           "t", "p", "Signif.", "FDR-q", "Adj. Signif.", "Cohen's d"), 
               caption="LME model including change in neuro-/endocrine parameters (acAN-TP2 vs. acAN-TP1), further independent variables: deltaBMI-SDS, age, age^2, eTIV; parameters tested: deltaLog10-Ghrelin, deltaLog10-BDNF, deltaLog10-IL6, deltaLog10-TNFalpha, deltaLog10-FT3, deltaFT3/FT4 ratio (significant findings filtered)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left", 
              html_font="Arial", font_size="10")
```
